<MIVA STANDARDOUTPUTLEVEL = "">

<MvCOMMENT>
|
| Miva Merchant
|
| This file and the source codes contained herein are the property of
| Miva, Inc.  Use of this file is restricted to the specific terms and
| conditions in the License Agreement associated with this file.  Distribution
| of this file or portions of this file for uses not covered by the License
| Agreement is not allowed without a written agreement signed by an officer of
| Miva, Inc.
|
| Copyright 1998-2023 Miva, Inc.  All rights reserved.
| http://www.miva.com
|
| Prefix         : MER-SUB-DTB-
| Next Error Code: 103   
|
</MvCOMMENT>

<MvFUNCTION NAME = "SUB_Store_Create" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| sNN_ProductSubscriptionSettings
	|
	</MvCOMMENT>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'ProductSubscriptionSettings
						  (
							product_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()	$ ',
							enabled		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_BOOL() 	$ ',
							mandatory	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_BOOL()	$ ',
							can_cancel	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_BOOL()	$ ',
							cncl_min	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()	$ ',
							can_qty		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_BOOL()	$ ',
							qty_min		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()	$ ',
							can_term	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_BOOL()	$ ',
							term_min	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()	$ ',
							can_date	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_BOOL()	$ ',
							date_min	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()	$ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00001', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'ProductSubscriptionSettings_1 ON ' $ g.Store_Table_Prefix $ 'ProductSubscriptionSettings ( product_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00002', g.MvQUERY_Error ) }">
	</MvIF>

	<MvCOMMENT>
	|
	| sNN_ProductSubscriptionTerms
	|
	</MvCOMMENT>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms
						  (
							id			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							product_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							frequency	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 20 )	$ ',
							term		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							descrip		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 )	$ ',
							n			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							fixed_dow	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							fixed_dom	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							sub_count	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							disp_order	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00003', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms_1 ON ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms ( id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00004', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms_2 ON ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms ( product_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00005', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms_3 ON ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms ( product_id, descrip )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00047', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms_4 ON ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms ( product_id, disp_order )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00102', g.MvQUERY_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StoreKey_Insert( 'ProductSubscriptionTerms', 1 ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StoreKey_Insert( 'ProductSubscriptionTermDisplayOrder', 1 ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvCOMMENT>
	|
	| sNN_ProductSubscriptionTermDates
	|
	</MvCOMMENT>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTermDates
						  (
							subterm_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER() $ ',
							term_dom	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER() $ ',
							term_mon	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER() $ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00048', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTermDates_1 ON ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTermDates ( subterm_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00049', g.MvQUERY_Error ) }">
	</MvIF>

	<MvCOMMENT>
	|
	| sNN_SubscriptionSettings
	|
	</MvCOMMENT>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'SubscriptionSettings
						  (
							afaildelay	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							maxafails	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							out_skip	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 10 )	$ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00096', g.MvQUERY_Error ) }">
	</MvIF>

	<MvEVAL EXPR = "{ SubscriptionSettings_Default( l.subscriptionsettings ) }">

	<MvIF EXPR = "{ NOT SubscriptionSettings_Insert( l.subscriptionsettings ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvCOMMENT>
	|
	| sNN_Subscriptions
	|
	</MvCOMMENT>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'Subscriptions
						  (
							id				' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							order_id		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							line_id			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							cust_id			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							custpc_id		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							product_id		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							subterm_id		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							addr_id			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							ship_id			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							ship_data		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 100 )		$ ',
							quantity		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							termrem			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							termproc		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							firstdate		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							lastdate		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							nextdate		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							status			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 1 )			$ ',
							message			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_MEMO()			$ ',
							cncldate		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							tax				' $ [ g.Module_Library_Native_DBAPI ].DB_Type_NUMBER( 10, 2 )	$ ',
							shipping		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_NUMBER( 10, 2 )	$ ',
							subtotal		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_NUMBER( 10, 2 )	$ ',
							total			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_NUMBER( 10, 2 )	$ ',
							authfails		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							lastafail		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00006', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'Subscriptions_1 ON ' $ g.Store_Table_Prefix $ 'Subscriptions ( id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00007', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'Subscriptions_2 ON ' $ g.Store_Table_Prefix $ 'Subscriptions ( order_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00008', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'Subscriptions_3 ON ' $ g.Store_Table_Prefix $ 'Subscriptions ( cust_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00009', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'Subscriptions_4 ON ' $ g.Store_Table_Prefix $ 'Subscriptions ( product_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00010', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'Subscriptions_5 ON ' $ g.Store_Table_Prefix $ 'Subscriptions ( subterm_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00011', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'Subscriptions_6 ON ' $ g.Store_Table_Prefix $ 'Subscriptions ( custpc_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00050', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'Subscriptions_7 ON ' $ g.Store_Table_Prefix $ 'Subscriptions ( status )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00064', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'Subscriptions_8 ON ' $ g.Store_Table_Prefix $ 'Subscriptions ( ship_id, ship_data )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00091', g.MvQUERY_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StoreKey_Insert( 'Subscriptions', 1 ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvCOMMENT>
	|
	| sNN_SubscriptionOptions
	|
	</MvCOMMENT>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'SubscriptionOptions
						  (
							subscrp_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							templ_code	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							attr_code	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							value		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_MEMO()		$ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00012', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'SubscriptionOptions_1 ON ' $ g.Store_Table_Prefix $ 'SubscriptionOptions ( subscrp_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00013', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SUB_Create_Data_Files" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].DomainPrivilege_Insert( 'SUBS', 'Subscriptions' ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SUB_Store_Delete" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'ProductSubscriptionSettings' }"> 
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'ProductSubscriptionTerms' }"> 
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'ProductSubscriptionTermDates' }"> 
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'SubscriptionSettings' }"> 
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'Subscriptions' }"> 
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'SubscriptionOptions' }"> 

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| sNN_ProductSubscriptionSettings
|
</MvCOMMENT>

<MvFUNCTION NAME = "ProductSubscriptionSettings_Read" PARAMETERS = "productsubscriptionsettings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.productsubscriptionsettings:product_id"		VALUE = "{ ProductSubscriptionSettings.d.product_id }">
	<MvASSIGN NAME = "l.productsubscriptionsettings:enabled"		VALUE = "{ ProductSubscriptionSettings.d.enabled }">
	<MvASSIGN NAME = "l.productsubscriptionsettings:mandatory"		VALUE = "{ ProductSubscriptionSettings.d.mandatory }">
	<MvASSIGN NAME = "l.productsubscriptionsettings:can_cancel"		VALUE = "{ ProductSubscriptionSettings.d.can_cancel }">
	<MvASSIGN NAME = "l.productsubscriptionsettings:cncl_min"		VALUE = "{ ProductSubscriptionSettings.d.cncl_min }">
	<MvASSIGN NAME = "l.productsubscriptionsettings:can_qty"		VALUE = "{ ProductSubscriptionSettings.d.can_qty }">
	<MvASSIGN NAME = "l.productsubscriptionsettings:qty_min"		VALUE = "{ ProductSubscriptionSettings.d.qty_min }">
	<MvASSIGN NAME = "l.productsubscriptionsettings:can_term"		VALUE = "{ ProductSubscriptionSettings.d.can_term }">
	<MvASSIGN NAME = "l.productsubscriptionsettings:term_min"		VALUE = "{ ProductSubscriptionSettings.d.term_min }">
	<MvASSIGN NAME = "l.productsubscriptionsettings:can_date"		VALUE = "{ ProductSubscriptionSettings.d.can_date }">
	<MvASSIGN NAME = "l.productsubscriptionsettings:date_min"		VALUE = "{ ProductSubscriptionSettings.d.date_min }">
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionSettings_Default" PARAMETERS = "product_id, productsubscriptionsettings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.productsubscriptionsettings:product_id"		VALUE = "{ l.product_id }">
	<MvASSIGN NAME = "l.productsubscriptionsettings:enabled"		VALUE = 0>
	<MvASSIGN NAME = "l.productsubscriptionsettings:mandatory"		VALUE = 0>
	<MvASSIGN NAME = "l.productsubscriptionsettings:can_cancel"		VALUE = 1>
	<MvASSIGN NAME = "l.productsubscriptionsettings:cncl_min"		VALUE = 0>
	<MvASSIGN NAME = "l.productsubscriptionsettings:can_qty"		VALUE = 1>
	<MvASSIGN NAME = "l.productsubscriptionsettings:qty_min"		VALUE = 0>
	<MvASSIGN NAME = "l.productsubscriptionsettings:can_term"		VALUE = 1>
	<MvASSIGN NAME = "l.productsubscriptionsettings:term_min"		VALUE = 0>
	<MvASSIGN NAME = "l.productsubscriptionsettings:can_date"		VALUE = 1>
	<MvASSIGN NAME = "l.productsubscriptionsettings:date_min"		VALUE = 0>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionSettings_Equal_Default" PARAMETERS = "productsubscriptionsettings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.productsubscriptionsettings:enabled NE 0 }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ l.productsubscriptionsettings:mandatory NE 0 }">	<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ l.productsubscriptionsettings:can_cancel NE 1 }">	<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ l.productsubscriptionsettings:cncl_min NE 0 }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ l.productsubscriptionsettings:can_qty NE 1 }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ l.productsubscriptionsettings:qty_min NE 0 }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ l.productsubscriptionsettings:can_term NE 1 }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ l.productsubscriptionsettings:term_min NE 0 }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ l.productsubscriptionsettings:can_date NE 1 }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ l.productsubscriptionsettings:date_min NE 0 }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionSettings_Insert" PARAMETERS = "productsubscriptionsettings var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'ProductSubscriptionSettings
						  ( product_id, enabled, mandatory, can_cancel, cncl_min, can_qty, qty_min, can_term, term_min, can_date, date_min )
						  VALUES
						  ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )' }"
			 FIELDS	= "l.productsubscriptionsettings:product_id, l.productsubscriptionsettings:enabled, l.productsubscriptionsettings:mandatory,
			 		   l.productsubscriptionsettings:can_cancel, l.productsubscriptionsettings:cncl_min,
			 		   l.productsubscriptionsettings:can_qty, l.productsubscriptionsettings:qty_min, 
			 		   l.productsubscriptionsettings:can_term, l.productsubscriptionsettings:term_min, 
			 		   l.productsubscriptionsettings:can_date, l.productsubscriptionsettings:date_min">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00014', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionSettings_Update" PARAMETERS = "productsubscriptionsettings var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'ProductSubscriptionSettings
						  SET
							enabled		= ?,
							mandatory	= ?,
							can_cancel	= ?,
							cncl_min	= ?,
							can_qty		= ?,
							qty_min		= ?,
							can_term	= ?,
							term_min	= ?,
							can_date	= ?,
							date_min	= ?
						  WHERE
						  	product_id	= ?' }"
			 FIELDS	= "l.productsubscriptionsettings:enabled, l.productsubscriptionsettings:mandatory,
			 		   l.productsubscriptionsettings:can_cancel, l.productsubscriptionsettings:cncl_min,
			 		   l.productsubscriptionsettings:can_qty, l.productsubscriptionsettings:qty_min,
			 		   l.productsubscriptionsettings:can_term, l.productsubscriptionsettings:term_min,
			 		   l.productsubscriptionsettings:can_date, l.productsubscriptionsettings:date_min,
			 		   l.productsubscriptionsettings:product_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00015', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionSettings_Load_Product_Cached" PARAMETERS = "product_id, productsubscriptionsettings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.product_id"						VALUE = "{ int( l.product_id ) }">

	<MvIF EXPR = "{ l.product_id LE 0 }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-SUB-DTB-00093' ) }">
	</MvIF>

	<MvREFERENCEARRAY NAME = "l.cache"					VARIABLE = "g.Session:cache:productsubscriptionsettings_load_product">
		<MvDIMENSION INDEX = "{ l.product_id }">
	</MvREFERENCEARRAY>

	<MvIF EXPR = "{ ISNULL l.cache:result }">
		<MvASSIGN NAME = "l.cache:result"				VALUE = "{ ProductSubscriptionSettings_Load_Product( l.product_id, l.cache:productsubscriptionsettings ) }">
		<MvIF EXPR = "{ NOT l.cache:result }">
			<MvASSIGN NAME = "l.cache:error_code"		VALUE = "{ g.Error_Code }">
			<MvASSIGN NAME = "l.cache:error_message"	VALUE = "{ g.Error_Message }">
			<MvASSIGN NAME = "l.cache:error_db_eof"		VALUE = "{ g.Error_DB_EOF }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT l.cache:result }">
		<MvIF EXPR = "{ l.cache:error_db_eof }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( l.cache:error_code ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( l.cache:error_code, l.cache:error_message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.productsubscriptionsettings"	VALUE = "{ l.cache:productsubscriptionsettings }">

	<MvFUNCTIONRETURN VALUE = "{ l.cache:result }">
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionSettings_Load_Product" PARAMETERS = "product_id, productsubscriptionsettings var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "ProductSubscriptionSettings"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'ProductSubscriptionSettings WHERE product_id = ?' }"
				FIELDS	= "l.product_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00016', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ ProductSubscriptionSettings.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductSubscriptionSettings">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-SUB-DTB-00017' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ ProductSubscriptionSettings_Read( l.productsubscriptionsettings ) }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductSubscriptionSettings">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionSettings_Delete_Product" PARAMETERS = "product_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'ProductSubscriptionSettings
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.product_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00018', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionSettings_Load_ProductOrDefault" PARAMETERS = "product_id, productsubscriptionsettings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ ProductSubscriptionSettings_Load_Product( l.product_id, l.productsubscriptionsettings ) }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">											<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvEVAL EXPR = "{ ProductSubscriptionSettings_Default( l.product_id, l.productsubscriptionsettings ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| sNN_ProductSubscriptionTerms
|
</MvCOMMENT>

<MvFUNCTION NAME = "ProductSubscriptionTerm_Read" PARAMETERS = "productsubscriptionterm var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.productsubscriptionterm:id"				VALUE = "{ ProductSubscriptionTerms.d.id }">
	<MvASSIGN NAME = "l.productsubscriptionterm:product_id"		VALUE = "{ ProductSubscriptionTerms.d.product_id }">
	<MvASSIGN NAME = "l.productsubscriptionterm:frequency"		VALUE = "{ ProductSubscriptionTerms.d.frequency }">
	<MvASSIGN NAME = "l.productsubscriptionterm:term"			VALUE = "{ ProductSubscriptionTerms.d.term }">
	<MvASSIGN NAME = "l.productsubscriptionterm:descrip"		VALUE = "{ ProductSubscriptionTerms.d.descrip }">
	<MvASSIGN NAME = "l.productsubscriptionterm:n"				VALUE = "{ ProductSubscriptionTerms.d.n }">
	<MvASSIGN NAME = "l.productsubscriptionterm:fixed_dow"		VALUE = "{ ProductSubscriptionTerms.d.fixed_dow }">
	<MvASSIGN NAME = "l.productsubscriptionterm:fixed_dom"		VALUE = "{ ProductSubscriptionTerms.d.fixed_dom }">
	<MvASSIGN NAME = "l.productsubscriptionterm:sub_count"		VALUE = "{ ProductSubscriptionTerms.d.sub_count }">
	<MvASSIGN NAME = "l.productsubscriptionterm:disp_order"		VALUE = "{ ProductSubscriptionTerms.d.disp_order }">
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTerm_Insert" PARAMETERS = "productsubscriptionterm var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.productsubscriptionterm:id"				VALUE = "{ [ g.Module_Library_DB ].StoreKey_Generate( 'ProductSubscriptionTerms' ) }">
	<MvASSIGN NAME = "l.productsubscriptionterm:disp_order"		VALUE = "{ [ g.Module_Library_DB ].StoreKey_Generate( 'ProductSubscriptionTermDisplayOrder' ) }">

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms
						  ( id, product_id, frequency, term, descrip, n, fixed_dow, fixed_dom, sub_count, disp_order )
						  VALUES
						  ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )' }"
			 FIELDS	= "l.productsubscriptionterm:id, l.productsubscriptionterm:product_id, l.productsubscriptionterm:frequency, l.productsubscriptionterm:term, l.productsubscriptionterm:descrip,
			 		   l.productsubscriptionterm:n, l.productsubscriptionterm:fixed_dow, l.productsubscriptionterm:fixed_dom, l.productsubscriptionterm:sub_count, l.productsubscriptionterm:disp_order">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00019', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTerm_Update" PARAMETERS = "productsubscriptionterm var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms
						  SET
							product_id	= ?,
							frequency	= ?,
							term		= ?,
							descrip		= ?,
							n			= ?,
							fixed_dow	= ?,
							fixed_dom	= ?,
							sub_count	= ?,
							disp_order	= ?
						  WHERE
						  	id			= ?' }"
			 FIELDS	= "l.productsubscriptionterm:product_id, l.productsubscriptionterm:frequency, l.productsubscriptionterm:term, l.productsubscriptionterm:descrip,
			 		   l.productsubscriptionterm:n, l.productsubscriptionterm:fixed_dow, l.productsubscriptionterm:fixed_dom, l.productsubscriptionterm:sub_count,
					   l.productsubscriptionterm:disp_order, 
					   l.productsubscriptionterm:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00020', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTerm_Load_ID" PARAMETERS = "id, productsubscriptionterm var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "ProductSubscriptionTerms"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms WHERE id = ?' }"
				FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00021', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ ProductSubscriptionTerms.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductSubscriptionTerms">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-SUB-DTB-00022' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ ProductSubscriptionTerm_Read( l.productsubscriptionterm ) }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductSubscriptionTerms">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTerm_Load_ID_Cached" PARAMETERS = "id, productsubscriptionterm var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.id"								VALUE = "{ int( l.id ) }">

	<MvIF EXPR = "{ l.id LE 0 }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-SUB-DTB-00065' ) }">
	</MvIF>

	<MvREFERENCEARRAY NAME = "l.cache"					VARIABLE = "g.Session:cache:productsubscriptionterm_load_id">
		<MvDIMENSION INDEX = "{ l.id }">
	</MvREFERENCEARRAY>

	<MvIF EXPR = "{ ISNULL l.cache:result }">
		<MvASSIGN NAME = "l.cache:result" 				VALUE = "{ ProductSubscriptionTerm_Load_ID( l.id, l.cache:productsubscriptionterm ) }">
		<MvIF EXPR = "{ NOT l.cache:result }">
			<MvASSIGN NAME = "l.cache:error_code"		VALUE = "{ g.Error_Code }">
			<MvASSIGN NAME = "l.cache:error_message"	VALUE = "{ g.Error_Message }">
			<MvASSIGN NAME = "l.cache:error_db_eof"		VALUE = "{ g.Error_DB_EOF }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT l.cache:result }">
		<MvIF EXPR = "{ l.cache:error_db_eof }">
			<MvFUNCTIONRETURN VALUE =  "{ [ g.Module_Library_DB ].Error_Load_EOF( l.cache:error_code ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( l.cache:error_code, l.cache:error_message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.productsubscriptionterm"		VALUE = "{ l.cache:productsubscriptionterm }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTerm_Load_Description" PARAMETERS = "product_id, descrip, productsubscriptionterm var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "ProductSubscriptionTerms"
				QUERY	= "{ 'SELECT
								*
							  FROM
								' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms
							  WHERE
								product_id	= ? AND
								' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'descrip' ) $ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) }"
				FIELDS	= "l.product_id, l.descrip">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00051', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ ProductSubscriptionTerms.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductSubscriptionTerms">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-SUB-DTB-00052' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ ProductSubscriptionTerm_Read( l.productsubscriptionterm ) }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductSubscriptionTerms">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTerm_Delete" PARAMETERS = "productsubscriptionterm var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PGR_DB ].PriceGroupXProductSubscription_Delete_All_ProductSubscriptionTerm( l.productsubscriptionterm:product_id, l.productsubscriptionterm:id )			AND
								 [ g.Module_Feature_PGR_DB ].PriceGroupXExcludedProductSubscription_Delete_All_ProductSubscriptionTerm( l.productsubscriptionterm:product_id, l.productsubscriptionterm:id )	AND
								 [ g.Module_Feature_PGR_DB ].PriceGroupXQualifyingProductSubscription_Delete_All_ProductSubscriptionTerm( l.productsubscriptionterm:product_id, l.productsubscriptionterm:id )	AND
								 ProductSubscriptionTerm_Delete_ID( l.productsubscriptionterm:id ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTerm_Delete_ID" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms
						  WHERE
							id = ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00023', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTerms_Delete_Product" PARAMETERS = "product_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.product_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00024', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTermList_Load_Product_Cached" PARAMETERS = "product_id, productsubscriptionterms var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.product_id"						VALUE = "{ int( l.product_id ) }">

	<MvIF EXPR = "{ l.product_id LE 0 }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-SUB-DTB-00094' ) }">
	</MvIF>

	<MvREFERENCEARRAY NAME = "l.cache"					VARIABLE = "g.Session:cache:productsubscriptiontermlist_load_product">
		<MvDIMENSION INDEX = "{ l.product_id }">
	</MvREFERENCEARRAY>

	<MvIF EXPR = "{ ISNULL l.cache:count }">
		<MvASSIGN NAME = "l.cache:count"				VALUE = "{ ProductSubscriptionTermList_Load_Product( l.product_id, l.cache:productsubscriptionterms ) }">
		<MvIF EXPR = "{ l.cache:count EQ 0 }">
			<MvASSIGN NAME = "l.cache:error_code"		VALUE = "{ g.Error_Code }">
			<MvASSIGN NAME = "l.cache:error_message"	VALUE = "{ g.Error_Message }">
			<MvASSIGN NAME = "l.cache:error_db_eof"		VALUE = "{ g.Error_DB_EOF }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ l.cache:count EQ 0 }">
		<MvIF EXPR = "{ l.cache:error_db_eof }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( l.cache:error_code ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( l.cache:error_code, l.cache:error_message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.productsubscriptionterms"		VALUE = "{ l.cache:productsubscriptionterms }">

	<MvFUNCTIONRETURN VALUE = "{ l.cache:count }">
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTermList_Load_Product" PARAMETERS = "product_id, productsubscriptionterms var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "ProductSubscriptionTerms"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms WHERE product_id = ? ORDER BY disp_order ASC' }"
				FIELDS	= "l.product_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00025', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.productsubscriptionterms_count"		VALUE = 0>
	<MvWHILE EXPR = "{ NOT ProductSubscriptionTerms.d.EOF }">
		<MvEVAL EXPR = "{ ProductSubscriptionTerm_Read( l.productsubscriptionterms[ ++l.productsubscriptionterms_count ] ) }">
		
		<MvSKIP NAME = "Merchant" VIEW = "ProductSubscriptionTerms" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductSubscriptionTerms">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-SUB-DTB-00026', l.productsubscriptionterms_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTerm_Increment_SubscriptionCount" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms
					      SET
							sub_count	= sub_count + 1
					      WHERE
						    id			= ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00027', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTerm_Decrement_SubscriptionCount" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms
					      SET
							sub_count	= sub_count - 1
					      WHERE
						    id			= ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00028', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTermList_Update_Offsets" PARAMETERS = "product_id, prodsubs var, prodsub_count" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.pastend" 		VALUE = "">
	<MvASSIGN NAME = "l.pastend_count"	VALUE = 0>

	<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].SortOffsetArray( l.prodsubs, l.prodsub_count ) }">

	<MvFOREACH ITERATOR = "l.prodsub" ARRAY = "l.prodsubs" COUNT = "{ l.prodsub_count }">
		<MvCOMMENT>
		|
		| Determine disp_order of current prodsub at this offset.
		|
		</MvCOMMENT>

		<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant',
																				 'ProductSubscriptionTerms',
																				 'SELECT id, disp_order FROM ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms WHERE id <> ? AND product_id = ? ORDER BY disp_order',
																				 [ g.Module_Library_DB ].SQL_Query_Field( l.prodsub:id ) $ ',' $ [ g.Module_Library_DB ].SQL_Query_Field( l.product_id ),
																				 l.prodsub:offset - 1,
																				 1 ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00090', g.MvOPENVIEW_Error ) }">
		</MvIF>

		<MvIF EXPR = "{ ProductSubscriptionTerms.d.EOF }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductSubscriptionTerms">

			<MvCOMMENT>
			|
			| Offset was higher than the last record.  This case requires specialized processing, so save this record for later.
			|
			</MvCOMMENT>

			<MvASSIGN NAME = "l.pastend_count"							VALUE = "{ l.pastend_count + 1 }">
			<MvASSIGN NAME = "l.pastend" INDEX = "{ l.pastend_count }"	VALUE = "{ l.prodsub }">

		<MvELSEIF EXPR = "{ l.pastend_count }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductSubscriptionTerms">

			<MvIF EXPR = "{ NOT ProductSubscriptionTerm_Update_Offsets_PastEnd( l.product_id, l.pastend, l.pastend_count ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvASSIGN NAME = "l.pastend_count" VALUE = 0>
		<MvELSE>
			<MvASSIGN NAME = "l.disp_order" VALUE = "{ ProductSubscriptionTerms.d.disp_order }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductSubscriptionTerms">

			<MvCOMMENT>
			|
			| Make a hole by shifting prodsubs after this disp_order down
			|
			</MvCOMMENT>

			<MvQUERY NAME  = "Merchant" 
					 QUERY = "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms 
								 SET 
								  	disp_order 	= disp_order + 1 
								 WHERE 
								  	disp_order >= ? AND 
								  	product_id 	= ?' }" 
					 FIELDS = "l.disp_order, l.product_id">
			<MvIF EXPR = "{ g.MvQUERY_Error }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00087', g.MvQUERY_Error ) }">
			</MvIF>

			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Library_DB ].StoreKey_Generate( 'ProductSubscriptionTermDisplayOrder' ) }">

			<MvCOMMENT>
			|
			| Put the prodsub in the newly created hole
			|
			</MvCOMMENT>

			<MvQUERY NAME  = "Merchant" 
					 QUERY = "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms 
								 SET 
					 				disp_order 	= ? 
								 WHERE 
					 				id 			= ? AND 
					 				product_id 	= ?' }" 
					 FIELDS = "l.disp_order, 
					 		   l.prodsub:id, l.product_id">
			<MvIF EXPR = "{ g.MvQUERY_Error }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00088', g.MvQUERY_Error ) }">
			</MvIF>
		</MvIF>
	</MvFOREACH>

	<MvCOMMENT>
	|
	| If all the downward records were past the end, they must be processed here.
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ l.pastend_count }">
		<MvIF EXPR = "{ NOT ProductSubscriptionTerm_Update_Offsets_PastEnd( l.product_id, l.pastend, l.pastend_count ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Product_Update_LastUpdated( l.product_id ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTerm_Update_Offsets_PastEnd" PARAMETERS = "product_id, pastend var, pastend_count" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| Process records moving past the end.  These records must be sorted in ascending order.
	|
	</MvCOMMENT>

	<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].SortOffsetArray_PastEnd( l.pastend, l.pastend_count ) }">

	<MvFOREACH ITERATOR = "l.element" ARRAY = "l.pastend" COUNT = "{ l.pastend_count }">
		<MvASSIGN NAME = "l.disp_order" VALUE = "{ [ g.Module_Library_DB ].StoreKey_Generate( 'ProductSubscriptionTermDisplayOrder' ) }">

		<MvQUERY NAME  = "Merchant" 
				 QUERY = "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms 
							 SET 
								disp_order 	= ? 
							 WHERE 
								id 			= ? AND 
								product_id 	= ?' }" 
				 FIELDS = "l.disp_order, 
				 		   l.element:id, l.product_id">
		<MvIF EXPR = "{ g.MvQUERY_Error }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00089', g.MvQUERY_Error ) }">
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| sNN_ProductSubscriptionTermDates
|
</MvCOMMENT>

<MvFUNCTION NAME = "ProductSubscriptionTermDate_Read" PARAMETERS = "productsubscriptiontermdate var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.productsubscriptiontermdate:subterm_id"		VALUE = "{ ProductSubscriptionTermDates.d.subterm_id }">
	<MvASSIGN NAME = "l.productsubscriptiontermdate:term_dom"		VALUE = "{ ProductSubscriptionTermDates.d.term_dom }">
	<MvASSIGN NAME = "l.productsubscriptiontermdate:term_mon"		VALUE = "{ ProductSubscriptionTermDates.d.term_mon }">
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTermDate_Insert" PARAMETERS = "productsubscriptiontermdate var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTermDates
						  ( subterm_id, term_dom, term_mon )
						  VALUES
						  ( ?, ?, ? )' }"
			 FIELDS	= "l.productsubscriptiontermdate:subterm_id, l.productsubscriptiontermdate:term_dom, l.productsubscriptiontermdate:term_mon">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00053', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTermDate_Delete_All_ProductSubscriptionTerm" PARAMETERS = "subterm_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTermDates
						  WHERE
							subterm_id = ?' }"
			 FIELDS	= "l.subterm_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00054', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ProductSubscriptionTermDateList_Load_ProductSubscriptionTerm" PARAMETERS = "subterm_id, productsubscriptiontermdates var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "ProductSubscriptionTermDates"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTermDates WHERE subterm_id = ? ORDER BY term_mon ASC, term_dom ASC' }"
				FIELDS	= "l.subterm_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00055', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.productsubscriptiontermdates_count"		VALUE = 0>
	<MvWHILE EXPR = "{ NOT ProductSubscriptionTermDates.d.EOF }">
		<MvEVAL EXPR = "{ ProductSubscriptionTermDate_Read( l.productsubscriptiontermdates[ ++l.productsubscriptiontermdates_count ] ) }">
		
		<MvSKIP NAME = "Merchant" VIEW = "ProductSubscriptionTermDates" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductSubscriptionTermDates">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-SUB-DTB-00056', l.productsubscriptiontermdates_count ) }">
</MvFUNCTION>

<MvCOMMENT>
|
| sNN_SubscriptionSettings
|
</MvCOMMENT>

<MvFUNCTION NAME = "SubscriptionSettings_Read" PARAMETERS = "subscriptionsettings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.subscriptionsettings:afaildelay"	VALUE = "{ SubscriptionSettings.d.afaildelay }">
	<MvASSIGN NAME = "l.subscriptionsettings:maxafails"		VALUE = "{ SubscriptionSettings.d.maxafails }">
	<MvASSIGN NAME = "l.subscriptionsettings:out_skip"		VALUE = "{ SubscriptionSettings.d.out_skip }">
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionSettings_Default" PARAMETERS = "subscriptionsettings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.subscriptionsettings:afaildelay"	VALUE = 1>
	<MvASSIGN NAME = "l.subscriptionsettings:maxafails"		VALUE = 0>
	<MvASSIGN NAME = "l.subscriptionsettings:out_skip"		VALUE = "process">
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionSettings_Insert" PARAMETERS = "subscriptionsettings var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'SubscriptionSettings
						  ( afaildelay, maxafails, out_skip )
						  VALUES
						  ( ?, ?, ? )' }"
			 FIELDS	= "l.subscriptionsettings:afaildelay, l.subscriptionsettings:maxafails, l.subscriptionsettings:out_skip">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00097', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionSettings_Update" PARAMETERS = "subscriptionsettings var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'SubscriptionSettings
			 			  SET
			 			  	afaildelay	= ?,
							maxafails	= ?,
							out_skip	= ?' }"
			 FIELDS = "l.subscriptionsettings:afaildelay, l.subscriptionsettings:maxafails, l.subscriptionsettings:out_skip">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00098', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionSettings_Load_Cached" PARAMETERS = "subscriptionsettings var" STANDARDOUTPUTLEVEL = "">
	<MvREFERENCE NAME = "l.cache" VARIABLE = "g.Session:cache:subscriptionsettings_load_cached">

	<MvIF EXPR = "{ ISNULL l.cache }">
		<MvASSIGN NAME = "l.cache:result"				VALUE = "{ SubscriptionSettings_Load( l.cache:subscriptionsettings ) }">

		<MvIF EXPR = "{ NOT l.cache:result }">
			<MvASSIGN NAME = "l.cache:error_code"		VALUE = "{ g.Error_Code }">
			<MvASSIGN NAME = "l.cache:error_message"	VALUE = "{ g.Error_Message }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT l.cache:result }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( l.cache:error_code, l.cache:error_message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.subscriptionsettings"			VALUE = "{ l.cache:subscriptionsettings }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionSettings_Load" PARAMETERS = "subscriptionsettings var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW 	= "SubscriptionSettings"
				QUERY 	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'SubscriptionSettings' }">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00099', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvEVAL EXPR = "{ SubscriptionSettings_Read( l.subscriptionsettings ) }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "SubscriptionSettings">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| sNN_Subscriptions
|
</MvCOMMENT>

<MvFUNCTION NAME = "Subscription_Read" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.subscription:id"			VALUE = "{ Subscriptions.d.id }">
	<MvASSIGN NAME = "l.subscription:order_id"		VALUE = "{ Subscriptions.d.order_id }">
	<MvASSIGN NAME = "l.subscription:line_id"		VALUE = "{ Subscriptions.d.line_id }">
	<MvASSIGN NAME = "l.subscription:cust_id"		VALUE = "{ Subscriptions.d.cust_id }">
	<MvASSIGN NAME = "l.subscription:custpc_id"		VALUE = "{ Subscriptions.d.custpc_id }">
	<MvASSIGN NAME = "l.subscription:product_id"	VALUE = "{ Subscriptions.d.product_id }">
	<MvASSIGN NAME = "l.subscription:subterm_id"	VALUE = "{ Subscriptions.d.subterm_id }">
	<MvASSIGN NAME = "l.subscription:addr_id"		VALUE = "{ Subscriptions.d.addr_id }">
	<MvASSIGN NAME = "l.subscription:ship_id"		VALUE = "{ Subscriptions.d.ship_id }">
	<MvASSIGN NAME = "l.subscription:ship_data"		VALUE = "{ Subscriptions.d.ship_data }">
	<MvASSIGN NAME = "l.subscription:quantity"		VALUE = "{ Subscriptions.d.quantity }">
	<MvASSIGN NAME = "l.subscription:termrem"		VALUE = "{ Subscriptions.d.termrem }">
	<MvASSIGN NAME = "l.subscription:termproc"		VALUE = "{ Subscriptions.d.termproc }">
	<MvASSIGN NAME = "l.subscription:firstdate"		VALUE = "{ Subscriptions.d.firstdate }">
	<MvASSIGN NAME = "l.subscription:lastdate"		VALUE = "{ Subscriptions.d.lastdate }">
	<MvASSIGN NAME = "l.subscription:nextdate"		VALUE = "{ Subscriptions.d.nextdate }">
	<MvASSIGN NAME = "l.subscription:status"		VALUE = "{ Subscriptions.d.status }">
	<MvASSIGN NAME = "l.subscription:message"		VALUE = "{ Subscriptions.d.message }">
	<MvASSIGN NAME = "l.subscription:cncldate"		VALUE = "{ Subscriptions.d.cncldate }">
	<MvASSIGN NAME = "l.subscription:tax"			VALUE = "{ Subscriptions.d.tax }">
	<MvASSIGN NAME = "l.subscription:shipping"		VALUE = "{ Subscriptions.d.shipping }">
	<MvASSIGN NAME = "l.subscription:subtotal"		VALUE = "{ Subscriptions.d.subtotal }">
	<MvASSIGN NAME = "l.subscription:total"			VALUE = "{ Subscriptions.d.total }">
	<MvASSIGN NAME = "l.subscription:authfails"		VALUE = "{ Subscriptions.d.authfails }">
	<MvASSIGN NAME = "l.subscription:lastafail"		VALUE = "{ Subscriptions.d.lastafail }">
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Insert" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.subscription:custpc_id }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.subscription:custpc_id ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ProductSubscriptionTerm_Increment_SubscriptionCount( l.subscription:subterm_id ) }">
		<MvIF EXPR = "{ l.subscription:custpc_id }">
			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 0>
	<MvELSEIF EXPR = "{ NOT Subscription_Insert_LowLevel( l.subscription ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ ProductSubscriptionTerm_Decrement_SubscriptionCount( l.subscription:subterm_id ) }">

		<MvIF EXPR = "{ l.subscription:custpc_id }">
			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Created( l.module, l.subscription ) }">
	</MvFOREACH>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_created', 1 ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Insert_LowLevel" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.subscription:id"	VALUE = "{ [ g.Module_Library_DB ].StoreKey_Generate( 'Subscriptions' ) }">

	<MvIF EXPR = "{ ISNULL l.subscription:authfails }">	<MvASSIGN NAME = "l.subscription:authfails" VALUE = 0> </MvIF>
	<MvIF EXPR = "{ ISNULL l.subscription:lastafail }">	<MvASSIGN NAME = "l.subscription:lastafail" VALUE = 0> </MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'Subscriptions
						  ( id, order_id, line_id, cust_id, custpc_id, product_id, subterm_id, addr_id, ship_id, ship_data, quantity, termrem, termproc,
						    firstdate, lastdate, nextdate, status, message, cncldate, tax, shipping, subtotal, total, authfails, lastafail )
						  VALUES
						  ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )' }"
			 FIELDS	= "l.subscription:id, l.subscription:order_id, l.subscription:line_id, l.subscription:cust_id, l.subscription:custpc_id,
					   l.subscription:product_id, l.subscription:subterm_id, l.subscription:addr_id, l.subscription:ship_id, l.subscription:ship_data,
					   l.subscription:quantity, l.subscription:termrem, l.subscription:termproc, l.subscription:firstdate, l.subscription:lastdate, l.subscription:nextdate,
					   l.subscription:status, l.subscription:message, l.subscription:cncldate, l.subscription:tax, l.subscription:shipping, l.subscription:subtotal,
					   l.subscription:total, l.subscription:authfails, l.subscription:lastafail">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00029', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionList_Insert" PARAMETERS = "subscriptions var, subscription_count" STANDARDOUTPUTLEVEL = "">
	<MvFOREACH ITERATOR = "l.subscription" ARRAY = "l.subscriptions" COUNT = "{ l.subscription_count }">
		<MvIF EXPR = "{ l.subscription:custpc_id }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.subscription:custpc_id ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ NOT ProductSubscriptionTerm_Increment_SubscriptionCount( l.subscription:subterm_id ) }">
			<MvIF EXPR = "{ l.subscription:custpc_id }">
				<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">
			</MvIF>

			<MvFUNCTIONRETURN VALUE = 0>
		<MvELSEIF EXPR = "{ NOT SubscriptionWithOptions_Insert_LowLevel( l.subscription ) }">
			<MvASSIGN NAME = "l.null" VALUE = "{ ProductSubscriptionTerm_Decrement_SubscriptionCount( l.subscription:subterm_id ) }">

			<MvIF EXPR = "{ l.subscription:custpc_id }">
				<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">
			</MvIF>

			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_created', l.subscription_count ) }">

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">
		<MvIF EXPR = "{ l.module:api_ver GE 9.065 }">
			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscriptions_Created( l.module, l.subscriptions, l.subscription_count ) }">
		<MvELSE>
			<MvFOREACH ITERATOR = "l.subscription" ARRAY = "l.subscriptions" COUNT = "{ l.subscription_count }">
				<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Created( l.module, l.subscription ) }">
			</MvFOREACH>
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionWithOptions_Insert" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.subscription:custpc_id }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.subscription:custpc_id ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ProductSubscriptionTerm_Increment_SubscriptionCount( l.subscription:subterm_id ) }">
		<MvIF EXPR = "{ l.subscription:custpc_id }">
			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 0>
	<MvELSEIF EXPR = "{ NOT SubscriptionWithOptions_Insert_LowLevel( l.subscription ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ ProductSubscriptionTerm_Increment_SubscriptionCount( l.subscription:subterm_id ) }">

		<MvIF EXPR = "{ l.subscription:custpc_id }">
			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Created( l.module, l.subscription ) }">
	</MvFOREACH>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_created', 1 ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionWithOptions_Insert_LowLevel" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Subscription_Insert_LowLevel( l.subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.option" ARRAY = "l.subscription:options" COUNT = "{ l.subscription:option_count }">
		<MvASSIGN NAME = "l.option:subscrp_id" VALUE = "{ l.subscription:id }">

		<MvIF EXPR = "{ NOT SubscriptionOption_Insert( l.option ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Subscription_Load_ID( l.subscription:id, l.existing_subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ l.subscription:custpc_id NE l.existing_subscription:custpc_id }">
		<MvIF EXPR = "{ l.existing_subscription:custpc_id }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.existing_subscription:custpc_id ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ l.subscription:custpc_id }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.subscription:custpc_id ) }">
				<MvIF EXPR = "{ l.existing_subscription:custpc_id }">
					<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.existing_subscription:custpc_id ) }">
				</MvIF>

				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ l.subscription:subterm_id NE l.existing_subscription:subterm_id }">
		<MvIF EXPR = "{ NOT ProductSubscriptionTerm_Decrement_SubscriptionCount( l.existing_subscription:subterm_id ) }">
			<MvIF EXPR = "{ l.subscription:custpc_id NE l.existing_subscription:custpc_id }">
				<MvIF EXPR = "{ l.existing_subscription:custpc_id }">	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.existing_subscription:custpc_id ) }">	</MvIF>
				<MvIF EXPR = "{ l.subscription:custpc_id }">			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">			</MvIF>
			</MvIF>

			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ NOT ProductSubscriptionTerm_Increment_SubscriptionCount( l.subscription:subterm_id ) }">
			<MvASSIGN NAME = "l.null" VALUE = "{ ProductSubscriptionTerm_Increment_SubscriptionCount( l.existing_subscription:subterm_id ) }">

			<MvIF EXPR = "{ l.subscription:custpc_id NE l.existing_subscription:custpc_id }">
				<MvIF EXPR = "{ l.existing_subscription:custpc_id }">	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.existing_subscription:custpc_id ) }">	</MvIF>
				<MvIF EXPR = "{ l.subscription:custpc_id }">			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">			</MvIF>
			</MvIF>

			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT Subscription_Update_LowLevel( l.subscription ) }">
		<MvIF EXPR = "{ l.subscription:custpc_id NE l.existing_subscription:custpc_id }">
			<MvIF EXPR = "{ l.existing_subscription:custpc_id }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.existing_subscription:custpc_id ) }">	</MvIF>
			<MvIF EXPR = "{ l.subscription:custpc_id }">				<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ l.subscription:subterm_id NE l.existing_subscription:subterm_id }">
			<MvASSIGN NAME = "l.null" VALUE = "{ ProductSubscriptionTerm_Increment_SubscriptionCount( l.existing_subscription:subterm_id ) }">
			<MvASSIGN NAME = "l.null" VALUE = "{ ProductSubscriptionTerm_Decrement_SubscriptionCount( l.subscription:subterm_id ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Changed( l.module, l.existing_subscription, l.subscription ) }">
	</MvFOREACH>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_updated', 1 ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_LowLevel" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
						  SET
							order_id	= ?,
							line_id		= ?,
							cust_id		= ?,
							custpc_id	= ?,
							product_id	= ?,
							subterm_id	= ?,
							addr_id		= ?,
							ship_id		= ?,
							ship_data	= ?,
							quantity	= ?,
							termrem		= ?,
							termproc	= ?,
							firstdate	= ?,
							lastdate	= ?,
							nextdate	= ?,
							status		= ?,
							message		= ?,
							cncldate	= ?,
							tax			= ?,
							shipping	= ?,
							subtotal	= ?,
							total		= ?,
							authfails	= ?,
							lastafail	= ?
						  WHERE
						  	id			= ?' }"
			 FIELDS	= "l.subscription:order_id, l.subscription:line_id, l.subscription:cust_id, l.subscription:custpc_id, l.subscription:product_id, l.subscription:subterm_id, l.subscription:addr_id,
			 		   l.subscription:ship_id,l.subscription:ship_data, l.subscription:quantity, l.subscription:termrem, l.subscription:termproc, l.subscription:firstdate, l.subscription:lastdate, l.subscription:nextdate,
					   l.subscription:status, l.subscription:message, l.subscription:cncldate, l.subscription:tax, l.subscription:shipping, l.subscription:subtotal, l.subscription:total, l.subscription:authfails, l.subscription:lastafail,
					   l.subscription:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00030', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionWithOptions_Update" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Subscription_Load_ID( l.subscription:id, l.existing_subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ l.subscription:custpc_id NE l.existing_subscription:custpc_id }">
		<MvIF EXPR = "{ l.existing_subscription:custpc_id }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.existing_subscription:custpc_id ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ l.subscription:custpc_id }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.subscription:custpc_id ) }">
				<MvIF EXPR = "{ l.existing_subscription:custpc_id }">
					<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.existing_subscription:custpc_id ) }">
				</MvIF>

				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ l.subscription:subterm_id NE l.existing_subscription:subterm_id }">
		<MvIF EXPR = "{ NOT ProductSubscriptionTerm_Decrement_SubscriptionCount( l.existing_subscription:subterm_id ) }">
			<MvIF EXPR = "{ l.subscription:custpc_id NE l.existing_subscription:custpc_id }">
				<MvIF EXPR = "{ l.existing_subscription:custpc_id }">	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.existing_subscription:custpc_id ) }">	</MvIF>
				<MvIF EXPR = "{ l.subscription:custpc_id }">			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">			</MvIF>
			</MvIF>

			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ NOT ProductSubscriptionTerm_Increment_SubscriptionCount( l.subscription:subterm_id ) }">
			<MvASSIGN NAME = "l.null" VALUE = "{ ProductSubscriptionTerm_Increment_SubscriptionCount( l.existing_subscription:subterm_id ) }">

			<MvIF EXPR = "{ l.subscription:custpc_id NE l.existing_subscription:custpc_id }">
				<MvIF EXPR = "{ l.existing_subscription:custpc_id }">	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.existing_subscription:custpc_id ) }">	</MvIF>
				<MvIF EXPR = "{ l.subscription:custpc_id }">			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">			</MvIF>
			</MvIF>

			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT SubscriptionWithOptions_Update_LowLevel( l.subscription ) }">
		<MvIF EXPR = "{ l.subscription:custpc_id NE l.existing_subscription:custpc_id }">
			<MvIF EXPR = "{ l.existing_subscription:custpc_id }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Increment_ReferenceCount( l.existing_subscription:custpc_id ) }">	</MvIF>
			<MvIF EXPR = "{ l.subscription:custpc_id }">				<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ l.subscription:subterm_id NE l.existing_subscription:subterm_id }">
			<MvASSIGN NAME = "l.null" VALUE = "{ ProductSubscriptionTerm_Increment_SubscriptionCount( l.existing_subscription:subterm_id ) }">
			<MvASSIGN NAME = "l.null" VALUE = "{ ProductSubscriptionTerm_Decrement_SubscriptionCount( l.subscription:subterm_id ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Changed( l.module, l.existing_subscription, l.subscription ) }">
	</MvFOREACH>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_updated', 1 ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionWithOptions_Update_LowLevel" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Subscription_Update_LowLevel( l.subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT SubscriptionOption_Delete_All_Subscription( l.subscription:id ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.option" ARRAY = "l.subscription:options" COUNT = "{ l.subscription:option_count }">
		<MvASSIGN NAME = "l.option:subscrp_id" VALUE = "{ l.subscription:id }">

		<MvIF EXPR = "{ NOT SubscriptionOption_Insert( l.option ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_Status_Active" PARAMETERS = "subscription var, message" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.subscription:status"	VALUE = "A">
	<MvASSIGN NAME = "l.subscription:message" 	VALUE = "{ l.message }">
	<MvASSIGN NAME = "l.subscription:cncldate"	VALUE = 0>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_updated', 1 ) }">

	<MvFUNCTIONRETURN VALUE = "{ Subscription_Update_Status( l.subscription ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_Status_Cancel" PARAMETERS = "subscription var, message" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.subscription:status"	VALUE = "C">
	<MvASSIGN NAME = "l.subscription:message" 	VALUE = "{ l.message }">
	<MvASSIGN NAME = "l.subscription:cncldate"	VALUE = "{ s.dyn_time_t }">

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_updated', 1 ) }">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_canceled', 1 ) }">

	<MvFUNCTIONRETURN VALUE = "{ Subscription_Update_Status( l.subscription ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_Status_Cancel_WithNotifications" PARAMETERS = "subscription var, message" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Subscription_Load_ID( l.subscription:id, l.existing_subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.subscription:status"	VALUE = "C">
	<MvASSIGN NAME = "l.subscription:message" 	VALUE = "{ l.message }">
	<MvASSIGN NAME = "l.subscription:cncldate"	VALUE = "{ s.dyn_time_t }">

	<MvIF EXPR = "{ NOT Subscription_Update_Status( l.subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Changed( l.module, l.existing_subscription, l.subscription ) }">
	</MvFOREACH>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_updated', 1 ) }">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_canceled', 1 ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_Status_Error" PARAMETERS = "subscription var, message" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.subscription:status"	VALUE = "E">
	<MvASSIGN NAME = "l.subscription:message" 	VALUE = "{ l.message }">

	<MvFUNCTIONRETURN VALUE = "{ Subscription_Update_Status( l.subscription ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_Status" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
						  SET
							status		= ?,
							message		= ?,
							cncldate	= ?
						  WHERE
						  	id		= ?' }"
			 FIELDS	= "l.subscription:status, l.subscription:message, l.subscription:cncldate,
					   l.subscription:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00066', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_Shipping" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
			 			  SET
			 				ship_id		= ?,
			 			  	ship_data	= ?
						  WHERE
						  	id			= ?' }"
			 FIELDS	= "l.subscription:ship_id, l.subscription:ship_data,
					   l.subscription:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00095', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_ProcessingInformation_LowLevel" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
						  SET
							termrem		= ?,
							termproc	= ?,
							firstdate	= ?,
							lastdate	= ?,
							nextdate	= ?,
							status		= ?,
							message		= ?,
							tax			= ?,
							shipping	= ?,
							subtotal	= ?,
							total		= ?
						  WHERE
						  	id			= ?' }"
			 FIELDS	= "l.subscription:termrem, l.subscription:termproc, l.subscription:firstdate, l.subscription:lastdate, l.subscription:nextdate, l.subscription:status, l.subscription:message, l.subscription:tax, l.subscription:shipping, l.subscription:subtotal, l.subscription:total,
					   l.subscription:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00067', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_AuthorizationFailureTracking" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
						  SET
							authfails	= ?,
							lastafail	= ?
						  WHERE
						  	id			= ?' }"
			 FIELDS	= "l.subscription:authfails, l.subscription:lastafail,
					   l.subscription:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00100', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_FirstDate" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Subscription_Load_ID( l.subscription:id, l.existing_subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT Subscription_Update_FirstDate_LowLevel( l.subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Changed( l.module, l.existing_subscription, l.subscription ) }">
	</MvFOREACH>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_updated', 1 ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_FirstDate_LowLevel" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
						  SET
							firstdate	= ?
						  WHERE
						  	id			= ?' }"
			 FIELDS	= "l.subscription:firstdate,
					   l.subscription:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00057', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_LastDate" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Subscription_Load_ID( l.subscription:id, l.existing_subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT Subscription_Update_LastDate_LowLevel( l.subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Changed( l.module, l.existing_subscription, l.subscription ) }">
	</MvFOREACH>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_updated', 1 ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_LastDate_LowLevel" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
						  SET
							lastdate	= ?
						  WHERE
						  	id			= ?' }"
			 FIELDS	= "l.subscription:lastdate,
					   l.subscription:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00031', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_NextDate" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Subscription_Load_ID( l.subscription:id, l.existing_subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT Subscription_Update_NextDate_LowLevel( l.subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Changed( l.module, l.existing_subscription, l.subscription ) }">
	</MvFOREACH>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_updated', 1 ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_NextDate_LowLevel" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
						  SET
							nextdate	= ?
						  WHERE
						  	id			= ?' }"
			 FIELDS	= "l.subscription:nextdate,
					   l.subscription:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00032', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_TermRemaining" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Subscription_Load_ID( l.subscription:id, l.existing_subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT Subscription_Update_TermRemaining_LowLevel( l.subscription ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Changed( l.module, l.existing_subscription, l.subscription ) }">
	</MvFOREACH>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_updated', 1 ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_TermRemaining_LowLevel" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
						  SET
							termrem		= ?
						  WHERE
						  	id			= ?' }"
			 FIELDS	= "l.subscription:termrem,
					   l.subscription:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00033', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_Totals" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
						  SET
							tax			= ?,
							shipping	= ?,
							subtotal	= ?,
							total		= ?
						  WHERE
						  	id			= ?' }"
			 FIELDS	= "l.subscription:tax, l.subscription:shipping, l.subscription:subtotal, l.subscription:total,
					   l.subscription:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00068', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_All_CustomerPaymentCard" PARAMETERS = "cust_id, old_custpc_id, new_custpc_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
						  SET
							custpc_id	= ?
						  WHERE
						  	cust_id		= ? AND
						  	custpc_id	= ?' }"
			 FIELDS	= "l.new_custpc_id,
			 		   l.cust_id, l.old_custpc_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00080', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_All_Shipping" PARAMETERS = "old_ship_id, old_ship_data, new_ship_id, new_ship_data" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
			 			  SET
			 				ship_id		= ?,
			 			  	ship_data	= ?
			 			  WHERE
			 				ship_id		= ? AND
			 				ship_data	= ?' }"
			 FIELDS = "l.new_ship_id, l.new_ship_data,
					   l.old_ship_id, l.old_ship_data">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00092', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Active_CustomerPaymentCard_Count" PARAMETERS = "cust_id, custpc_id, count var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Subscriptions"
				QUERY	= "{ 'SELECT
								COUNT( * ) AS total_count
							  FROM
								' $ g.Store_Table_Prefix $ 'Subscriptions
							  WHERE
								cust_id		= ? AND
								custpc_id	= ? AND
								status		<> \'C\'' }"
				FIELDS	= "l.cust_id, l.custpc_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00081', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Subscriptions.d.EOF }">	<MvASSIGN NAME = "l.count" VALUE = 0>
	<MvELSE>								<MvASSIGN NAME = "l.count" VALUE = "{ Subscriptions.d.total_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Update_All_CustomerAddress" PARAMETERS = "cust_id, old_addr_id, new_addr_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Subscriptions
						  SET
							addr_id	= ?
						  WHERE
						  	cust_id	= ? AND
						  	addr_id	= ?' }"
			 FIELDS	= "l.new_addr_id,
			 		   l.cust_id, l.old_addr_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00082', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Count_Active_CustomerAddress" PARAMETERS = "cust_id, addr_id, count var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Subscriptions"
				QUERY	= "{ 'SELECT
								COUNT( * ) AS total_count
							  FROM
								' $ g.Store_Table_Prefix $ 'Subscriptions
							  WHERE
								cust_id		= ? AND
								addr_id		= ? AND
								status		<> \'C\'' }"
				FIELDS	= "l.cust_id, l.addr_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00083', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Subscriptions.d.EOF }">	<MvASSIGN NAME = "l.count" VALUE = 0>
	<MvELSE>								<MvASSIGN NAME = "l.count" VALUE = "{ Subscriptions.d.total_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionList_Load_Order" PARAMETERS = "order_id, subscriptions var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Subscriptions"
				QUERY	= "{ 'SELECT
								*
							  FROM
								' $ g.Store_Table_Prefix $ 'Subscriptions
							  WHERE
								order_id = ?' }"
				FIELDS	= "l.order_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00060', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.subscription_count"	VALUE = 0>
	<MvWHILE EXPR = "{ NOT Subscriptions.d.EOF }">
		<MvEVAL EXPR = "{ Subscription_Read( l.subscriptions[ ++l.subscription_count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "Subscriptions" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-SUB-DTB-00061', l.subscription_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionList_Load_Product" PARAMETERS = "product_id, subscriptions var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Subscriptions"
				QUERY	= "{ 'SELECT
								*
							  FROM
								' $ g.Store_Table_Prefix $ 'Subscriptions
							  WHERE
								product_id = ?' }"
				FIELDS	= "l.product_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00034', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.subscription_count"	VALUE = 0>
	<MvWHILE EXPR = "{ NOT Subscriptions.d.EOF }">
		<MvEVAL EXPR = "{ Subscription_Read( l.subscriptions[ ++l.subscription_count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "Subscriptions" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-SUB-DTB-00035', l.subscription_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionList_Load_Pending" PARAMETERS = "dtstamp, subscriptions var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Subscriptions"
				QUERY	= "{ 'SELECT
								sub.*,
								pst.id			AS pst_id,
								pst.product_id	AS pst_prod_id,
								pst.frequency	AS pst_frequency,
								pst.term		AS pst_term,
								pst.descrip		AS pst_descrip,
								pst.n			AS pst_n,
								pst.fixed_dow	AS pst_fixed_dow,
								pst.fixed_dom	AS pst_fixed_dom,
								pst.sub_count	AS pst_sub_count,
								pst.disp_order	AS pst_disp_order
							  FROM
								' $ g.Store_Table_Prefix $ 'SubscriptionSettings sset,
								' $ g.Store_Table_Prefix $ 'Subscriptions sub
								LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms pst ON sub.subterm_id = pst.id
							  WHERE
							  	status		<> \'C\'				AND
								nextdate	<= ?					AND
								( pst.term = 0 OR sub.termrem > 0 )	AND
								( sub.authfails = 0 OR ( sub.lastafail + ( sset.afaildelay * 86400 ) ) < ? )
							  ORDER BY
								sub.cust_id, sub.addr_id, sub.ship_id, sub.ship_data, sub.custpc_id, sub.nextdate, sub.id' }"
				FIELDS	= "l.dtstamp, l.dtstamp">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00036', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.subscription_count"	VALUE = 0>

	<MvWHILE EXPR = "{ NOT Subscriptions.d.EOF }">
		<MvASSIGN NAME = "l.subscription"					VALUE = "">
		
		<MvEVAL EXPR = "{ Subscription_Read( l.subscription ) }">

		<MvASSIGN NAME = "l.subscription:term:id"			VALUE = "{ Subscriptions.d.pst_id }">
		<MvASSIGN NAME = "l.subscription:term:product_id"	VALUE = "{ Subscriptions.d.pst_prod_id }">
		<MvASSIGN NAME = "l.subscription:term:frequency"	VALUE = "{ Subscriptions.d.pst_frequency }">
		<MvASSIGN NAME = "l.subscription:term:term"			VALUE = "{ Subscriptions.d.pst_term }">
		<MvASSIGN NAME = "l.subscription:term:descrip"		VALUE = "{ Subscriptions.d.pst_descrip }">
		<MvASSIGN NAME = "l.subscription:term:n"			VALUE = "{ Subscriptions.d.pst_n }">
		<MvASSIGN NAME = "l.subscription:term:fixed_dow"	VALUE = "{ Subscriptions.d.pst_fixed_dow }">
		<MvASSIGN NAME = "l.subscription:term:fixed_dom"	VALUE = "{ Subscriptions.d.pst_fixed_dom }">
		<MvASSIGN NAME = "l.subscription:term:sub_count"	VALUE = "{ Subscriptions.d.pst_sub_count }">
		<MvASSIGN NAME = "l.subscription:term:disp_order"	VALUE = "{ Subscriptions.d.pst_disp_order }">

		<MvIF EXPR = "{ [ g.Module_Library_DB ].Product_Load_ID_WithRuntimeInventory( l.subscription:product_id, l.subscription:product ) }">
			<MvASSIGN NAME = "l.subscription:option_count"		VALUE = "{ SubscriptionOptionList_Load_Subscription( l.subscription:id, l.subscription:options ) }">
			<MvASSIGN NAME = "l.subscription:attribute_count"	VALUE = "{ [ g.Feature_Filename_SUB_UT ].SubscriptionOptions_BuildAttributes( l.subscription:options, l.subscription:option_count, l.subscription:attributes ) }">

			<MvIF EXPR = "{ [ g.Feature_Filename_SUB_UT ].Subscription_Validate_Attributes_DetermineVariant( l.subscription, l.subscription:product, l.subscription:attributes, l.subscription:attribute_count, l.subscription:basketoptions, l.subscription:basketoption_count ) }">
				<MvIF EXPR = "{ [ g.Module_Feature_INV_RT ].Inventory_Adjust_VariantPricing( l.subscription:product, l.subscription:variant_id, l.subscription:attr_price_override ) }">
					<MvASSIGN NAME = "l.subscription_count" VALUE = "{ miva_array_insert_var( l.subscriptions, l.subscription, -1 ) }">
				</MvIF>
			</MvIF>
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "Subscriptions" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-SUB-DTB-00037', l.subscription_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionGroupList_Load_Pending" PARAMETERS = "dtstamp, subscription_groups var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.last_cust_id"	VALUE = -1>
	<MvASSIGN NAME = "l.last_addr_id"	VALUE = -1>
	<MvASSIGN NAME = "l.last_ship_id"	VALUE = -1>
	<MvASSIGN NAME = "l.last_custpc_id"	VALUE = -1>
	<MvASSIGN NAME = "l.last_ship_data"	VALUE = "">

	<MvASSIGN NAME = "l.subscription_group_count"	VALUE = 0>
	<MvASSIGN NAME = "l.subscription_groups"		VALUE = "">

	<MvFOREACH ITERATOR = "l.subscription" ARRAY = "l.subscriptions" COUNT = "{ SubscriptionList_Load_Pending( l.dtstamp, l.subscriptions ) }">
		<MvIF EXPR = "{ ( l.subscription:cust_id NE l.last_cust_id ) OR
						( l.subscription:addr_id NE l.last_addr_id ) OR
						( l.subscription:ship_id NE l.last_ship_id ) OR
						( l.subscription:custpc_id NE l.last_custpc_id ) OR
						( l.subscription:ship_data NE l.last_ship_data ) }">
			<MvASSIGN NAME = "l.subscription_group_count"	VALUE = "{ l.subscription_group_count + 1 }">
			<MvASSIGN NAME = "l.last_cust_id"				VALUE = "{ l.subscription:cust_id }">
			<MvASSIGN NAME = "l.last_addr_id"				VALUE = "{ l.subscription:addr_id }">
			<MvASSIGN NAME = "l.last_ship_id"				VALUE = "{ l.subscription:ship_id }">
			<MvASSIGN NAME = "l.last_custpc_id"				VALUE = "{ l.subscription:custpc_id }">
			<MvASSIGN NAME = "l.last_ship_data"				VALUE = "{ l.subscription:ship_data }">
		</MvIF>

		<MvREFERENCEARRAY NAME = "l.subscription_group"		VARIABLE = "l.subscription_groups">
			<MvDIMENSION INDEX = "{ l.subscription_group_count }">
		</MvREFERENCEARRAY>

		<MvASSIGN NAME = "l.subscription_group:subscription_count" VALUE = "{ miva_array_insert( l.subscription_group:subscriptions, l.subscription, -1 ) }">
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = "{ l.subscription_group_count }">
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Load_ID" PARAMETERS = "id, subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Subscriptions"
				QUERY	= "{ 'SELECT
								*
							  FROM ' $ 
							  	g.Store_Table_Prefix $ 'Subscriptions
							  WHERE
							  	id = ?' }"
				FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00038', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Subscriptions.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-SUB-DTB-00039' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ Subscription_Read( l.subscription ) }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Delete_All_Product" PARAMETERS = "product_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.module_count"	VALUE = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">

	<MvCOMMENT>
	|
	| Delete SubscriptionOptions
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ g.Native_DBAPI EQ 'postgresql' }">
		<MvQUERY NAME 	= "Merchant"
				 QUERY 	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'SubscriptionOptions so
							  USING
							  	' $ g.Store_Table_Prefix $ 'Subscriptions s WHERE s.product_id = ? AND so.subscrp_id = s.id' }"
				 FIELDS = "l.product_id">
		<MvIF EXPR = "{ g.MvQUERY_Error }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00085', g.MvQUERY_Error ) }">
		</MvIF>
	<MvELSE>
		<MvQUERY NAME	= "Merchant"
				 QUERY	= "{ 'DELETE so.* FROM ' $ g.Store_Table_Prefix $ 'SubscriptionOptions so, ' $ g.Store_Table_Prefix $ 'Subscriptions s WHERE s.product_id = ? AND so.subscrp_id = s.id' }"
				 FIELDS	= "l.product_id">
		<MvIF EXPR = "{ g.MvQUERY_Error }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00069', g.MvQUERY_Error ) }">
		</MvIF>
	</MvIF>

	<MvCOMMENT>
	|
	| Decrement payment card and subscription term reference counts and notify modules
	|
	</MvCOMMENT>

	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Subscriptions"
				QUERY	= "{ 'SELECT
								*
							  FROM
								' $ g.Store_Table_Prefix $ 'Subscriptions
							  WHERE
								product_id = ?' }"
				FIELDS	= "l.product_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00071', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvWHILE EXPR = "{ NOT Subscriptions.d.EOF }">
		<MvEVAL EXPR = "{ Subscription_Read( l.subscription ) }">

		<MvIF EXPR = "{ l.subscription:custpc_id }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">
				<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ NOT ProductSubscriptionTerm_Decrement_SubscriptionCount( l.subscription:subterm_id ) }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ l.module_count }">
			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Deleted( l.module, l.subscription ) }">
		</MvFOREACH>

		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_updated', 1 ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_canceled', 1 ) }">

		<MvSKIP NAME = "Merchant" VIEW = "Subscriptions" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">

	<MvCOMMENT>
	|
	| Delete subscriptions
	|
	</MvCOMMENT>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'Subscriptions WHERE product_id = ?' }"
			 FIELDS	= "l.product_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00072', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Delete_All_Customer" PARAMETERS = "cust_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.module_count"	VALUE = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">

	<MvCOMMENT>
	|
	| Delete SubscriptionOptions
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ g.Native_DBAPI EQ 'postgresql' }">
		<MvQUERY NAME 	= "Merchant"
				 QUERY 	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'SubscriptionOptions so
							  USING
							  	' $ g.Store_Table_Prefix $ 'Subscriptions s WHERE s.cust_id = ? AND so.subscrp_id = s.id' }"
				 FIELDS = "l.cust_id">
		<MvIF EXPR = "{ g.MvQUERY_Error }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00086', g.MvQUERY_Error ) }">
		</MvIF>
	<MvELSE>
		<MvQUERY NAME	= "Merchant"
				 QUERY	= "{ 'DELETE so.* FROM ' $ g.Store_Table_Prefix $ 'SubscriptionOptions so, ' $ g.Store_Table_Prefix $ 'Subscriptions s WHERE s.cust_id = ? AND so.subscrp_id = s.id' }"
				 FIELDS	= "l.cust_id">
		<MvIF EXPR = "{ g.MvQUERY_Error }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00073', g.MvQUERY_Error ) }">
		</MvIF>
	</MvIF>

	<MvCOMMENT>
	|
	| Decrement payment card and subscription term reference counts and notify modules
	|
	</MvCOMMENT>

	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Subscriptions"
				QUERY	= "{ 'SELECT
								*
							  FROM
								' $ g.Store_Table_Prefix $ 'Subscriptions
							  WHERE
								cust_id = ?' }"
				FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00075', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvWHILE EXPR = "{ NOT Subscriptions.d.EOF }">
		<MvEVAL EXPR = "{ Subscription_Read( l.subscription ) }">

		<MvIF EXPR = "{ l.subscription:custpc_id }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">
				<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ NOT ProductSubscriptionTerm_Decrement_SubscriptionCount( l.subscription:subterm_id ) }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ l.module_count }">
			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Deleted( l.module, l.subscription ) }">
		</MvFOREACH>

		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_updated', 1 ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_canceled', 1 ) }">

		<MvSKIP NAME = "Merchant" VIEW = "Subscriptions" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">

	<MvCOMMENT>
	|
	| Delete subscriptions
	|
	</MvCOMMENT>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'Subscriptions WHERE cust_id = ?' }"
			 FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00076', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Delete" PARAMETERS = "subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.subscription:custpc_id }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_Pay_DB ].CustomerPaymentCard_Decrement_ReferenceCount( l.subscription:custpc_id ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ProductSubscriptionTerm_Decrement_SubscriptionCount( l.subscription:subterm_id ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	<MvELSEIF EXPR = "{ NOT SubscriptionOption_Delete_All_Subscription( l.subscription:id ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	<MvELSEIF EXPR = "{ NOT Subscription_Delete_LowLevel( l.subscription:id ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_subscript', l.modules ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Subscription_Deleted( l.module, l.subscription ) }">
	</MvFOREACH>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_updated', 1 ) }">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'subscription_canceled', 1 ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Subscription_Delete_LowLevel" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'Subscriptions
						  WHERE
							id = ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00040', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Runtime_SubscriptionList_Load_Offset_Customer" PARAMETERS = "cust_id, offset, max, sort, nextoffset var, subscriptions var" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ Runtime_SubscriptionList_Build_Query( l.query ) }">
	<MvEVAL EXPR = "{ Runtime_SubscriptionList_Build_Query_Customer( l.query, l.cust_id ) }">
	<MvEVAL EXPR = "{ Runtime_SubscriptionList_Build_Query_ORDER_BY( l.query, l.sort ) }">

	<MvFUNCTIONRETURN VALUE = "{ Runtime_SubscriptionList_Load_Query( l.query, l.offset, l.max, l.nextoffset, l.total_count, l.subscriptions ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Runtime_Subscription_Count_Customer" PARAMETERS = "cust_id, count var" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ Runtime_SubscriptionList_Build_Query( l.query ) }">
	<MvEVAL EXPR = "{ Runtime_SubscriptionList_Build_Query_Customer( l.query, l.cust_id ) }">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].SQL_Query_Count( l.query, l.count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Runtime_SubscriptionList_Build_Query" PARAMETERS = "query var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.query" VALUE = "">

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT( l.query, 'sub.*,

																		  pst.frequency			AS productsubscriptionterm_frequency,
																		  pst.term				AS productsubscriptionterm_term,
																		  pst.descrip			AS productsubscriptionterm_descrip,
																		  pst.n					AS productsubscriptionterm_n,
																		  pst.fixed_dow			AS productsubscriptionterm_fixed_dow,
																		  pst.fixed_dom			AS productsubscriptionterm_fixed_dom,
																		  pst.sub_count			AS productsubscriptionterm_sub_count,

																		  pss.product_id		AS productsubscriptionsettings_product_id,
																		  pss.enabled			AS productsubscriptionsettings_enabled,
																		  pss.mandatory			AS productsubscriptionsettings_mandatory,
																		  pss.can_cancel		AS productsubscriptionsettings_can_cancel,
																		  pss.cncl_min			AS productsubscriptionsettings_cncl_min,
																		  pss.can_qty			AS productsubscriptionsettings_can_qty,
																		  pss.qty_min			AS productsubscriptionsettings_qty_min,
																		  pss.can_term			AS productsubscriptionsettings_can_term,
																		  pss.term_min			AS productsubscriptionsettings_term_min,
																		  pss.can_date			AS productsubscriptionsettings_can_date,
																		  pss.date_min			AS productsubscriptionsettings_date_min,

																		  prod.active 			AS product_active,
																		  prod.agrpcount 		AS product_agrpcount,
																		  prod.cancat_id 		AS product_cancat_id,
																		  cat.code	 			AS product_cancat_code,
																		  prod.catcount 		AS product_catcount,
																		  prod.code 			AS product_code,
																		  prod.cost 			AS product_cost,
																		  prod.descrip 			AS product_descrip,
																		  prod.disp_order 		AS product_disp_order,
																		  prod.image 			AS product_image,
																		  prod.name 			AS product_name,
																		  prod.page_code		AS product_page_code,
																		  prod.page_title 		AS product_page_title,
																		  prod.pgrpcount 		AS product_pgrpcount,
																		  prod.price 			AS product_price,
																		  prod.sku 				AS product_sku,
																		  prod.taxable 			AS product_taxable,
																		  prod.thumbnail 		AS product_thumbnail,
																		  prod.weight 			AS product_weight,
																		  prod.dt_created		AS product_dt_created,
																		  prod.dt_updated		AS product_dt_updated,
																		  ipc.inventory			AS ipc_inventory,
																		  ips.active			AS ips_active,
																		  ips.in_long			AS ips_in_long,
																		  ips.in_short			AS ips_in_short,
																		  ips.low_level			AS ips_low_level,
																		  ips.low_long			AS ips_low_long,
																		  ips.low_lvl_d			AS ips_low_lvl_d,
																		  ips.low_short			AS ips_low_short,
																		  ips.low_track			AS ips_low_track,
																		  ips.out_level			AS ips_out_level,
																		  ips.out_long			AS ips_out_long,
																		  ips.out_lvl_d			AS ips_out_lvl_d,
																		  ips.out_short			AS ips_out_short,
																		  ips.out_track			AS ips_out_track,
																		  iset.active			AS iset_active,
																		  iset.in_long			AS iset_in_long,
																		  iset.in_short			AS iset_in_short,
																		  iset.low_level		AS iset_low_level,
																		  iset.low_long			AS iset_low_long,
																		  iset.low_short		AS iset_low_short,
																		  iset.low_track		AS iset_low_track,
																		  iset.out_level		AS iset_out_level,
																		  iset.out_long			AS iset_out_long,
																		  iset.out_short		AS iset_out_short,
																		  iset.out_track		AS iset_out_track,

																		  cpc.id				AS paymentcard_id,
																		  cpc.cust_id			AS paymentcard_cust_id,
																		  cpc.fname				AS paymentcard_fname,
																		  cpc.lname				AS paymentcard_lname,
																		  cpc.exp_month			AS paymentcard_exp_month,
																		  cpc.exp_year			AS paymentcard_exp_year,
																		  cpc.lastfour			AS paymentcard_lastfour,
																		  cpc.addr1				AS paymentcard_addr1,
																		  cpc.addr2				AS paymentcard_addr2,
																		  cpc.city				AS paymentcard_city,
																		  cpc.state				AS paymentcard_state,
																		  cpc.zip				AS paymentcard_zip,
																		  cpc.cntry				AS paymentcard_cntry,
																		  cpc.lastused			AS paymentcard_lastused,
																		  cpc.token				AS paymentcard_token,
																		  cpc.type_id			AS paymentcard_type_id,
																		  pct.type				AS paymentcard_type,
																		  pct.mod_code			AS paymentcard_mod_code,
																		  pct.meth_code			AS paymentcard_meth_code,

																		  addr.descrip			AS address_descrip,
																		  addr.fname			AS address_fname,
																		  addr.lname			AS address_lname,
																		  addr.email			AS address_email,
																		  addr.comp				AS address_comp,
																		  addr.phone			AS address_phone,
																		  addr.fax				AS address_fax,
																		  addr.addr				AS address_addr,
																		  addr.addr2			AS address_addr2,
																		  addr.city				AS address_city,
																		  addr.state			AS address_state,
																		  addr.zip				AS address_zip,
																		  addr.cntry			AS address_cntry,
																		  addr.resdntl			AS address_resdntl' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT_NULL_INTEGER( l.query, 'pbv.page_id', 'product_page_id' ) }">

	<MvCOMMENT>
	|
	| FROM
	|
	</MvCOMMENT>

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.query, g.Store_Table_Prefix $ 'Subscriptions', 		'sub' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.query, g.Store_Table_Prefix $ 'Products', 			'prod' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.query, g.Store_Table_Prefix $ 'InventorySettings', 	'iset' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'sub',	g.Store_Table_Prefix $ 'ProductSubscriptionSettings', 	'pss', 	'sub.product_id = pss.product_id',	'' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'sub',	g.Store_Table_Prefix $ 'ProductSubscriptionTerms', 		'pst', 	'sub.subterm_id = pst.id',			'' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'sub',	g.Store_Table_Prefix $ 'CustomerPaymentCards', 			'cpc', 	'sub.custpc_id = cpc.id',			'' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'sub',	g.Store_Table_Prefix $ 'PaymentCardTypes', 				'pct', 	'cpc.type_id = pct.id',				'' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'sub',	g.Store_Table_Prefix $ 'CustomerAddresses', 			'addr', 'sub.addr_id = addr.id',			'' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'prod',	g.Store_Table_Prefix $ 'PageBranchVersions',			'pbv',	'prod.page_code <> \'\'	AND pbv.branch_id = ? AND pbv.head = 1 AND ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'pbv.code' ) $ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'prod.page_code' ), [ g.Module_Library_DB ].SQL_Query_Field( [ g.Module_Feature_TUI_MGR ].TemplateManager_Working_Branch_ID() ) ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'prod',	g.Store_Table_Prefix $ 'Categories', 					'cat', 	'prod.cancat_id = cat.id',			'' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'prod',	g.Store_Table_Prefix $ 'InventoryProductSettings', 		'ips', 	'ips.product_id = prod.id',			'' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'prod',	g.Store_Table_Prefix $ 'InventoryProductCounts', 		'ipc', 	'ipc.product_id = prod.id',			'' ) }">

	<MvCOMMENT>
	|
	| WHERE
	|
	</MvCOMMENT>

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, 'sub.product_id	= prod.id', '' ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Runtime_SubscriptionList_Build_Query_ORDER_BY" PARAMETERS = "query var, sort" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.sort EQ 'id_desc' }">				<MvASSIGN NAME = "l.sort_col" VALUE = "sub.id">				<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'name_asc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "prod.name">			<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'name_desc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "prod.name">			<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'code_asc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "prod.code">			<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'code_desc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "prod.code">			<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'total_asc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "sub.total">			<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'total_desc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "sub.total">			<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'firstdate_asc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "sub.firstdate">		<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'firstdate_desc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "sub.firstdate">		<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'lastdate_asc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "sub.lastdate">		<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'lastdate_desc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "sub.lastdate">		<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'nextdate_asc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "sub.nextdate">		<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'nextdate_desc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "sub.nextdate">		<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'payment_asc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "sub.custpc_id">		<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'payment_desc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "sub.custpc_id">		<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'shipping_asc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "sub.ship_data">		<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'shipping_desc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "sub.ship_data">		<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'termrem_asc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "sub.termrem">		<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'termrem_desc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "sub.termrem">		<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'termproc_asc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "sub.termproc">		<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'termproc_desc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "sub.termproc">		<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSE>											<MvASSIGN NAME = "l.sort_col" VALUE = "sub.id">				<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_ORDER_BY( l.query, l.sort_col, l.sort_dir ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Runtime_SubscriptionList_Build_Query_Customer" PARAMETERS = "query var, cust_id" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, 'sub.cust_id = ?', [ g.Module_Library_DB ].SQL_Query_Field( l.cust_id ) ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Runtime_SubscriptionList_Build_Query_Active" PARAMETERS = "query var" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, 'sub.status <> \'C\'', '' ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Runtime_SubscriptionList_Build_Query_ActiveWithin" PARAMETERS = "query var, cncldate" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, '( sub.status <> \'C\' OR sub.cncldate >= ? )', [ g.Module_Library_DB ].SQL_Query_Field( l.cncldate ) ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Runtime_SubscriptionList_Load_Query" PARAMETERS = "query var, offset, max, nextoffset var, total_count var, subscriptions var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.max EQ 0 }">	<MvASSIGN NAME = "l.limit" VALUE = 0>
	<MvELSE>						<MvASSIGN NAME = "l.limit" VALUE = "{ l.max + 1 }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].SQL_Query_Count( l.query, l.total_count ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.sql" VALUE = "{ [ g.Module_Library_DB ].SQL_Query_Build( l.query, l.fields ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Products',
																			 l.sql, l.fields,
																			 l.offset, l.limit ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00062', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.subscription_count" VALUE = 0>
	<MvWHILE EXPR = "{ ( NOT Products.d.EOF ) AND ( ( l.max EQ 0 ) OR ( l.subscription_count LT l.max ) ) }">
		<MvREFERENCEARRAY NAME = "l.subscription"										VARIABLE = "l.subscriptions">
			<MvDIMENSION INDEX = "{ ++l.subscription_count }">
		</MvREFERENCEARRAY>

		<MvASSIGN NAME = "l.subscription:id"											VALUE = "{ Products.d.id }">
		<MvASSIGN NAME = "l.subscription:order_id"										VALUE = "{ Products.d.order_id }">
		<MvASSIGN NAME = "l.subscription:line_id"										VALUE = "{ Products.d.line_id }">
		<MvASSIGN NAME = "l.subscription:cust_id"										VALUE = "{ Products.d.cust_id }">
		<MvASSIGN NAME = "l.subscription:custpc_id"										VALUE = "{ Products.d.custpc_id }">
		<MvASSIGN NAME = "l.subscription:product_id"									VALUE = "{ Products.d.product_id }">
		<MvASSIGN NAME = "l.subscription:subterm_id"									VALUE = "{ Products.d.subterm_id }">
		<MvASSIGN NAME = "l.subscription:addr_id"										VALUE = "{ Products.d.addr_id }">
		<MvASSIGN NAME = "l.subscription:ship_id"										VALUE = "{ Products.d.ship_id }">
		<MvASSIGN NAME = "l.subscription:ship_data"										VALUE = "{ Products.d.ship_data }">
		<MvASSIGN NAME = "l.subscription:quantity"										VALUE = "{ Products.d.quantity }">
		<MvASSIGN NAME = "l.subscription:termrem"										VALUE = "{ Products.d.termrem }">
		<MvASSIGN NAME = "l.subscription:termproc"										VALUE = "{ Products.d.termproc }">
		<MvASSIGN NAME = "l.subscription:firstdate"										VALUE = "{ Products.d.firstdate }">
		<MvASSIGN NAME = "l.subscription:lastdate"										VALUE = "{ Products.d.lastdate }">
		<MvASSIGN NAME = "l.subscription:nextdate"										VALUE = "{ Products.d.nextdate }">
		<MvASSIGN NAME = "l.subscription:status"										VALUE = "{ Products.d.status }">
		<MvASSIGN NAME = "l.subscription:message"										VALUE = "{ Products.d.message }">
		<MvASSIGN NAME = "l.subscription:cncldate"										VALUE = "{ Products.d.cncldate }">
		<MvASSIGN NAME = "l.subscription:tax"											VALUE = "{ Products.d.tax }">
		<MvASSIGN NAME = "l.subscription:shipping"										VALUE = "{ Products.d.shipping }">
		<MvASSIGN NAME = "l.subscription:subtotal"										VALUE = "{ Products.d.subtotal }">
		<MvASSIGN NAME = "l.subscription:total"											VALUE = "{ Products.d.total }">
		<MvASSIGN NAME = "l.subscription:authfails"										VALUE = "{ Products.d.authfails }">
		<MvASSIGN NAME = "l.subscription:lastafail"										VALUE = "{ Products.d.lastafail }">

		<MvASSIGN NAME = "l.subscription:productsubscriptionterm:id"					VALUE = "{ Products.d.subterm_id }">
		<MvASSIGN NAME = "l.subscription:productsubscriptionterm:product_id"			VALUE = "{ Products.d.product_id }">
		<MvASSIGN NAME = "l.subscription:productsubscriptionterm:frequency"				VALUE = "{ Products.d.productsubscriptionterm_frequency }">
		<MvASSIGN NAME = "l.subscription:productsubscriptionterm:term"					VALUE = "{ Products.d.productsubscriptionterm_term }">
		<MvASSIGN NAME = "l.subscription:productsubscriptionterm:descrip"				VALUE = "{ Products.d.productsubscriptionterm_descrip }">
		<MvASSIGN NAME = "l.subscription:productsubscriptionterm:n"						VALUE = "{ Products.d.productsubscriptionterm_n }">
		<MvASSIGN NAME = "l.subscription:productsubscriptionterm:fixed_dow"				VALUE = "{ Products.d.productsubscriptionterm_fixed_dow }">
		<MvASSIGN NAME = "l.subscription:productsubscriptionterm:fixed_dom"				VALUE = "{ Products.d.productsubscriptionterm_fixed_dom }">
		<MvASSIGN NAME = "l.subscription:productsubscriptionterm:sub_count"				VALUE = "{ Products.d.productsubscriptionterm_sub_count }">

		<MvIF EXPR = "{ ISNULL Products.d.productsubscriptionsettings_product_id }">
			<MvEVAL EXPR = "{ ProductSubscriptionSettings_Default( Products.d.product_id, l.subscription:productsubscriptionsettings ) }">
		<MvELSE>
			<MvASSIGN NAME = "l.subscription:productsubscriptionsettings:product_id"	VALUE = "{ Products.d.product_id }">
			<MvASSIGN NAME = "l.subscription:productsubscriptionsettings:enabled"		VALUE = "{ Products.d.productsubscriptionsettings_enabled }">
			<MvASSIGN NAME = "l.subscription:productsubscriptionsettings:mandatory"		VALUE = "{ Products.d.productsubscriptionsettings_mandatory }">
			<MvASSIGN NAME = "l.subscription:productsubscriptionsettings:can_cancel"	VALUE = "{ Products.d.productsubscriptionsettings_can_cancel }">
			<MvASSIGN NAME = "l.subscription:productsubscriptionsettings:cncl_min"		VALUE = "{ Products.d.productsubscriptionsettings_cncl_min }">
			<MvASSIGN NAME = "l.subscription:productsubscriptionsettings:can_qty"		VALUE = "{ Products.d.productsubscriptionsettings_can_qty }">
			<MvASSIGN NAME = "l.subscription:productsubscriptionsettings:qty_min"		VALUE = "{ Products.d.productsubscriptionsettings_qty_min }">
			<MvASSIGN NAME = "l.subscription:productsubscriptionsettings:can_term"		VALUE = "{ Products.d.productsubscriptionsettings_can_term }">
			<MvASSIGN NAME = "l.subscription:productsubscriptionsettings:term_min"		VALUE = "{ Products.d.productsubscriptionsettings_term_min }">
			<MvASSIGN NAME = "l.subscription:productsubscriptionsettings:can_date"		VALUE = "{ Products.d.productsubscriptionsettings_can_date }">
			<MvASSIGN NAME = "l.subscription:productsubscriptionsettings:date_min"		VALUE = "{ Products.d.productsubscriptionsettings_date_min }">
		</MvIF>

		<MvASSIGN NAME = "l.subscription:product:id"									VALUE = "{ Products.d.product_id }">
		<MvASSIGN NAME = "l.subscription:product:catcount"								VALUE = "{ Products.d.product_catcount }">
		<MvASSIGN NAME = "l.subscription:product:cancat_id"								VALUE = "{ Products.d.product_cancat_id }">
		<MvASSIGN NAME = "l.subscription:product:agrpcount"								VALUE = "{ Products.d.product_agrpcount }">
		<MvASSIGN NAME = "l.subscription:product:pgrpcount"								VALUE = "{ Products.d.product_pgrpcount }">
		<MvASSIGN NAME = "l.subscription:product:disp_order"							VALUE = "{ Products.d.product_disp_order }">
		<MvASSIGN NAME = "l.subscription:product:page_id"								VALUE = "{ Products.d.product_page_id }">
		<MvASSIGN NAME = "l.subscription:product:page_code"								VALUE = "{ Products.d.product_page_code }">
		<MvASSIGN NAME = "l.subscription:product:code"									VALUE = "{ Products.d.product_code }">
		<MvASSIGN NAME = "l.subscription:product:sku"									VALUE = "{ Products.d.product_sku }">
		<MvASSIGN NAME = "l.subscription:product:name"									VALUE = "{ Products.d.product_name }">
		<MvASSIGN NAME = "l.subscription:product:page_title"							VALUE = "{ Products.d.product_page_title }">
		<MvASSIGN NAME = "l.subscription:product:thumbnail"								VALUE = "{ Products.d.product_thumbnail }">
		<MvASSIGN NAME = "l.subscription:product:image"									VALUE = "{ Products.d.product_image }">
		<MvASSIGN NAME = "l.subscription:product:price"									VALUE = "{ Products.d.product_price }">
		<MvASSIGN NAME = "l.subscription:product:cost"									VALUE = "{ Products.d.product_cost }">
		<MvASSIGN NAME = "l.subscription:product:descrip"								VALUE = "{ Products.d.product_descrip }">
		<MvASSIGN NAME = "l.subscription:product:weight"								VALUE = "{ Products.d.product_weight }">
		<MvASSIGN NAME = "l.subscription:product:taxable"								VALUE = "{ Products.d.product_taxable }">
		<MvASSIGN NAME = "l.subscription:product:active"								VALUE = "{ Products.d.product_active }">
		<MvASSIGN NAME = "l.subscription:product:dt_created"							VALUE = "{ Products.d.product_dt_created }">
		<MvASSIGN NAME = "l.subscription:product:dt_updated"							VALUE = "{ Products.d.product_dt_updated }">

		<MvEVAL EXPR = "{ [ g.Module_Feature_INV_RT ].Runtime_Product_InventoryFields_Read( l.subscription:product ) }">

		<MvASSIGN NAME = "l.subscription:paymentcard:id"								VALUE = "{ Products.d.paymentcard_id }">
		<MvASSIGN NAME = "l.subscription:paymentcard:cust_id"							VALUE = "{ Products.d.paymentcard_cust_id }">
		<MvASSIGN NAME = "l.subscription:paymentcard:fname"								VALUE = "{ Products.d.paymentcard_fname }">
		<MvASSIGN NAME = "l.subscription:paymentcard:lname"								VALUE = "{ Products.d.paymentcard_lname }">
		<MvASSIGN NAME = "l.subscription:paymentcard:exp_month"							VALUE = "{ Products.d.paymentcard_exp_month }">
		<MvASSIGN NAME = "l.subscription:paymentcard:exp_year"							VALUE = "{ Products.d.paymentcard_exp_year }">
		<MvASSIGN NAME = "l.subscription:paymentcard:lastfour"							VALUE = "{ Products.d.paymentcard_lastfour }">
		<MvASSIGN NAME = "l.subscription:paymentcard:addr1"								VALUE = "{ Products.d.paymentcard_addr1 }">
		<MvASSIGN NAME = "l.subscription:paymentcard:addr2"								VALUE = "{ Products.d.paymentcard_addr2 }">
		<MvASSIGN NAME = "l.subscription:paymentcard:city"								VALUE = "{ Products.d.paymentcard_city }">
		<MvASSIGN NAME = "l.subscription:paymentcard:state"								VALUE = "{ Products.d.paymentcard_state }">
		<MvASSIGN NAME = "l.subscription:paymentcard:zip"								VALUE = "{ Products.d.paymentcard_zip }">
		<MvASSIGN NAME = "l.subscription:paymentcard:cntry"								VALUE = "{ Products.d.paymentcard_cntry }">
		<MvASSIGN NAME = "l.subscription:paymentcard:lastused"							VALUE = "{ Products.d.paymentcard_lastused }">
		<MvASSIGN NAME = "l.subscription:paymentcard:token"								VALUE = "{ Products.d.paymentcard_token }">
		<MvASSIGN NAME = "l.subscription:paymentcard:type_id"							VALUE = "{ Products.d.paymentcard_type_id }">
		<MvASSIGN NAME = "l.subscription:paymentcard:type" 								VALUE = "{ Products.d.paymentcard_type }">
		<MvASSIGN NAME = "l.subscription:paymentcard:mod_code" 							VALUE = "{ Products.d.paymentcard_mod_code }">
		<MvASSIGN NAME = "l.subscription:paymentcard:meth_code" 						VALUE = "{ Products.d.paymentcard_meth_code }">

		<MvASSIGN NAME = "l.subscription:address:descrip" 								VALUE = "{ Products.d.address_descrip }">
		<MvASSIGN NAME = "l.subscription:address:fname" 								VALUE = "{ Products.d.address_fname }">
		<MvASSIGN NAME = "l.subscription:address:lname" 								VALUE = "{ Products.d.address_lname }">
		<MvASSIGN NAME = "l.subscription:address:email" 								VALUE = "{ Products.d.address_email }">
		<MvASSIGN NAME = "l.subscription:address:comp" 									VALUE = "{ Products.d.address_comp }">
		<MvASSIGN NAME = "l.subscription:address:phone" 								VALUE = "{ Products.d.address_phone }">
		<MvASSIGN NAME = "l.subscription:address:fax" 									VALUE = "{ Products.d.address_fax }">

		<MvIF EXPR = "{ ISNULL Products.d.address_addr2 }">
			<MvASSIGN NAME = "l.subscription:address:addr"								VALUE = "{ Products.d.address_addr }">
		<MvELSE>
			<MvASSIGN NAME = "l.subscription:address:addr"								VALUE = "{ Products.d.address_addr $ ' ' $ Products.d.address_addr2 }">
		</MvIF>

		<MvASSIGN NAME = "l.subscription:address:addr1"									VALUE = "{ Products.d.address_addr }">
		<MvASSIGN NAME = "l.subscription:address:addr2"									VALUE = "{ Products.d.address_addr2 }">
		<MvASSIGN NAME = "l.subscription:address:city" 									VALUE = "{ Products.d.address_city }">
		<MvASSIGN NAME = "l.subscription:address:state" 								VALUE = "{ Products.d.address_state }">
		<MvASSIGN NAME = "l.subscription:address:zip" 									VALUE = "{ Products.d.address_zip }">
		<MvASSIGN NAME = "l.subscription:address:cntry" 								VALUE = "{ Products.d.address_cntry }">
		<MvASSIGN NAME = "l.subscription:address:resdntl" 								VALUE = "{ Products.d.address_resdntl }">

		<MvSKIP NAME = "Merchant" VIEW = "Products" ROWS = 1>
	</MvWHILE>
	
	<MvIF EXPR = "{ Products.d.EOF }">
		<MvASSIGN NAME = "l.nextoffset"	VALUE = 0>
	<MvELSE>
		<MvASSIGN NAME = "l.nextoffset"	VALUE = "{ l.offset + l.subscription_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Products">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-SUB-DTB-00063', l.subscription_count ) }">
</MvFUNCTION>

<MvCOMMENT>
|
| sNN_SubscriptionOptions
|
</MvCOMMENT>

<MvFUNCTION NAME = "SubscriptionOption_Read" PARAMETERS = "subscriptionoption var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.subscriptionoption:subscrp_id"		VALUE = "{ SubscriptionOptions.d.subscrp_id }">
	<MvASSIGN NAME = "l.subscriptionoption:templ_code"		VALUE = "{ SubscriptionOptions.d.templ_code }">
	<MvASSIGN NAME = "l.subscriptionoption:attr_code"		VALUE = "{ SubscriptionOptions.d.attr_code }">
	<MvASSIGN NAME = "l.subscriptionoption:value"			VALUE = "{ SubscriptionOptions.d.value }">
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionOption_Insert" PARAMETERS = "subscriptionoption var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'SubscriptionOptions
					      ( subscrp_id, templ_code, attr_code, value )
						  VALUES
						  ( ?, ?, ?, ? )' }"
			 FIELDS	= "l.subscriptionoption:subscrp_id, l.subscriptionoption:templ_code, l.subscriptionoption:attr_code, l.subscriptionoption:value">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00041', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionOption_Delete_All_Subscription" PARAMETERS = "subscrp_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'SubscriptionOptions WHERE subscrp_id = ?' }"
			 FIELDS	= "l.subscrp_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00042', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionOptionList_Load_Subscription" PARAMETERS = "subscrp_id, subscriptionoptions var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "SubscriptionOptions"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'SubscriptionOptions WHERE subscrp_id = ? ORDER BY templ_code, attr_code' }"
				FIELDS	= "l.subscrp_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00043', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.subscriptionoption_count"	VALUE = 0>
	<MvWHILE EXPR = "{ NOT SubscriptionOptions.d.EOF }">
		<MvEVAL EXPR = "{ SubscriptionOption_Read( l.subscriptionoptions[ ++l.subscriptionoption_count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "SubscriptionOptions" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "SubscriptionOptions">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-SUB-DTB-00044', l.subscriptionoption_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionOption_Copy_Order" PARAMETERS = "order var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "OrderOptions"
				QUERY	= "{ 'SELECT
								att.code	AS productattribute_code,
								ata.code	AS attmpat_code,

								oi.subscrp_id,
								oo.attr_code,
								oo.opt_code,
								oo.data,
								oo.data_long
							  FROM ' $
								g.Store_Table_Prefix $ 'OrderOptions oo
								LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'OrderItems oi ON oi.order_id = oo.order_id AND oi.line_id = oo.line_id
								LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'AttributeTemplateAttrs ata ON ata.id = oo.attmpat_id
								LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'Attributes att ON oo.attr_id = att.id
							  WHERE
								oo.order_id		= ? AND
								oi.subscrp_id	<> 0' }"
				FIELDS	= "l.order:id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00045', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvWHILE EXPR = "{ NOT OrderOptions.d.EOF }">
		<MvASSIGN NAME = "l.subscriptionoption:subscrp_id"		VALUE = "{ OrderOptions.d.subscrp_id }">
		<MvASSIGN NAME = "l.subscriptionoption:value"			VALUE = "{ OrderOptions.d.opt_code $ OrderOptions.d.data $ OrderOptions.d.data_long }">

		<MvIF EXPR = "{ NOT ISNULL OrderOptions.d.attmpat_code }">
			<MvASSIGN NAME = "l.subscriptionoption:templ_code"	VALUE = "{ OrderOptions.d.attmpat_code }">
			<MvASSIGN NAME = "l.subscriptionoption:attr_code"	VALUE = "{ OrderOptions.d.productattribute_code }">
		<MvELSE>
			<MvASSIGN NAME = "l.subscriptionoption:templ_code"	VALUE = "">
			<MvASSIGN NAME = "l.subscriptionoption:attr_code"	VALUE = "{ OrderOptions.d.attr_code }">
		</MvIF>

		<MvIF EXPR = "{ NOT SubscriptionOption_Insert( l.subscriptionoption ) }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "OrderOptions">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "OrderOptions" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "OrderOptions">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionOptionList_Load_Basket_Line" PARAMETERS = "basket_id, line_id, subscriptionoptions var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ [ g.Module_Library_DB ].Basket_ID_Is_Provisional( l.basket_id ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-SUB-DTB-00084', 0 ) }">
	</MvIF>

	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "BasketOptions"
				QUERY	= "{ 'SELECT
								att.code	AS productattribute_code,
								ata.code	AS attmpat_code,

								bo.attr_code,
								bo.opt_code,
								bo.data,
								bo.data_long
							  FROM ' $
								g.Store_Table_Prefix $ 'BasketOptions bo
								LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'Attributes att ON bo.attr_id = att.id
								LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'AttributeTemplateAttrs ata ON ata.id = bo.attmpat_id
							  WHERE
							  	bo.basket_id	= ? AND
								bo.line_id		= ?
							  ORDER BY
								att.disp_order, ata.disporder' }"
				FIELDS	= "l.basket_id, l.line_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-SUB-DTB-00077', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.subscriptionoption_count" VALUE = 0>

	<MvWHILE EXPR = "{ NOT BasketOptions.d.EOF }">
		<MvASSIGN NAME = "l.subscriptionoption_count"																VALUE = "{ l.subscriptionoption_count + 1 }">
		<MvASSIGN NAME = "l.subscriptionoptions" INDEX = "{ l.subscriptionoption_count }" MEMBER = "subscrp_id"		VALUE = 0>
		<MvASSIGN NAME = "l.subscriptionoptions" INDEX = "{ l.subscriptionoption_count }" MEMBER = "value"			VALUE = "{ BasketOptions.d.opt_code $ BasketOptions.d.data $ BasketOptions.d.data_long }">

		<MvIF EXPR = "{ NOT ISNULL BasketOptions.d.attmpat_code }">
			<MvASSIGN NAME = "l.subscriptionoptions" INDEX = "{ l.subscriptionoption_count }" MEMBER = "templ_code"	VALUE = "{ BasketOptions.d.attmpat_code }">
			<MvASSIGN NAME = "l.subscriptionoptions" INDEX = "{ l.subscriptionoption_count }" MEMBER = "attr_code"	VALUE = "{ BasketOptions.d.productattribute_code }">
		<MvELSE>
			<MvASSIGN NAME = "l.subscriptionoptions" INDEX = "{ l.subscriptionoption_count }" MEMBER = "templ_code"	VALUE = "">
			<MvASSIGN NAME = "l.subscriptionoptions" INDEX = "{ l.subscriptionoption_count }" MEMBER = "attr_code"	VALUE = "{ BasketOptions.d.attr_code }">
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "BasketOptions" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "BasketOptions">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-SUB-DTB-00078', l.subscriptionoption_count ) }">
</MvFUNCTION>

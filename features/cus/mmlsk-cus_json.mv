<MIVA STANDARDOUTPUTLEVEL = "">

<MvCOMMENT>
|
| Miva Merchant
|
| This file and the source codes contained herein are the property of
| Miva, Inc.  Use of this file is restricted to the specific terms and
| conditions in the License Agreement associated with this file.  Distribution
| of this file or portions of this file for uses not covered by the License
| Agreement is not allowed without a written agreement signed by an officer of
| Miva, Inc.
|
| Copyright 1998-2025 Miva, Inc.  All rights reserved.
| http://www.miva.com
|
| Prefix         : MER-CUS-JSN-
| Next Error Code: 82   
|
</MvCOMMENT>

<MvFUNCTION NAME = "JSON_Customer" PARAMETERS = "customer var" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvASSIGN NAME = "l.formatted_credit"		VALUE = "{ [ g.Module_Root $ g.Store:currncy_mod:module ].CurrencyModule_AddFormatting( g.Store:currncy_mod, l.customer:credit ) }">
	<MvASSIGN NAME = "l.formatted_order_avg"	VALUE = "{ [ g.Module_Root $ g.Store:currncy_mod:module ].CurrencyModule_AddFormatting( g.Store:currncy_mod, l.customer:order_avg ) }">
	<MvASSIGN NAME = "l.formatted_order_tot"	VALUE = "{ [ g.Module_Root $ g.Store:currncy_mod:module ].CurrencyModule_AddFormatting( g.Store:currncy_mod, l.customer:order_tot ) }">

	"id":					<MvEVAL EXPR = "{ int( l.customer:id ) }">,
	"account_id":			<MvEVAL EXPR = "{ int( l.customer:account_id ) }">,
	"login":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:login ) }">",
	"pw_email":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:pw_email ) }">",
	"ship_id":				<MvEVAL EXPR = "{ int( l.customer:ship_id ) }">,
	"ship_res":				<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.customer:ship_res ) }">,
	"ship_fname":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:ship_fname ) }">",
	"ship_lname":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:ship_lname ) }">",
	"ship_email":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:ship_email ) }">",
	"ship_comp":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:ship_comp ) }">",
	"ship_phone":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:ship_phone ) }">",
	"ship_fax":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:ship_fax ) }">",
	"ship_addr1":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:ship_addr1 ) }">",
	"ship_addr2":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:ship_addr2 ) }">",
	"ship_city":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:ship_city ) }">",
	"ship_state":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:ship_state ) }">",
	"ship_zip":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:ship_zip ) }">",
	"ship_cntry":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:ship_cntry ) }">",
	"bill_id":				<MvEVAL EXPR = "{ int( l.customer:bill_id ) }">,
	"bill_fname":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:bill_fname ) }">",
	"bill_lname":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:bill_lname ) }">",
	"bill_email":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:bill_email ) }">",
	"bill_comp":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:bill_comp ) }">",
	"bill_phone":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:bill_phone ) }">",
	"bill_fax":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:bill_fax ) }">",
	"bill_addr1":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:bill_addr1 ) }">",
	"bill_addr2":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:bill_addr2 ) }">",
	"bill_city":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:bill_city ) }">",
	"bill_state":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:bill_state ) }">",
	"bill_zip":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:bill_zip ) }">",
	"bill_cntry":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customer:bill_cntry ) }">",
	"tax_exempt":			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.customer:tax_exempt ) }">,
	"order_cnt":			<MvEVAL EXPR = "{ int( l.customer:order_cnt ) }">,
	"order_avg":			<MvEVAL EXPR = "{ l.customer:order_avg ROUND 2 }">,
	"formatted_order_avg":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.formatted_order_avg ) }">",
	"order_tot":			<MvEVAL EXPR = "{ l.customer:order_tot ROUND 2 }">,
	"formatted_order_tot":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.formatted_order_tot ) }">",
	"note_count":			<MvEVAL EXPR = "{ int( l.customer:note_count ) }">,
	"dt_created":			<MvEVAL EXPR = "{ int( l.customer:dt_created ) }">,
	"dt_updated":			<MvEVAL EXPR = "{ int( l.customer:dt_updated ) }">,
	"dt_login":				<MvEVAL EXPR = "{ int( l.customer:dt_login ) }">,
	"dt_pwchg":				<MvEVAL EXPR = "{ int( l.customer:dt_pwchg ) }">,
	"credit":				<MvEVAL EXPR = "{ l.customer:credit ROUND 2 }">,
	"formatted_credit":		"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.formatted_credit ) }">"
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_CustomFields_Initialize" PARAMETERS = "filterlist var, customfield_state var" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Filter_Structify( l.filterlist ) }">

	<MvASSIGN NAME = "l.customfield_state"				VALUE = "">

	<MvCOMMENT>
	|
	| Build Custom Field Displayable data from MMBatchList "ondemandcolumns"
	|
	</MvCOMMENT>

	<MvFOREACH ITERATOR = "l.filter" ARRAY = "l.filterlist">
		<MvIF EXPR = "{ l.filter:name EQ 'ondemandcolumns' }">
			<MvFOREACH ITERATOR = "l.column_code" ARRAY = "l.filter:value">
				<MvIF EXPR = "{ ( 'CustomField_Values:' IN l.column_code ) NE 1 }">
					<MvFOREACHCONTINUE>
				</MvIF>

				<MvASSIGN NAME = "l.module_code"		VALUE = "{ gettoken( l.column_code, ':', 2 ) }">
				<MvASSIGN NAME = "l.customfield_code"	VALUE = "{ gettoken( l.column_code, ':', 3 ) }">

				<MvREFERENCEARRAY NAME = "l.displayable" VARIABLE = "l.displayable_custom_fields">
					<MvMEMBER NAME = "{ l.module_code }">
					<MvMEMBER NAME = "{ l.customfield_code }">
				</MvREFERENCEARRAY>

				<MvASSIGN NAME = "l.displayable" VALUE = 1>
			</MvFOREACH>
		</MvIF>
	</MvFOREACH>

	<MvCOMMENT>
	|
	| Load the custom field modules and their associated fields
	|
	| :fields[n]
	|	:module				- reference to cached modules
	|	:code				- custom field code
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.field_count"					VALUE = 0>

	<MvFOREACH INDEX = "l.module_pos" ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'fields_cust', l.modules ) }">
		<MvASSIGN NAME = "l.null"						VALUE = "{ [ g.Module_Library_DB ].Module_Load_Features( l.module ) }">
		<MvASSIGN NAME = "l.module_fields"				VALUE = "">

		<MvFOREACH ITERATOR = "l.module_field" ARRAY = "l.module_fields" COUNT = "{ [ g.Module_Root $ l.module:module ].Module_Customer_Fields( l.module, l.module_fields ) }">
			<MvASSIGN NAME = "l.field_count"			VALUE = "{ l.field_count + 1 }">
			<MvREFERENCEARRAY NAME = "l.field" VARIABLE = "l.fields">
				<MvDIMENSION INDEX = "{ l.field_count }">
			</MvREFERENCEARRAY>

			<MvREFERENCEARRAY NAME = "l.field:module" VARIABLE = "l.modules">
				<MvDIMENSION INDEX = "{ l.module_pos }">
			</MvREFERENCEARRAY>

			<MvASSIGN NAME = "l.field:code"				VALUE = "{ l.module_field:code }">
			<MvASSIGN NAME = "l.field:type"				VALUE = "{ l.module_field:type }">

			<MvREFERENCEARRAY NAME = "l.displayable" VARIABLE = "l.displayable_custom_fields">
				<MvMEMBER NAME = "{ l.field:module:code }">
				<MvMEMBER NAME = "{ l.field:code }">
			</MvREFERENCEARRAY>

			<MvIF EXPR = "{ NOT l.displayable }">
				<MvIF EXPR = "{ miva_member_exists( l.displayable_custom_fields, '*' ) }">
					<MvASSIGN NAME = "l.displayable"		VALUE = 1>
				<MvELSE>
					<MvREFERENCEARRAY NAME = "l.module_displayable" VARIABLE = "l.displayable_custom_fields">
						<MvMEMBER NAME = "{ l.field:module:code }">
					</MvREFERENCEARRAY>

					<MvIF EXPR = "{ miva_member_exists( l.module_displayable, '*' ) }">
						<MvASSIGN NAME = "l.displayable"	VALUE = 1>
					</MvIF>
				</MvIF>
			</MvIF>

			<MvIF EXPR = "{ l.displayable AND l.field:module:api_ver GE 9.07 }">
				<MvEVAL EXPR = "{ [ g.Module_Root $ l.field:module:module ].Module_Customer_Field_Capabilities( l.field:module, l.field:code, l.field:capabilities ) }">
			</MvIF>
		</MvFOREACH>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_CustomFields_Initialize( l.fields, l.field_count, l.displayable_custom_fields, 'fields_cust_map', l.customfield_state ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_CustomFields" PARAMETERS = "customfield_state var, cust_id" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "{ JSON_Customer_CustomFields_With_View( l.customfield_state, l.cust_id, '' ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_CustomFields_With_View" PARAMETERS = "customfield_state var, cust_id, view" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "{ JSON_Customer_CustomFields_With_Query( l.null, l.customfield_state, l.cust_id, l.view ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_CustomFields_With_Query" PARAMETERS = "query var, customfield_state var, cust_id, view" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ l.customfield_state:plan_count EQ 0 }">
		<MvFUNCTIONRETURN>
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_Data_Reference( l.query, 'Customer_CustomFields', l.ref ) }">

	<MvASSIGN NAME = "l.last_module_id" VALUE = "">

	,"CustomField_Values":
	{

	<MvFOREACH ITERATOR = "l.plan" ARRAY = "l.customfield_state:plan" COUNT = "{ l.customfield_state:plan_count }">
		<MvIF EXPR = "{ l.plan:module:id NE l.last_module_id }">
			<MvIF EXPR = "{ NOT ISNULL l.last_module_id }">
				},
			</MvIF>

			"<MvEVAL EXPR = "{ l.plan:module:encoded_code }">":
			{

			<MvASSIGN NAME = "l.last_module_id"		VALUE = "{ l.plan:module:id }">
			<MvASSIGN NAME = "l.output_field_count"	VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ l.plan:field_single }">
			<MvREFERENCEARRAY NAME = "l.queried" VARIABLE = "l.ref:data:queried">
				<MvMEMBER NAME = "{ l.plan:module:code }">
				<MvMEMBER NAME = "{ l.plan:field_code }">
			</MvREFERENCEARRAY>

			<MvIF EXPR = "{ NOT ISNULL l.view AND l.queried AND l.plan:capabilities:query }">	<MvASSIGN NAME = "l.value" VALUE = "{ [ g.Module_Root $ l.plan:module:module ].Module_Customer_Field_Query_Value( l.plan:module, l.view, l.plan:field_code ) }">
			<MvELSE>																			<MvASSIGN NAME = "l.value" VALUE = "{ [ g.Module_Root $ l.plan:module:module ].Module_Customer_Field_Value( l.plan:module, l.cust_id, l.plan:field_code ) }">
			</MvIF>

			<MvIF EXPR = "{ l.output_field_count++ GT 0 }">
				,
			</MvIF>

			"<MvEVAL EXPR = "{ l.plan:encoded_field_code }">": <MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Output_CustomField_Value( l.plan:base_type, l.plan:type_data, l.value ) }">
		<MvELSEIF EXPR = "{ l.plan:field_array }">
			<MvASSIGN NAME = "l.values" VALUE = "">

			<MvIF EXPR = "{ l.output_field_count++ GT 0 }">
				,
			</MvIF>

			<MvIF EXPR = "{ l.plan:module:api_ver LT 9.08 }">
				<MvASSIGN NAME = "l.value" VALUE = "{ [ g.Module_Root $ l.plan:module:module ].Module_Customer_Field_Value( l.plan:module, l.cust_id, l.plan:field_code ) }">

				"<MvEVAL EXPR = "{ l.plan:encoded_field_code }">": <MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Output_CustomField_Value( l.plan:base_type, l.plan:type_data, l.value ) }">
			<MvELSE>
				"<MvEVAL EXPR = "{ l.plan:encoded_field_code }">":
				[
				<MvFOREACH ITERATOR = "l.value" ARRAY = "l.values" INDEX = "l.pos" COUNT = "{ [ g.Module_Root $ l.plan:module:module ].Module_Customer_Field_Value_Array( l.plan:module, l.cust_id, l.plan:field_code, l.values ) }">
					<MvIF EXPR = "{ l.pos GT 1 }">
						,	
					</MvIF>

					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Output_CustomField_Value( l.plan:base_type, l.plan:type_data, l.value ) }">
				</MvFOREACH>
				]
			</MvIF>
		<MvELSEIF EXPR = "{ NOT ISNULL l.plan:field_map }">
			<MvASSIGN NAME = "l.mapped"			VALUE = 0>

			<MvFOREACH ITERATOR = "l.field" ARRAY = "l.plan:fields" COUNT = "{ l.plan:field_count }">
				<MvASSIGN NAME = "l.loaded"		VALUE = 0>

				<MvREFERENCEARRAY NAME = "l.queried" VARIABLE = "l.ref:data:queried">
					<MvMEMBER NAME = "{ l.plan:module:code }">
					<MvMEMBER NAME = "{ l.field:code }">
				</MvREFERENCEARRAY>

				<MvIF EXPR = "{ NOT ISNULL l.view AND l.queried AND l.field:capabilities:query }">
					<MvASSIGN NAME = "l.loaded" VALUE = 1>
					<MvASSIGN NAME = "l.value"	VALUE = "{ [ g.Module_Root $ l.plan:module:module ].Module_Customer_Field_Query_Value( l.plan:module, l.view, l.field:code ) }">
				<MvELSEIF EXPR = "{ NOT l.mapped }">
					<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Root $ l.plan:module:module ].Module_Customer_Fields_Mapped( l.plan:module, l.cust_id, l.plan:field_map, l.module_output ) }">
					<MvASSIGN NAME = "l.mapped" VALUE = 1>
				</MvIF>

				<MvIF EXPR = "{ NOT l.loaded }">
					<MvREFERENCEARRAY NAME = "l.value" VARIABLE = "l.module_output">
						<MvMEMBER NAME = "{ l.field:code }">
					</MvREFERENCEARRAY>
				</MvIF>

				<MvIF EXPR = "{ l.output_field_count++ GT 0 }">
					,
				</MvIF>

				"<MvEVAL EXPR = "{ l.field:encoded_code }">": <MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Output_CustomField_Value( l.field:base_type, l.field:type_data, l.value ) }">
			</MvFOREACH>
		</MvIF>
	</MvFOREACH>

	<MvIF EXPR = "{ l.last_module_id }">
		}
	</MvIF>

	}
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_Loaders_Present" PARAMETERS = "" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Exists( 'Customer_ID' ) }">			<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Exists( 'Edit_Customer' ) }">		<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Exists( 'Customer_Login' ) }">		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 0>
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_Load" PARAMETERS = "customer var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Retrieve_Integer( 'Customer_ID', l.customer_id ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Load_ID( l.customer_id, l.customer ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00001', 'Customer not found' ) }">
		</MvIF>
	<MvELSEIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Retrieve( 'Edit_Customer', l.customer_login ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Load_Login( l.customer_login, l.customer ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00002', 'Customer not found' ) }">
		</MvIF>
	<MvELSEIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Retrieve( 'Customer_Login', l.customer_login ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Load_Login( l.customer_login, l.customer ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00056', 'Customer not found' ) }">
		</MvIF>
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00057', 'Unable to load customer: One of Customer_ID, Edit_Customer or Customer_Login must be specified' ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_Load_ID" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">					<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">		<MvFUNCTIONRETURN>	</MvIF>

	<MvASSIGN NAME = "g.Customer_ID"	VALUE = "{ int( g.Customer_ID ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Load_ID( g.Customer_ID, l.customer ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00014', 'Unable to load customer' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		<MvEVAL EXPR = "{ JSON_Customer( l.customer ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_Load_Login" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN>	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Load_Login( g.Customer_Login, l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		<MvEVAL EXPR = "{ JSON_Customer( l.customer ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerLoginList_Load_Match" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN>	</MvIF>

	<MvASSIGN NAME = "g.Count"	VALUE = "{ int( g.Count ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers',
																	  'SELECT
																		*
																	   FROM
																		' $ g.Store_Table_Prefix $ 'Customers
																	   WHERE
																		' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( 'login' ) $ ' LIKE ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( '?' ) $ ' OR
																		' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( 'ship_email' ) $ ' LIKE ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( '?' ) $ ' OR
																		' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( 'ship_fname' ) $ ' LIKE ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( '?' ) $ ' OR
																		' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( 'ship_lname' ) $ ' LIKE ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( '?' ) $ ' OR
																		' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( 'bill_email' ) $ ' LIKE ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( '?' ) $ ' OR
																		' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( 'bill_fname' ) $ ' LIKE ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( '?' ) $ ' OR
																		' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( 'bill_lname' ) $ ' LIKE ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( '?' ),
																	  'g.Search, g.Search, g.Search, g.Search, g.Search, g.Search, g.Search',
																	  0, g.Count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00003', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customer_count"					VALUE = 0>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">	
	[
	<MvWHILE EXPR = "{ ( l.customer_count LT g.Count ) AND ( NOT Customers.d.EOF ) }">
		<MvEVAL EXPR = "{ [ g.Feature_Filename_CUS_DB ].Customer_Read( l.customer ) }">

		<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_Start( l.customer_count ) }">
			<MvEVAL EXPR = "{ JSON_Customer( l.customer ) }">
		<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_End() }">

		<MvSKIP NAME = "Merchant" VIEW = "Customers"	ROWS = 1>
	</MvWHILE>
	]
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerCustomFieldList_Load" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">					<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">		<MvFUNCTIONRETURN>	</MvIF>

	<MvASSIGN NAME = "l.count" VALUE = 0>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	[
		<MvFOREACH ITERATOR = "l.customfield" ARRAY = "l.customfields" COUNT = "{ [ g.Module_Library_Utilities ].CustomerCustomFieldList_Load( l.customfields ) }">
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_Start( l.count ) }">
				"code":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customfield:code ) }">",
				"name":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customfield:name ) }">",
				"type":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customfield:type ) }">",
				"public":		<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.customfield:public ) }">,
				"readonly":		<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.customfield:readonly ) }">,
				"searchable":	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.customfield:capabilities:search ) }">,
				"sortable":		<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.customfield:capabilities:orderby ) }">,
				"module":
				{
					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Module( l.customfield:module ) }">
				}
				<MvIF EXPR = "{ l.customfield:type EQ 'choice' }">
					,
					"choices":
					[
						<MvFOREACH ITERATOR = "l.choice" ARRAY = "l.customfield:choices" INDEX = "l.choice_pos">
							<MvIF EXPR = "{ l.choice_pos GT 1 }">
								,
							</MvIF>

							"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.choice ) }">"
						</MvFOREACH>
					]
				</MvIF>
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_End() }">
		</MvFOREACH>
	]
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BaseCustomerList_Filters" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.available_filters" VALUE = "">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'cust.id',			'id' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.login',		'login' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.pw_email',	'pw_email' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_BOOL(		l.available_filters, 'cust.ship_res',	'ship_res' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.ship_fname',	'ship_fname' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.ship_lname',	'ship_lname' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.ship_email',	'ship_email' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.ship_comp',	'ship_comp' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.ship_phone',	'ship_phone' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.ship_fax',	'ship_fax' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.ship_addr',	'ship_addr1' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.ship_addr2',	'ship_addr2' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.ship_city',	'ship_city' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.ship_state',	'ship_state' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.ship_zip',	'ship_zip' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.ship_cntry',	'ship_cntry' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.bill_fname',	'bill_fname' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.bill_lname',	'bill_lname' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.bill_email',	'bill_email' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.bill_comp',	'bill_comp' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.bill_phone',	'bill_phone' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.bill_fax',	'bill_fax' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.bill_addr',	'bill_addr1' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.bill_addr2',	'bill_addr2' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.bill_city',	'bill_city' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.bill_state',	'bill_state' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.bill_zip',	'bill_zip' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cust.bill_cntry',	'bill_cntry' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'cust.credit',		'credit' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'cust.note_count',	'note_count' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'cust.dt_created',	'dt_created' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'cust.dt_updated',	'dt_updated' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'cust.dt_login',	'dt_login' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'cust.dt_pwchg',	'dt_pwchg' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_BOOL(		l.available_filters, 'cust.tax_exempt',	'tax_exempt' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'cust.order_cnt',	'order_cnt' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'cust.order_avg',	'order_avg' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'cust.order_tot',	'order_tot' ) }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NULL_CHAR(	l.available_filters, 'ba.title',		'business_title' ) }">

	<MvFUNCTIONRETURN VALUE = "{ l.available_filters }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BaseCustomerList_OrderBy" PARAMETERS = "" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "id:cust.id,login:cust.login,pw_email:cust.pw_email,
							   ship_name:cust.ship_fname;cust.ship_lname,ship_fname:cust.ship_fname,ship_lname:cust.ship_lname,ship_email:cust.ship_email,ship_comp:cust.ship_comp,ship_phone:cust.ship_phone,
							   ship_fax:cust.ship_fax,ship_addr1:cust.ship_addr,ship_addr2:cust.ship_addr2,ship_city:cust.ship_city,ship_state:cust.ship_state,ship_zip:cust.ship_zip,ship_cntry:cust.ship_cntry,ship_res:cust.ship_res,
							   bill_name:cust.bill_fname;cust.bill_lname,bill_fname:cust.bill_fname,bill_lname:cust.bill_lname,bill_email:cust.bill_email,bill_comp:cust.bill_comp,bill_phone:cust.bill_phone,
							   bill_fax:cust.bill_fax,bill_addr1:cust.bill_addr,bill_addr2:cust.bill_addr2,bill_city:cust.bill_city,bill_state:cust.bill_state,bill_zip:cust.bill_zip,bill_cntry:cust.bill_cntry,
							   business_title:ba.title:null_char,note_count:cust.note_count,dt_created:cust.dt_created,dt_updated:cust.dt_updated,dt_login:cust.dt_login,dt_pwchg:cust.dt_pwchg,cust.credit,
							   tax_exempt:cust.tax_exempt,order_cnt:cust.order_cnt,order_avg:cust.order_avg,order_tot:cust.order_tot">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerList_Load_Query" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">					<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvASSIGN NAME = "l.filter"				VALUE = "">
	<MvASSIGN NAME = "l.sort"				VALUE = "">
	<MvASSIGN NAME = "l.offset"				VALUE = 0>
	<MvASSIGN NAME = "l.count"				VALUE = 0>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Filter(	'o', 'Filter',	l.filter )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Sort',	l.sort )	OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Offset',	l.offset )	OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Count',	l.count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>
	
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT( l.search_query, 'cust.*' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT_NULL_CHAR( l.search_query, 'ba.title', 'business_title' ) }">

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.search_query, g.Store_Table_Prefix $ 'Customers', 'cust' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.search_query, 'cust', g.Store_Table_Prefix $ 'BusinessAccounts', 'ba', 'cust.account_id = ba.id', '' ) }">

	<MvASSIGN NAME = "l.filter_columns" 	VALUE = "{ JSON_BaseCustomerList_Filters() }">
	<MvASSIGN NAME = "l.orderby_columns"	VALUE = "{ JSON_BaseCustomerList_OrderBy() }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Filter_Callback_With_CustomFields( l.search_query, l.filter, l.filter_columns, g.Module_Feature_CUS_JSON, '', '', 'JSON_Customer_CustomFields_Query_Filter', l.null ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].SQL_Query_Count( l.search_query, l.total_count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Query_Callback_With_CustomFields( l.search_query, l.filter, g.Module_Feature_CUS_JSON, 'JSON_Customer_CustomFields_Query' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_OrderBy_Callback_With_CustomFields( l.search_query, l.sort, l.orderby_columns, 'cust.login', g.Module_Feature_CUS_JSON, 'JSON_Customer_CustomFields_Query_OrderBy' ) }">

	<MvASSIGN NAME = "l.search_sql"			VALUE = "{ [ g.Module_Library_DB ].SQL_Query_Build( l.search_query, l.search_fields ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers', l.search_sql, l.search_fields, l.offset, l.count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00007', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customer_count"		VALUE = 0>

	<MvEVAL EXPR = "{ JSON_Customer_CustomFields_Initialize( l.filter, l.customfield_state ) }">	
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"total_count":	<MvEVAL EXPR = "{ int( l.total_count ) }">,
		"start_offset":	<MvEVAL EXPR = "{ int( l.offset ) }">,
		"data":
		[
		<MvWHILE EXPR = "{ ( NOT Customers.d.EOF ) AND ( ( l.count EQ 0 ) OR ( l.customer_count LT l.count ) ) }">
			<MvEVAL EXPR = "{ [ g.Feature_Filename_CUS_DB ].Customer_Read( l.customer ) }">

			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_Start( l.customer_count ) }">
				<MvEVAL EXPR = "{ JSON_Customer( l.customer ) }">
				<MvEVAL EXPR = "{ JSON_Customer_CustomFields_With_Query( l.search_query, l.customfield_state, Customers.d.id, 'Customers' ) }">,
				"business_title": "<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( Customers.d.business_title ) }">"
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_End() }">

			<MvSKIP NAME = "Merchant" VIEW = "Customers" ROWS = 1>
		</MvWHILE>
		]
	}
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_CustomFields_Query" PARAMETERS = "query var, module var, code" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.module EQ '*' }">
		<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'fields_cust', l.modules ) }">
			<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Library_DB ].Module_Load_Features( l.module ) }">

			<MvIF EXPR = "{ NOT JSON_Customer_CustomFields_Query( l.query, l.module, '*' ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvFOREACH>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ ( l.module:api_ver LT 9.07 ) OR ( NOT l.module:feature_hash:fields_cust ) }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ l.code EQ '*' }">
		<MvFOREACH ITERATOR = "l.module_field" ARRAY = "l.module_fields" COUNT = "{ [ g.Module_Root $ l.module:module ].Module_Customer_Fields( l.module, l.module_fields ) }">
			<MvIF EXPR = "{ NOT JSON_Customer_CustomFields_Query( l.query, l.module, l.module_field:code ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvFOREACH>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_Data_Reference( l.query, 'Customer_CustomFields', l.ref ) }">

	<MvIF EXPR = "{ [ g.Module_Library_DB ].SQL_Query_Total_Join_Count( l.query ) GE 50 }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Root $ l.module:module ].Module_Customer_Field_Capabilities( l.module, l.code, l.capabilities ) }">

	<MvIF EXPR = "{ NOT l.capabilities:query }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGNARRAY NAME = "l.ref:data:queried"	VALUE = 1>
		<MvMEMBER NAME = "{ l.module:code }">
		<MvMEMBER NAME = "{ l.code }">
	</MvASSIGNARRAY>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Customer_Field_Query( l.module, l.query, l.code ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_CustomFields_Query_Filter" PARAMETERS = "query var, field_count var, module var, filter_name, filter_operator, filter_value, data var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ ( l.module:api_ver LT 9.07 ) OR ( NOT l.module:feature_hash:fields_cust ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Root $ l.module:module ].Module_Customer_Field_Capabilities( l.module, l.filter_name, l.capabilities ) }">

	<MvIF EXPR = "{ NOT l.capabilities:search }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Customer_Field_Query_Search( l.module, l.query, l.filter_name, l.filter_operator, l.filter_value ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_CustomFields_Query_OrderBy" PARAMETERS = "query var, direction, module var, code" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ ( l.module:api_ver LT 9.07 ) OR ( NOT l.module:feature_hash:fields_cust ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Root $ l.module:module ].Module_Customer_Field_Capabilities( l.module, l.code, l.capabilities ) }">

	<MvIF EXPR = "{ NOT l.capabilities:orderby }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Customer_Field_Query_OrderBy( l.module, l.query, l.code, l.direction ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_CustomFields_Query_Index" PARAMETERS = "loaded_record var, module var, customer_id, code" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ ( l.module:api_ver LT 9.07 ) OR ( NOT l.module:feature_hash:fields_cust ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Customer_Field_Query_OrderBy_LoadIndexRecord( l.module, l.loaded_record, l.customer_id, l.code ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerIndex_Load_ID" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN> </MvIF>

	<MvASSIGN NAME = "l.query" 				VALUE = "">
	<MvASSIGN NAME = "l.record" 			VALUE = "">

	<MvREFERENCE NAME = "l.customer" 		VARIABLE = "l.record:cust">
	<MvREFERENCE NAME = "l.businessaccount"	VARIABLE = "l.record:ba">

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.filter"				VALUE = "">
	<MvASSIGN NAME = "l.sort"				VALUE = "">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Filter(	'o', 'Filter',		l.filter )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Sort',		l.sort ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ l.customer:account_id }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].BusinessAccount_Load( l.customer:account_id, l.businessaccount ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>
		</MvIF>
	</MvIF>

	<MvCOMMENT>
	|
	| The output of Customer_Load_ID sets xxx_addr to xxx_addr $ ' ' $ xxx_addr2 from the database.  SQL_Query_Index doesn't know this so we need
	| to explicitly reset those values to what it expects.
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.customer:ship_addr"	VALUE = "{ l.customer:ship_addr1 }">
	<MvASSIGN NAME = "l.customer:bill_addr"	VALUE = "{ l.customer:bill_addr1 }">
	
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.query, g.Store_Table_Prefix $ 'Customers', 'cust' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'cust', g.Store_Table_Prefix $ 'BusinessAccounts', 'ba', 'cust.account_id = ba.id', '' ) }">

	<MvASSIGN NAME = "l.filter_columns" 	VALUE = "{ JSON_BaseCustomerList_Filters() }">
	<MvASSIGN NAME = "l.orderby_columns"	VALUE = "{ JSON_BaseCustomerList_OrderBy() }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Filter_Callback_With_CustomFields( l.query, l.filter, l.filter_columns, g.Module_Feature_CUS_JSON, '', '', 'JSON_Customer_CustomFields_Query_Filter', l.null ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_OrderBy_Callback_With_CustomFields( l.query, l.sort, l.orderby_columns, 'cust.login', g.Module_Feature_CUS_JSON, 'JSON_Customer_CustomFields_Query_OrderBy' ) }">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_SQL_Query_Index_With_CustomFields( l.query, l.record, l.index, l.customer:id, g.Module_Feature_CUS_JSON, 'JSON_Customer_CustomFields_Query_Index' ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"index":	<MvEVAL EXPR = "{ int( l.index ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_Delete" PARAMETERS = "" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 0, 0, 1 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Delete( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">	
	</MvIF>
	
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerList_Delete" PARAMETERS = "" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 0, 0, 1 ) }">	<MvFUNCTIONRETURN>	</MvIF>

	<MvASSIGN NAME = "l.processed" 		VALUE = 0>
	<MvASSIGN NAME = "l.error_count" 	VALUE = 0>
	<MvASSIGN NAME = "l.errors" 		VALUE = "">
	<MvASSIGN NAME = "l.start_time" 	VALUE = "{ s.dyn_time_t }">

	<MvFOREACH ITERATOR = "l.customer_id" ARRAY = "l.customer_ids" COUNT = "{ [ g.Module_JSON ].JSON_Array_Integer( g.Customer_IDs, l.customer_ids ) }">
		<MvASSIGN NAME = "l.processed" 	VALUE = "{ l.processed + 1 }">

		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Load_ID( l.customer_id, l.customer ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>
		<MvELSE>
			<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Delete( l.customer ) }">
				<MvASSIGN NAME = "l.error_count" VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Error( l.customer_id, g.Error_Code, g.Error_Message, l.errors ) }">
			<MvELSE>
				<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00013', 'Customer \'' $ l.customer:login $ '\' deleted' ) }">
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ ( s.dyn_time_t - l.start_time ) GE 60 }">								<MvFOREACHSTOP>
		<MvELSEIF EXPR = "{ ( s.dyn_time_remaining GE 0 ) AND ( s.dyn_time_remaining LE 3 ) }">	<MvFOREACHSTOP>
		</MvIF>
	</MvFOREACH>

	<MvIF EXPR = "{ l.error_count }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Errors( l.processed, l.errors ) }">
	</MvIF>
	
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Success( l.processed ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_Insert" PARAMETERS = "" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 1, 0, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvASSIGN NAME = "l.customer:pgrpcount" 	VALUE = 0>
	<MvASSIGN NAME = "l.customer:ship_res"		VALUE = 1>
	<MvASSIGN NAME = "l.customer:tax_exempt"	VALUE = 0>
	<MvASSIGN NAME = "l.customer:order_cnt"		VALUE = 0>
	<MvASSIGN NAME = "l.customer:order_avg"		VALUE = 0.00>
	<MvASSIGN NAME = "l.customer:order_tot"		VALUE = 0.00>
	<MvASSIGN NAME = "l.password"				VALUE = "">
	<MvASSIGN NAME = "l.businessaccount_title"	VALUE = "">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Code( 		'O', 'Customer_Login',				l.customer:login ) 		OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'R', 'Customer_PasswordEmail',		l.customer:pw_email ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'R', 'Customer_Password',			l.password )			OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'Customer_ShipResidential',	l.customer:ship_res )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipFirstName',		l.customer:ship_fname ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipLastName',		l.customer:ship_lname ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipEmail',			l.customer:ship_email ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipCompany',		l.customer:ship_comp ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipPhone',			l.customer:ship_phone ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipFax',			l.customer:ship_fax ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipAddress1',		l.customer:ship_addr1 )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipAddress2',		l.customer:ship_addr2 ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipCity',			l.customer:ship_city ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipState',			l.customer:ship_state ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipZip',			l.customer:ship_zip ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipCountry',		l.customer:ship_cntry ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillFirstName',		l.customer:bill_fname ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillLastName',		l.customer:bill_lname ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillEmail',			l.customer:bill_email ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillCompany',		l.customer:bill_comp ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillPhone',			l.customer:bill_phone ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillFax',			l.customer:bill_fax ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillAddress1',		l.customer:bill_addr1 )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillAddress2',		l.customer:bill_addr2 ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillCity',			l.customer:bill_city ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillState',			l.customer:bill_state ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillZip',			l.customer:bill_zip ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillCountry',		l.customer:bill_cntry ) OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean( 	'o', 'Customer_Tax_Exempt',			l.customer:tax_exempt )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Customer_BusinessAccount',	l.businessaccount_title ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customer:login }">
		<MvIF EXPR = "{ NOT [ g.Feature_Filename_CUS_UT ].CustomerLogin_Generate_Email( l.customer:pw_email, l.customer:login ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>
	<MvELSE>
		<MvIF EXPR = "{ [ g.Module_Feature_CUS_DB ].Customer_Load_Login( l.customer:login, l.existing_customer ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_Login', 'A customer with the login \'' $ l.existing_customer:login $ '\' already exists' ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].CustomerSettings_Load( l.customersettings ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>
	
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Password( l.customersettings, l.password ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_Password', g.Validation_Message ) }">
	<MvELSEIF EXPR = "{ NOT [ g.Feature_Filename_CUS_UT ].Customer_Password_Encrypt( l.password, l.customer:password ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Email( l.customer:pw_email ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_PasswordEmail', g.Validation_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:ship_email }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Email( l.customer:ship_email ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_ShipEmail', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:ship_phone }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Phone( l.customer:ship_phone, l.customer:ship_cntry ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_ShipPhone', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:ship_fax }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Phone( l.customer:ship_fax, l.customer:ship_cntry ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_ShipFax', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:ship_zip }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Zip( l.customer:ship_zip, l.customer:ship_cntry ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_ShipZip', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:bill_email }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Email( l.customer:bill_email ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_BillEmail', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:bill_phone }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Phone( l.customer:bill_phone, l.customer:bill_cntry ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_BillPhone', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:bill_fax }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Phone( l.customer:bill_fax, l.customer:bill_cntry ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_BillFax', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:bill_zip }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Zip( l.customer:bill_zip, l.customer:bill_cntry ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_BillZip', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.businessaccount_title }">
		<MvASSIGN NAME = "l.customer:account_id"	VALUE = 0>
	<MvELSEIF EXPR = "{ [ g.Module_Feature_CUS_DB ].BusinessAccount_Load_Title( l.businessaccount_title, l.businessaccount ) }">
		<MvASSIGN NAME = "l.customer:account_id"	VALUE = "{ l.businessaccount:id }">
	<MvELSEIF EXPR = "{ [ g.Module_Library_DB ].Error_Is_EOF() }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_BusinessAccount', 'Business Account \'' $ l.businessaccount_title $ '\' not found' ) }">
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvCOMMENT>
	|
	| Validate custom fields
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.customfields"		VALUE = "">
	<MvASSIGN NAME = "l.customfield_count"	VALUE = 0>
	<MvASSIGN NAME = "l.null"				VALUE = "{ [ g.Module_JSON ].JSON_Input_Retrieve_Raw( 'CustomField_Values', l.customfield_values ) }">

	<MvFOREACH ITERATOR = "l.module_code" ARRAY = "l.module_codelist" COUNT = "{ miva_struct_members( l.customfield_values, l.module_codelist ) }">
		<MvASSIGN NAME = "l.module_code"	VALUE = "{ [ g.Module_JSON ].JSON_Decode( l.module_code ) }">

		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].ModuleAndFeatures_Load_Code_Cached( l.module_code, l.module ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00058', 'Module \'' $ l.module_code $ '\' not found' ) }">
		<MvELSEIF EXPR = "{ NOT l.module:active }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00059', 'Module \'' $ l.module:code $ '\' is deactivated' ) }">
		<MvELSEIF EXPR = "{ NOT l.module:feature_hash:fields_cust }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00060', 'Module \'' $ l.module:code $ '\' does not provide feature \'fields_cust\'' ) }">
		<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].StoreModule_Count_Module_Cached( l.module:id ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00061', 'Module \'' $ l.module:code $ '\' is not installed in store \'' $ g.Store:code $ '\'' ) }">
		</MvIF>

		<MvASSIGN NAME = "l.fields"	VALUE = "">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Customer_Fields( l.module, l.fields ) }">

		<MvREFERENCEARRAY NAME = "l.customfield_members" VARIABLE = "l.customfield_values">
			<MvMEMBER NAME = "{ l.module:code }">
		</MvREFERENCEARRAY>

		<MvFOREACH ITERATOR = "l.customfield_code" ARRAY = "l.customfield_codelist" COUNT = "{ miva_struct_members( l.customfield_members, l.customfield_codelist ) }">
			<MvASSIGN NAME = "l.customfield_code"		VALUE = "{ [ g.Module_JSON ].JSON_Decode( l.customfield_code ) }">

			<MvIF EXPR = "{ NOT miva_array_search( l.fields, 1, l.field, 'l.field:code EQ l.customfield_code' ) }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'CustomField_Values:' $ l.module:code $ ':' $ l.customfield_code, 'Failed to load custom field \'' $ l.customfield_code $ '\'' ) }">
			</MvIF>

			<MvASSIGN NAME = "l.customfield"			VALUE = "">
			<MvASSIGN NAME = "l.customfield:module"		VALUE = "{ l.module }">
			<MvASSIGN NAME = "l.customfield:code"		VALUE = "{ l.customfield_code }">
			<MvASSIGN NAME = "l.customfield:type"		VALUE = "{ l.field:type }">

			<MvREFERENCEARRAY NAME = "l.customfield_value" VARIABLE = "l.customfield_values">
				<MvMEMBER NAME = "{ l.module:code }">
				<MvMEMBER NAME = "{ l.customfield_code }">
			</MvREFERENCEARRAY>

			<MvIF EXPR = "{ l.customfield:type NE 'multitext' }">	<MvASSIGN NAME = "l.customfield:value"			VALUE = "{ [ g.Module_JSON ].JSON_Decode( l.customfield_value ) }">
			<MvELSE>												<MvASSIGN NAME = "l.customfield:value_count"	VALUE = "{ [ g.Module_JSON ].JSON_Array_String( l.customfield_value, l.customfield:values ) }">
			</MvIF>

			<MvASSIGN NAME = "l.customfield_count"		VALUE = "{ miva_array_insert_var( l.customfields, l.customfield, -1 ) }">
		</MvFOREACH>
	</MvFOREACH>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Insert( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00015', 'Customer \'' $ l.customer:login $ '\' inserted' ) }">

	<MvCOMMENT>
	|
	| Insert Custom Fields
	|
	</MvCOMMENT>

	<MvFOREACH ITERATOR = "l.customfield" ARRAY = "l.customfields" COUNT = "{ l.customfield_count }">
		<MvIF EXPR = "{ l.customfield:type NE 'multitext' }">	<MvASSIGN NAME = "l.result" VALUE = "{ [ g.Module_Root $ l.customfield:module:module ].Module_Customer_Set_Field( l.customfield:module, l.customer:id, l.customfield:code, l.customfield:value ) }">
		<MvELSE>												<MvASSIGN NAME = "l.result" VALUE = "{ [ g.Module_Root $ l.customfield:module:module ].Module_Customer_Set_Field_Array( l.customfield:module, l.customer:id, l.customfield:code, l.customfield:values, l.customfield:value_count ) }">
		</MvIF>
		
		<MvIF EXPR = "{ NOT l.result }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'CustomField_Values:' $ l.customfield:module:code $ ':' $ l.customfield:code, g.Error_Code $ ': ' $ g.Error_Message ) }">
		</MvIF>
	</MvFOREACH>
	
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		<MvEVAL EXPR = "{ JSON_Customer( l.customer ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Customer_Update" PARAMETERS = "" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.original_login"		VALUE = "{ l.customer:login }">
	<MvASSIGN NAME = "l.customer:ship_addr"	VALUE = "">
	<MvASSIGN NAME = "l.customer:bill_addr"	VALUE = "">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Code( 		'O', 'Customer_Login',				l.customer:login ) 		OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'O', 'Customer_PasswordEmail',		l.customer:pw_email ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'O', 'Customer_Password',			l.new_password )		OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'Customer_ShipResidential',	l.customer:ship_res )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipFirstName',		l.customer:ship_fname ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipLastName',		l.customer:ship_lname ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipEmail',			l.customer:ship_email ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipCompany',		l.customer:ship_comp ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipPhone',			l.customer:ship_phone ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipFax',			l.customer:ship_fax ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipAddress1',		l.customer:ship_addr1 )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipAddress2',		l.customer:ship_addr2 ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipCity',			l.customer:ship_city ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipState',			l.customer:ship_state ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipZip',			l.customer:ship_zip ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_ShipCountry',		l.customer:ship_cntry ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillFirstName',		l.customer:bill_fname ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillLastName',		l.customer:bill_lname ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillEmail',			l.customer:bill_email ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillCompany',		l.customer:bill_comp ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillPhone',			l.customer:bill_phone ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillFax',			l.customer:bill_fax ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillAddress1',		l.customer:bill_addr1 )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillAddress2',		l.customer:bill_addr2 ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillCity',			l.customer:bill_city ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillState',			l.customer:bill_state ) OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillZip',			l.customer:bill_zip ) 	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Customer_BillCountry',		l.customer:bill_cntry ) OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean( 	'o', 'Customer_Tax_Exempt',			l.customer:tax_exempt ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ tolower( l.original_login ) NE tolower( l.customer:login ) }">
		<MvIF EXPR = "{ [ g.Module_Feature_CUS_DB ].Customer_Load_Login( l.customer:login, l.existing_customer ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_Login', 'A customer with the login \'' $ l.existing_customer:login $ '\' already exists' ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Email( l.customer:pw_email ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_PasswordEmail', g.Validation_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.new_password }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].CustomerSettings_Load( l.customersettings ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
		
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Password( l.customersettings, l.new_password ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_Password', g.Validation_Message ) }">
		</MvIF>

		<MvIF EXPR = "{ NOT [ g.Feature_Filename_CUS_UT ].Customer_Password_Encrypt( l.new_password, l.customer:password ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:ship_email }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Email( l.customer:ship_email ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_ShipEmail', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:ship_phone }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Phone( l.customer:ship_phone, l.customer:ship_cntry ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_ShipPhone', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:ship_fax }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Phone( l.customer:ship_fax, l.customer:ship_cntry ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_ShipFax', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:ship_zip }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Zip( l.customer:ship_zip, l.customer:ship_cntry ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_ShipZip', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:bill_email }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Email( l.customer:bill_email ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_BillEmail', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:bill_phone }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Phone( l.customer:bill_phone, l.customer:bill_cntry ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_BillPhone', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:bill_fax }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Phone( l.customer:bill_fax, l.customer:bill_cntry ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_BillFax', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:bill_zip }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Zip( l.customer:bill_zip, l.customer:bill_cntry ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_BillZip', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Exists( 'Customer_BusinessAccount' ) }">
		<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Text( 'o', 'Customer_BusinessAccount', l.businessaccount_title ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
		<MvELSEIF EXPR = "{ ISNULL l.businessaccount_title }">
			<MvASSIGN NAME = "l.customer:account_id"	VALUE = 0>
		<MvELSEIF EXPR = "{ [ g.Module_Feature_CUS_DB ].BusinessAccount_Load_Title( l.businessaccount_title, l.businessaccount ) }">
			<MvASSIGN NAME = "l.customer:account_id"	VALUE = "{ l.businessaccount:id }">
		<MvELSEIF EXPR = "{ [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Customer_BusinessAccount', 'Business Account \'' $ l.businessaccount_title $ '\' not found' ) }">
		<MvELSE>
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>
	</MvIF>

	<MvCOMMENT>
	|
	| Validate custom fields
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.customfields"		VALUE = "">
	<MvASSIGN NAME = "l.customfield_count"	VALUE = 0>
	<MvASSIGN NAME = "l.null"				VALUE = "{ [ g.Module_JSON ].JSON_Input_Retrieve_Raw( 'CustomField_Values', l.customfield_values ) }">

	<MvFOREACH ITERATOR = "l.module_code" ARRAY = "l.module_codelist" COUNT = "{ miva_struct_members( l.customfield_values, l.module_codelist ) }">
		<MvASSIGN NAME = "l.module_code"	VALUE = "{ [ g.Module_JSON ].JSON_Decode( l.module_code ) }">

		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].ModuleAndFeatures_Load_Code_Cached( l.module_code, l.module ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00062', 'Module \'' $ l.module_code $ '\' not found' ) }">
		<MvELSEIF EXPR = "{ NOT l.module:active }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00063', 'Module \'' $ l.module:code $ '\' is deactivated' ) }">
		<MvELSEIF EXPR = "{ NOT l.module:feature_hash:fields_cust }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00064', 'Module \'' $ l.module:code $ '\' does not provide feature \'fields_cust\'' ) }">
		<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].StoreModule_Count_Module_Cached( l.module:id ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00065', 'Module \'' $ l.module:code $ '\' is not installed in store \'' $ g.Store:code $ '\'' ) }">
		</MvIF>

		<MvASSIGN NAME = "l.fields"	VALUE = "">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Customer_Fields( l.module, l.fields ) }">

		<MvREFERENCEARRAY NAME = "l.customfield_members" VARIABLE = "l.customfield_values">
			<MvMEMBER NAME = "{ l.module:code }">
		</MvREFERENCEARRAY>

		<MvFOREACH ITERATOR = "l.customfield_code" ARRAY = "l.customfield_codelist" COUNT = "{ miva_struct_members( l.customfield_members, l.customfield_codelist ) }">
			<MvASSIGN NAME = "l.customfield_code"		VALUE = "{ [ g.Module_JSON ].JSON_Decode( l.customfield_code ) }">

			<MvIF EXPR = "{ NOT miva_array_search( l.fields, 1, l.field, 'l.field:code EQ l.customfield_code' ) }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'CustomField_Values:' $ l.module:code $ ':' $ l.customfield_code, 'Failed to load custom field \'' $ l.customfield_code $ '\'' ) }">
			</MvIF>

			<MvASSIGN NAME = "l.customfield"			VALUE = "">
			<MvASSIGN NAME = "l.customfield:module"		VALUE = "{ l.module }">
			<MvASSIGN NAME = "l.customfield:code"		VALUE = "{ l.customfield_code }">
			<MvASSIGN NAME = "l.customfield:type"		VALUE = "{ l.field:type }">

			<MvREFERENCEARRAY NAME = "l.customfield_value" VARIABLE = "l.customfield_values">
				<MvMEMBER NAME = "{ l.module:code }">
				<MvMEMBER NAME = "{ l.customfield_code }">
			</MvREFERENCEARRAY>

			<MvIF EXPR = "{ l.customfield:type NE 'multitext' }">	<MvASSIGN NAME = "l.customfield:value"			VALUE = "{ [ g.Module_JSON ].JSON_Decode( l.customfield_value ) }">
			<MvELSE>												<MvASSIGN NAME = "l.customfield:value_count"	VALUE = "{ [ g.Module_JSON ].JSON_Array_String( l.customfield_value, l.customfield:values ) }">
			</MvIF>

			<MvASSIGN NAME = "l.customfield_count"		VALUE = "{ miva_array_insert_var( l.customfields, l.customfield, -1 ) }">
		</MvFOREACH>
	</MvFOREACH>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Update( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00006', 'Customer \'' $ l.customer:login $ '\' updated' ) }">

	<MvCOMMENT>
	|
	| Update Custom Fields
	|
	</MvCOMMENT>

	<MvFOREACH ITERATOR = "l.customfield" ARRAY = "l.customfields" COUNT = "{ l.customfield_count }">
		<MvIF EXPR = "{ l.customfield:type NE 'multitext' }">	<MvASSIGN NAME = "l.result" VALUE = "{ [ g.Module_Root $ l.customfield:module:module ].Module_Customer_Set_Field( l.customfield:module, l.customer:id, l.customfield:code, l.customfield:value ) }">
		<MvELSE>												<MvASSIGN NAME = "l.result" VALUE = "{ [ g.Module_Root $ l.customfield:module:module ].Module_Customer_Set_Field_Array( l.customfield:module, l.customer:id, l.customfield:code, l.customfield:values, l.customfield:value_count ) }">
		</MvIF>

		<MvIF EXPR = "{ NOT l.result }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'CustomField_Values:' $ l.customfield:module:code $ ':' $ l.customfield:code, g.Error_Code $ ': ' $ g.Error_Message ) }">
		</MvIF>
	</MvFOREACH>
	
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvCOMMENT>
|
| Customer Credit History
|
</MvCOMMENT>

<MvFUNCTION NAME = "JSON_CustomerCreditHistory" PARAMETERS = "credit var" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvASSIGN NAME = "l.formatted_amount" VALUE = "{ [ g.Module_Root $ g.Store:currncy_mod:module ].CurrencyModule_AddFormatting( g.Store:currncy_mod, l.credit:amount ) }">

	"id":					<MvEVAL EXPR = "{ int( l.credit:id ) }">,
	"user_id":				<MvEVAL EXPR = "{ int( l.credit:user_id ) }">,
	"cust_id":				<MvEVAL EXPR = "{ int( l.credit:cust_id ) }">,
	"order_id":				<MvEVAL EXPR = "{ int( l.credit:order_id ) }">,
	"txref":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.credit:txref ) }">",
	"descrip":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.credit:descrip ) }">",
	"amount":				<MvEVAL EXPR = "{ l.credit:amount ROUND 2 }">,
	"formatted_amount":		"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.formatted_amount ) }">",
	"dtstamp":				<MvEVAL EXPR = "{ int( l.credit:dtstamp ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerCreditHistory_Load" PARAMETERS = "credit var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Retrieve_Integer( 'CustomerCreditHistory_ID', l.customer_credit_history_id ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].CustomerCreditHistory_Load_ID( l.customer_credit_history_id, l.credit ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00008', 'Unable to load customer credit history entry' ) }">
		</MvIF>
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00069', 'Unable to load customer credit history: CustomerCreditHistory_ID must be specified' ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerCreditHistoryList_Load_Query" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">					<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'ACRD', 1, 0, 0, 0 ) }">		<MvFUNCTIONRETURN>	</MvIF>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.available_filters"	VALUE = "">
	<MvASSIGN NAME = "l.filter"				VALUE = "">
	<MvASSIGN NAME = "l.sort"				VALUE = "">
	<MvASSIGN NAME = "l.offset"				VALUE = 0>
	<MvASSIGN NAME = "l.count"				VALUE = 0>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'u.name',			'user_name' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'cch.order_id',	'order_id' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cch.txref',		'txref' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cch.descrip',		'descrip' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'cch.amount',		'amount' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'cch.dtstamp',		'dtstamp' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'cch.id',			'id' ) }">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Filter(	'o', 'Filter',	l.filter )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Sort',	l.sort )	OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Offset',	l.offset )	OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Count',	l.count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>
	
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT( l.search_query, 'cch.*,
																				 u.name AS user_name' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.search_query, g.Store_Table_Prefix $ 'CustomerCreditHistory', 'cch' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.search_query, 'cch', 'Users', 'u', 'u.id = cch.user_id', '' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.search_query, 'cch.cust_id = ? ', [ g.Module_Library_DB ].SQL_Query_Field( l.customer:id ) ) }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Filter( l.search_query, l.filter, l.available_filters ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_OrderBy_Fields( l.search_query, l.sort,
																		'user_name:u.name,order_id:cch.order_id,txref:cch.txref,descrip:cch.descrip,amount:cch.amount,dtstamp:cch.dtstamp',
																		'cch.id' ) }"> 

	<MvASSIGN NAME = "l.search_sql"		VALUE = "{ [ g.Module_Library_DB ].SQL_Query_Build( l.search_query, l.search_fields ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].SQL_Query_Count( l.search_query, l.total_count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'CustomerCreditHistory', l.search_sql, l.search_fields, l.offset, l.count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00009', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.credit_count"	VALUE = 0>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"total_count":	<MvEVAL EXPR = "{ int( l.total_count ) }">,
		"start_offset":	<MvEVAL EXPR = "{ int( l.offset ) }">,
		"data":
		[
		<MvWHILE EXPR = "{ ( NOT CustomerCreditHistory.d.EOF ) AND ( ( l.count EQ 0 ) OR ( l.credit_count LT l.count ) ) }">
			<MvEVAL EXPR = "{ [ g.Feature_Filename_CUS_DB ].CustomerCreditHistory_Read( l.credit ) }">

			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_Start( l.credit_count ) }">
				<MvEVAL EXPR = "{ JSON_CustomerCreditHistory( l.credit ) }">
				, "user_name": "<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( CustomerCreditHistory.d.user_name ) }">"
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_End() }">

			<MvSKIP NAME = "Merchant" VIEW = "CustomerCreditHistory" ROWS = 1>
		</MvWHILE>
		]
	}
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerCreditHistory">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerCreditHistory_Delete" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'ACRD', 0, 0, 0, 1 ) }">	<MvFUNCTIONRETURN>	</MvIF>

	<MvIF EXPR = "{ JSON_CustomerCreditHistory_Load( l.credit ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].CustomerCreditHistory_Delete_ID( l.credit:id ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">	
		</MvIF>

		<MvIF EXPR = "{ NOT [ g.Feature_Filename_CUS_DB ].Customer_Load_ID( l.credit:cust_id, l.customer ) }">	<MvASSIGN NAME = "l.message" VALUE = "{ 'Deleted customer credit history entry for customer ID ' $ l.credit:cust_id $ '' }">
		<MvELSE>																								<MvASSIGN NAME = "l.message" VALUE = "{ 'Deleted customer credit history entry for customer \'' $ l.customer:login $ '\'' }">
		</MvIF>

		<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00010', l.message ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerCreditHistory_Insert" PARAMETERS = "" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'ACRD', 0, 1, 0, 0 ) }">	<MvFUNCTIONRETURN>	</MvIF>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Number(	'R', 'Amount',					l.amount, 10, 2 )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'R', 'Description',				l.description )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'TransactionReference',	l.transaction_reference ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ l.amount EQ 0 }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Amount', 'Amount must be a non-zero value' ) }">
	</MvIF>

	<MvASSIGN NAME = "l.credit"				VALUE = "">
	<MvASSIGN NAME = "l.credit:user_id"		VALUE = "{ g.User:id }">
	<MvASSIGN NAME = "l.credit:cust_id" 	VALUE = "{ l.customer:id }">
	<MvASSIGN NAME = "l.credit:txref"		VALUE = "{ l.transaction_reference }">
	<MvASSIGN NAME = "l.credit:descrip" 	VALUE = "{ l.description }">
	<MvASSIGN NAME = "l.credit:amount"	 	VALUE = "{ l.amount }">
	<MvASSIGN NAME = "l.credit:order_id" 	VALUE = 0>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].CustomerCreditHistory_Insert( l.credit ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00011', 'Added customer credit history entry for customer \'' $ l.customer:login $ '\' with amount \'' $ ( l.credit:amount ROUND 2 ) $ '\'' ) }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		<MvEVAL EXPR = "{ JSON_CustomerCreditHistory( l.credit ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvCOMMENT>
|
| Business Accounts
|
</MvCOMMENT>

<MvFUNCTION NAME = "JSON_BusinessAccount" PARAMETERS = "businessaccount var" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvASSIGN NAME = "l.formatted_order_avg"	VALUE = "{ [ g.Module_Root $ g.Store:currncy_mod:module ].CurrencyModule_AddFormatting( g.Store:currncy_mod, l.businessaccount:order_avg ) }">
	<MvASSIGN NAME = "l.formatted_order_tot"	VALUE = "{ [ g.Module_Root $ g.Store:currncy_mod:module ].CurrencyModule_AddFormatting( g.Store:currncy_mod, l.businessaccount:order_tot ) }">

	"id":					<MvEVAL EXPR = "{ int( l.businessaccount:id ) }">,
	"title":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.businessaccount:title ) }">",
	"tax_exempt":			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.businessaccount:tax_exempt ) }">,
	"order_cnt":			<MvEVAL EXPR = "{ int( l.businessaccount:order_cnt ) }">,
	"order_avg":			<MvEVAL EXPR = "{ l.businessaccount:order_avg ROUND 2 }">,
	"formatted_order_avg":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.formatted_order_avg ) }">",
	"order_tot":			<MvEVAL EXPR = "{ l.businessaccount:order_tot ROUND 2 }">,
	"formatted_order_tot":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.formatted_order_tot ) }">",
	"note_count":			<MvEVAL EXPR = "{ int( l.businessaccount:note_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BusinessAccount_Load" PARAMETERS = "businessaccount var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Retrieve_Integer( 'BusinessAccount_ID', l.businessaccount_id ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].BusinessAccount_Load( l.businessaccount_id, l.businessaccount ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00019', 'Business account not found' ) }">
		</MvIF>
	<MvELSEIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Retrieve( 'Edit_BusinessAccount', l.businessaccount_title ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].BusinessAccount_Load_Title( l.businessaccount_title, l.businessaccount ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00066', 'Business account not found' ) }">
		</MvIF>	
	<MvELSEIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Retrieve( 'BusinessAccount_Title', l.businessaccount_title ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].BusinessAccount_Load_Title( l.businessaccount_title, l.businessaccount ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00030', 'Business account not found' ) }">
		</MvIF>
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00031', 'Unable to load business account: One of BusinessAccount_ID, Edit_BusinessAccount or BusinessAccount_Title must be specified' ) }">
	</MvIF>
	
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BaseBusinessAccountList_Filters" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.available_filters" VALUE = "">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'ba.title',		'' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'ba.note_count',	'' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_BOOL(		l.available_filters, 'ba.tax_exempt',	'' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'ba.order_cnt',	'' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'ba.order_avg',	'' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'ba.order_tot',	'' ) }">

	<MvFUNCTIONRETURN VALUE = "{ l.available_filters }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BaseBusinessAccountList_OrderBy" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "ba.id,ba.title,ba.note_count,ba.tax_exempt,ba.order_cnt,ba.order_avg,ba.order_tot">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BusinessAccountList_Load_Query" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvASSIGN NAME = "l.filter"				VALUE = "">
	<MvASSIGN NAME = "l.sort"				VALUE = "">
	<MvASSIGN NAME = "l.offset"				VALUE = 0>
	<MvASSIGN NAME = "l.count"				VALUE = 0>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Filter(	'o', 'Filter',	l.filter )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Sort',	l.sort )	OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Offset',	l.offset )	OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Count',	l.count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>
	
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT( l.search_query, '*' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.search_query, g.Store_Table_Prefix $ 'BusinessAccounts', 'ba' ) }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Filter( l.search_query, l.filter, [ g.Module_Feature_CUS_JSON ].JSON_BaseBusinessAccountList_Filters() ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_OrderBy( l.search_query, l.sort, [ g.Module_Feature_CUS_JSON ].JSON_BaseBusinessAccountList_OrderBy(), 'ba.id' ) }"> 

	<MvASSIGN NAME = "l.search_sql"		VALUE = "{ [ g.Module_Library_DB ].SQL_Query_Build( l.search_query, l.search_fields ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].SQL_Query_Count( l.search_query, l.total_count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'BusinessAccounts', l.search_sql, l.search_fields, l.offset, l.count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00020', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.businessaccount_count" VALUE = 0>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"total_count":	<MvEVAL EXPR = "{ int( l.total_count ) }">,
		"start_offset":	<MvEVAL EXPR = "{ int( l.offset ) }">,
		"data":
		[
		<MvWHILE EXPR = "{ ( NOT BusinessAccounts.d.EOF ) AND ( ( l.count EQ 0 ) OR ( l.businessaccount_count LT l.count ) ) }">
			<MvEVAL EXPR = "{ [ g.Module_Feature_CUS_DB ].BusinessAccount_Read( l.businessaccount ) }">

			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_Start( l.businessaccount_count ) }">
				<MvEVAL EXPR = "{ JSON_BusinessAccount( l.businessaccount ) }">
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_End() }">

			<MvSKIP NAME = "Merchant" VIEW = "BusinessAccounts" ROWS = 1>
		</MvWHILE>
		]
	}
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "BusinessAccounts">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BusinessAccountIndex_Load_ID" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN> </MvIF>

	<MvASSIGN NAME = "l.query" 	VALUE = "">
	<MvASSIGN NAME = "l.record" VALUE = "">

	<MvREFERENCE NAME = "l.businessaccount" VARIABLE = "l.record:ba">

	<MvIF EXPR = "{ NOT JSON_BusinessAccount_Load( l.businessaccount ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.filter"				VALUE = "">
	<MvASSIGN NAME = "l.sort"				VALUE = "">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Filter(	'o', 'Filter',		l.filter )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Sort',		l.sort ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>
	
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.query, g.Store_Table_Prefix $ 'BusinessAccounts', 'ba' ) }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Filter( l.query, l.filter, [ g.Module_Feature_CUS_JSON ].JSON_BaseBusinessAccountList_Filters() ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_OrderBy( l.query, l.sort, [ g.Module_Feature_CUS_JSON ].JSON_BaseBusinessAccountList_OrderBy(), 'ba.id' ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].SQL_Query_Index( l.query, l.record, l.index ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"index":	<MvEVAL EXPR = "{ int( l.index ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BusinessAccount_Load_ID" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN> </MvIF>

	<MvIF EXPR = "{ NOT JSON_BusinessAccount_Load( l.businessaccount ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		<MvEVAL EXPR = "{ JSON_BusinessAccount( l.businessaccount ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BusinessAccount_Insert" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 1, 0, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvASSIGN NAME = "l.businessaccount"			VALUE = "">
	<MvASSIGN NAME = "l.businessaccount:title"		VALUE = "">
	<MvASSIGN NAME = "l.businessaccount:tax_exempt"	VALUE = 0>
	<MvASSIGN NAME = "l.businessaccount:order_cnt"	VALUE = 0>
	<MvASSIGN NAME = "l.businessaccount:order_avg"	VALUE = 0.00>
	<MvASSIGN NAME = "l.businessaccount:order_tot"	VALUE = 0.00>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Text(		'R', 'BusinessAccount_Title',		l.businessaccount:title ) OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'BusinessAccount_Tax_Exempt',	l.businessaccount:tax_exempt ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_CUS_DB ].BusinessAccount_Load_Title( l.businessaccount:title, l.null ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'BusinessAccount_Title', 'Business account \'' $ l.businessaccount:title $ '\' already exists' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].BusinessAccount_Insert( l.businessaccount ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00022', 'Added business account \'' $ l.businessaccount:title $ '\'' ) }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		<MvEVAL EXPR = "{ JSON_BusinessAccount( l.businessaccount ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BusinessAccount_Update" PARAMETERS = "" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvIF EXPR = "{ NOT JSON_BusinessAccount_Load( l.businessaccount ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Text(		'O', 'BusinessAccount_Title',		l.businessaccount:title ) OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'BusinessAccount_Tax_Exempt',	l.businessaccount:tax_exempt ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_CUS_DB ].BusinessAccount_Load_Title( l.businessaccount:title, l.existing ) AND l.existing:id NE l.businessaccount:id }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'BusinessAccount_Title', 'Business account \'' $ l.businessaccount:title $ '\' already exists' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].BusinessAccount_Update( l.businessaccount ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00023', 'Updated business account \'' $ l.businessaccount:title $ '\'' ) }">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BusinessAccountList_Delete" PARAMETERS = "" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 0, 0, 1 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvASSIGN NAME = "l.processed" 		VALUE = 0>
	<MvASSIGN NAME = "l.error_count" 	VALUE = 0>
	<MvASSIGN NAME = "l.errors" 		VALUE = "">
	<MvASSIGN NAME = "l.start_time" 	VALUE = "{ s.dyn_time_t }">

	<MvIF EXPR = "{  NOT [ g.Module_JSON ].JSON_Input_Integer_Array( 'R', 'BusinessAccount_IDs', l.businessaccount_ids, l.businessaccount_id_count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvFOREACH ITERATOR = "l.businessaccount_id" ARRAY = "l.businessaccount_ids" COUNT = "{ l.businessaccount_id_count }">
		<MvASSIGN NAME = "l.processed" 	VALUE = "{ l.processed + 1 }">

		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].BusinessAccount_Load( l.businessaccount_id, l.businessaccount ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>
		<MvELSE>
			<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].BusinessAccount_Delete( l.businessaccount ) }">
				<MvASSIGN NAME = "l.error_count" VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Error( l.businessaccount_id, g.Error_Code, g.Error_Message, l.errors ) }">
			<MvELSE>
				<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00024', 'Business account \'' $ l.businessaccount:title $ '\' deleted' ) }">
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ ( s.dyn_time_t - l.start_time ) GE 60 }">								<MvFOREACHSTOP>
		<MvELSEIF EXPR = "{ ( s.dyn_time_remaining GE 0 ) AND ( s.dyn_time_remaining LE 3 ) }">	<MvFOREACHSTOP>
		</MvIF>
	</MvFOREACH>

	<MvIF EXPR = "{ l.error_count }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Errors( l.processed, l.errors ) }">
	</MvIF>
	
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Success( l.processed ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BusinessAccountCustomerList_Load_Query" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvIF EXPR = "{ NOT JSON_BusinessAccount_Load( l.businessaccount ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.filter"				VALUE = "">
	<MvASSIGN NAME = "l.sort"				VALUE = "">
	<MvASSIGN NAME = "l.offset"				VALUE = 0>
	<MvASSIGN NAME = "l.count"				VALUE = 0>
	<MvASSIGN NAME = "l.assigned"			VALUE = 1>
	<MvASSIGN NAME = "l.unassigned"			VALUE = 0>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Filter(	'o', 'Filter',		l.filter )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Sort',		l.sort )		OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Offset',		l.offset )		OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Count',		l.count )		OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'Assigned',	l.assigned )	OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'Unassigned',	l.unassigned ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvASSIGN NAME = "l.search_query"		VALUE = "">

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT( l.search_query,	'cust.*, ba.title AS business_title' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.search_query, g.Store_Table_Prefix $ 'Customers', 'cust' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.search_query, 'cust', g.Store_Table_Prefix $ 'BusinessAccounts', 'ba', 'ba.id = ? AND ba.id = cust.account_id', [ g.Module_Library_DB ].SQL_Query_Field( l.businessaccount:id ) ) }">

	<MvIF EXPR = "{ l.assigned AND ( NOT l.unassigned ) }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.search_query,	'cust.account_id = ?', [ g.Module_Library_DB ].SQL_Query_Field( l.businessaccount:id ) ) }">
	<MvELSEIF EXPR = "{ l.assigned OR l.unassigned }">
		<MvIF EXPR = "{ NOT l.assigned }">
			<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.search_query,	'cust.account_id <> ?', [ g.Module_Library_DB ].SQL_Query_Field( l.businessaccount:id ) ) }">
		</MvIF>
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
	</MvIF>

	<MvASSIGN NAME = "l.filter_columns" 	VALUE = "{ JSON_BaseCustomerList_Filters() }">
	<MvASSIGN NAME = "l.orderby_columns"	VALUE = "{ JSON_BaseCustomerList_OrderBy() }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Filter_Callback_With_CustomFields( l.search_query, l.filter, l.filter_columns, g.Module_Feature_CUS_JSON, '', '', 'JSON_Customer_CustomFields_Query_Filter', l.null ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].SQL_Query_Count( l.search_query, l.total_count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Query_Callback_With_CustomFields( l.search_query, l.filter, g.Module_Feature_CUS_JSON, 'JSON_Customer_CustomFields_Query' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_OrderBy_Callback_With_CustomFields( l.search_query, l.sort, l.orderby_columns, 'cust.login', g.Module_Feature_CUS_JSON, 'JSON_Customer_CustomFields_Query_OrderBy' ) }">

	<MvASSIGN NAME = "l.search_sql"			VALUE = "{ [ g.Module_Library_DB ].SQL_Query_Build( l.search_query, l.search_fields ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers', l.search_sql, l.search_fields, l.offset, l.count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00025', g.MvOPENVIEW_Error ) }">
	</MvIF>
	
	<MvASSIGN NAME = "l.customer_count" 	VALUE = 0>
	
	<MvEVAL EXPR = "{ JSON_Customer_CustomFields_Initialize( l.filter, l.customfield_state ) }">	
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"total_count":	<MvEVAL EXPR = "{ int( l.total_count ) }">,
		"start_offset":	<MvEVAL EXPR = "{ int( l.offset ) }">,
		"data": 
		[
		<MvWHILE EXPR = "{ ( NOT Customers.d.EOF ) AND ( ( l.count EQ 0 ) OR ( l.customer_count LT l.count ) ) }">
			<MvEVAL EXPR = "{ [ g.Module_Feature_CUS_DB ].Customer_Read( l.customer ) }">

			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_Start( l.customer_count ) }">
				<MvEVAL EXPR = "{ JSON_Customer( l.customer ) }">
				<MvEVAL EXPR = "{ JSON_Customer_CustomFields_With_Query( l.search_query, l.customfield_state, Customers.d.id, 'Customers' ) }">
				
				, "assigned": <MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( Customers.d.account_id EQ l.businessaccount:id ) }">,
				"business_title": "<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( Customers.d.business_title ) }">"
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_End() }">

			<MvSKIP NAME = "Merchant" VIEW = "Customers" ROWS = 1>
		</MvWHILE>
		]
	}
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BusinessAccountCustomerIndex_Load_ID" PARAMETERS = "" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN> </MvIF>

	<MvASSIGN NAME = "l.query"					VALUE = "">
	<MvASSIGN NAME = "l.record"					VALUE = "">

	<MvREFERENCE NAME = "l.customer"			VARIABLE = "l.record:cust">
	<MvREFERENCE NAME = "l.customer_account"	VARIABLE = "l.record:ba">

	<MvIF EXPR = "{ NOT JSON_BusinessAccount_Load( l.businessaccount ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.filter"					VALUE = "">
	<MvASSIGN NAME = "l.sort"					VALUE = "">
	<MvASSIGN NAME = "l.assigned"				VALUE = 1>
	<MvASSIGN NAME = "l.unassigned"				VALUE = 0>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Filter(	'o', 'Filter',		l.filter )				OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Sort',		l.sort )				OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'Assigned',	l.assigned )			OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'Unassigned',	l.unassigned ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvCOMMENT>
	|
	| The output of Customer_Load_ID sets xxx_addr to xxx_addr $ ' ' $ xxx_addr2 from the database.  SQL_Query_Index doesn't know this so we need
	| to explicitly reset those values to what it expects.
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.customer:ship_addr"		VALUE = "{ l.customer:ship_addr1 }">
	<MvASSIGN NAME = "l.customer:bill_addr"		VALUE = "{ l.customer:bill_addr1 }">

	<MvIF EXPR = "{ l.customer:account_id }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].BusinessAccount_Load( l.customer:account_id, l.customer_account ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>
		</MvIF>
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.query, g.Store_Table_Prefix $ 'Customers', 'cust' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'cust', g.Store_Table_Prefix $ 'BusinessAccounts', 'ba', 'ba.id = ? AND ba.id = cust.account_id', [ g.Module_Library_DB ].SQL_Query_Field( l.businessaccount:id ) ) }">

	<MvIF EXPR = "{ l.assigned AND ( NOT l.unassigned ) }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query,	'cust.account_id = ?', [ g.Module_Library_DB ].SQL_Query_Field( l.businessaccount:id ) ) }">
	<MvELSEIF EXPR = "{ l.assigned OR l.unassigned }">
		<MvIF EXPR = "{ NOT l.assigned }">
			<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query,	'cust.account_id <> ?', [ g.Module_Library_DB ].SQL_Query_Field( l.businessaccount:id ) ) }">
		</MvIF>
	<MvELSE>
		<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
		{
			"index": -1
		}
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
	</MvIF>

	<MvASSIGN NAME = "l.filter_columns" 	VALUE = "{ JSON_BaseCustomerList_Filters() }">
	<MvASSIGN NAME = "l.orderby_columns"	VALUE = "{ JSON_BaseCustomerList_OrderBy() }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Filter_Callback_With_CustomFields( l.query, l.filter, l.filter_columns, g.Module_Feature_CUS_JSON, '', '', 'JSON_Customer_CustomFields_Query_Filter', l.null ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_OrderBy_Callback_With_CustomFields( l.query, l.sort, l.orderby_columns, 'cust.login', g.Module_Feature_CUS_JSON, 'JSON_Customer_CustomFields_Query_OrderBy' ) }">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_SQL_Query_Index_With_CustomFields( l.query, l.record, l.index, l.customer:id, g.Module_Feature_CUS_JSON, 'JSON_Customer_CustomFields_Query_Index' ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"index":	<MvEVAL EXPR = "{ int( l.index ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_BusinessAccountCustomer_Update_Assigned" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvIF EXPR = "{ NOT JSON_BusinessAccount_Load( l.businessaccount ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Boolean( 'R', 'Assigned', l.assigned ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ NOT l.customer:account_id AND l.assigned }">
		<MvASSIGN NAME = "l.customer:account_id" VALUE = "{ l.businessaccount:id }">
	<MvELSEIF EXPR = "{ l.customer:account_id }">
		<MvIF EXPR = "{ NOT l.assigned }">	<MvASSIGN NAME = "l.customer:account_id" VALUE = 0>
		<MvELSE>							<MvASSIGN NAME = "l.customer:account_id" VALUE = "{ l.businessaccount:id }">
		</MvIF>
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Update( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ l.customer:account_id }">	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00028', 'Customer \'' $ l.customer:login $ '\' added to business account \'' $ l.businessaccount:title $ '\'' ) }">	
	<MvELSE>									<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00029', 'Customer \'' $ l.customer:login $ '\' removed from business account \'' $ l.businessaccount:title $ '\'' ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvCOMMENT>
|
| Customer Addresses
|
</MvCOMMENT>

<MvFUNCTION NAME = "JSON_CustomerAddress" PARAMETERS = "customeraddress var" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	"id":		<MvEVAL EXPR = "{ int( l.customeraddress:id ) }">,
	"cust_id":	<MvEVAL EXPR = "{ int( l.customeraddress:cust_id ) }">,
	"descrip":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:descrip ) }">",
	"fname":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:fname ) }">",
	"lname":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:lname ) }">",
	"email":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:email ) }">",
	"comp":		"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:comp ) }">",
	"phone":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:phone ) }">",
	"fax":		"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:fax ) }">",
	"addr1":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:addr1 ) }">",
	"addr2":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:addr2 ) }">",
	"city":		"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:city ) }">",
	"state":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:state ) }">",
	"zip":		"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:zip ) }">",
	"cntry":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.customeraddress:cntry ) }">",
	"resdntl":	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.customeraddress:resdntl ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerAddress_Loaders_Present" PARAMETERS = "" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Exists( 'Address_ID' ) }">					<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Exists( 'CustomerAddress_ID' ) }">		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 0>
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerAddress_Load" PARAMETERS = "customeraddress var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Retrieve_Integer( 'Address_ID', l.address_id ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].CustomerAddress_Load_ID( l.address_id, l.customeraddress ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00070', 'Customer Address not found' ) }">
		</MvIF>
	<MvELSEIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Retrieve_Integer( 'CustomerAddress_ID', l.address_id ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].CustomerAddress_Load_ID( l.address_id, l.customeraddress ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00071', 'Customer Address not found' ) }">
		</MvIF>
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-JSN-00072', 'Unable to load customer address: One of Address_ID or CustomerAddress_ID must be specified' ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerAddress_Load_Address" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN>	</MvIF>

	<MvIF EXPR = "{ NOT JSON_CustomerAddress_Load( l.address ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		<MvEVAL EXPR = "{ JSON_CustomerAddress( l.address ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerAddressList_Load_Query" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN> </MvIF>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.available_filters"	VALUE = "">
	<MvASSIGN NAME = "l.filter"				VALUE = "">
	<MvASSIGN NAME = "l.sort"				VALUE = "">
	<MvASSIGN NAME = "l.offset"				VALUE = 0>
	<MvASSIGN NAME = "l.count"				VALUE = 0>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'id',		'id' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'cust_id',	'cust_id' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'descrip',	'descrip' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'fname',	'fname' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'lname',	'lname' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'email',	'email' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'comp',	'comp' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'phone',	'phone' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'fax',		'fax' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'addr',	'addr1' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'addr2',	'addr2' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'city',	'city' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'state',	'state' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'zip',		'zip' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'cntry',	'cntry' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_BOOL(		l.available_filters, 'resdntl',	'resdntl' ) }">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Filter(	'o', 'Filter',	l.filter )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Sort',	l.sort )	OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Offset',	l.offset )	OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Count',	l.count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT( l.search_query, '*' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.search_query, g.Store_Table_Prefix $ 'CustomerAddresses', '' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.search_query, 'cust_id = ? ', [ g.Module_Library_DB ].SQL_Query_Field( l.customer:id ) ) }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Filter( l.search_query, l.filter, l.available_filters ) }">

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_OrderBy_Fields( l.search_query, l.sort,
																		'cust_id, id, descrip, fname, lname, email, comp, phone, fax, addr1:addr, addr2, city, state, zip, cntry, resdntl',
																		'id' ) }"> 

	<MvASSIGN NAME = "l.search_sql"	VALUE = "{ [ g.Module_Library_DB ].SQL_Query_Build( l.search_query, l.search_fields ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].SQL_Query_Count( l.search_query, l.total_count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'CustomerAddresses', l.search_sql, l.search_fields, l.offset, l.count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00033', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.address_count" VALUE = 0>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"total_count":	<MvEVAL EXPR = "{ int( l.total_count ) }">,
		"start_offset":	<MvEVAL EXPR = "{ int( l.offset ) }">,
		"data":
		[
		<MvWHILE EXPR = "{ ( NOT CustomerAddresses.d.EOF ) AND ( ( l.count EQ 0 ) OR ( l.address_count LT l.count ) ) }">
			<MvEVAL EXPR = "{ [ g.Feature_Filename_CUS_DB ].CustomerAddress_Read( l.customeraddress ) }">

			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_Start( l.address_count ) }">
			<MvEVAL EXPR = "{ JSON_CustomerAddress( l.customeraddress ) }">
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_End() }">

			<MvSKIP NAME = "Merchant" VIEW = "CustomerAddresses" ROWS = 1>
		</MvWHILE>
		]
	}
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerAddresses">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerAddressList_Load_Customer" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN> </MvIF>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customeraddress_count" VALUE = 0>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"ship_id": <MvEVAL EXPR = "{ int( l.customer:ship_id ) }">,
		"bill_id": <MvEVAL EXPR = "{ int( l.customer:bill_id ) }">,
		"addresses":
		[
		<MvFOREACH ITERATOR = "l.customeraddress" ARRAY = "l.customeraddresses" COUNT = "{ [ g.Feature_Filename_CUS_DB ].CustomerAddressList_Load_Customer( l.customer:id, l.customeraddresses ) }">
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_Start( l.customeraddress_count ) }">
			<MvEVAL EXPR = "{ JSON_CustomerAddress( l.customeraddress ) }">
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_End() }">
		</MvFOREACH>
		]
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerAddress_Insert" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>
	
	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customeraddress"			VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:cust_id"	VALUE = "{ l.customer:id }">
	<MvASSIGN NAME = "l.customeraddress:descrip"	VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:fname"		VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:lname"		VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:email"		VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:phone"		VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:fax"		VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:comp"		VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:addr1"		VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:addr2"		VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:city"		VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:state"		VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:zip"		VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:cntry"		VALUE = "">
	<MvASSIGN NAME = "l.customeraddress:resdntl"	VALUE = 0>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Description',		l.customeraddress:descrip )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'FirstName',		l.customeraddress:fname )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'LastName',		l.customeraddress:lname )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Email',			l.customeraddress:email )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Phone',			l.customeraddress:phone )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Fax',				l.customeraddress:fax )			OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Company',			l.customeraddress:comp )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Address1',		l.customeraddress:addr1 )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Address2',		l.customeraddress:addr2 )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'City',			l.customeraddress:city )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'State',			l.customeraddress:state )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Zip',				l.customeraddress:zip )			OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Country',			l.customeraddress:cntry )		OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'Residential',		l.customeraddress:resdntl ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StandardFields_Load( l.standardfields ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customeraddress:descrip }">
		<MvASSIGN NAME = "l.customeraddress:descrip" 	VALUE = "{ l.customeraddress:addr1 }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_StandardFields( l.standardfields, l.customeraddress ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00035', g.Validation_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_CUS_DB ].CustomerAddress_Load_AddressFields( l.customeraddress:cust_id, l.customeraddress, l.duplicate_address ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00036', 'Customer address already exists' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].CustomerAddress_Insert( l.customeraddress ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00037', 'Added customer address \'' $ l.customeraddress:id $ '\'' ) }">

	<MvASSIGN NAME = "l.update_customer" 				VALUE = 0>

	<MvIF EXPR = "{ NOT l.customer:ship_id }">
		<MvASSIGN NAME = "l.customer:ship_id" 			VALUE = "{ l.customeraddress:id }">
		<MvASSIGN NAME = "l.customer:ship_descrip"		VALUE = "{ l.customeraddress:descrip }">
		<MvASSIGN NAME = "l.customer:ship_fname"		VALUE = "{ l.customeraddress:fname }">
		<MvASSIGN NAME = "l.customer:ship_lname"		VALUE = "{ l.customeraddress:lname }">
		<MvASSIGN NAME = "l.customer:ship_email"		VALUE = "{ l.customeraddress:email }">
		<MvASSIGN NAME = "l.customer:ship_comp"			VALUE = "{ l.customeraddress:comp }">
		<MvASSIGN NAME = "l.customer:ship_phone"		VALUE = "{ l.customeraddress:phone }">
		<MvASSIGN NAME = "l.customer:ship_fax"			VALUE = "{ l.customeraddress:fax }">
		<MvASSIGN NAME = "l.customer:ship_addr"			VALUE = "">
		<MvASSIGN NAME = "l.customer:ship_addr1"		VALUE = "{ l.customeraddress:addr1 }">
		<MvASSIGN NAME = "l.customer:ship_addr2"		VALUE = "{ l.customeraddress:addr2 }">
		<MvASSIGN NAME = "l.customer:ship_city"			VALUE = "{ l.customeraddress:city }">
		<MvASSIGN NAME = "l.customer:ship_state"		VALUE = "{ l.customeraddress:state }">
		<MvASSIGN NAME = "l.customer:ship_zip"			VALUE = "{ l.customeraddress:zip }">
		<MvASSIGN NAME = "l.customer:ship_cntry"		VALUE = "{ l.customeraddress:cntry }">
		<MvASSIGN NAME = "l.customer:ship_res"			VALUE = "{ l.customeraddress:resdntl }">
		<MvASSIGN NAME = "l.update_customer" 			VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ NOT l.customer:bill_id }">
		<MvASSIGN NAME = "l.customer:bill_id" 			VALUE = "{ l.customeraddress:id }">
		<MvASSIGN NAME = "l.customer:bill_descrip"		VALUE = "{ l.customeraddress:descrip }">
		<MvASSIGN NAME = "l.customer:bill_fname"		VALUE = "{ l.customeraddress:fname }">
		<MvASSIGN NAME = "l.customer:bill_lname"		VALUE = "{ l.customeraddress:lname }">
		<MvASSIGN NAME = "l.customer:bill_email"		VALUE = "{ l.customeraddress:email }">
		<MvASSIGN NAME = "l.customer:bill_comp"			VALUE = "{ l.customeraddress:comp }">
		<MvASSIGN NAME = "l.customer:bill_phone"		VALUE = "{ l.customeraddress:phone }">
		<MvASSIGN NAME = "l.customer:bill_fax"			VALUE = "{ l.customeraddress:fax }">
		<MvASSIGN NAME = "l.customer:bill_addr"			VALUE = "">
		<MvASSIGN NAME = "l.customer:bill_addr1"		VALUE = "{ l.customeraddress:addr1 }">
		<MvASSIGN NAME = "l.customer:bill_addr2"		VALUE = "{ l.customeraddress:addr2 }">
		<MvASSIGN NAME = "l.customer:bill_city"			VALUE = "{ l.customeraddress:city }">
		<MvASSIGN NAME = "l.customer:bill_state"		VALUE = "{ l.customeraddress:state }">
		<MvASSIGN NAME = "l.customer:bill_zip"			VALUE = "{ l.customeraddress:zip }">
		<MvASSIGN NAME = "l.customer:bill_cntry"		VALUE = "{ l.customeraddress:cntry }">
		<MvASSIGN NAME = "l.update_customer" 			VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ l.update_customer }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Update( l.customer ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>
	<MvELSE>
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Update_LastUpdated( l.customer:id ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		<MvEVAL EXPR = "{ JSON_CustomerAddress( l.customeraddress ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerAddress_Update" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	<MvELSEIF EXPR = "{ NOT JSON_CustomerAddress_Load( l.customeraddress ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	<MvELSEIF EXPR = "{ l.customer:id NE l.customeraddress:cust_id }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00038', 'Customer address not found' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Description',		l.customeraddress:descrip )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'FirstName',		l.customeraddress:fname )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'LastName',		l.customeraddress:lname )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Email',			l.customeraddress:email )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Phone',			l.customeraddress:phone )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Fax',				l.customeraddress:fax )			OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Company',			l.customeraddress:comp )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Address1',		l.customeraddress:addr1 )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Address2',		l.customeraddress:addr2 )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'City',			l.customeraddress:city )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'State',			l.customeraddress:state )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Zip',				l.customeraddress:zip )			OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Country',			l.customeraddress:cntry )		OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'Residential',		l.customeraddress:resdntl ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StandardFields_Load( l.standardfields ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customeraddress:descrip }">
		<MvASSIGN NAME = "l.customeraddress:descrip" 	VALUE = "{ l.customeraddress:addr1 }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_StandardFields( l.standardfields, l.customeraddress ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00039', g.Validation_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_CUS_DB ].CustomerAddress_Load_AddressFields( l.customeraddress:cust_id, l.customeraddress, l.duplicate_address ) }">
		<MvIF EXPR = "{ l.customeraddress:id NE l.duplicate_address:id }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00040', 'Customer address already exists' ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].CustomerAddress_Update( l.customeraddress ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00041', 'Customer address updated \'' $ l.customeraddress:id $ '\'' ) }">

	<MvASSIGN NAME = "l.update_customer" 				VALUE = 0>

	<MvIF EXPR = "{ l.customeraddress:id EQ l.customer:ship_id }">
		<MvASSIGN NAME = "l.customer:ship_descrip"		VALUE = "{ l.customeraddress:descrip }">
		<MvASSIGN NAME = "l.customer:ship_fname"		VALUE = "{ l.customeraddress:fname }">
		<MvASSIGN NAME = "l.customer:ship_lname"		VALUE = "{ l.customeraddress:lname }">
		<MvASSIGN NAME = "l.customer:ship_email"		VALUE = "{ l.customeraddress:email }">
		<MvASSIGN NAME = "l.customer:ship_comp"			VALUE = "{ l.customeraddress:comp }">
		<MvASSIGN NAME = "l.customer:ship_phone"		VALUE = "{ l.customeraddress:phone }">
		<MvASSIGN NAME = "l.customer:ship_fax"			VALUE = "{ l.customeraddress:fax }">
		<MvASSIGN NAME = "l.customer:ship_addr"			VALUE = "">
		<MvASSIGN NAME = "l.customer:ship_addr1"		VALUE = "{ l.customeraddress:addr1 }">
		<MvASSIGN NAME = "l.customer:ship_addr2"		VALUE = "{ l.customeraddress:addr2 }">
		<MvASSIGN NAME = "l.customer:ship_city"			VALUE = "{ l.customeraddress:city }">
		<MvASSIGN NAME = "l.customer:ship_state"		VALUE = "{ l.customeraddress:state }">
		<MvASSIGN NAME = "l.customer:ship_zip"			VALUE = "{ l.customeraddress:zip }">
		<MvASSIGN NAME = "l.customer:ship_cntry"		VALUE = "{ l.customeraddress:cntry }">
		<MvASSIGN NAME = "l.customer:ship_res"			VALUE = "{ l.customeraddress:resdntl }">
		<MvASSIGN NAME = "l.update_customer" 			VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ l.customeraddress:id EQ l.customer:bill_id }">
		<MvASSIGN NAME = "l.customer:bill_descrip"		VALUE = "{ l.customeraddress:descrip }">
		<MvASSIGN NAME = "l.customer:bill_fname"		VALUE = "{ l.customeraddress:fname }">
		<MvASSIGN NAME = "l.customer:bill_lname"		VALUE = "{ l.customeraddress:lname }">
		<MvASSIGN NAME = "l.customer:bill_email"		VALUE = "{ l.customeraddress:email }">
		<MvASSIGN NAME = "l.customer:bill_comp"			VALUE = "{ l.customeraddress:comp }">
		<MvASSIGN NAME = "l.customer:bill_phone"		VALUE = "{ l.customeraddress:phone }">
		<MvASSIGN NAME = "l.customer:bill_fax"			VALUE = "{ l.customeraddress:fax }">
		<MvASSIGN NAME = "l.customer:bill_addr"			VALUE = "">
		<MvASSIGN NAME = "l.customer:bill_addr1"		VALUE = "{ l.customeraddress:addr1 }">
		<MvASSIGN NAME = "l.customer:bill_addr2"		VALUE = "{ l.customeraddress:addr2 }">
		<MvASSIGN NAME = "l.customer:bill_city"			VALUE = "{ l.customeraddress:city }">
		<MvASSIGN NAME = "l.customer:bill_state"		VALUE = "{ l.customeraddress:state }">
		<MvASSIGN NAME = "l.customer:bill_zip"			VALUE = "{ l.customeraddress:zip }">
		<MvASSIGN NAME = "l.customer:bill_cntry"		VALUE = "{ l.customeraddress:cntry }">
		<MvASSIGN NAME = "l.update_customer" 			VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ l.update_customer }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Update( l.customer ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>
	<MvELSE>
		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Update_LastUpdated( l.customer:id ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerAddress_SetAsDefault" PARAMETERS = "" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvIF EXPR = "{ NOT JSON_CustomerAddress_Load( l.address ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Load_ID( l.address:cust_id, l.customer ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00079', 'Failed to load customer' ) }">
	</MvIF>

	<MvASSIGN NAME = "l.set_as_shipping"				VALUE = 0>
	<MvASSIGN NAME = "l.set_as_billing"					VALUE = 0>
	<MvASSIGN NAME = "l.update_customer" 				VALUE = 0>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Boolean( 'O', 'SetAsShipping',	l.set_as_shipping ) OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean( 'O', 'SetAsBilling',	l.set_as_billing ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ l.set_as_shipping }">
		<MvASSIGN NAME = "l.update_customer" 			VALUE = 1>

		<MvASSIGN NAME = "l.customer:ship_id"			VALUE = "{ l.address:id }">
		<MvASSIGN NAME = "l.customer:ship_descrip"		VALUE = "{ l.address:descrip }">
		<MvASSIGN NAME = "l.customer:ship_fname"		VALUE = "{ l.address:fname }">
		<MvASSIGN NAME = "l.customer:ship_lname"		VALUE = "{ l.address:lname }">
		<MvASSIGN NAME = "l.customer:ship_email"		VALUE = "{ l.address:email }">
		<MvASSIGN NAME = "l.customer:ship_comp"			VALUE = "{ l.address:comp }">
		<MvASSIGN NAME = "l.customer:ship_phone"		VALUE = "{ l.address:phone }">
		<MvASSIGN NAME = "l.customer:ship_fax"			VALUE = "{ l.address:fax }">
		<MvASSIGN NAME = "l.customer:ship_addr"			VALUE = "">
		<MvASSIGN NAME = "l.customer:ship_addr1"		VALUE = "{ l.address:addr1 }">
		<MvASSIGN NAME = "l.customer:ship_addr2"		VALUE = "{ l.address:addr2 }">
		<MvASSIGN NAME = "l.customer:ship_city"			VALUE = "{ l.address:city }">
		<MvASSIGN NAME = "l.customer:ship_state"		VALUE = "{ l.address:state }">
		<MvASSIGN NAME = "l.customer:ship_zip"			VALUE = "{ l.address:zip }">
		<MvASSIGN NAME = "l.customer:ship_cntry"		VALUE = "{ l.address:cntry }">
		<MvASSIGN NAME = "l.customer:ship_res"			VALUE = "{ l.address:resdntl }">
	</MvIF>

	<MvIF EXPR = "{ l.set_as_billing }">
		<MvASSIGN NAME = "l.update_customer" 			VALUE = 1>

		<MvASSIGN NAME = "l.customer:bill_id"			VALUE = "{ l.address:id }">
		<MvASSIGN NAME = "l.customer:bill_descrip"		VALUE = "{ l.address:descrip }">
		<MvASSIGN NAME = "l.customer:bill_fname"		VALUE = "{ l.address:fname }">
		<MvASSIGN NAME = "l.customer:bill_lname"		VALUE = "{ l.address:lname }">
		<MvASSIGN NAME = "l.customer:bill_email"		VALUE = "{ l.address:email }">
		<MvASSIGN NAME = "l.customer:bill_comp"			VALUE = "{ l.address:comp }">
		<MvASSIGN NAME = "l.customer:bill_phone"		VALUE = "{ l.address:phone }">
		<MvASSIGN NAME = "l.customer:bill_fax"			VALUE = "{ l.address:fax }">
		<MvASSIGN NAME = "l.customer:bill_addr"			VALUE = "">
		<MvASSIGN NAME = "l.customer:bill_addr1"		VALUE = "{ l.address:addr1 }">
		<MvASSIGN NAME = "l.customer:bill_addr2"		VALUE = "{ l.address:addr2 }">
		<MvASSIGN NAME = "l.customer:bill_city"			VALUE = "{ l.address:city }">
		<MvASSIGN NAME = "l.customer:bill_state"		VALUE = "{ l.address:state }">
		<MvASSIGN NAME = "l.customer:bill_zip"			VALUE = "{ l.address:zip }">
		<MvASSIGN NAME = "l.customer:bill_cntry"		VALUE = "{ l.address:cntry }">
		<MvASSIGN NAME = "l.customer:bill_res"			VALUE = "{ l.address:resdntl }">
	</MvIF>

	<MvIF EXPR = "{ l.update_customer }">
		<MvIF EXPR = "{ NOT [ g.Feature_Filename_CUS_DB ].Customer_Update( l.customer ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>

		<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00078', 'Customer \'' $ l.customer:login $ '\' updated' ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerAddress_Delete" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ JSON_CustomerAddress_Load( l.customeraddress ) }">
		<MvIF EXPR = "{ l.customer:id NE l.customeraddress:cust_id }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00042', 'Customer address not found' ) }">
		</MvIF>

		<MvIF EXPR = "{ NOT [ g.Module_Feature_SUB_DB ].Subscription_Count_Active_CustomerAddress( l.customer:id, l.customeraddress:id, l.count ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		<MvELSEIF EXPR = "{ l.count GT 0 }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00054', 'Customer Address is associated with a subscription and cannot be removed.' ) }">
		<MvELSEIF EXPR = "{ NOT [ g.Module_Feature_SUB_DB ].Subscription_Update_All_CustomerAddress( l.customer:id, l.customeraddress:id, 0 ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>

		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].CustomerAddress_Delete( l.customeraddress:id ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">	
		</MvIF>

		<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00044', 'Deleted customer address id \'' $ g.CustomerAddress_ID $ '\'' ) }">

		<MvIF EXPR = "{ ( l.customeraddress:id EQ l.customer:ship_id ) OR ( l.customeraddress:id EQ l.customer:bill_id ) }">
			<MvASSIGN NAME = "l.customer_ship_updated" 		VALUE = 0>
			<MvASSIGN NAME = "l.customer_bill_updated" 		VALUE = 0>

			<MvIF EXPR = "{ l.customeraddress:id EQ l.customer:ship_id }">
				<MvASSIGN NAME = "l.customer:ship_id" 		VALUE = 0>
				<MvASSIGN NAME = "l.customer:ship_descrip"	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_fname" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_lname" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_email" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_phone" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_fax" 		VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_comp" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_addr" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_addr1" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_addr2"	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_city"		VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_state"	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_zip"		VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_cntry"	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_res"		VALUE = 0>

				<MvASSIGN NAME = "l.customer_ship_updated" 	VALUE = 1>
			</MvIF>

			<MvIF EXPR = "{ l.customeraddress:id EQ l.customer:bill_id }">
				<MvASSIGN NAME = "l.customer:bill_id" 		VALUE = 0>
				<MvASSIGN NAME = "l.customer:bill_descrip"	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_fname" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_lname" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_email" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_phone" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_fax" 		VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_comp" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_addr" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_addr1" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_addr2"	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_city"		VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_state"	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_zip"		VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_cntry"	VALUE = "">

				<MvASSIGN NAME = "l.customer_bill_updated" 	VALUE = 1>
			</MvIF>

			<MvIF EXPR = "{ NOT [ g.Feature_Filename_CUS_DB ].Customer_Update( l.customer ) }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">	
			</MvIF>
			
			<MvIF EXPR = "{ l.customer_ship_updated }"><MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00050', 'Customer \'' $ l.customer:id $ '\' default ship address deleted' ) }"></MvIF>
			<MvIF EXPR = "{ l.customer_bill_updated }"><MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00051', 'Customer \'' $ l.customer:id $ '\' default bill address deleted' ) }"></MvIF>
		<MvELSE>
			<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Update_LastUpdated( l.customer:id ) }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>
		</MvIF>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerAddressList_Delete" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvASSIGN NAME = "l.processed" 		VALUE = 0>
	<MvASSIGN NAME = "l.error_count" 	VALUE = 0>
	<MvASSIGN NAME = "l.errors" 		VALUE = "">
	<MvASSIGN NAME = "l.start_time" 	VALUE = "{ s.dyn_time_t }">

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>
	
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Integer_Array( 'R', 'CustomerAddress_IDs', l.customeraddress_ids, l.customeraddress_id_count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvFOREACH ITERATOR = "l.customeraddress_id" ARRAY = "l.customeraddress_ids" COUNT = "{ l.customeraddress_id_count }">
		<MvASSIGN NAME = "l.processed" 				VALUE = "{ l.processed + 1 }">

		<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].CustomerAddress_Load( l.customer:id, l.customeraddress_id, l.customeraddress ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>
		<MvELSE>
			<MvIF EXPR = "{ NOT [ g.Module_Feature_SUB_DB ].Subscription_Count_Active_CustomerAddress( l.customer:id, l.customeraddress:id, l.count ) }">
				<MvASSIGN NAME = "l.error_count" VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Error( l.paymentcard:id, g.Error_Code, g.Error_Message, l.errors ) }">
				<MvFOREACHCONTINUE>
			<MvELSEIF EXPR = "{ l.count GT 0 }">
				<MvASSIGN NAME = "l.error_count" VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Error( l.customeraddress:id, 'MER-CUS-JSN-00055', 'Customer Address is associated with a subscription and cannot be removed.', l.errors ) }">
				<MvFOREACHCONTINUE>
			<MvELSEIF EXPR = "{ NOT [ g.Module_Feature_SUB_DB ].Subscription_Update_All_CustomerAddress( l.customer:id, l.customeraddress:id, 0 ) }">
				<MvASSIGN NAME = "l.error_count" VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Error( l.paymentcard:id, g.Error_Code, g.Error_Message, l.errors ) }">
				<MvFOREACHCONTINUE>
			</MvIF>

			<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].CustomerAddress_Delete( l.customeraddress:id ) }">
				<MvASSIGN NAME = "l.error_count" VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Error( l.customeraddress:id, g.Error_Code, g.Error_Message, l.errors ) }">
			<MvELSE>
				<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00046', 'Customer address \'' $ l.customeraddress:id $ '\' deleted' ) }">
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ ( l.customeraddress:id EQ l.customer:ship_id ) OR ( l.customeraddress:id EQ l.customer:bill_id ) }">
			<MvASSIGN NAME = "l.customer_ship_updated" 		VALUE = 0>
			<MvASSIGN NAME = "l.customer_bill_updated" 		VALUE = 0>

			<MvIF EXPR = "{ l.customeraddress:id EQ l.customer:ship_id }">
				<MvASSIGN NAME = "l.customer:ship_id" 		VALUE = 0>
				<MvASSIGN NAME = "l.customer:ship_descrip"	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_fname" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_lname" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_email" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_phone" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_fax" 		VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_comp" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_addr" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_addr1" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_addr2"	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_city"		VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_state"	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_zip"		VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_cntry"	VALUE = "">
				<MvASSIGN NAME = "l.customer:ship_res"		VALUE = 0>

				<MvASSIGN NAME = "l.customer_ship_updated" 	VALUE = 1>
			</MvIF>

			<MvIF EXPR = "{ l.customeraddress:id EQ l.customer:bill_id }">
				<MvASSIGN NAME = "l.customer:bill_id" 		VALUE = 0>
				<MvASSIGN NAME = "l.customer:bill_descrip"	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_fname" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_lname" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_email" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_phone" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_fax" 		VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_comp" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_addr" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_addr1" 	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_addr2"	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_city"		VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_state"	VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_zip"		VALUE = "">
				<MvASSIGN NAME = "l.customer:bill_cntry"	VALUE = "">

				<MvASSIGN NAME = "l.customer_bill_updated" 	VALUE = 1>
			</MvIF>

			<MvIF EXPR = "{ NOT [ g.Feature_Filename_CUS_DB ].Customer_Update( l.customer ) }">
				<MvASSIGN NAME = "l.error_count" VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Error( l.customeraddress_id, g.Error_Code, g.Error_Message, l.errors ) }">
			<MvELSE>
				<MvIF EXPR = "{ l.customer_ship_updated }"><MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00052', 'Customer \'' $ l.customer:id $ '\' default ship address deleted' ) }"></MvIF>
				<MvIF EXPR = "{ l.customer_bill_updated }"><MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-CUS-JSN-00053', 'Customer \'' $ l.customer:id $ '\' default bill address deleted' ) }"></MvIF>
			</MvIF>
		<MvELSE>
			<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Update_LastUpdated( l.customer:id ) }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ ( s.dyn_time_t - l.start_time ) GE 60 }">								<MvFOREACHSTOP>
		<MvELSEIF EXPR = "{ ( s.dyn_time_remaining GE 0 ) AND ( s.dyn_time_remaining LE 3 ) }">	<MvFOREACHSTOP>
		</MvIF>
	</MvFOREACH>

	<MvIF EXPR = "{ l.error_count }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Errors( l.processed, l.errors ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_ListProcessed_Success( l.processed ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_CustomerAddress_Update_Residential" PARAMETERS = "" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>																	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'CUST', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Access_Denied() }">	</MvIF>

	<MvIF EXPR = "{ NOT JSON_CustomerAddress_Load( l.customeraddress ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Boolean( 'R', 'Residential', l.customeraddress:resdntl ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Feature_Filename_CUS_DB ].CustomerAddress_Update( l.customeraddress ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Update_LastUpdated( l.customeraddress:cust_id ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvCOMMENT>
|
| Customer Price Groups
|
</MvCOMMENT>

<MvFUNCTION NAME = "JSON_CustomerPriceGroupList_Load_Query" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">					<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'PGRP', 1, 0, 0, 0 ) }">		<MvFUNCTIONRETURN>	</MvIF>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.available_filters"	VALUE = "">
	<MvASSIGN NAME = "l.filter"				VALUE = "">
	<MvASSIGN NAME = "l.sort"				VALUE = "">
	<MvASSIGN NAME = "l.offset"				VALUE = 0>
	<MvASSIGN NAME = "l.count"				VALUE = 0>
	<MvASSIGN NAME = "l.assigned"			VALUE = 1>
	<MvASSIGN NAME = "l.unassigned"			VALUE = 0>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'pg.id',			'id' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'pg.name',			'name' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'pg.module_id',	'module_id' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'pg.custscope',	'custscope' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'pg.rate',			'rate' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'pg.discount',		'discount' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'pg.markup',		'markup' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_RFC3339(	l.available_filters, 'pg.dt_start',		'dt_start' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_RFC3339(	l.available_filters, 'pg.dt_end',		'dt_end' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'pg.priority',		'priority' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_BOOL(		l.available_filters, 'pg.exclusion',	'exclusion' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_CHAR(		l.available_filters, 'pg.descrip',		'descrip' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_BOOL(		l.available_filters, 'pg.display',		'display' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'pg.qmn_subtot',	'qmn_subtot' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'pg.qmx_subtot',	'qmx_subtot' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'pg.qmn_quan',		'qmn_quan' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'pg.qmx_quan',		'qmx_quan' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'pg.qmn_weight',	'qmn_weight' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'pg.qmx_weight',	'qmx_weight' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'pg.bmn_subtot',	'bmn_subtot' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'pg.bmx_subtot',	'bmx_subtot' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'pg.bmn_quan',		'bmn_quan' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_INTEGER(	l.available_filters, 'pg.bmx_quan',		'bmx_quan' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'pg.bmn_weight',	'bmn_weight' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_NUMBER(	l.available_filters, 'pg.bmx_weight',	'bmx_weight' ) }">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Filter(	'o', 'Filter',		l.filter )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Sort',		l.sort )		OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Offset',		l.offset )		OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Count',		l.count )		OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'Assigned',	l.assigned )	OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'Unassigned',	l.unassigned ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvASSIGN NAME = "l.search_query"	VALUE = "">

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT( l.search_query,	'pg.*,
																				 m.id			AS module_id,
																				 m.code			AS module_code,
																				 m.name			AS module_name,
																				 m.provider		AS module_provider,
																				 m.api_ver		AS module_api_ver,
																				 m.version		AS module_version,
																				 m.module		AS module_module,
																				 m.refcount		AS module_refcount,
																				 m.active		AS module_active,
																				 m.priority		AS module_priority,
																				 pgxc.pgrp_id	AS assigned' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT_NULL_CHAR( l.search_query, 'm.name', 'type' ) }">

	<MvIF EXPR = "{ l.assigned AND ( NOT l.unassigned ) }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.search_query,	g.Store_Table_Prefix $ 'PriceGroupXCustomer',	'pgxc' ) }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.search_query,	g.Store_Table_Prefix $ 'PriceGroups',			'pg' ) }">

		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.search_query,	'pgxc.cust_id = ? AND pg.id = pgxc.pgrp_id', [ g.Module_Library_DB ].SQL_Query_Field( l.customer:id ) ) }">
	<MvELSEIF EXPR = "{ l.assigned OR l.unassigned }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.search_query,	g.Store_Table_Prefix $ 'PriceGroups',			'pg' ) }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.search_query, 'pg', g.Store_Table_Prefix $ 'PriceGroupXCustomer', 'pgxc', 'pgxc.cust_id = ? AND pg.id = pgxc.pgrp_id', [ g.Module_Library_DB ].SQL_Query_Field( l.customer:id ) ) }">

		<MvIF EXPR = "{ NOT l.assigned }">
			<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.search_query,	'pgxc.pgrp_id IS NULL', '' ) }">
		</MvIF>
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.search_query, 'pg', 'Modules', 'm', 'pg.module_id = m.id', '' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.search_query,	'pg.custscope = \'X\'', '' ) }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Filter( l.search_query, l.filter, l.available_filters ) }">

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_OrderBy_Fields( l.search_query, l.sort,
																		'id:pg.id,name:pg.name,type:m.name:null_char,custscope:pg.custscope,rate:pg.rate,discount:pg.discount,markup:pg.markup,
																		 dt_start:pg.dt_start,dt_end:pg.dt_end,priority:pg.priority;-pg.id,exclusion:pg.exclusion,descrip:pg.descrip,display:pg.display,
																		 qualifying_subtotal:pg.qmn_subtot,qualifying_quantity:pg.qmn_quan,qualifying_weight:pg.qmn_weight,
																		 basket_quantity:pg.bmn_quan,basket_subtotal:pg.bmn_subtot,basket_weight:pg.bmn_weight',
																		'-pg.priority;pg.id' ) }">

	<MvASSIGN NAME = "l.search_sql"	VALUE = "{ [ g.Module_Library_DB ].SQL_Query_Build( l.search_query, l.search_fields ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].SQL_Query_Count( l.search_query, l.total_count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'PriceGroups', l.search_sql, l.search_fields, l.offset, l.count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00047', g.MvOPENVIEW_Error ) }">
	</MvIF>
	
	<MvASSIGN NAME = "l.customer_count" VALUE = 0>
	
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"total_count":	<MvEVAL EXPR = "{ int( l.total_count ) }">,
		"start_offset":	<MvEVAL EXPR = "{ int( l.offset ) }">,
		"data":
		[
		<MvWHILE EXPR = "{ ( NOT PriceGroups.d.EOF ) AND ( ( l.count EQ 0 ) OR ( l.pricegroup_count LT l.count ) ) }">
			<MvEVAL EXPR = "{ [ g.Module_Feature_PGR_DB ].PriceGroupAndModule_Read( l.pricegroup ) }">

			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_Start( l.pricegroup_count ) }">
			<MvEVAL EXPR = "{ [ g.Module_Feature_PGR_JSON ].JSON_PriceGroup( l.pricegroup ) }">
			, "assigned":	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( PriceGroups.d.assigned ) }">
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_End() }">

			<MvSKIP NAME = "Merchant" VIEW = "PriceGroups" ROWS = 1>
		</MvWHILE>
		]
	}
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "PriceGroups">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvCOMMENT>
|
| Customer Availability Groups
|
</MvCOMMENT>

<MvFUNCTION NAME = "JSON_CustomerAvailabilityGroupList_Load_Query" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'AGRP', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN> </MvIF>

	<MvASSIGN NAME = "l.search_query"	VALUE = "">
	<MvASSIGN NAME = "l.filter"			VALUE = "">
	<MvASSIGN NAME = "l.sort"			VALUE = "">
	<MvASSIGN NAME = "l.offset"			VALUE = "">
	<MvASSIGN NAME = "l.count"			VALUE = "">
	<MvASSIGN NAME = "l.assigned"		VALUE = 1>
	<MvASSIGN NAME = "l.unassigned"		VALUE = 0>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Filter(	'o', 'Filter',		l.filter )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o', 'Sort',		l.sort )		OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Offset',		l.offset )		OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o', 'Count',		l.count )		OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'Assigned',	l.assigned )	OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'o', 'Unassigned',	l.unassigned ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT( l.search_query,	'ag.*,
																				 agxc.agrp_id AS assigned' ) }">

	<MvIF EXPR = "{ l.assigned AND ( NOT l.unassigned ) }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.search_query,	g.Store_Table_Prefix $ 'AvailGroupXCustomer',	'agxc' ) }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.search_query,	g.Store_Table_Prefix $ 'AvailabilityGroups',	'ag' ) }">

		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.search_query,	'agxc.cust_id = ? AND ag.id = agxc.agrp_id', [ g.Module_Library_DB ].SQL_Query_Field( l.customer:id ) ) }">
	<MvELSEIF EXPR = "{ l.assigned OR l.unassigned }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.search_query,	g.Store_Table_Prefix $ 'AvailabilityGroups',	'ag' ) }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.search_query, 'ag', g.Store_Table_Prefix $ 'AvailGroupXCustomer', 'agxc', 'agxc.cust_id = ? AND ag.id = agxc.agrp_id', [ g.Module_Library_DB ].SQL_Query_Field( l.customer:id ) ) }">

		<MvIF EXPR = "{ NOT l.assigned }">
			<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.search_query,	'agxc.agrp_id IS NULL', '' ) }">
		</MvIF>
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Filter( l.search_query, l.filter, [ g.Module_Feature_AGR_JSON ].JSON_BaseAvailabilityGroupList_Filters() ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_OrderBy( l.search_query, l.sort, [ g.Module_Feature_AGR_JSON ].JSON_BaseAvailabilityGroupList_OrderBy(), 'ag.id' ) }">

	<MvASSIGN NAME = "l.search_sql"	VALUE = "{ [ g.Module_Library_DB ].SQL_Query_Build( l.search_query, l.search_fields ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].SQL_Query_Count( l.search_query, l.total_count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'AvailabilityGroups', l.search_sql, l.search_fields, l.offset, l.count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00081', g.MvOPENVIEW_Error ) }">
	</MvIF>
	
	<MvASSIGN NAME = "l.availabilitygroup_count" VALUE = 0>
	
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"total_count":	<MvEVAL EXPR = "{ encodejavascriptnumber( l.total_count ) }">,
		"start_offset":	<MvEVAL EXPR = "{ encodejavascriptnumber( l.offset ) }">,
		"data":
		[
		<MvWHILE EXPR = "{ ( NOT AvailabilityGroups.d.EOF ) AND ( ( l.count EQ 0 ) OR ( l.availabilitygroup_count LT l.count ) ) }">
			<MvEVAL EXPR = "{ [ g.Module_Feature_AGR_DB ].AvailabilityGroup_Read( l.availabilitygroup ) }">

			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_Start( l.availabilitygroup_count ) }">
				<MvEVAL EXPR = "{ [ g.Module_Feature_AGR_JSON ].JSON_AvailabilityGroup( l.availabilitygroup ) }">
				, "assigned": <MvEVAL EXPR = "{ encodejavascriptboolean( AvailabilityGroups.d.assigned ) }">
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_End() }">

			<MvSKIP NAME = "Merchant" VIEW = "AvailabilityGroups" ROWS = 1>
		</MvWHILE>
		]
	}
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "AvailabilityGroups">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvCOMMENT>
|
| Shop As Customer
|
</MvCOMMENT>

<MvFUNCTION NAME = "JSON_ShopAsCustomer_MostRecentBasket_Load_Customer" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'SHOP', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN> </MvIF>

	<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT(		l.query, 'session_id' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM(		l.query, g.Store_Table_Prefix $ 'Baskets', '' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE(		l.query, 'cust_id = ?',		[ g.Module_Library_DB ].SQL_Query_Field( l.customer:id ) ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE(		l.query, 'lastupdate > ?',	[ g.Module_Library_DB ].SQL_Query_Field( s.dyn_time_t - ( g.Store:baskexp * 60 ) ) ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_ORDER_BY(	l.query, 'lastupdate', 'DESC' ) }">

	<MvASSIGN NAME = "l.sql" VALUE = "{ [ g.Module_Library_DB ].SQL_Query_Build( l.query, l.fields ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'ShopAsCustomer', l.sql, l.fields, 0, 1 ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00067', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"basket_session_id": "<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( ShopAsCustomer.d.session_id ) }">"
	}
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "ShopAsCustomer">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_ShopAsCustomer_CreateOrShareSession" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'SHOP', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN> </MvIF>

	<MvIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Exists( 'Basket_Session_ID' ) }">
		<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Text( 'R', 'Basket_Session_ID', l.basket_session_id ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
		</MvIF>

		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Basket_Load_Session( l.basket_session_id, l.basket ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00068', 'Failed to load basket session' ) }">
		</MvIF>

		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'shopascustomer_session_shared', 1 ) }">
	<MvELSE>
		<MvIF EXPR = "{ NOT JSON_Customer_Load( l.customer ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>

		<MvASSIGN NAME = "l.basket"				VALUE = "">
		<MvASSIGN NAME = "l.basket:session_id" 	VALUE = "{ MakeSessionID() }">
		<MvASSIGN NAME = "l.basket:cussess_id" 	VALUE = "{ MakeSessionID() }">
		<MvASSIGN NAME = "l.basket:order_id"	VALUE = 0>
		<MvASSIGN NAME = "l.basket:order_proc"	VALUE = 0>
		<MvASSIGN NAME = "l.basket:ship_id"		VALUE = 0>
		<MvASSIGN NAME = "l.basket:lastupdate"	VALUE = "{ s.dyn_time_t }">
		<MvASSIGN NAME = "l.basket:cust_id"	 	VALUE = "{ l.customer:id }">

		<MvIF EXPR = "{ NOT [ g.Feature_Filename_CUS_UT ].TaxExempt_Load_Customer( l.customer, l.basket:tax_exempt ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>

		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Basket_Insert( l.basket ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>

		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'shopascustomer_session_new', 1 ) }">
	</MvIF>

	<MvASSIGN NAME = "l.shopascustomersession"				VALUE = "">
	<MvASSIGN NAME = "l.shopascustomersession:session_id"	VALUE = "{ MakeSessionID() }">
	<MvASSIGN NAME = "l.shopascustomersession:admsess_id"	VALUE = "{ g.Session_ID }">
	<MvASSIGN NAME = "l.shopascustomersession:user_id"		VALUE = "{ g.User:id }">
	<MvASSIGN NAME = "l.shopascustomersession:store_id"		VALUE = "{ g.Store:id }">
	<MvASSIGN NAME = "l.shopascustomersession:basket_id"	VALUE = "{ l.basket:basket_id }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].ShopAsCustomerSession_Delete_AdminSession( g.Session_ID ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].ShopAsCustomerSession_Insert( l.shopascustomersession ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.flags"				VALUE = "">
	<MvASSIGN NAME = "l.flags:nosession"	VALUE = 1>
	<MvASSIGN NAME = "l.flags:secure"		VALUE = 1>
	<MvASSIGN NAME = "l.flags:sep"			VALUE = 1>
	<MvASSIGN NAME = "l.redirect_url"		VALUE = "{ [ g.Module_Feature_URI_UT ].Store_Page_Code_URL( 'SFNT', l.flags ) }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"session_id":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.shopascustomersession:session_id ) }">",
		"redirect_url":	"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.redirect_url $ 'Session_ID=' $ encodeattribute( l.basket:session_id ) ) }">"
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_ShopAsCustomer_DeleteSession" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">	<MvFUNCTIONRETURN> </MvIF>

	<MvIF EXPR = "{ NOT [ g.Feature_Filename_CUS_DB ].ShopAsCustomerSession_Delete_AdminSession( g.Session_ID ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Runtime_ShopAsCustomer_Cookie_Set" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">						<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Runtime_CORS_Preflight_Headers() }">	<MvFUNCTIONRETURN> </MvIF>

	<MvIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Retrieve( 'Session_ID', l.shopascustomer_session_id ) }">
		<MvIF EXPR = "{ [ g.Feature_Filename_CUS_DB ].ShopAsCustomerSession_Load_Session( l.shopascustomer_session_id, l.shopascustomersession ) AND
						l.shopascustomersession:store_id EQ g.Store:id }">
			<MvIF EXPR = "{ [ g.Module_Library_DB ].Basket_Load_ID( l.shopascustomersession:basket_id, l.basket ) }">
				<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Feature_FileName_CUS_UT ].ShopAsCustomer_SetCookies( l.basket, l.shopascustomersession ) }">
			</MvIF>
		</MvIF>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Runtime_ShopAsCustomer_Cookie_Clear" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">						<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Runtime_CORS_Preflight_Headers() }">	<MvFUNCTIONRETURN> </MvIF>

	<MvREFERENCEARRAY NAME = "l.shopascustomer_session_id" VARIABLE = "g.Request_Cookies">
		<MvMEMBER NAME = "{ 'mm5-' $ [ g.Module_Library_Utilities ].AlphaNumericOnly( g.Store:code ) $ '-shopascustomer-session' }">
	</MvREFERENCEARRAY>

	<MvIF EXPR = "{ NOT ISNULL l.shopascustomer_session_id }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Feature_Filename_CUS_DB ].ShopAsCustomerSession_Delete_Session( l.shopascustomer_session_id ) }">
	</MvIF>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Feature_FileName_CUS_UT ].ShopAsCustomer_ClearCookies() }">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_Address_Validate" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT g.Store:addrval_id }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00076', 'Address validation is not configured' ) }">
	</MvIF>

	<MvASSIGN NAME = "l.address" VALUE = "">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Company', 		l.address:comp )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Address1', 		l.address:addr1 )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Address2', 		l.address:addr2 )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'City', 			l.address:city )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'State', 			l.address:state )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Zip', 			l.address:zip )		OR
					NOT [ g.Module_JSON ].JSON_Input_Text( 		'o', 'Country', 		l.address:cntry )	OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(	'O', 'Residential', 	l.address:resdntl ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Module_Load_ID( g.Store:addrval_id, l.address_module ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00077', 'Unable to load address validation module' ) }">
	<MvELSEIF EXPR = "{ NOT l.address_module:active }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00074', 'Module \'' $ l.address_module:name $ '\' has been deactivated' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Module_Load_Features( l.address_module ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT l.address_module:feature_hash:addrval }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-CUS-JSN-00075', 'Module \'' $ l.address_module:code $ '\' does not provide the addrval feature' ) }">
	</MvIF>

	<MvASSIGN NAME = "l.count" 					VALUE = 0>
	<MvASSIGN NAME = "l.address_count" 			VALUE = "{ [ g.Module_Root $ l.address_module:module ].AddressValidationModule_Validate_Address( l.address_module, l.address, l.verified_addresses ) }">

	<MvIF EXPR = "{ l.address_count EQ 0 }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	[
		<MvFOREACH ITERATOR = "l.address" ARRAY = "l.verified_addresses" COUNT = "{ l.address_count }">
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_Start( l.count ) }">
				"addr1":		"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.address:addr1 ) }">",
				"addr2":		"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.address:addr2 ) }">",
				"comp":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.address:comp ) }">",
				"city":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.address:city ) }">",
				"state":		"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.address:state ) }">",
				"zip":			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.address:zip ) }">",
				"country":		"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.address:country ) }">",
				"resdntl":		<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.address:resdntl ) }">
			<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_End() }">
		</MvFOREACH>
	]

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

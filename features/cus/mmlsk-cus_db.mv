<MIVA STANDARDOUTPUTLEVEL = "">

<MvCOMMENT>
|
| Miva Merchant
|
| This file and the source codes contained herein are the property of
| Miva, Inc.  Use of this file is restricted to the specific terms and
| conditions in the License Agreement associated with this file.  Distribution
| of this file or portions of this file for uses not covered by the License
| Agreement is not allowed without a written agreement signed by an officer of
| Miva, Inc.
|
| Copyright 1998-2023 Miva, Inc.  All rights reserved.
| http://www.miva.com
|
| Prefix         : MER-CUS-DTB-
| Next Error Code: 169   
|
</MvCOMMENT>

<MvCOMMENT>
|
| Customers
|
</MvCOMMENT>

<MvFUNCTION NAME = "CUS_Create_Data_Files" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].DomainPrivilege_Insert( 'CUST', 'Customers' ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].DomainPrivilege_Insert( 'ACRD', 'Account Credit' ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].DomainPrivilege_Insert( 'SHOP', 'Shop As Customer' ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'CREATE TABLE ShopAsCustomerSessions
						  (
							session_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 40 )	$ ',
							admsess_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 40 )	$ ',
							user_id		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							store_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							basket_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00137', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "CREATE UNIQUE INDEX ShopAsCustomerSessions_1 ON ShopAsCustomerSessions ( session_id )">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00165', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "CREATE UNIQUE INDEX ShopAsCustomerSessions_2 ON ShopAsCustomerSessions ( admsess_id )">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00138', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "CREATE INDEX ShopAsCustomerSessions_3 ON ShopAsCustomerSessions ( store_id, basket_id )">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00139', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "CREATE INDEX ShopAsCustomerSessions_4 ON ShopAsCustomerSessions ( user_id )">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00140', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CUS_Store_Create" PARAMETERS = "store_email" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE TABLE ' $  g.Store_Table_Prefix $ 'Customers
						  (
							id			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							account_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							agrpcount	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							pgrpcount	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							login		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							pw_email	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 )		$ ',
							password	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 )		$ ',
							ship_res	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_BOOL() 			$ ',
							ship_id		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							ship_fname	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							ship_lname	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							ship_email	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 )		$ ',
							ship_comp	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							ship_phone	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							ship_fax	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							ship_addr	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 100 )		$ ',
							ship_addr2	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 100 )		$ ',
							ship_city	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							ship_state	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							ship_zip	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							ship_cntry	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							bill_id		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							bill_fname	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							bill_lname	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							bill_email	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 )		$ ',
							bill_comp	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							bill_phone	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							bill_fax	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							bill_addr	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 100 )		$ ',
							bill_addr2	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 100 )		$ ',
							bill_city	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							bill_state	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							bill_zip	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							bill_cntry	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
							credit		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_NUMBER( 10, 2 )	$ ',
							note_count	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							dt_created	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							dt_updated	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							dt_login	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							dt_pwchg	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							tax_exempt	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_BOOL()			$ ',
							order_cnt	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							order_avg	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_NUMBER( 10, 2 )	$ ',
							order_tot	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_NUMBER( 10, 2 )	$ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00001', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'Customers_1 ON ' $ g.Store_Table_Prefix $ 'Customers ( id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00002', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'Customers_2 ON ' $ g.Store_Table_Prefix $ 'Customers ( login )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00003', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'Customers_3 ON ' $ g.Store_Table_Prefix $ 'Customers ( pw_email )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00048', g.MvQUERY_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StoreKey_Insert( 'Customers', 1 ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE TABLE ' $  g.Store_Table_Prefix $ 'CustomerEmail
						  (
							email_from	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 ) $ ',
							email_cc	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 ) $ ',
							subject		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 ) $ ',
							header		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_MEMO() $ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00004', g.MvQUERY_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customer_email"	MEMBER = "email_from"	VALUE = "{ l.store_email }">
	<MvASSIGN NAME = "l.customer_email"	MEMBER = "email_cc" 	VALUE = "">
	<MvASSIGN NAME = "l.customer_email"	MEMBER = "subject" 		VALUE = "Your password">
	<MvASSIGN NAME = "l.customer_email"	MEMBER = "header" 		VALUE = "Click on the following link to reset your password.">

	<MvIF EXPR = "{ NOT CustomerEmail_Insert( l.customer_email ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE TABLE ' $  g.Store_Table_Prefix $ 'CustomerSettings
						  (
							pw_min_len	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							pw_complex	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							resettype	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 10 )	$ ',
							resetexp	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							pwchgauth	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_BOOL()		$ ',
							def_wshlst	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 )	$ ',
							req_token	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_BOOL()		$ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00049', g.MvQUERY_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customersettings:pw_min_len"	VALUE = 6>
	<MvASSIGN NAME = "l.customersettings:pw_complex"	VALUE = 1>
	<MvASSIGN NAME = "l.customersettings:resettype"		VALUE = "change">
	<MvASSIGN NAME = "l.customersettings:resetexp"		VALUE = 1440>
	<MvASSIGN NAME = "l.customersettings:pwchgauth"		VALUE = 1>
	<MvASSIGN NAME = "l.customersettings:def_wshlst"	VALUE = "Wish List">
	<MvASSIGN NAME = "l.customersettings:req_token"		VALUE = 1>

	<MvIF EXPR = "{ NOT CustomerSettings_Insert( l.customersettings ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'CustomerPasswordReset
						  (
							cust_id		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							token		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							dt_created	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 10 )	$ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00054', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'CustomerPasswordReset_1 ON ' $ g.Store_Table_Prefix $ 'CustomerPasswordReset ( cust_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00055', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'CustomerPasswordReset_2 ON ' $ g.Store_Table_Prefix $ 'CustomerPasswordReset ( token )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00056', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'CustomerPasswordReset_3 ON ' $ g.Store_Table_Prefix $ 'CustomerPasswordReset ( dt_created )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00057', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory
						  (
							id			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							user_id		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							cust_id		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							order_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							txref		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 100 )		$ ',
							descrip		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 )		$ ',
							amount		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_NUMBER( 10, 2 )	$ ',
							dtstamp		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00066', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory_1 ON ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory ( id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00067', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory_2 ON ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory ( cust_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00068', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory_3 ON ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory ( order_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00069', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory_4 ON ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory ( txref )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00070', g.MvQUERY_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StoreKey_Insert( 'CustomerCreditHistory', 1 ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StoreKey_Insert( 'BusinessAccounts', 1 ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'BusinessAccounts
						  (
							id			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER() 		$ ',
							agrpcount	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							pgrpcount	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							title		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 )		$ ',
							note_count	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER() 		$ ',
							tax_exempt	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_BOOL()			$ ',
							order_cnt	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
							order_avg	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_NUMBER( 10, 2 )	$ ',
							order_tot	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_NUMBER( 10, 2 )	$ '
						  )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00084', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'BusinessAccounts_1 ON ' $ g.Store_Table_Prefix $ 'BusinessAccounts ( id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00085', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'BusinessAccounts_2 ON ' $ g.Store_Table_Prefix $ 'BusinessAccounts ( title )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00086', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'CustomerAddresses
			  		      (
							id			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
			  		    	cust_id		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							descrip		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 )	$ ',
							fname		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							lname		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							email		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 254 )	$ ',
							comp		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							phone		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							fax			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							addr		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 100 )	$ ',
							addr2		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 100 )	$ ',
							city		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							state		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							zip			' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							cntry		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							resdntl		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_BOOL()		$ '
			  		      )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00095', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'CustomerAddresses_1 ON ' $ g.Store_Table_Prefix $ 'CustomerAddresses ( id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00096', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'CustomerAddresses_2 ON ' $ g.Store_Table_Prefix $ 'CustomerAddresses ( cust_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00097', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'CustomerAddresses_3 ON ' $ g.Store_Table_Prefix $ 'CustomerAddresses ( cust_id, id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00098', g.MvQUERY_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StoreKey_Insert( 'CustomerAddresses', 1 ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CUS_Store_Delete" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'Customers' }">
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'CustomerEmail' }">
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'CustomerSettings' }">
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'CustomerPasswordReset' }">
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'CustomerCreditHistory' }">
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'BusinessAccounts' }">
	<MvQUERY NAME = "Merchant"	QUERY = "{ 'DROP TABLE ' $  g.Store_Table_Prefix $ 'CustomerAddresses' }">

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Library_DB ].StoreKey_Delete( 'Customers' ) }">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Library_DB ].StoreKey_Delete( 'CustomerCreditHistory' ) }">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Library_DB ].StoreKey_Delete( 'BusinessAccounts' ) }">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Library_DB ].StoreKey_Delete( 'CustomerAddresses' ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Read" PARAMETERS = "customer var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.customer:id"					VALUE = "{ Customers.d.id }">
	<MvASSIGN NAME = "l.customer:account_id"			VALUE = "{ Customers.d.account_id }">
	<MvASSIGN NAME = "l.customer:original_account_id"	VALUE = "{ Customers.d.account_id }">
	<MvASSIGN NAME = "l.customer:agrpcount"				VALUE = "{ Customers.d.agrpcount }">
	<MvASSIGN NAME = "l.customer:pgrpcount"				VALUE = "{ Customers.d.pgrpcount }">
	<MvASSIGN NAME = "l.customer:login"					VALUE = "{ Customers.d.login }">
	<MvASSIGN NAME = "l.customer:pw_email"				VALUE = "{ Customers.d.pw_email }">
	<MvASSIGN NAME = "l.customer:password"				VALUE = "{ Customers.d.password }">
	<MvASSIGN NAME = "l.customer:original_password"		VALUE = "{ Customers.d.password }">

	<MvASSIGN NAME = "l.customer:ship_res"				VALUE = "{ Customers.d.ship_res }">
	<MvASSIGN NAME = "l.customer:ship_id"				VALUE = "{ Customers.d.ship_id }">
	<MvASSIGN NAME = "l.customer:ship_fname"			VALUE = "{ Customers.d.ship_fname }">
	<MvASSIGN NAME = "l.customer:ship_lname"			VALUE = "{ Customers.d.ship_lname }">
	<MvASSIGN NAME = "l.customer:ship_email"			VALUE = "{ Customers.d.ship_email }">
	<MvASSIGN NAME = "l.customer:ship_comp"				VALUE = "{ Customers.d.ship_comp }">
	<MvASSIGN NAME = "l.customer:ship_phone"			VALUE = "{ Customers.d.ship_phone }">
	<MvASSIGN NAME = "l.customer:ship_fax"				VALUE = "{ Customers.d.ship_fax }">

	<MvIF EXPR = "{ len( Customers.d.ship_addr2 ) EQ 0 }">
		<MvASSIGN NAME = "l.customer:ship_addr"			VALUE = "{ Customers.d.ship_addr }">
	<MvELSE>
		<MvASSIGN NAME = "l.customer:ship_addr"			VALUE = "{ Customers.d.ship_addr $ ' ' $ Customers.d.ship_addr2 }">
	</MvIF>

	<MvASSIGN NAME = "l.customer:ship_addr1"			VALUE = "{ Customers.d.ship_addr }">
	<MvASSIGN NAME = "l.customer:ship_addr2"			VALUE = "{ Customers.d.ship_addr2 }">
	<MvASSIGN NAME = "l.customer:ship_city"				VALUE = "{ Customers.d.ship_city }">
	<MvASSIGN NAME = "l.customer:ship_state"			VALUE = "{ Customers.d.ship_state }">
	<MvASSIGN NAME = "l.customer:ship_zip"				VALUE = "{ Customers.d.ship_zip }">
	<MvASSIGN NAME = "l.customer:ship_cntry"			VALUE = "{ Customers.d.ship_cntry }">

	<MvASSIGN NAME = "l.customer:bill_id"				VALUE = "{ Customers.d.bill_id }">
	<MvASSIGN NAME = "l.customer:bill_fname"			VALUE = "{ Customers.d.bill_fname }">
	<MvASSIGN NAME = "l.customer:bill_lname"			VALUE = "{ Customers.d.bill_lname }">
	<MvASSIGN NAME = "l.customer:bill_email"			VALUE = "{ Customers.d.bill_email }">
	<MvASSIGN NAME = "l.customer:bill_comp"				VALUE = "{ Customers.d.bill_comp }">
	<MvASSIGN NAME = "l.customer:bill_phone"			VALUE = "{ Customers.d.bill_phone }">
	<MvASSIGN NAME = "l.customer:bill_fax"				VALUE = "{ Customers.d.bill_fax }">

	<MvIF EXPR = "{ len( Customers.d.bill_addr2 ) EQ 0 }">
		<MvASSIGN NAME = "l.customer:bill_addr"			VALUE = "{ Customers.d.bill_addr }">
	<MvELSE>
		<MvASSIGN NAME = "l.customer:bill_addr"			VALUE = "{ Customers.d.bill_addr $ ' ' $ Customers.d.bill_addr2 }">
	</MvIF>

	<MvASSIGN NAME = "l.customer:bill_addr1"			VALUE = "{ Customers.d.bill_addr }">
	<MvASSIGN NAME = "l.customer:bill_addr2"			VALUE = "{ Customers.d.bill_addr2 }">
	<MvASSIGN NAME = "l.customer:bill_city"				VALUE = "{ Customers.d.bill_city }">
	<MvASSIGN NAME = "l.customer:bill_state"			VALUE = "{ Customers.d.bill_state }">
	<MvASSIGN NAME = "l.customer:bill_zip"				VALUE = "{ Customers.d.bill_zip }">
	<MvASSIGN NAME = "l.customer:bill_cntry"			VALUE = "{ Customers.d.bill_cntry }">
	<MvASSIGN NAME = "l.customer:credit"				VALUE = "{ Customers.d.credit }">
	<MvASSIGN NAME = "l.customer:note_count"			VALUE = "{ Customers.d.note_count }">
	<MvASSIGN NAME = "l.customer:dt_created"			VALUE = "{ Customers.d.dt_created }">
	<MvASSIGN NAME = "l.customer:dt_updated"			VALUE = "{ Customers.d.dt_updated }">
	<MvASSIGN NAME = "l.customer:dt_login"				VALUE = "{ Customers.d.dt_login }">
	<MvASSIGN NAME = "l.customer:dt_pwchg"				VALUE = "{ Customers.d.dt_pwchg }">
	<MvASSIGN NAME = "l.customer:tax_exempt" 			VALUE = "{ Customers.d.tax_exempt }">
	<MvASSIGN NAME = "l.customer:order_cnt" 			VALUE = "{ Customers.d.order_cnt }">
	<MvASSIGN NAME = "l.customer:order_avg" 			VALUE = "{ Customers.d.order_avg }">
	<MvASSIGN NAME = "l.customer:order_tot" 			VALUE = "{ Customers.d.order_tot }">
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Insert" PARAMETERS = "customer var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Customer_Insert_LowLevel( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_cust', l.modules ) }">
		<MvDO FILE = "{ g.Module_Root $ l.module:module }" NAME = "l.null"	VALUE = "{ Module_Notify_Customer_Insert( l.module, l.customer ) }">
	</MvFOREACH>
	
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Insert_LowLevel" PARAMETERS = "customer var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StandardFields_Load_Cached( l.standardfields ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.customer:id"								VALUE = "{ [ g.Module_Library_DB ].StoreKey_Generate( 'Customers' ) }">
	<MvASSIGN NAME = "l.customer:note_count" 						VALUE = 0>
	<MvASSIGN NAME = "l.customer:ship_id" 							VALUE = 0>
	<MvASSIGN NAME = "l.customer:bill_id" 							VALUE = 0>
	<MvASSIGN NAME = "l.customer:dt_created" 						VALUE = "{ s.dyn_time_t }">
	<MvASSIGN NAME = "l.customer:dt_updated" 						VALUE = "{ l.customer:dt_created }">
	<MvASSIGN NAME = "l.customer:dt_login" 							VALUE = 0>
	<MvASSIGN NAME = "l.customer:dt_pwchg" 							VALUE = "{ l.customer:dt_created }">

	<MvIF EXPR = "{ len( l.customer:ship_addr ) AND ( NOT len( l.customer:ship_addr1 ) ) AND ( NOT len( l.customer:ship_addr2 ) ) }">
		<MvASSIGN NAME = "l.customer:ship_addr1"					VALUE = "{ l.customer:ship_addr }">
	</MvIF>

	<MvIF EXPR = "{ len( l.customer:bill_addr ) AND ( NOT len( l.customer:bill_addr1 ) ) AND ( NOT len( l.customer:bill_addr2 ) ) }">
		<MvASSIGN NAME = "l.customer:bill_addr1"					VALUE = "{ l.customer:bill_addr }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Feature_Filename_CUS_UT ].Customer_Password_Encrypted( l.customer:password ) }">
		<MvASSIGN NAME = "l.null"									VALUE = "{ [ g.Feature_Filename_CUS_UT ].Customer_Password_Encrypt( l.customer:password, l.customer:password ) }">
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customer:agrpcount }">
		<MvASSIGN NAME = "l.customer:agrpcount"						VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customer:credit }">
		<MvASSIGN NAME = "l.customer:credit"						VALUE = "0.00">
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customer:account_id }">
		<MvASSIGN NAME = "l.customer:account_id" 	 	 	 	 	VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customer:ship_res }">
		<MvASSIGN NAME = "l.customer:ship_res" 	 	 	 	 		VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customer:tax_exempt }">
		<MvASSIGN NAME = "l.customer:tax_exempt" 					VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customer:order_cnt }">
		<MvASSIGN NAME = "l.customer:order_cnt" 					VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customer:order_avg }">
		<MvASSIGN NAME = "l.customer:order_avg" 					VALUE = 0.00>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customer:order_tot }">
		<MvASSIGN NAME = "l.customer:order_tot" 					VALUE = 0.00>
	</MvIF>

	<MvASSIGN NAME = "l.customeraddress_ship:cust_id"				VALUE = "{ l.customer:id }">
	<MvASSIGN NAME = "l.customeraddress_ship:fname"					VALUE = "{ l.customer:ship_fname }">
	<MvASSIGN NAME = "l.customeraddress_ship:lname"					VALUE = "{ l.customer:ship_lname }">
	<MvASSIGN NAME = "l.customeraddress_ship:email"					VALUE = "{ l.customer:ship_email }">
	<MvASSIGN NAME = "l.customeraddress_ship:comp"					VALUE = "{ l.customer:ship_comp }">
	<MvASSIGN NAME = "l.customeraddress_ship:phone"					VALUE = "{ l.customer:ship_phone }">
	<MvASSIGN NAME = "l.customeraddress_ship:fax"					VALUE = "{ l.customer:ship_fax }">
	<MvASSIGN NAME = "l.customeraddress_ship:addr1"					VALUE = "{ l.customer:ship_addr1 }">
	<MvASSIGN NAME = "l.customeraddress_ship:addr2"					VALUE = "{ l.customer:ship_addr2 }">
	<MvASSIGN NAME = "l.customeraddress_ship:city"					VALUE = "{ l.customer:ship_city }">
	<MvASSIGN NAME = "l.customeraddress_ship:state"					VALUE = "{ l.customer:ship_state }">
	<MvASSIGN NAME = "l.customeraddress_ship:zip"					VALUE = "{ l.customer:ship_zip }">
	<MvASSIGN NAME = "l.customeraddress_ship:cntry"					VALUE = "{ l.customer:ship_cntry }">
	<MvASSIGN NAME = "l.customeraddress_ship:resdntl"				VALUE = "{ l.customer:ship_res }">

	<MvIF EXPR = "{ NOT ISNULL l.customer:ship_descrip }">
		<MvASSIGN NAME = "l.customeraddress_ship:descrip" 			VALUE = "{ l.customer:ship_descrip }">
	<MvELSE>
		<MvASSIGN NAME = "l.customeraddress_ship:descrip"			VALUE = "{ l.customer:ship_addr1 }">
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Admin ].Validate_StandardFields( l.standardfields, l.customeraddress_ship ) }">
		<MvIF EXPR = "{ NOT CustomerAddress_Insert( l.customeraddress_ship ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvASSIGN NAME = "l.customer:ship_id" 						VALUE = "{ l.customeraddress_ship:id }">
	</MvIF>

	<MvASSIGN NAME = "l.customeraddress_bill:cust_id" 				VALUE = "{ l.customer:id }">
	<MvASSIGN NAME = "l.customeraddress_bill:fname"					VALUE = "{ l.customer:bill_fname }">
	<MvASSIGN NAME = "l.customeraddress_bill:lname"					VALUE = "{ l.customer:bill_lname }">
	<MvASSIGN NAME = "l.customeraddress_bill:email"					VALUE = "{ l.customer:bill_email }">
	<MvASSIGN NAME = "l.customeraddress_bill:comp"					VALUE = "{ l.customer:bill_comp }">
	<MvASSIGN NAME = "l.customeraddress_bill:phone"					VALUE = "{ l.customer:bill_phone }">
	<MvASSIGN NAME = "l.customeraddress_bill:fax"					VALUE = "{ l.customer:bill_fax }">
	<MvASSIGN NAME = "l.customeraddress_bill:addr1"					VALUE = "{ l.customer:bill_addr1 }">
	<MvASSIGN NAME = "l.customeraddress_bill:addr2"					VALUE = "{ l.customer:bill_addr2 }">
	<MvASSIGN NAME = "l.customeraddress_bill:city"					VALUE = "{ l.customer:bill_city }">
	<MvASSIGN NAME = "l.customeraddress_bill:state"					VALUE = "{ l.customer:bill_state }">
	<MvASSIGN NAME = "l.customeraddress_bill:zip"					VALUE = "{ l.customer:bill_zip }">
	<MvASSIGN NAME = "l.customeraddress_bill:cntry"					VALUE = "{ l.customer:bill_cntry }">
	<MvASSIGN NAME = "l.customeraddress_bill:resdntl"				VALUE = 0>

	<MvIF EXPR = "{ [ g.Feature_Filename_CUS_UT ].CustomerAddress_Compare_Same( l.customeraddress_ship, l.customeraddress_bill ) }">
		<MvASSIGN NAME = "l.customer:bill_id" 						VALUE = "{ l.customer:ship_id }">
	<MvELSE>
		<MvIF EXPR = "{ NOT ISNULL l.customer:bill_descrip }">
			<MvASSIGN NAME = "l.customeraddress_bill:descrip" 		VALUE = "{ l.customer:bill_descrip }">
		<MvELSE>
			<MvASSIGN NAME = "l.customeraddress_bill:descrip"		VALUE = "{ l.customer:bill_addr1 }">
		</MvIF>

		<MvIF EXPR = "{ [ g.Module_Admin ].Validate_StandardFields( l.standardfields, l.customeraddress_bill ) }">
			<MvIF EXPR = "{ NOT CustomerAddress_Insert( l.customeraddress_bill ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvASSIGN NAME = "l.customer:bill_id" 					VALUE = "{ l.customeraddress_bill:id }">
		</MvIF>
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'Customers
					      ( id, account_id, agrpcount, pgrpcount, login, pw_email, password, ship_res, ship_id, ship_fname, ship_lname, ship_email,
						    ship_comp, ship_phone, ship_fax, ship_addr, ship_addr2, ship_city, ship_state, ship_zip, ship_cntry, bill_id, bill_fname,
						    bill_lname, bill_email, bill_comp, bill_phone, bill_fax, bill_addr, bill_addr2, bill_city, bill_state, bill_zip, bill_cntry,
						    credit, note_count, dt_created, dt_updated, dt_login, dt_pwchg, tax_exempt, order_cnt, order_avg, order_tot )
						  VALUES
						  ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )' }"
			 FIELDS	= "l.customer:id, l.customer:account_id, l.customer:agrpcount, l.customer:pgrpcount, l.customer:login, l.customer:pw_email,
					   l.customer:password, l.customer:ship_res, l.customer:ship_id, l.customer:ship_fname, l.customer:ship_lname,
					   l.customer:ship_email, l.customer:ship_comp, l.customer:ship_phone,
					   l.customer:ship_fax, l.customer:ship_addr1, l.customer:ship_addr2, 
					   l.customer:ship_city, l.customer:ship_state, l.customer:ship_zip, l.customer:ship_cntry, 
					   l.customer:bill_id, l.customer:bill_fname, l.customer:bill_lname, l.customer:bill_email, l.customer:bill_comp,
					   l.customer:bill_phone, l.customer:bill_fax, l.customer:bill_addr1, l.customer:bill_addr2, 
					   l.customer:bill_city, l.customer:bill_state, l.customer:bill_zip, l.customer:bill_cntry,
					   l.customer:credit, l.customer:note_count, l.customer:dt_created, l.customer:dt_updated, l.customer:dt_login, l.customer:dt_pwchg,
					   l.customer:tax_exempt, l.customer:order_cnt, l.customer:order_avg, l.customer:order_tot">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00005', g.MvQUERY_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ len( l.customer:ship_addr2 ) EQ 0 }">
		<MvASSIGN NAME = "l.customer:ship_addr"	VALUE = "{ l.customer:ship_addr1 }">
	<MvELSE>
		<MvASSIGN NAME = "l.customer:ship_addr"	VALUE = "{ l.customer:ship_addr1 $ ' ' $ l.customer:ship_addr2 }">
	</MvIF>

	<MvIF EXPR = "{ len( l.customer:bill_addr2 ) EQ 0 }">
		<MvASSIGN NAME = "l.customer:bill_addr"	VALUE = "{ l.customer:bill_addr1 }">
	<MvELSE>
		<MvASSIGN NAME = "l.customer:bill_addr"	VALUE = "{ l.customer:bill_addr1 $ ' ' $ l.customer:bill_addr2 }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Update" PARAMETERS = "customer var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StandardFields_Load_Cached( l.standardfields ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:ship_addr AND
					l.customer:ship_addr NE ( l.customer:ship_addr1 $ ' ' $ l.customer:ship_addr2 ) }">
		<MvASSIGN NAME = "l.customer:ship_addr1"	VALUE = "{ l.customer:ship_addr }">
		<MvASSIGN NAME = "l.customer:ship_addr2"	VALUE = "">
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.customer:bill_addr AND
					l.customer:bill_addr NE ( l.customer:bill_addr1 $ ' ' $ l.customer:bill_addr2 ) }">
		<MvASSIGN NAME = "l.customer:bill_addr1"	VALUE = "{ l.customer:bill_addr }">
		<MvASSIGN NAME = "l.customer:bill_addr2"	VALUE = "">
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customer:ship_res }">
		<MvASSIGN NAME = "l.customer:ship_res" 		VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT CustomerAddress_Update_Customer( l.customer, l.standardfields ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT Customer_Update_LowLevel( l.customer ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customer:ship_addr2 }">
		<MvASSIGN NAME = "l.customer:ship_addr"	VALUE = "{ l.customer:ship_addr1 }">
	<MvELSE>
		<MvASSIGN NAME = "l.customer:ship_addr"	VALUE = "{ l.customer:ship_addr1 $ ' ' $ l.customer:ship_addr2 }">
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customer:bill_addr2 }">
		<MvASSIGN NAME = "l.customer:bill_addr"	VALUE = "{ l.customer:bill_addr1 }">
	<MvELSE>
		<MvASSIGN NAME = "l.customer:bill_addr"	VALUE = "{ l.customer:bill_addr1 $ ' ' $ l.customer:bill_addr2 }">
	</MvIF>

	<MvIF EXPR = "{ l.customer:original_account_id NE l.customer:account_id }">
		<MvIF EXPR = "{ l.customer:original_account_id }">
			<MvIF EXPR = "{ NOT BusinessAccount_Update_OrderMetrics( l.customer:original_account_id ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ l.customer:account_id }">
			<MvIF EXPR = "{ NOT BusinessAccount_Update_OrderMetrics( l.customer:account_id ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_cust', l.modules ) }">
		<MvIF EXPR = "{ l.module:api_ver GE 9.03 }">
			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Customer_Update( l.module, l.customer ) }">
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Update_LowLevel" PARAMETERS = "customer var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Feature_Filename_CUS_UT ].Customer_Password_Encrypted( l.customer:password ) }">
		<MvASSIGN NAME = "l.null"				VALUE = "{ [ g.Feature_Filename_CUS_UT ].Customer_Password_Encrypt( l.customer:password, l.customer:password ) }">
	</MvIF>

	<MvIF EXPR = "{ l.customer:password NE l.customer:original_password }">
		<MvASSIGN NAME = "l.customer:dt_pwchg"	VALUE = "{ s.dyn_time_t }">
	</MvIF>

	<MvASSIGN NAME = "l.customer:dt_updated"	VALUE = "{ s.dyn_time_t }">

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Customers
					      SET
					      	account_id	= ?,
							agrpcount	= ?,
							pgrpcount	= ?,
							login		= ?,
							pw_email	= ?,
							password	= ?,
							ship_res	= ?,
							ship_id		= ?,
							ship_fname	= ?,
							ship_lname	= ?,
							ship_email	= ?,
							ship_comp	= ?,
							ship_phone	= ?,
							ship_fax	= ?,
							ship_addr	= ?,
							ship_addr2	= ?,
							ship_city	= ?,
							ship_state	= ?,
							ship_zip	= ?,
							ship_cntry	= ?,
							bill_id		= ?,
							bill_fname	= ?,
							bill_lname	= ?,
							bill_email	= ?,
							bill_comp	= ?,
							bill_phone	= ?,
							bill_fax	= ?,
							bill_addr	= ?,
							bill_addr2	= ?,
							bill_city	= ?,
							bill_state	= ?,
							bill_zip	= ?,
							bill_cntry	= ?,
							dt_updated	= ?,
							dt_pwchg	= ?,
							tax_exempt	= ?,
							order_cnt	= ?,
							order_avg	= ?,
							order_tot	= ?
					      WHERE
						    id			= ?' }"
			 FIELDS	= "l.customer:account_id, l.customer:agrpcount, l.customer:pgrpcount, l.customer:login, l.customer:pw_email,
			 		   l.customer:password, l.customer:ship_res, l.customer:ship_id, l.customer:ship_fname, l.customer:ship_lname,
			 		   l.customer:ship_email, l.customer:ship_comp, l.customer:ship_phone, l.customer:ship_fax,
			 		   l.customer:ship_addr1, l.customer:ship_addr2, l.customer:ship_city, l.customer:ship_state,
			 		   l.customer:ship_zip, l.customer:ship_cntry, l.customer:bill_id, l.customer:bill_fname, l.customer:bill_lname,
					   l.customer:bill_email, l.customer:bill_comp, l.customer:bill_phone,
					   l.customer:bill_fax, l.customer:bill_addr1, l.customer:bill_addr2, l.customer:bill_city, 
					   l.customer:bill_state, l.customer:bill_zip, l.customer:bill_cntry, l.customer:dt_updated, l.customer:dt_pwchg, l.customer:tax_exempt,
					   l.customer:order_cnt, l.customer:order_avg, l.customer:order_tot,
					   l.customer:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00006', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Update_Customer" PARAMETERS = "customer var, standardfields var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.ship_address:cust_id"								VALUE = "{ l.customer:id }">
	<MvASSIGN NAME = "l.ship_address:fname"									VALUE = "{ l.customer:ship_fname }">
	<MvASSIGN NAME = "l.ship_address:lname"									VALUE = "{ l.customer:ship_lname }">
	<MvASSIGN NAME = "l.ship_address:email"									VALUE = "{ l.customer:ship_email }">
	<MvASSIGN NAME = "l.ship_address:comp"									VALUE = "{ l.customer:ship_comp }">
	<MvASSIGN NAME = "l.ship_address:phone"									VALUE = "{ l.customer:ship_phone }">
	<MvASSIGN NAME = "l.ship_address:fax"									VALUE = "{ l.customer:ship_fax }">
	<MvASSIGN NAME = "l.ship_address:addr1"									VALUE = "{ l.customer:ship_addr1 }">
	<MvASSIGN NAME = "l.ship_address:addr2"									VALUE = "{ l.customer:ship_addr2 }">
	<MvASSIGN NAME = "l.ship_address:city"									VALUE = "{ l.customer:ship_city }">
	<MvASSIGN NAME = "l.ship_address:state"									VALUE = "{ l.customer:ship_state }">
	<MvASSIGN NAME = "l.ship_address:zip"									VALUE = "{ l.customer:ship_zip }">
	<MvASSIGN NAME = "l.ship_address:cntry"									VALUE = "{ l.customer:ship_cntry }">
	<MvASSIGN NAME = "l.ship_address:resdntl"								VALUE = "{ l.customer:ship_res }">

	<MvASSIGN NAME = "l.bill_address:cust_id" 								VALUE = "{ l.customer:id }">
	<MvASSIGN NAME = "l.bill_address:fname"									VALUE = "{ l.customer:bill_fname }">
	<MvASSIGN NAME = "l.bill_address:lname"									VALUE = "{ l.customer:bill_lname }">
	<MvASSIGN NAME = "l.bill_address:email"									VALUE = "{ l.customer:bill_email }">
	<MvASSIGN NAME = "l.bill_address:comp"									VALUE = "{ l.customer:bill_comp }">
	<MvASSIGN NAME = "l.bill_address:phone"									VALUE = "{ l.customer:bill_phone }">
	<MvASSIGN NAME = "l.bill_address:fax"									VALUE = "{ l.customer:bill_fax }">
	<MvASSIGN NAME = "l.bill_address:addr1"									VALUE = "{ l.customer:bill_addr1 }">
	<MvASSIGN NAME = "l.bill_address:addr2"									VALUE = "{ l.customer:bill_addr2 }">
	<MvASSIGN NAME = "l.bill_address:city"									VALUE = "{ l.customer:bill_city }">
	<MvASSIGN NAME = "l.bill_address:state"									VALUE = "{ l.customer:bill_state }">
	<MvASSIGN NAME = "l.bill_address:zip"									VALUE = "{ l.customer:bill_zip }">
	<MvASSIGN NAME = "l.bill_address:cntry"									VALUE = "{ l.customer:bill_cntry }">

	<MvIF EXPR = "{ l.standardfields:primaddr EQ 'shipping' }">
		<MvIF EXPR = "{ NOT CustomerAddress_Update_Customer_Shipping( l.customer, l.ship_address, l.standardfields ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		<MvELSEIF EXPR = "{ NOT CustomerAddress_Update_Customer_Billing( l.customer, l.bill_address, l.standardfields ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	<MvELSE>
		<MvIF EXPR = "{ NOT CustomerAddress_Update_Customer_Billing( l.customer, l.bill_address, l.standardfields ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		<MvELSEIF EXPR = "{ NOT CustomerAddress_Update_Customer_Shipping( l.customer, l.ship_address, l.standardfields ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Update_Customer_Shipping" PARAMETERS = "customer var, ship_address var, standardfields var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.customer:ship_id 		EQ 0	AND
					l.ship_address:fname	EQ ''	AND
					l.ship_address:lname	EQ ''	AND
					l.ship_address:email	EQ ''	AND
					l.ship_address:comp		EQ ''	AND
					l.ship_address:phone	EQ ''	AND
					l.ship_address:fax		EQ ''	AND
					l.ship_address:addr1	EQ ''	AND
					l.ship_address:addr2	EQ ''	AND
					l.ship_address:city		EQ ''	AND
					l.ship_address:state	EQ ''	AND
					l.ship_address:zip		EQ ''	AND
					l.ship_address:cntry	EQ '' }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ CustomerAddress_Load_AddressFields( l.customer:id, l.ship_address, l.customeraddress_ship_original ) }">
		<MvASSIGN NAME = "l.customer:ship_id" 								VALUE = "{ l.customeraddress_ship_original:id }">
		<MvASSIGN NAME = "l.ship_address:id" 								VALUE = "{ l.customeraddress_ship_original:id }">
		<MvASSIGN NAME = "l.ship_address:descrip" 							VALUE = "{ l.customeraddress_ship_original:descrip }">

		<MvCOMMENT>
		|
		| Note: since CustomerAddress_Load_AddressFields will load matches case-insensitive,
		| we must check to see if any fields differ (including case) and update accordingly.
		| If updating the primary address, always update if the fields have changed
		| If updating the secondary address, only update if the original loaded matches the
		| newly loaded (ie, the case hasn't been altered by the primary record)
		|
		</MvCOMMENT>

		<MvIF EXPR = "{ l.standardfields:primaddr EQ 'shipping' }">
			<MvIF EXPR = "{ l.ship_address:fname	NE l.customeraddress_ship_original:fname	OR
							l.ship_address:lname	NE l.customeraddress_ship_original:lname	OR
							l.ship_address:email	NE l.customeraddress_ship_original:email	OR
							l.ship_address:comp		NE l.customeraddress_ship_original:comp		OR
							l.ship_address:phone	NE l.customeraddress_ship_original:phone	OR
							l.ship_address:fax		NE l.customeraddress_ship_original:fax		OR
							l.ship_address:addr1	NE l.customeraddress_ship_original:addr1	OR
							l.ship_address:addr2	NE l.customeraddress_ship_original:addr2	OR
							l.ship_address:city		NE l.customeraddress_ship_original:city		OR
							l.ship_address:state	NE l.customeraddress_ship_original:state	OR
							l.ship_address:zip		NE l.customeraddress_ship_original:zip		OR
							l.ship_address:cntry	NE l.customeraddress_ship_original:cntry	OR
							l.ship_address:resdntl	NE l.customeraddress_ship_original:resdntl }">
				<MvIF EXPR = "{ NOT CustomerAddress_Update( l.ship_address ) }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			</MvIF>
		<MvELSEIF EXPR = "{ CustomerAddress_Load_ID( l.customeraddress_ship_original:id, l.customeraddress_ship ) }">
			<MvIF EXPR = "{ (
								l.customeraddress_ship:fname	EQ l.customeraddress_ship_original:fname	AND
								l.customeraddress_ship:lname	EQ l.customeraddress_ship_original:lname	AND
								l.customeraddress_ship:email	EQ l.customeraddress_ship_original:email	AND
								l.customeraddress_ship:comp		EQ l.customeraddress_ship_original:comp		AND
								l.customeraddress_ship:phone	EQ l.customeraddress_ship_original:phone	AND
								l.customeraddress_ship:fax		EQ l.customeraddress_ship_original:fax		AND
								l.customeraddress_ship:addr1	EQ l.customeraddress_ship_original:addr1	AND
								l.customeraddress_ship:addr2	EQ l.customeraddress_ship_original:addr2	AND
								l.customeraddress_ship:city		EQ l.customeraddress_ship_original:city		AND
								l.customeraddress_ship:state	EQ l.customeraddress_ship_original:state	AND
								l.customeraddress_ship:zip		EQ l.customeraddress_ship_original:zip		AND
								l.customeraddress_ship:cntry	EQ l.customeraddress_ship_original:cntry
							) AND
							( 
								l.ship_address:fname	NE l.customeraddress_ship_original:fname	OR
								l.ship_address:lname	NE l.customeraddress_ship_original:lname	OR
								l.ship_address:email	NE l.customeraddress_ship_original:email	OR
								l.ship_address:comp		NE l.customeraddress_ship_original:comp		OR
								l.ship_address:phone	NE l.customeraddress_ship_original:phone	OR
								l.ship_address:fax		NE l.customeraddress_ship_original:fax		OR
								l.ship_address:addr1	NE l.customeraddress_ship_original:addr1	OR
								l.ship_address:addr2	NE l.customeraddress_ship_original:addr2	OR
								l.ship_address:city		NE l.customeraddress_ship_original:city		OR
								l.ship_address:state	NE l.customeraddress_ship_original:state	OR
								l.ship_address:zip		NE l.customeraddress_ship_original:zip		OR
								l.ship_address:cntry	NE l.customeraddress_ship_original:cntry	OR
								l.ship_address:resdntl	NE l.customeraddress_ship_original:resdntl
							) }">
				<MvIF EXPR = "{ NOT CustomerAddress_Update( l.ship_address ) }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			</MvIF>
		</MvIF>
	<MvELSEIF EXPR = "{ CustomerAddress_Load_ID_Cached( l.customer:ship_id, l.customeraddress_ship ) }">
		<MvASSIGN NAME = "l.ship_address:id" 								VALUE = "{ l.customeraddress_ship:id }">
		<MvASSIGN NAME = "l.ship_address:descrip" 							VALUE = "{ l.customeraddress_ship:descrip }">

		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_StandardFields( l.standardfields, l.ship_address ) }">
			<MvASSIGN NAME = "l.customer:ship_id" 							VALUE = 0>
		<MvELSE>
			<MvIF EXPR = "{ l.customer:ship_id NE l.customer:bill_id }">
				<MvIF EXPR = "{ NOT CustomerAddress_Update( l.ship_address ) }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			<MvELSE>
				<MvIF EXPR = "{ l.standardfields:primaddr EQ 'shipping' }">
					<MvIF EXPR = "{ NOT CustomerAddress_Update( l.ship_address ) }">
						<MvFUNCTIONRETURN VALUE = 0>
					</MvIF>
				<MvELSE>
					<MvIF EXPR = "{ ISNULL l.customer:ship_descrip }">
						<MvASSIGN NAME = "l.ship_address:descrip" 			VALUE = "{ l.customer:ship_addr1 }">
					<MvELSE>
						<MvASSIGN NAME = "l.ship_address:descrip" 			VALUE = "{ l.customer:ship_descrip }">
					</MvIF>

					<MvIF EXPR = "{ NOT CustomerAddress_Insert( l.ship_address ) }">
						<MvFUNCTIONRETURN VALUE = 0>
					</MvIF>

					<MvASSIGN NAME = "l.customer:ship_id" 					VALUE = "{ l.ship_address:id }">
				</MvIF>
			</MvIF>
		</MvIF>
	<MvELSE>
		<MvIF EXPR = "{ ISNULL l.customer:ship_descrip }">
			<MvASSIGN NAME = "l.ship_address:descrip" 						VALUE = "{ l.customer:ship_addr1 }">
		<MvELSE>
			<MvASSIGN NAME = "l.ship_address:descrip" 						VALUE = "{ l.customer:ship_descrip }">
		</MvIF>

		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_StandardFields( l.standardfields, l.ship_address ) }">
			<MvASSIGN NAME = "l.customer:ship_id" 							VALUE = 0>
		<MvELSE>
			<MvIF EXPR = "{ NOT CustomerAddress_Insert( l.ship_address ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvASSIGN NAME = "l.customer:ship_id" 							VALUE = "{ l.ship_address:id }">
		</MvIF>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Update_Customer_Billing" PARAMETERS = "customer var, bill_address var, standardfields var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.customer:bill_id		EQ 0	AND
					l.bill_address:fname	EQ ''	AND
					l.bill_address:lname	EQ ''	AND
					l.bill_address:email	EQ ''	AND
					l.bill_address:comp		EQ ''	AND
					l.bill_address:phone	EQ ''	AND
					l.bill_address:fax		EQ ''	AND
					l.bill_address:addr1	EQ ''	AND
					l.bill_address:addr2	EQ ''	AND
					l.bill_address:city		EQ ''	AND
					l.bill_address:state	EQ ''	AND
					l.bill_address:zip		EQ ''	AND
					l.bill_address:cntry	EQ '' }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ CustomerAddress_Load_AddressFields( l.customer:id, l.bill_address, l.customeraddress_bill_original ) }">
		<MvASSIGN NAME = "l.customer:bill_id" 								VALUE = "{ l.customeraddress_bill_original:id }">
		<MvASSIGN NAME = "l.bill_address:id" 								VALUE = "{ l.customeraddress_bill_original:id }">
		<MvASSIGN NAME = "l.bill_address:descrip" 							VALUE = "{ l.customeraddress_bill_original:descrip }">
		<MvASSIGN NAME = "l.bill_address:resdntl" 							VALUE = "{ l.customeraddress_bill_original:resdntl }">

		<MvCOMMENT>
		|
		| Note: since CustomerAddress_Load_AddressFields will load matches case-insensitive,
		| we must check to see if any fields differ (including case) and update accordingly.
		| If updating the primary address, always update if the fields have changed
		| If updating the secondary address, only update if the original loaded matches the
		| newly loaded (ie, the case hasn't been altered by the primary record)
		|
		</MvCOMMENT>

		<MvIF EXPR = "{ l.standardfields:primaddr EQ 'billing' }">
			<MvIF EXPR = "{ l.bill_address:fname	NE l.customeraddress_bill_original:fname	OR
							l.bill_address:lname	NE l.customeraddress_bill_original:lname	OR
							l.bill_address:email	NE l.customeraddress_bill_original:email	OR
							l.bill_address:comp		NE l.customeraddress_bill_original:comp		OR
							l.bill_address:phone	NE l.customeraddress_bill_original:phone	OR
							l.bill_address:fax		NE l.customeraddress_bill_original:fax		OR
							l.bill_address:addr1	NE l.customeraddress_bill_original:addr1	OR
							l.bill_address:addr2	NE l.customeraddress_bill_original:addr2	OR
							l.bill_address:city		NE l.customeraddress_bill_original:city		OR
							l.bill_address:state	NE l.customeraddress_bill_original:state	OR
							l.bill_address:zip		NE l.customeraddress_bill_original:zip		OR
							l.bill_address:cntry	NE l.customeraddress_bill_original:cntry }">
				<MvIF EXPR = "{ NOT CustomerAddress_Update( l.bill_address ) }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			</MvIF>
		<MvELSEIF EXPR = "{ CustomerAddress_Load_ID( l.customeraddress_bill_original:id, l.customeraddress_bill ) }">
			<MvIF EXPR = "{ (
								l.customeraddress_bill:fname	EQ l.customeraddress_bill_original:fname	AND
								l.customeraddress_bill:lname	EQ l.customeraddress_bill_original:lname	AND
								l.customeraddress_bill:email	EQ l.customeraddress_bill_original:email	AND
								l.customeraddress_bill:comp		EQ l.customeraddress_bill_original:comp		AND
								l.customeraddress_bill:phone	EQ l.customeraddress_bill_original:phone	AND
								l.customeraddress_bill:fax		EQ l.customeraddress_bill_original:fax		AND
								l.customeraddress_bill:addr1	EQ l.customeraddress_bill_original:addr1	AND
								l.customeraddress_bill:addr2	EQ l.customeraddress_bill_original:addr2	AND
								l.customeraddress_bill:city		EQ l.customeraddress_bill_original:city		AND
								l.customeraddress_bill:state	EQ l.customeraddress_bill_original:state	AND
								l.customeraddress_bill:zip		EQ l.customeraddress_bill_original:zip		AND
								l.customeraddress_bill:cntry	EQ l.customeraddress_bill_original:cntry
							) AND
							( 
								l.bill_address:fname	NE l.customeraddress_bill_original:fname	OR
								l.bill_address:lname	NE l.customeraddress_bill_original:lname	OR
								l.bill_address:email	NE l.customeraddress_bill_original:email	OR
								l.bill_address:comp		NE l.customeraddress_bill_original:comp		OR
								l.bill_address:phone	NE l.customeraddress_bill_original:phone	OR
								l.bill_address:fax		NE l.customeraddress_bill_original:fax		OR
								l.bill_address:addr1	NE l.customeraddress_bill_original:addr1	OR
								l.bill_address:addr2	NE l.customeraddress_bill_original:addr2	OR
								l.bill_address:city		NE l.customeraddress_bill_original:city		OR
								l.bill_address:state	NE l.customeraddress_bill_original:state	OR
								l.bill_address:zip		NE l.customeraddress_bill_original:zip		OR
								l.bill_address:cntry	NE l.customeraddress_bill_original:cntry
							) }">
				<MvIF EXPR = "{ NOT CustomerAddress_Update( l.bill_address ) }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			</MvIF>
		</MvIF>
	<MvELSEIF EXPR = "{ CustomerAddress_Load_ID_Cached( l.customer:bill_id, l.customeraddress_bill ) }">
		<MvASSIGN NAME = "l.bill_address:id" 								VALUE = "{ l.customeraddress_bill:id }">
		<MvASSIGN NAME = "l.bill_address:descrip" 							VALUE = "{ l.customeraddress_bill:descrip }">
		<MvASSIGN NAME = "l.bill_address:resdntl" 							VALUE = "{ l.customeraddress_bill:resdntl }">

		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_StandardFields( l.standardfields, l.bill_address ) }">
			<MvASSIGN NAME = "l.customer:bill_id" 							VALUE = 0>
		<MvELSE>
			<MvIF EXPR = "{ l.customer:ship_id NE l.customer:bill_id }">
				<MvIF EXPR = "{ NOT CustomerAddress_Update( l.bill_address ) }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			<MvELSE>
				<MvIF EXPR = "{ l.standardfields:primaddr EQ 'billing' }">
					<MvIF EXPR = "{ NOT CustomerAddress_Update( l.bill_address ) }">
						<MvFUNCTIONRETURN VALUE = 0>
					</MvIF>
				<MvELSE>
					<MvIF EXPR = "{ CustomerAddress_Load_ID_Cached( l.customer:ship_id, l.customeraddress_ship ) AND
									[ g.Feature_Filename_CUS_UT ].CustomerAddress_Compare_Same( l.customeraddress_ship, l.bill_address ) }">
						<MvASSIGN NAME = "l.customer:bill_id" 				VALUE = "{ l.customer:ship_id }">
					<MvELSE>
						<MvIF EXPR = "{ ISNULL l.customer:bill_descrip }">
							<MvASSIGN NAME = "l.bill_address:descrip" 		VALUE = "{ l.customer:bill_addr1 }">
						<MvELSE>
							<MvASSIGN NAME = "l.bill_address:descrip" 		VALUE = "{ l.customer:bill_descrip }">
						</MvIF>

						<MvIF EXPR = "{ NOT CustomerAddress_Insert( l.bill_address ) }">
							<MvFUNCTIONRETURN VALUE = 0>
						</MvIF>

						<MvASSIGN NAME = "l.customer:bill_id" 				VALUE = "{ l.bill_address:id }">
					</MvIF>
				</MvIF>
			</MvIF>
		</MvIF>
	<MvELSE>
		<MvIF EXPR = "{ ISNULL l.customer:bill_descrip }">
			<MvASSIGN NAME = "l.bill_address:descrip" 						VALUE = "{ l.customer:bill_addr1 }">
		<MvELSE>
			<MvASSIGN NAME = "l.bill_address:descrip" 						VALUE = "{ l.customer:bill_descrip }">
		</MvIF>

		<MvASSIGN NAME = "l.bill_address:resdntl"							VALUE = 0>

		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_StandardFields( l.standardfields, l.bill_address ) }">
			<MvASSIGN NAME = "l.customer:bill_id" 							VALUE = 0>
		<MvELSE>
			<MvIF EXPR = "{ NOT CustomerAddress_Insert( l.bill_address ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvASSIGN NAME = "l.customer:bill_id" 							VALUE = "{ l.bill_address:id }">
		</MvIF>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Update_All_Account" PARAMETERS = "old_account_id, account_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $
			 				g.Store_Table_Prefix $ 'Customers
			 			  SET
			 			  	account_id = ?
			 			  WHERE
			 			  	account_id = ?' }"
			 FIELDS = "l.account_id, l.old_account_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00087', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Update_LastUpdated" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Customers
			 			  SET
			 				dt_updated	= ?
			 			  WHERE
			 				id			= ?' }"
			 FIELDS = "s.dyn_time_t,
					   l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00162', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Update_LastLogin" PARAMETERS = "customer var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.customer:dt_login" VALUE = "{ s.dyn_time_t }">

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $
			 				g.Store_Table_Prefix $ 'Customers
			 			  SET
			 			  	dt_login	= ?
			 			  WHERE
			 			  	id			= ?' }"
			 FIELDS = "l.customer:dt_login, l.customer:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00120', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Update_OrderMetrics" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| Regenerate Customer Metrics
	|
	</MvCOMMENT>

	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Metrics"
				QUERY	= "{ 'SELECT
								MIN( c.account_id )	AS account_id,
								COUNT( o.id )		AS order_cnt,
								AVG( o.total )		AS order_avg,
								SUM( o.total )		AS order_tot
							  FROM ' $ 
								g.Store_Table_Prefix $ 'Customers c
								LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'Orders o ON o.cust_id = c.id
							  WHERE
								c.id = ?' }"
				FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00156', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Metrics.d.EOF OR ( ISNULL Metrics.d.account_id ) }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "Metrics">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.account_id"	VALUE = "{ Metrics.d.account_id }">
	<MvASSIGN NAME = "l.order_cnt"	VALUE = "{ Metrics.d.order_cnt }">
	<MvASSIGN NAME = "l.order_avg"	VALUE = "{ Metrics.d.order_avg ROUND 2 }">
	<MvASSIGN NAME = "l.order_tot"	VALUE = "{ Metrics.d.order_tot ROUND 2 }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Metrics">

	<MvCOMMENT>
	|
	| Update Customer Metrics
	|
	</MvCOMMENT>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $
			 				g.Store_Table_Prefix $ 'Customers
			 			  SET
			 			  	order_cnt	= ?,
			 			  	order_avg	= ?,
			 			  	order_tot	= ?
			 			  WHERE
			 			  	id			= ?' }"
			 FIELDS = "l.order_cnt, l.order_avg, l.order_tot,
					   l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00153', g.MvQUERY_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ l.account_id GT 0 }">
		<MvIF EXPR = "{ NOT BusinessAccount_Update_OrderMetrics( l.account_id ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Adjust_Credit" PARAMETERS = "cust_id, credit" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Customers
					      SET
							credit	= credit + ?
					      WHERE
						    id		= ?' }"
			 FIELDS	= "l.credit, l.cust_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00071', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Delete_ID" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'Customers WHERE id = ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00007', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Delete" PARAMETERS = "customer var" STANDARDOUTPUTLEVEL = "">
	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_cust', l.modules ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Customer_Delete( l.module, l.customer ) }">
	</MvFOREACH>

	<MvTRANSACT NAME = "Merchant">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_SUB_DB ].Subscription_Delete_All_Customer( l.customer:id ) }">
		<MvROLLBACK NAME = "Merchant">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ l.customer:pgrpcount }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_PGR_DB ].PriceGroupXCustomer_Delete_All_Customer( l.customer:id ) }">
			<MvROLLBACK NAME = "Merchant">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_PGR_DB ].CouponXCustomer_Delete_All_Customer( l.customer:id ) }">
		<MvROLLBACK NAME = "Merchant">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Order_Update_All_Customer( l.customer:id, 0 ) }">
		<MvROLLBACK NAME = "Merchant">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ l.customer:agrpcount }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_AGR_DB ].AvailGroupXCustomer_Delete_All_Customer( l.customer:id ) }">
			<MvROLLBACK NAME = "Merchant">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_PAY_DB ].CustomerPaymentCard_Delete_All_Customer( l.customer:id ) }">
		<MvROLLBACK NAME = "Merchant">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT CustomerCreditHistory_Delete_All_Customer( l.customer:id ) }">
		<MvROLLBACK NAME = "Merchant">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT CustomerAddress_Delete_Customer( l.customer:id ) }">
		<MvROLLBACK NAME = "Merchant">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_WSH_DB ].WishLists_Delete_All_Customer( l.customer:id ) }">
		<MvROLLBACK NAME = "Merchant">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT Customer_Delete_ID( l.customer:id ) }">
		<MvROLLBACK NAME = "Merchant">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ l.customer:account_id }">
		<MvIF EXPR = "{ NOT BusinessAccount_Update_OrderMetrics( l.customer:account_id ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvCOMMIT NAME = "Merchant">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Increment_NoteCount" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Customers
			 			  SET
			 			  	note_count	= note_count + 1
			 			  WHERE
			 			  	id			= ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00099', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Decrement_NoteCount" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Customers
			 			  SET
			 			  	note_count	= note_count - 1
			 			  WHERE
			 			  	id			= ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00100', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Increment_AvailabilityGroupCount" PARAMETERS = "cust_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Customers
					      SET
							agrpcount	= agrpcount + 1
					      WHERE
						    id			= ?' }"
			 FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00129', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Decrement_AvailabilityGroupCount" PARAMETERS = "cust_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Customers
					      SET
							agrpcount	= agrpcount - 1
					      WHERE
						    id			= ?' }"
			 FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00130', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Decrement_AvailabilityGroupCount_All" PARAMETERS = "agrp_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Customers
					      SET
							agrpcount	= agrpcount - 1
					      WHERE
						    id IN ( SELECT cust_id FROM ' $ g.Store_Table_Prefix $ 'AvailGroupXCustomer WHERE agrp_id = ? )' }"
			 FIELDS	= "l.agrp_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00131', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Increment_PriceGroupCount" PARAMETERS = "cust_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Customers
					      SET
							pgrpcount	= pgrpcount + 1
					      WHERE
						    id			= ?' }"
			 FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00008', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Decrement_PriceGroupCount" PARAMETERS = "cust_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Customers
					      SET
							pgrpcount	= pgrpcount - 1
					      WHERE
						    id			= ?' }"
			 FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00009', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Decrement_PriceGroupCount_All" PARAMETERS = "pgrp_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Customers
					      SET
							pgrpcount	= pgrpcount - 1
					      WHERE
						    id IN ( SELECT cust_id FROM ' $ g.Store_Table_Prefix $ 'PriceGroupXCustomer WHERE pgrp_id = ? )' }"
			 FIELDS	= "l.pgrp_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00010', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Load_ID" PARAMETERS = "id, customer var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Customers"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'Customers WHERE id = ?' }"
				FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00011', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00031' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ Customer_Read( l.customer ) }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Load_ID_Cached" PARAMETERS = "id, customer var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.id"								VALUE = "{ int( l.id ) }">

	<MvIF EXPR = "{ l.id LE 0 }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00118' ) }">
	</MvIF>

	<MvREFERENCEARRAY NAME = "l.cache"					VARIABLE = "g.Session:cache:customer_load_id">
		<MvDIMENSION INDEX = "{ l.id }">
	</MvREFERENCEARRAY>

	<MvIF EXPR = "{ ISNULL l.cache:result }">
		<MvASSIGN NAME = "l.cache:result" 				VALUE = "{ Customer_Load_ID( l.id, l.cache:customer ) }">
		<MvIF EXPR = "{ NOT l.cache:result }">
			<MvASSIGN NAME = "l.cache:error_code"		VALUE = "{ g.Error_Code }">
			<MvASSIGN NAME = "l.cache:error_message"	VALUE = "{ g.Error_Message }">
			<MvASSIGN NAME = "l.cache:error_db_eof"		VALUE = "{ g.Error_DB_EOF }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT l.cache:result }">
		<MvIF EXPR = "{ l.cache:error_db_eof }">
			<MvFUNCTIONRETURN VALUE =  "{ [ g.Module_Library_DB ].Error_Load_EOF( l.cache:error_code ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( l.cache:error_code, l.cache:error_message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customer"						VALUE = "{ l.cache:customer }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Load_Login" PARAMETERS = "login, customer var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Customers"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'Customers WHERE ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'login' ) $ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) }"
				FIELDS	= "l.login">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00012', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00032' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ Customer_Read( l.customer ) }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Load_Email" PARAMETERS = "pw_email, customer var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Customers"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'Customers WHERE ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'pw_email' ) $ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ ' ORDER BY id ASC' }"
				FIELDS	= "l.pw_email">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00064', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00065' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ Customer_Read( l.customer ) }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Load_First" PARAMETERS = "customer var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers',
																			 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'Customers ORDER BY id ASC',
																			 '',
																			 0, 1 ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00013', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00033' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ Customer_Read( l.customer ) }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Load_Next" PARAMETERS = "customer var, next_customer var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.Customer_Load_Next_Customer_ID"		VALUE = "{ l.customer:id }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers',
																			 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'Customers WHERE id > ? ORDER BY id ASC',
																			 'g.Customer_Load_Next_Customer_ID',
																			 0, 1 ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00014', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00034' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ Customer_Read( l.next_customer ) }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Load_Previous" PARAMETERS = "customer var, prev_customer var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.Customer_Load_Previous_Customer_ID"	VALUE = "{ l.customer:id }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers',
																			 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'Customers WHERE id < ? ORDER BY id DESC',
																			 'g.Customer_Load_Previous_Customer_ID',
																			 0, 1 ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00015', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00035' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ Customer_Read( l.prev_customer ) }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Customer_Load_Last" PARAMETERS = "customer var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers',
																			 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'Customers ORDER BY id DESC',
																			 '',
																			 0, 1 ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00016', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00036' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ Customer_Read( l.customer ) }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerList_Load_All" PARAMETERS = "customers var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Customers"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'Customers' }">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00017', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customer_count"	VALUE = 0>
	<MvWHILE EXPR = "{ NOT Customers.d.EOF }">
		<MvASSIGN NAME = "l.customer_count" VALUE = "{ l.customer_count + 1 }">
		<MvEVAL EXPR = "{ Customer_Read( l.customers[ l.customer_count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "Customers">
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-CUS-DTB-00037', l.customer_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerList_Load_Offset" PARAMETERS = "offset, search, searchable_fields, max, nextoffset var, customers var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.query"		VALUE = "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'Customers' }">

	<MvIF EXPR = "{ len( l.search ) }">
		<MvASSIGN NAME = "l.query"	VALUE = "{ l.query $ ' WHERE ' $ [ g.Module_Library_DB ].SQL_Search_Clause( l.search, g.Store_Table_Prefix $ 'Customers', l.searchable_fields, l.fields ) }">
	</MvIF>

	<MvASSIGN NAME = "l.query"		VALUE = "{ l.query $ ' ORDER BY id' }">

	<MvIF EXPR = "{ l.max EQ 0 }">	<MvASSIGN NAME = "l.limit" VALUE = 0>
	<MvELSE>						<MvASSIGN NAME = "l.limit" VALUE = "{ l.max + 1 }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers',
																			 l.query, l.fields,
																			 l.offset, l.limit ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00018', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customer_count" VALUE = 0>
	<MvWHILE EXPR = "{ ( NOT Customers.d.EOF ) AND ( ( l.max EQ 0 ) OR ( l.customer_count LT l.max ) ) }">
		<MvASSIGN NAME = "l.customer_count" VALUE = "{ l.customer_count + 1 }">
		<MvEVAL EXPR = "{ Customer_Read( l.customers[ l.customer_count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "Customers" ROWS = 1>
	</MvWHILE>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvASSIGN NAME = "l.nextoffset"	VALUE = 0>
	<MvELSE>
		<MvASSIGN NAME = "l.nextoffset"	VALUE = "{ l.offset + l.customer_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-CUS-DTB-00038', l.customer_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerList_Load_Offset_AvailabilityGroup_Unassigned" PARAMETERS = "agrp_id, offset, search, searchable_fields, max, nextoffset var, customers var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.CustomerList_Load_Offset_AvailabilityGroup_Unassigned_Agrp_ID"	VALUE = "{ l.agrp_id }">

	<MvASSIGN NAME = "l.fields"		VALUE = "g.CustomerList_Load_Offset_AvailabilityGroup_Unassigned_Agrp_ID">
	<MvASSIGN NAME = "l.query"		VALUE = "{ 'SELECT
													cus.*
												FROM ' $
													g.Store_Table_Prefix $ 'Customers cus
													LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'AvailGroupXCustomer agxc ON agxc.agrp_id = ? AND agxc.cust_id = cus.id
												WHERE
													agxc.cust_id IS NULL' }">
	<MvIF EXPR = "{ len( l.search ) }">
		<MvASSIGN NAME = "l.query"	VALUE = "{ l.query $ ' AND ' $ [ g.Module_Library_DB ].SQL_Search_Clause( l.search, 'cus', l.searchable_fields, l.fields ) }">
	</MvIF>

	<MvASSIGN NAME = "l.query"		VALUE = "{ l.query $ ' ORDER BY cus.id' }">

	<MvIF EXPR = "{ l.max EQ 0 }">	<MvASSIGN NAME = "l.limit" VALUE = 0>
	<MvELSE>						<MvASSIGN NAME = "l.limit" VALUE = "{ l.max + 1 }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers',
																			 l.query, l.fields,
																			 l.offset, l.limit ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00019', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customer_count" VALUE = 0>
	<MvWHILE EXPR = "{ ( NOT Customers.d.EOF ) AND ( ( l.max EQ 0 ) OR ( l.customer_count LT l.max ) ) }">
		<MvASSIGN NAME = "l.customer_count" VALUE = "{ l.customer_count + 1 }">
		<MvEVAL EXPR = "{ Customer_Read( l.customers[ l.customer_count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "Customers" ROWS = 1>
	</MvWHILE>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvASSIGN NAME = "l.nextoffset"	VALUE = 0>
	<MvELSE>
		<MvASSIGN NAME = "l.nextoffset"	VALUE = "{ l.offset + l.customer_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-CUS-DTB-00039', l.customer_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerList_Load_Offset_AvailabilityGroup_All" PARAMETERS = "agrp_id, offset, search, searchable_fields, max, nextoffset var, customers var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.CustomerList_Load_Offset_AvailabilityGroup_All_Agrp_ID"	VALUE = "{ l.agrp_id }">

	<MvASSIGN NAME = "l.fields"		VALUE = "g.CustomerList_Load_Offset_AvailabilityGroup_All_Agrp_ID">
	<MvASSIGN NAME = "l.query"		VALUE = "{ 'SELECT
													cust.*,
													agxc.agrp_id AS assigned
												FROM ' $
													g.Store_Table_Prefix $ 'Customers cust
													LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'AvailGroupXCustomer agxc ON ( cust.id = agxc.cust_id and agxc.agrp_id = ? )' }">

	<MvIF EXPR = "{ len( l.search ) }">
		<MvASSIGN NAME = "l.query"	VALUE = "{ l.query $ ' WHERE ' $ [ g.Module_Library_DB ].SQL_Search_Clause( l.search, 'cust', l.searchable_fields, l.fields ) }">
	</MvIF>

	<MvASSIGN NAME = "l.query"		VALUE = "{ l.query $ ' ORDER BY cust.id' }">

	<MvIF EXPR = "{ l.max EQ 0 }">	<MvASSIGN NAME = "l.limit" VALUE = 0>
	<MvELSE>						<MvASSIGN NAME = "l.limit" VALUE = "{ l.max + 1 }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers',
																			 l.query, l.fields,
																			 l.offset, l.limit ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00020', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customer_count" VALUE = 0>
	<MvWHILE EXPR = "{ ( NOT Customers.d.EOF ) AND ( ( l.max EQ 0 ) OR ( l.customer_count LT l.max ) ) }">
		<MvASSIGN NAME = "l.customer_count" VALUE = "{ l.customer_count + 1 }">
		<MvEVAL EXPR = "{ Customer_Read( l.customers[ l.customer_count ] ) }">
		<MvASSIGN NAME = "l.customers" INDEX = "{ l.customer_count }" MEMBER = "assigned" VALUE = "{ Customers.d.assigned NE 0 }">

		<MvSKIP NAME = "Merchant" VIEW = "Customers" ROWS = 1>
	</MvWHILE>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvASSIGN NAME = "l.nextoffset"	VALUE = 0>
	<MvELSE>
		<MvASSIGN NAME = "l.nextoffset"	VALUE = "{ l.offset + l.customer_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-CUS-DTB-00040', l.customer_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerList_Load_Offset_AvailabilityGroup_Assigned" PARAMETERS = "agrp_id, offset, search, searchable_fields, max, nextoffset var, customers var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.CustomerList_Load_Offset_AvailabilityGroup_Assigned_Agrp_ID"	VALUE = "{ l.agrp_id }">

	<MvASSIGN NAME = "l.fields"		VALUE = "g.CustomerList_Load_Offset_AvailabilityGroup_Assigned_Agrp_ID">
	<MvASSIGN NAME = "l.query"		VALUE = "{ 'SELECT
													cust.*
												FROM ' $
													g.Store_Table_Prefix $ 'Customers cust, ' $
													g.Store_Table_Prefix $ 'AvailGroupXCustomer agxc
												WHERE
													cust.id			= agxc.cust_id AND
													agxc.agrp_id	= ?' }">

	<MvIF EXPR = "{ len( l.search ) }">
		<MvASSIGN NAME = "l.query"	VALUE = "{ l.query $ ' AND ' $ [ g.Module_Library_DB ].SQL_Search_Clause( l.search, 'cust', l.searchable_fields, l.fields ) }">
	</MvIF>

	<MvASSIGN NAME = "l.query"		VALUE = "{ l.query $ ' ORDER BY cust.id' }">

	<MvIF EXPR = "{ l.max EQ 0 }">	<MvASSIGN NAME = "l.limit" VALUE = 0>
	<MvELSE>						<MvASSIGN NAME = "l.limit" VALUE = "{ l.max + 1 }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers',
																			 l.query, l.fields,
																			 l.offset, l.limit ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00021', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customer_count" VALUE = 0>
	<MvWHILE EXPR = "{ ( NOT Customers.d.EOF ) AND ( ( l.max EQ 0 ) OR ( l.customer_count LT l.max ) ) }">
		<MvASSIGN NAME = "l.customer_count" VALUE = "{ l.customer_count + 1 }">
		<MvEVAL EXPR = "{ Customer_Read( l.customers[ l.customer_count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "Customers" ROWS = 1>
	</MvWHILE>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvASSIGN NAME = "l.nextoffset"	VALUE = 0>
	<MvELSE>
		<MvASSIGN NAME = "l.nextoffset"	VALUE = "{ l.offset + l.customer_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-CUS-DTB-00041', l.customer_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerList_Load_Offset_PriceGroup_Unassigned" PARAMETERS = "pgrp_id, offset, search, searchable_fields, max, nextoffset var, customers var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.CustomerList_Load_Offset_PriceGroup_Unassigned_Pgrp_ID"	VALUE = "{ l.pgrp_id }">

	<MvASSIGN NAME = "l.fields"		VALUE = "g.CustomerList_Load_Offset_PriceGroup_Unassigned_Pgrp_ID">
	<MvASSIGN NAME = "l.query"		VALUE = "{ 'SELECT
													cus.*
												FROM ' $
													g.Store_Table_Prefix $ 'Customers cus
													LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'PriceGroupXCustomer pgxc ON pgxc.pgrp_id = ? AND pgxc.cust_id = cus.id
												WHERE
													pgxc.cust_id IS NULL' }">

	<MvIF EXPR = "{ len( l.search ) }">
		<MvASSIGN NAME = "l.query"	VALUE = "{ l.query $ ' AND ' $ [ g.Module_Library_DB ].SQL_Search_Clause( l.search, 'cus', l.searchable_fields, l.fields ) }">
	</MvIF>

	<MvASSIGN NAME = "l.query"		VALUE = "{ l.query $ ' ORDER BY cus.id' }">

	<MvIF EXPR = "{ l.max EQ 0 }">	<MvASSIGN NAME = "l.limit" VALUE = 0>
	<MvELSE>						<MvASSIGN NAME = "l.limit" VALUE = "{ l.max + 1 }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers',
																			 l.query, l.fields,
																			 l.offset, l.limit ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00022', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customer_count" VALUE = 0>
	<MvWHILE EXPR = "{ ( NOT Customers.d.EOF ) AND ( ( l.max EQ 0 ) OR ( l.customer_count LT l.max ) ) }">
		<MvASSIGN NAME = "l.customer_count" VALUE = "{ l.customer_count + 1 }">
		<MvEVAL EXPR = "{ Customer_Read( l.customers[ l.customer_count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "Customers" ROWS = 1>
	</MvWHILE>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvASSIGN NAME = "l.nextoffset"	VALUE = 0>
	<MvELSE>
		<MvASSIGN NAME = "l.nextoffset"	VALUE = "{ l.offset + l.customer_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-CUS-DTB-00042', l.customer_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerList_Load_Offset_PriceGroup_All" PARAMETERS = "pgrp_id, offset, search, searchable_fields, max, nextoffset var, customers var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.CustomerList_Load_Offset_PriceGroup_All_Pgrp_ID"	VALUE = "{ l.pgrp_id }">

	<MvASSIGN NAME = "l.fields"		VALUE = "g.CustomerList_Load_Offset_PriceGroup_All_Pgrp_ID">
	<MvASSIGN NAME = "l.query"		VALUE = "{ 'SELECT
													cust.*,
													pgxc.pgrp_id AS assigned
												FROM ' $
													g.Store_Table_Prefix $ 'Customers cust
													LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'PriceGroupXCustomer pgxc ON ( cust.id = pgxc.cust_id and pgxc.pgrp_id = ? )' }">

	<MvIF EXPR = "{ len( l.search ) }">
		<MvASSIGN NAME = "l.query"	VALUE = "{ l.query $ ' WHERE ' $ [ g.Module_Library_DB ].SQL_Search_Clause( l.search, 'cust', l.searchable_fields, l.fields ) }">
	</MvIF>

	<MvASSIGN NAME = "l.query"		VALUE = "{ l.query $ ' ORDER BY cust.id' }">

	<MvIF EXPR = "{ l.max EQ 0 }">	<MvASSIGN NAME = "l.limit" VALUE = 0>
	<MvELSE>						<MvASSIGN NAME = "l.limit" VALUE = "{ l.max + 1 }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers',
																			 l.query, l.fields,
																			 l.offset, l.limit ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00023', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customer_count" VALUE = 0>
	<MvWHILE EXPR = "{ ( NOT Customers.d.EOF ) AND ( ( l.max EQ 0 ) OR ( l.customer_count LT l.max ) ) }">
		<MvASSIGN NAME = "l.customer_count" VALUE = "{ l.customer_count + 1 }">
		<MvEVAL EXPR = "{ Customer_Read( l.customers[ l.customer_count ] ) }">
		<MvASSIGN NAME = "l.customers" INDEX = "{ l.customer_count }" MEMBER = "assigned" VALUE = "{ Customers.d.assigned NE 0 }">

		<MvSKIP NAME = "Merchant" VIEW = "Customers" ROWS = 1>
	</MvWHILE>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvASSIGN NAME = "l.nextoffset"	VALUE = 0>
	<MvELSE>
		<MvASSIGN NAME = "l.nextoffset"	VALUE = "{ l.offset + l.customer_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-CUS-DTB-00043', l.customer_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerList_Load_Offset_PriceGroup_Assigned" PARAMETERS = "pgrp_id, offset, search, searchable_fields, max, nextoffset var, customers var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.CustomerList_Load_Offset_PriceGroup_Assigned_Pgrp_ID"	VALUE = "{ l.pgrp_id }">

	<MvASSIGN NAME = "l.fields"		VALUE = "g.CustomerList_Load_Offset_PriceGroup_Assigned_Pgrp_ID">
	<MvASSIGN NAME = "l.query"		VALUE = "{ 'SELECT
													cust.*
												FROM ' $
													g.Store_Table_Prefix $ 'Customers cust, ' $
													g.Store_Table_Prefix $ 'PriceGroupXCustomer pgxc
												WHERE
													cust.id			= pgxc.cust_id AND
													pgxc.pgrp_id	= ?' }">

	<MvIF EXPR = "{ len( l.search ) }">
		<MvASSIGN NAME = "l.query"	VALUE = "{ l.query $ ' AND ' $ [ g.Module_Library_DB ].SQL_Search_Clause( l.search, 'cust', l.searchable_fields, l.fields ) }">
	</MvIF>

	<MvASSIGN NAME = "l.query"		VALUE = "{ l.query $ ' ORDER BY id' }">

	<MvIF EXPR = "{ l.max EQ 0 }">	<MvASSIGN NAME = "l.limit" VALUE = 0>
	<MvELSE>						<MvASSIGN NAME = "l.limit" VALUE = "{ l.max + 1 }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Customers',
																			 l.query, l.fields,
																			 l.offset, l.limit ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00024', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customer_count" VALUE = 0>
	<MvWHILE EXPR = "{ ( NOT Customers.d.EOF ) AND ( ( l.max EQ 0 ) OR ( l.customer_count LT l.max ) ) }">
		<MvASSIGN NAME = "l.customer_count" VALUE = "{ l.customer_count + 1 }">
		<MvEVAL EXPR = "{ Customer_Read( l.customers[ l.customer_count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "Customers" ROWS = 1>
	</MvWHILE>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvASSIGN NAME = "l.nextoffset"	VALUE = 0>
	<MvELSE>
		<MvASSIGN NAME = "l.nextoffset"	VALUE = "{ l.offset + l.customer_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-CUS-DTB-00044', l.customer_count ) }">
</MvFUNCTION>

<MvCOMMENT>
|
| CustomerEmail
|
</MvCOMMENT>

<MvFUNCTION NAME = "CustomerEmail_Read" PARAMETERS = "customeremail var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.customeremail:email_from"	VALUE = "{ CustomerEmail.d.email_from }">
	<MvASSIGN NAME = "l.customeremail:email_cc"		VALUE = "{ CustomerEmail.d.email_cc }">
	<MvASSIGN NAME = "l.customeremail:subject"		VALUE = "{ CustomerEmail.d.subject }">
	<MvASSIGN NAME = "l.customeremail:header"		VALUE = "{ CustomerEmail.d.header }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerEmail_Insert" PARAMETERS = "customeremail var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'CustomerEmail
					      ( email_from, email_cc, subject, header )
						  VALUES
						  ( ?, ?, ?, ? )' }"
			 FIELDS	= "l.customeremail:email_from, l.customeremail:email_cc, l.customeremail:subject,
					   l.customeremail:header">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00028', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerEmail_Update" PARAMETERS = "customeremail var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'CustomerEmail
					      SET
							email_from	= ?,
							email_cc	= ?,
							subject		= ?,
							header		= ?' }"
			 FIELDS	= "l.customeremail:email_from, l.customeremail:email_cc, l.customeremail:subject,
					   l.customeremail:header">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00029', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerEmail_Load" PARAMETERS = "customeremail var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "CustomerEmail"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'CustomerEmail' }">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00030', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvEVAL EXPR = "{ CustomerEmail_Read( l.customeremail ) }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerEmail">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| CustomerSettings
|
</MvCOMMENT>

<MvFUNCTION NAME = "CustomerSettings_Read" PARAMETERS = "customersettings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.customersettings:pw_min_len"	VALUE = "{ CustomerSettings.d.pw_min_len }">
	<MvASSIGN NAME = "l.customersettings:pw_complex"	VALUE = "{ CustomerSettings.d.pw_complex }">
	<MvASSIGN NAME = "l.customersettings:resettype"		VALUE = "{ CustomerSettings.d.resettype }">
	<MvASSIGN NAME = "l.customersettings:resetexp"		VALUE = "{ CustomerSettings.d.resetexp }">
	<MvASSIGN NAME = "l.customersettings:pwchgauth"		VALUE = "{ CustomerSettings.d.pwchgauth }">
	<MvASSIGN NAME = "l.customersettings:def_wshlst"	VALUE = "{ CustomerSettings.d.def_wshlst }">
	<MvASSIGN NAME = "l.customersettings:req_token"		VALUE = "{ CustomerSettings.d.req_token }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerSettings_Insert" PARAMETERS = "customersettings var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'CustomerSettings
					      ( pw_min_len, pw_complex, resettype, resetexp, pwchgauth, def_wshlst, req_token )
						  VALUES
						  ( ?, ?, ?, ?, ?, ?, ? )' }"
			 FIELDS	= "l.customersettings:pw_min_len, l.customersettings:pw_complex, l.customersettings:resettype, l.customersettings:resetexp,
			 		   l.customersettings:pwchgauth, l.customersettings:def_wshlst, l.customersettings:req_token">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00051', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerSettings_Update" PARAMETERS = "customersettings var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.Session:cache:customersettings_load_cached"	VALUE = "">

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'CustomerSettings
					      SET
							pw_min_len	= ?,
							pw_complex	= ?,
							resettype	= ?,
							resetexp	= ?,
							pwchgauth	= ?,
							def_wshlst	= ?,
							req_token	= ?' }"
			 FIELDS	= "l.customersettings:pw_min_len, l.customersettings:pw_complex, l.customersettings:resettype, l.customersettings:resetexp,
			 		   l.customersettings:pwchgauth, l.customersettings:def_wshlst, l.customersettings:req_token">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00052', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerSettings_Load_Cached" PARAMETERS = "customersettings var" STANDARDOUTPUTLEVEL = "">
	<MvREFERENCE NAME = "l.cache"						VARIABLE = "g.Session:cache:customersettings_load_cached">

	<MvIF EXPR = "{ ISNULL l.cache:result }">
		<MvASSIGN NAME = "l.cache:result"				VALUE = "{ CustomerSettings_Load( l.cache:customersettings ) }">
		<MvIF EXPR = "{ NOT l.cache:result }">
			<MvASSIGN NAME = "l.cache:error_code"		VALUE = "{ g.Error_Code }">
			<MvASSIGN NAME = "l.cache:error_message"	VALUE = "{ g.Error_Message }">
            <MvASSIGN NAME = "l.cache:error_db_eof"		VALUE = "{ g.Error_DB_EOF }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT l.cache:result }">
		<MvIF EXPR = "{ l.cache:error_db_eof }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( l.cache:error_code ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( l.cache:error_code, l.cache:error_message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customersettings"				VALUE = "{ l.cache:customersettings }">

	<MvFUNCTIONRETURN VALUE = "{ l.cache:result }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerSettings_Load" PARAMETERS = "customersettings var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "CustomerSettings"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'CustomerSettings' }">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00053', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvEVAL EXPR = "{ CustomerSettings_Read( l.customersettings ) }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerSettings">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerPasswordReset_Generate" PARAMETERS = "cust_id, token var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT CustomerPasswordReset_Delete_Expired() }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.reset:cust_id"		VALUE = "{ l.cust_id }">
	<MvASSIGN NAME = "l.reset:token"		VALUE = "{ glosub( crypto_base64_encode( crypto_rand_bytes( 36 ) ), '+', '_' ) }">
	<MvASSIGN NAME = "l.reset:dt_created"	VALUE = "{ s.dyn_time_t }">

	<MvIF EXPR = "{ NOT CustomerPasswordReset_Insert( l.reset ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_Error_IsIndexDuplicate( g.Error_Message ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ NOT CustomerPasswordReset_Update( l.reset ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvASSIGN NAME = "l.token"				VALUE = "{ l.reset:token }">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerPasswordReset_Insert" PARAMETERS = "reset var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'CustomerPasswordReset
						  ( cust_id, token, dt_created )
						  VALUES
						  ( ?, ?, ? )' }"
			 FIELDS	= "l.reset:cust_id, l.reset:token, l.reset:dt_created">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00058', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerPasswordReset_Update" PARAMETERS = "reset var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'CustomerPasswordReset
						  SET
							token		= ?,
							dt_created	= ?
						  WHERE
							cust_id		= ?' }"
			 FIELDS	= "l.reset:token, l.reset:dt_created,
					   l.reset:cust_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00059', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerPasswordReset_Delete_Expired" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT CustomerSettings_Load_Cached( l.customersettings ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.expiry_cutoff"	VALUE = "{ s.dyn_time_t - ( l.customersettings:resetexp * 60 ) }">

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'CustomerPasswordReset WHERE dt_created < ?' }"
			 FIELDS	= "l.expiry_cutoff">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00060', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerPasswordReset_Delete_Customer" PARAMETERS = "cust_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'CustomerPasswordReset WHERE cust_id = ?' }"
			 FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00061', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerPasswordReset_Load_Token" PARAMETERS = "token, reset var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT CustomerPasswordReset_Delete_Expired() }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "CustomerPasswordReset"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'CustomerPasswordReset WHERE token = ?' }"
				FIELDS	= "l.token">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00062', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ CustomerPasswordReset.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerPasswordReset">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00063' ) }">
	</MvIF>

	<MvASSIGN NAME = "l.reset:cust_id"		VALUE = "{ CustomerPasswordReset.d.cust_id }">
	<MvASSIGN NAME = "l.reset:token"		VALUE = "{ CustomerPasswordReset.d.token }">
	<MvASSIGN NAME = "l.reset:dt_created"	VALUE = "{ CustomerPasswordReset.d.dt_created }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerPasswordReset">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| CustomerCreditHistory
|
</MvCOMMENT>

<MvFUNCTION NAME = "CustomerCreditHistory_Read" PARAMETERS = "credit var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.credit:id"				VALUE = "{ CustomerCreditHistory.d.id }">
	<MvASSIGN NAME = "l.credit:user_id"			VALUE = "{ CustomerCreditHistory.d.user_id }">
	<MvASSIGN NAME = "l.credit:cust_id"			VALUE = "{ CustomerCreditHistory.d.cust_id }">
	<MvASSIGN NAME = "l.credit:order_id"		VALUE = "{ CustomerCreditHistory.d.order_id }">
	<MvASSIGN NAME = "l.credit:txref"			VALUE = "{ CustomerCreditHistory.d.txref }">
	<MvASSIGN NAME = "l.credit:descrip"			VALUE = "{ CustomerCreditHistory.d.descrip }">
	<MvASSIGN NAME = "l.credit:amount"			VALUE = "{ CustomerCreditHistory.d.amount }">
	<MvASSIGN NAME = "l.credit:dtstamp"			VALUE = "{ CustomerCreditHistory.d.dtstamp }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerCreditHistory_Insert" PARAMETERS = "credit var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Customer_Adjust_Credit( l.credit:cust_id, l.credit:amount ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	<MvELSEIF EXPR = "{ NOT CustomerCreditHistory_Insert_LowLevel( l.credit ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerCreditHistory_Insert_LowLevel" PARAMETERS = "credit var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.credit:id"				VALUE = "{ [ g.Module_Library_DB ].StoreKey_Generate( 'CustomerCreditHistory' ) }">
	<MvASSIGN NAME = "l.credit:dtstamp"			VALUE = "{ s.dyn_time_t }">

	<MvIF EXPR = "{ ISNULL l.credit:user_id }">		<MvASSIGN NAME = "l.credit:user_id"		VALUE = 0> </MvIF>
	<MvIF EXPR = "{ ISNULL l.credit:order_id }">	<MvASSIGN NAME = "l.credit:order_id"	VALUE = 0> </MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory
					      ( id, user_id, cust_id, order_id, txref, descrip, amount, dtstamp )
						  VALUES
						  ( ?, ?, ?, ?, ?, ?, ?, ? )' }"
			 FIELDS	= "l.credit:id, l.credit:user_id, l.credit:cust_id, l.credit:order_id,
					   l.credit:txref, l.credit:descrip, l.credit:amount, l.credit:dtstamp">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00072', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerCreditHistory_Delete_All_Customer" PARAMETERS = "cust_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory WHERE cust_id = ?' }"
			 FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00074', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerCreditHistory_Delete_ID" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory WHERE id = ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00075', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerCreditHistory_Load_ID" PARAMETERS = "id, credit var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "CustomerCreditHistory"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory WHERE id = ?' }"
				FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00076', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ CustomerCreditHistory.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerCreditHistory">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00077' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ CustomerCreditHistory_Read( l.credit ) }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerCreditHistory">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerCreditHistoryList_Load_All" PARAMETERS = "credits var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "CustomerCreditHistory"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory' }">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00078', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.credit_count"	VALUE = 0>
	<MvWHILE EXPR = "{ NOT CustomerCreditHistory.d.EOF }">
		<MvEVAL EXPR = "{ CustomerCreditHistory_Read( l.credits[ ++l.credit_count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "CustomerCreditHistory">
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerCreditHistory">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-CUS-DTB-00079', l.credit_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerCreditHistoryList_Load_Customer" PARAMETERS = "cust_id, credits var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "CustomerCreditHistory"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'CustomerCreditHistory WHERE cust_id = ?' }"
				FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00080', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.credit_count"	VALUE = 0>
	<MvWHILE EXPR = "{ NOT CustomerCreditHistory.d.EOF }">
		<MvEVAL EXPR = "{ CustomerCreditHistory_Read( l.credits[ ++l.credit_count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "CustomerCreditHistory">
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerCreditHistory">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-CUS-DTB-00081', l.credit_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerCreditHistoryList_Load_Offset_Customer" PARAMETERS = "cust_id, offset, max, sort, nextoffset var, credits var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.sort EQ 'id_desc' }">				<MvASSIGN NAME = "l.sort_col" VALUE = "id">			<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'orderid_asc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "order_id">	<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'orderid_desc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "order_id">	<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'txref_asc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "txref">		<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'txref_desc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "txref">		<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'descrip_asc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "descrip">	<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'descrip_desc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "descrip">	<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'amount_asc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "amount">		<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'amount_desc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "amount">		<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSEIF EXPR = "{ l.sort EQ 'dtstamp_asc' }">		<MvASSIGN NAME = "l.sort_col" VALUE = "dtstamp">	<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	<MvELSEIF EXPR = "{ l.sort EQ 'dtstamp_desc' }">	<MvASSIGN NAME = "l.sort_col" VALUE = "dtstamp">	<MvASSIGN NAME = "l.sort_dir" VALUE = "DESC">
	<MvELSE>											<MvASSIGN NAME = "l.sort_col" VALUE = "id">			<MvASSIGN NAME = "l.sort_dir" VALUE = "ASC">
	</MvIF>

	<MvIF EXPR = "{ l.max EQ 0 }">	<MvASSIGN NAME = "l.limit" VALUE = 0>
	<MvELSE>						<MvASSIGN NAME = "l.limit" VALUE = "{ l.max + 1 }">
	</MvIF>

	<MvASSIGN NAME = "g.Session:cache:customercredithistorylist_load_offset_customer:cust_id"	VALUE = "{ l.cust_id }">
	<MvASSIGN NAME = "l.fields"																	VALUE = "g.Session:cache:customercredithistorylist_load_offset_customer:cust_id">

	<MvASSIGN NAME = "l.query"	VALUE = "{ 'SELECT
												*
											FROM ' $ 
												g.Store_Table_Prefix $ 'CustomerCreditHistory 
											WHERE
												cust_id = ? 
											ORDER BY ' $
												l.sort_col $ ' ' $ l.sort_dir }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'CustomerCreditHistory',
																			 l.query, l.fields,
																			 l.offset, l.limit ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00082', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.credit_count" VALUE = 0>
	<MvWHILE EXPR = "{ ( NOT CustomerCreditHistory.d.EOF ) AND ( ( l.max EQ 0 ) OR ( l.credit_count LT l.max ) ) }">
		<MvEVAL EXPR = "{ CustomerCreditHistory_Read( l.credits[ ++l.credit_count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "CustomerCreditHistory" ROWS = 1>
	</MvWHILE>
	
	<MvIF EXPR = "{ CustomerCreditHistory.d.EOF }">
		<MvASSIGN NAME = "l.nextoffset"	VALUE = 0>
	<MvELSE>
		<MvASSIGN NAME = "l.nextoffset"	VALUE = "{ l.offset + l.credit_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerCreditHistory">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-CUS-DTB-00083', l.credit_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerCreditHistoryList_Count_Customer" PARAMETERS = "cust_id, count var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "CustomerCreditHistory"
				QUERY	= "{ 'SELECT
								COUNT( * ) AS total_count
							  FROM ' $
								g.Store_Table_Prefix $ 'CustomerCreditHistory
							  WHERE
								cust_id = ?' }"
				FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ CustomerCreditHistory.d.EOF }">	<MvASSIGN NAME = "l.count" VALUE = 0>
	<MvELSE>										<MvASSIGN NAME = "l.count" VALUE = "{ CustomerCreditHistory.d.total_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerCreditHistory">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| BusinessAccounts
|
</MvCOMMENT>

<MvFUNCTION NAME = "BusinessAccount_Read" PARAMETERS = "businessaccount var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.businessaccount:id" 		VALUE = "{ BusinessAccounts.d.id }">
	<MvASSIGN NAME = "l.businessaccount:agrpcount"	VALUE = "{ BusinessAccounts.d.agrpcount }">
	<MvASSIGN NAME = "l.businessaccount:pgrpcount"	VALUE = "{ BusinessAccounts.d.pgrpcount }">
	<MvASSIGN NAME = "l.businessaccount:title"		VALUE = "{ BusinessAccounts.d.title }">
	<MvASSIGN NAME = "l.businessaccount:note_count"	VALUE = "{ BusinessAccounts.d.note_count }">
	<MvASSIGN NAME = "l.businessaccount:tax_exempt"	VALUE = "{ BusinessAccounts.d.tax_exempt }">
	<MvASSIGN NAME = "l.businessaccount:order_cnt"	VALUE = "{ BusinessAccounts.d.order_cnt }">
	<MvASSIGN NAME = "l.businessaccount:order_avg"	VALUE = "{ BusinessAccounts.d.order_avg }">
	<MvASSIGN NAME = "l.businessaccount:order_tot"	VALUE = "{ BusinessAccounts.d.order_tot }">
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Load" PARAMETERS = "id, businessaccount var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW 	= "BusinessAccounts"
				QUERY 	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'BusinessAccounts WHERE id = ?' }"
				FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00088', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ BusinessAccounts.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "BusinessAccounts">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00089' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ BusinessAccount_Read( l.businessaccount ) }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "BusinessAccounts">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Load_Title" PARAMETERS = "title, businessaccount var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW 	= "BusinessAccounts"
				QUERY 	= "{ 'SELECT
								*
							  FROM
							  	' $ g.Store_Table_Prefix $ 'BusinessAccounts
							  WHERE
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'title' ) $ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) }"
				FIELDS	= "l.title">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00090', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ BusinessAccounts.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "BusinessAccounts">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00091' ) }">	
	</MvIF>

	<MvEVAL EXPR = "{ BusinessAccount_Read( l.businessaccount ) }">
	
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "BusinessAccounts">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Insert" PARAMETERS = "businessaccount var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.businessaccount:id"				VALUE = "{ [ g.Module_Library_DB ].StoreKey_Generate( 'BusinessAccounts' ) }">
	<MvASSIGN NAME = "l.businessaccount:note_count"		VALUE = 0>

	<MvIF EXPR = "{ ISNULL l.businessaccount:agrpcount }">
		<MvASSIGN NAME = "l.businessaccount:agrpcount"	VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.businessaccount:pgrpcount }">
		<MvASSIGN NAME = "l.businessaccount:pgrpcount"	VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.businessaccount:tax_exempt }">
		<MvASSIGN NAME = "l.businessaccount:tax_exempt" VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.businessaccount:order_cnt }">
		<MvASSIGN NAME = "l.businessaccount:order_cnt" VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.businessaccount:order_avg }">
		<MvASSIGN NAME = "l.businessaccount:order_avg" VALUE = 0.00>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.businessaccount:order_tot }">
		<MvASSIGN NAME = "l.businessaccount:order_tot" VALUE = 0.00>
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'BusinessAccounts
						  ( id, agrpcount, pgrpcount, title, note_count, tax_exempt, order_cnt, order_avg, order_tot )
						  VALUES
						  ( ?, ?, ?, ?, ?, ?, ?, ?, ? )' }"
			 FIELDS	= "l.businessaccount:id, l.businessaccount:agrpcount, l.businessaccount:pgrpcount,
					   l.businessaccount:title, l.businessaccount:note_count, l.businessaccount:tax_exempt,
					   l.businessaccount:order_cnt, l.businessaccount:order_avg, l.businessaccount:order_tot">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00092', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Update" PARAMETERS = "businessaccount var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $
			 				g.Store_Table_Prefix $ 'BusinessAccounts
			 			  SET
							agrpcount	= ?,
							pgrpcount	= ?,
			 				title		= ?,
			 				tax_exempt	= ?,
			 				order_cnt	= ?,
			 				order_avg	= ?,
			 				order_tot	= ?
			 			  WHERE
			 				id = ?' }"
			 FIELDS = "l.businessaccount:agrpcount, l.businessaccount:pgrpcount, l.businessaccount:title, l.businessaccount:tax_exempt,
			 		   l.businessaccount:order_cnt, l.businessaccount:order_avg, l.businessaccount:order_tot,
			 		   l.businessaccount:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00093', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Update_OrderMetrics" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| Regenerate Business Account Metrics
	|
	</MvCOMMENT>

	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Metrics"
				QUERY	= "{ 'SELECT
								COUNT( * )		AS order_cnt,
								AVG( total )	AS order_avg,
								SUM( total )	AS order_tot
							  FROM ' $ 
								g.Store_Table_Prefix $ 'BusinessAccounts b, ' $
								g.Store_Table_Prefix $ 'Customers c, ' $
								g.Store_Table_Prefix $ 'Orders o
							  WHERE
								b.id			= ? AND
								c.account_id	= b.id AND
								o.cust_id		= c.id' }"
				FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00160', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Metrics.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "Metrics">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.order_cnt"	VALUE = "{ Metrics.d.order_cnt }">
	<MvASSIGN NAME = "l.order_avg"	VALUE = "{ Metrics.d.order_avg ROUND 2 }">
	<MvASSIGN NAME = "l.order_tot"	VALUE = "{ Metrics.d.order_tot ROUND 2 }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Metrics">

	<MvCOMMENT>
	|
	| Update Business Account Metrics
	|
	</MvCOMMENT>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $
			 				g.Store_Table_Prefix $ 'BusinessAccounts
			 			  SET
			 			  	order_cnt	= ?,
			 			  	order_avg	= ?,
			 			  	order_tot	= ?
			 			  WHERE
			 			  	id			= ?' }"
			 FIELDS = "l.order_cnt, l.order_avg, l.order_tot,
					   l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00155', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Delete" PARAMETERS = "businessaccount var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{	NOT [ g.Module_Feature_AGR_DB ].AvailGroupXBusinessAccount_Delete_All_BusinessAccount( l.businessaccount:id )	OR 
	 				NOT [ g.Module_Feature_PGR_DB ].PriceGroupXBusinessAccount_Delete_All_BusinessAccount( l.businessaccount:id ) 	OR
	 				NOT [ g.Module_Feature_PGR_DB ].CouponXBusinessAccount_Delete_All_BusinessAccount( l.businessaccount:id ) 		OR
	 				NOT Customer_Update_All_Account( l.businessaccount:id, 0 ) 														OR
	 				NOT BusinessAccount_Delete_ID( l.businessaccount:id ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Delete_ID" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'BusinessAccounts WHERE id = ?' }"
			 FIELDS = "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00094', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Increment_NoteCount" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'BusinessAccounts
			 			  SET
			 			  	note_count	= note_count + 1
			 			  WHERE
			 			  	id			= ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00101', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Decrement_NoteCount" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'BusinessAccounts
			 			  SET
			 			  	note_count	= note_count - 1
			 			  WHERE
			 			  	id			= ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00102', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Increment_AvailabilityGroupCount" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'BusinessAccounts
					      SET
							agrpcount	= agrpcount + 1
					      WHERE
						    id			= ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00132', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Decrement_AvailabilityGroupCount" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'BusinessAccounts
					      SET
							agrpcount	= agrpcount - 1
					      WHERE
						    id			= ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00133', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Decrement_AvailabilityGroupCount_All" PARAMETERS = "agrp_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'BusinessAccounts
					      SET
							agrpcount	= agrpcount - 1
					      WHERE
						    id IN ( SELECT account_id FROM ' $ g.Store_Table_Prefix $ 'AvailGroupXBusinessAccount WHERE agrp_id = ? )' }"
			 FIELDS	= "l.agrp_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00134', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Increment_PriceGroupCount" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'BusinessAccounts
					      SET
							pgrpcount	= pgrpcount + 1
					      WHERE
						    id			= ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00126', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Decrement_PriceGroupCount" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'BusinessAccounts
					      SET
							pgrpcount	= pgrpcount - 1
					      WHERE
						    id			= ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00127', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BusinessAccount_Decrement_PriceGroupCount_All" PARAMETERS = "pgrp_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'BusinessAccounts
					      SET
							pgrpcount	= pgrpcount - 1
					      WHERE
						    id IN ( SELECT account_id FROM ' $ g.Store_Table_Prefix $ 'PriceGroupXBusinessAccount WHERE pgrp_id = ? )' }"
			 FIELDS	= "l.pgrp_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00128', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| CustomerAddresses
|
</MvCOMMENT>

<MvFUNCTION NAME = "CustomerAddress_Read" PARAMETERS = "customeraddress var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.customeraddress:id"			VALUE = "{ CustomerAddresses.d.id }">
	<MvASSIGN NAME = "l.customeraddress:cust_id"	VALUE = "{ CustomerAddresses.d.cust_id }">
	<MvASSIGN NAME = "l.customeraddress:descrip"	VALUE = "{ CustomerAddresses.d.descrip }">
	<MvASSIGN NAME = "l.customeraddress:fname"		VALUE = "{ CustomerAddresses.d.fname }">
	<MvASSIGN NAME = "l.customeraddress:lname"		VALUE = "{ CustomerAddresses.d.lname }">
	<MvASSIGN NAME = "l.customeraddress:email"		VALUE = "{ CustomerAddresses.d.email }">
	<MvASSIGN NAME = "l.customeraddress:comp"		VALUE = "{ CustomerAddresses.d.comp }">
	<MvASSIGN NAME = "l.customeraddress:phone"		VALUE = "{ CustomerAddresses.d.phone }">
	<MvASSIGN NAME = "l.customeraddress:fax"		VALUE = "{ CustomerAddresses.d.fax }">

	<MvIF EXPR = "{ ISNULL CustomerAddresses.d.addr2 }">
		<MvASSIGN NAME = "l.customeraddress:addr"	VALUE = "{ CustomerAddresses.d.addr }">
	<MvELSE>
		<MvASSIGN NAME = "l.customeraddress:addr"	VALUE = "{ CustomerAddresses.d.addr $ ' ' $ CustomerAddresses.d.addr2 }">
	</MvIF>

	<MvASSIGN NAME = "l.customeraddress:addr1"		VALUE = "{ CustomerAddresses.d.addr }">
	<MvASSIGN NAME = "l.customeraddress:addr2"		VALUE = "{ CustomerAddresses.d.addr2 }">
	<MvASSIGN NAME = "l.customeraddress:city"		VALUE = "{ CustomerAddresses.d.city }">
	<MvASSIGN NAME = "l.customeraddress:state"		VALUE = "{ CustomerAddresses.d.state }">
	<MvASSIGN NAME = "l.customeraddress:zip"		VALUE = "{ CustomerAddresses.d.zip }">
	<MvASSIGN NAME = "l.customeraddress:cntry"		VALUE = "{ CustomerAddresses.d.cntry }">
	<MvASSIGN NAME = "l.customeraddress:resdntl"	VALUE = "{ CustomerAddresses.d.resdntl }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Insert" PARAMETERS = "customeraddress var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.customeraddress:id" VALUE = "{ [ g.Module_Library_DB ].StoreKey_Generate( 'CustomerAddresses' ) }">

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'CustomerAddresses
			 			  ( id, cust_id, descrip, fname, lname, email, comp, phone, fax, addr, addr2, city, state, zip, cntry, resdntl )
			 			  VALUES
			 			  ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )' }"
			 FIELDS	= "l.customeraddress:id, l.customeraddress:cust_id, l.customeraddress:descrip, l.customeraddress:fname,
					   l.customeraddress:lname, l.customeraddress:email, l.customeraddress:comp, l.customeraddress:phone, l.customeraddress:fax,
					   l.customeraddress:addr1, l.customeraddress:addr2, l.customeraddress:city, l.customeraddress:state, l.customeraddress:zip,
					   l.customeraddress:cntry, l.customeraddress:resdntl">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00103', g.MvQUERY_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customeraddress:addr2 }">
		<MvASSIGN NAME = "l.customeraddress:addr"	VALUE = "{ l.customeraddress:addr1 }">
	<MvELSE>
		<MvASSIGN NAME = "l.customeraddress:addr"	VALUE = "{ l.customeraddress:addr1 $ ' ' $ l.customeraddress:addr2 }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Update" PARAMETERS = "customeraddress var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'CustomerAddresses
			 			  SET
							descrip	= ?,
							fname	= ?,
							lname	= ?,
							email	= ?,
							comp	= ?,
							phone	= ?,
							fax		= ?,
							addr	= ?,
							addr2	= ?,
							city	= ?,
							state	= ?,
							zip		= ?,
							cntry	= ?,
							resdntl	= ?
			 			  WHERE
			 			  	id 		= ?' }"
			 FIELDS	= "l.customeraddress:descrip, l.customeraddress:fname, l.customeraddress:lname, l.customeraddress:email, l.customeraddress:comp,
			 		   l.customeraddress:phone, l.customeraddress:fax, l.customeraddress:addr1, l.customeraddress:addr2, l.customeraddress:city,
			 		   l.customeraddress:state, l.customeraddress:zip, l.customeraddress:cntry, l.customeraddress:resdntl,
					   l.customeraddress:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00104', g.MvQUERY_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.customeraddress:addr2 }">
		<MvASSIGN NAME = "l.customeraddress:addr"	VALUE = "{ l.customeraddress:addr1 }">
	<MvELSE>
		<MvASSIGN NAME = "l.customeraddress:addr"	VALUE = "{ l.customeraddress:addr1 $ ' ' $ l.customeraddress:addr2 }">
	</MvIF>

	<MvASSIGN NAME = "g.Session:cache:customeraddress_load_id" INDEX = "{ l.customeraddress:id }" VALUE = "">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Delete" PARAMETERS = "id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'CustomerAddresses WHERE id = ?' }"
			 FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00105', g.MvQUERY_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "g.Session:cache:customeraddress_load_id" INDEX = "{ l.id }" VALUE = "">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Delete_Customer" PARAMETERS = "cust_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'CustomerAddresses WHERE cust_id = ?' }"
			 FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00106', g.MvQUERY_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "g.Session:cache:customeraddress_load_id" VALUE = "">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddressList_Load_Customer" PARAMETERS = "cust_id, customeraddresses var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW 	= "CustomerAddresses"
				QUERY 	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'CustomerAddresses WHERE cust_id = ? ORDER BY descrip, fname, lname, id' }"
				FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00107', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.count" VALUE = 0>

	<MvWHILE EXPR = "{ NOT CustomerAddresses.d.EOF }">
		<MvEVAL EXPR = "{ CustomerAddress_Read( l.customeraddresses[ ++l.count ] ) }">

		<MvSKIP NAME = "Merchant" VIEW = "CustomerAddresses" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerAddresses">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-CUS-DTB-00108', l.count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Load_ID" PARAMETERS = "id, customeraddress var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW 	= "CustomerAddresses"
				QUERY 	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'CustomerAddresses WHERE id = ?' }"
				FIELDS	= "l.id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00109', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ CustomerAddresses.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerAddresses">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00110' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ CustomerAddress_Read( l.customeraddress ) }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerAddresses">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Load_ID_Cached" PARAMETERS = "id, customeraddress var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.id"								VALUE = "{ int( l.id ) }">

	<MvIF EXPR = "{ l.id LE 0 }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00111' ) }">
	</MvIF>

	<MvREFERENCEARRAY NAME = "l.cache"					VARIABLE = "g.Session:cache:customeraddress_load_id">
		<MvDIMENSION INDEX = "{ l.id }">
	</MvREFERENCEARRAY>

	<MvIF EXPR = "{ ISNULL l.cache:result }">
		<MvASSIGN NAME = "l.cache:result" 				VALUE = "{ CustomerAddress_Load_ID( l.id, l.cache:customeraddress ) }">
		<MvIF EXPR = "{ NOT l.cache:result }">
			<MvASSIGN NAME = "l.cache:error_code"		VALUE = "{ g.Error_Code }">
			<MvASSIGN NAME = "l.cache:error_message"	VALUE = "{ g.Error_Message }">
			<MvASSIGN NAME = "l.cache:error_db_eof"		VALUE = "{ g.Error_DB_EOF }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT l.cache:result }">
		<MvIF EXPR = "{ l.cache:error_db_eof }">
			<MvFUNCTIONRETURN VALUE =  "{ [ g.Module_Library_DB ].Error_Load_EOF( l.cache:error_code ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( l.cache:error_code, l.cache:error_message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.customeraddress"				VALUE = "{ l.cache:customeraddress }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Load" PARAMETERS = "cust_id, id, customeraddress var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW 	= "CustomerAddresses"
				QUERY 	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'CustomerAddresses WHERE cust_id = ? AND id = ?' }"
				FIELDS	= "l.cust_id, l.id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00163', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ CustomerAddresses.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerAddresses">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00164' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ CustomerAddress_Read( l.customeraddress ) }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerAddresses">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Load_Description" PARAMETERS = "cust_id, descrip, customeraddress var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW 	= "CustomerAddresses"
				QUERY 	= "{ 'SELECT
								*
							  FROM
							  	' $ g.Store_Table_Prefix $ 'CustomerAddresses
							  WHERE
							  	cust_id = ? AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'descrip' ) $ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ '
							  ORDER BY
							  	id' }"
				FIELDS	= "l.cust_id, l.descrip">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00112', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ CustomerAddresses.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerAddresses">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00113' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ CustomerAddress_Read( l.customeraddress ) }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerAddresses">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Load_Address" PARAMETERS = "cust_id, addr, customeraddress var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW 	= "CustomerAddresses"
				QUERY 	= "{ 'SELECT
								*
							  FROM
							  	' $ g.Store_Table_Prefix $ 'CustomerAddresses
							  WHERE
							  	cust_id = ? AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'addr' ) $ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ '
							  ORDER BY
							  	id' }"
				FIELDS	= "l.cust_id, l.addr">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00114', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ CustomerAddresses.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerAddresses">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00115' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ CustomerAddress_Read( l.customeraddress ) }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerAddresses">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAddress_Load_AddressFields" PARAMETERS = "cust_id, address var, customeraddress var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW 	= "CustomerAddresses"
				QUERY 	= "{ 'SELECT
								*
							  FROM
							  	' $ g.Store_Table_Prefix $ 'CustomerAddresses
							  WHERE
							  	cust_id = ? AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'fname' ) 	$ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ ' AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'lname' ) 	$ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ ' AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'email' )	$ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ ' AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'comp' ) 	$ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ ' AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'phone' ) 	$ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ ' AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'fax' ) 	$ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ ' AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'addr' ) 	$ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ ' AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'addr2' ) 	$ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ ' AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'city' ) 	$ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ ' AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'state' ) 	$ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ ' AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'zip' ) 	$ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ ' AND
							  	' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'cntry' ) 	$ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( '?' ) $ '
							  ORDER BY
							  	id' }"
				FIELDS	= "l.cust_id, l.address:fname, l.address:lname, l.address:email, l.address:comp, l.address:phone, l.address:fax,
						   l.address:addr1, l.address:addr2, l.address:city, l.address:state, l.address:zip, l.address:cntry">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00116', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ CustomerAddresses.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerAddresses">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00117' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ CustomerAddress_Read( l.customeraddress ) }">

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerAddresses">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAndBusinessAccount_Load_CustomerID" PARAMETERS = "cust_id, customer var, businessaccount var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Customers"
				QUERY	= "{ 'SELECT
								cust.*,
								ba.id			AS ba_id,
								ba.agrpcount	AS ba_agrpcount,
								ba.pgrpcount	AS ba_pgrpcount,
								ba.title		AS ba_title,
								ba.note_count	AS ba_note_count
							  FROM
								' $ g.Store_Table_Prefix $ 'Customers cust
								LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'BusinessAccounts ba ON ba.id = cust.account_id
							  WHERE
								cust.id = ?' }"
				FIELDS	= "l.cust_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00135', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ Customers.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00136' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ Customer_Read( l.customer ) }">

	<MvIF EXPR = "{ Customers.d.account_id EQ 0 }">
		<MvASSIGN NAME = "l.businessaccount"			VALUE = "">
	<MvELSE>
		<MvASSIGN NAME = "l.businessaccount:id"			VALUE = "{ Customers.d.ba_id }">
		<MvASSIGN NAME = "l.businessaccount:agrpcount"	VALUE = "{ Customers.d.ba_agrpcount }">
		<MvASSIGN NAME = "l.businessaccount:pgrpcount"	VALUE = "{ Customers.d.ba_pgrpcount }">
		<MvASSIGN NAME = "l.businessaccount:title"		VALUE = "{ Customers.d.ba_title }">
		<MvASSIGN NAME = "l.businessaccount:note_count"	VALUE = "{ Customers.d.ba_note_count }">
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Customers">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| sNN_ShopAsCustomerSession
|
</MvCOMMENT>

<MvFUNCTION NAME = "ShopAsCustomerSession_Read" PARAMETERS = "shopascustomersession var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.shopascustomersession:session_id"	VALUE = "{ ShopAsCustomerSessions.d.session_id }">
	<MvASSIGN NAME = "l.shopascustomersession:admsess_id"	VALUE = "{ ShopAsCustomerSessions.d.admsess_id }">
	<MvASSIGN NAME = "l.shopascustomersession:user_id"		VALUE = "{ ShopAsCustomerSessions.d.user_id }">
	<MvASSIGN NAME = "l.shopascustomersession:store_id"		VALUE = "{ ShopAsCustomerSessions.d.store_id }">
	<MvASSIGN NAME = "l.shopascustomersession:basket_id"	VALUE = "{ ShopAsCustomerSessions.d.basket_id }">
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Load_Session" PARAMETERS = "session_id, shopascustomersession var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "ShopAsCustomerSessions"
				QUERY	= "SELECT * FROM ShopAsCustomerSessions WHERE session_id = ?"
				FIELDS	= "l.session_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00141', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ ShopAsCustomerSessions.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "ShopAsCustomerSessions">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00142' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ ShopAsCustomerSession_Read( l.shopascustomersession ) }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "ShopAsCustomerSessions">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Load_AdminSession" PARAMETERS = "admsess_id, shopascustomersession var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "ShopAsCustomerSessions"
				QUERY	= "SELECT * FROM ShopAsCustomerSessions WHERE admsess_id = ?"
				FIELDS	= "l.admsess_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00166', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ ShopAsCustomerSessions.d.EOF }">
		<MvCLOSEVIEW NAME = "Merchant" VIEW = "ShopAsCustomerSessions">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].Error_Load_EOF( 'MER-CUS-DTB-00167' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ ShopAsCustomerSession_Read( l.shopascustomersession ) }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "ShopAsCustomerSessions">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Insert" PARAMETERS = "shopascustomersession var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "INSERT INTO ShopAsCustomerSessions
						( session_id, admsess_id, user_id, store_id, basket_id )
					   VALUES
						( ?, ?, ?, ?, ? )"
			 FIELDS	= "l.shopascustomersession:session_id, l.shopascustomersession:admsess_id, l.shopascustomersession:user_id, l.shopascustomersession:store_id, l.shopascustomersession:basket_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00143', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Delete_Session" PARAMETERS = "session_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "DELETE FROM ShopAsCustomerSessions WHERE session_id = ?"
			 FIELDS	= "l.session_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00144', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Delete_AdminSession" PARAMETERS = "admsess_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "DELETE FROM ShopAsCustomerSessions WHERE admsess_id = ?"
			 FIELDS	= "l.admsess_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00168', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Delete_All" PARAMETERS = "" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "DELETE FROM ShopAsCustomerSessions">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00145', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Delete_All_Basket" PARAMETERS = "store_id, basket_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "DELETE FROM ShopAsCustomerSessions WHERE store_id = ? AND basket_id = ?"
			 FIELDS	= "l.store_id, l.basket_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00146', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Delete_All_User" PARAMETERS = "user_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "DELETE FROM ShopAsCustomerSessions WHERE user_id = ?"
			 FIELDS	= "l.user_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00147', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Delete_All_Basket_OlderThan" PARAMETERS = "store_id, time_t" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.Native_DBAPI EQ 'postgresql' }">
		<MvQUERY NAME 	= "Merchant"
				 QUERY 	= "{ 'DELETE FROM ShopAsCustomerSessions sacs
				 			  USING ' $ g.Store_Table_Prefix $ 'Baskets b WHERE b.lastupdate < ? AND sacs.store_id = ? AND sacs.basket_id = b.basket_id' }"
				 FIELDS = "l.store_id, l.time_t">
	<MvELSE>
		<MvQUERY NAME	= "Merchant"
				 QUERY	= "{ 'DELETE sacs.* FROM ShopAsCustomerSessions sacs, ' $ g.Store_Table_Prefix $ 'Baskets b WHERE b.lastupdate < ? AND sacs.store_id = ? AND sacs.basket_id = b.basket_id' }"
				 FIELDS	= "l.store_id, l.time_t">
	</MvIF>

	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00148', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Delete_All_AdminSession_UserAndBrowser" PARAMETERS = "user_id, browser_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.Native_DBAPI EQ 'postgresql' }">
		<MvQUERY NAME 	= "Merchant"
				 QUERY 	= "DELETE FROM ShopAsCustomerSessions sacs
				 		   USING AdminSessions a WHERE a.user_id = ? AND a.browser_id = ? AND sacs.admsess_id = a.session_id"
				 FIELDS = "l.user_id, l.browser_id">
	<MvELSE>
		<MvQUERY NAME	= "Merchant"
				 QUERY	= "DELETE sacs.* FROM ShopAsCustomerSessions sacs, AdminSessions a WHERE a.user_id = ? AND a.browser_id = ? AND sacs.admsess_id = a.session_id"
				 FIELDS	= "l.user_id, l.browser_id">
	</MvIF>

	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00149', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Delete_All_AdminSession_Expired" PARAMETERS = "min_last_update" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.Native_DBAPI EQ 'postgresql' }">
		<MvQUERY NAME 	= "Merchant"
				 QUERY 	= "DELETE FROM ShopAsCustomerSessions sacs
				 		   USING AdminSessions a WHERE a.lastupdate < ? AND sacs.admsess_id = a.session_id"
				 FIELDS = "l.min_last_update">
	<MvELSE>
		<MvQUERY NAME	= "Merchant"
				 QUERY	= "{ 'DELETE sacs.* FROM ShopAsCustomerSessions sacs, AdminSessions a WHERE a.lastupdate < ? AND sacs.admsess_id = a.session_id' }"
				 FIELDS	= "l.min_last_update">
	</MvIF>

	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00150', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Delete_All_AdminSession_User_OtherSession" PARAMETERS = "user_id, session_id" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.Native_DBAPI EQ 'postgresql' }">
		<MvQUERY NAME 	= "Merchant"
				 QUERY 	= "DELETE FROM ShopAsCustomerSessions sacs
				 		   USING AdminSessions a WHERE a.user_id = ? AND a.session_id <> ? AND sacs.admsess_id = a.session_id"
				 FIELDS = "l.user_id, l.session_id">
	<MvELSE>
		<MvQUERY NAME	= "Merchant"
				 QUERY	= "DELETE sacs.* FROM ShopAsCustomerSessions sacs, AdminSessions a WHERE a.user_id = ? AND a.session_id <> ? AND sacs.admsess_id = a.session_id"
				 FIELDS	= "l.user_id, l.session_id">
	</MvIF>

	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00151', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ShopAsCustomerSession_Delete_All_AdminSession_Session_Cookie" PARAMETERS = "cookie" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.Native_DBAPI EQ 'postgresql' }">
		<MvQUERY NAME 	= "Merchant"
				 QUERY 	= "DELETE FROM ShopAsCustomerSessions sacs
				 		   USING AdminSessions a WHERE a.cookie = ? AND sacs.admsess_id = a.session_id"
				 FIELDS = "l.cookie">
	<MvELSE>
		<MvQUERY NAME	= "Merchant"
				 QUERY	= "DELETE sacs.* FROM ShopAsCustomerSessions sacs, AdminSessions a WHERE a.cookie = ? AND sacs.admsess_id = a.session_id"
				 FIELDS	= "l.cookie">
	</MvIF>

	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CUS-DTB-00152', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

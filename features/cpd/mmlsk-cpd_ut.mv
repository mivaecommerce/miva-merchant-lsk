<MIVA STANDARDOUTPUTLEVEL = "">

<MvCOMMENT>
|
| Miva Merchant
|
| This file and the source codes contained herein are the property of
| Miva, Inc.  Use of this file is restricted to the specific terms and
| conditions in the License Agreement associated with this file.  Distribution
| of this file or portions of this file for uses not covered by the License
| Agreement is not allowed without a written agreement signed by an officer of
| Miva, Inc.
|
| Copyright 1998-2024 Miva, Inc.  All rights reserved.
| http://www.miva.com
|
| Prefix         : MER-CPD-UT-
| Next Error Code: 33
|
</MvCOMMENT>

<MvCOMMENT>
|
| Copy Product
|
</MvCOMMENT>

<MvFUNCTION NAME = "CopyProduct_Copy" PARAMETERS = "copyproductrules var, source_product var, dest_product var, data var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.result"		VALUE = 1>
	<MvREFERENCE NAME = "l.state"	VARIABLE = "l.data:state">

	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_Products( l.copyproductrules, l.source_product, l.dest_product, l.state:products ) }">																	</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_AvailGroupXProduct( l.copyproductrules, l.source_product, l.dest_product, l.state:availgroupxproduct ) }">												</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_CategoryXProduct( l.copyproductrules, l.source_product, l.dest_product, l.state:categoryxproduct ) }">													</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_InventoryProductSettings( l.copyproductrules, l.source_product, l.dest_product, l.state:inventoryproductsettings ) }">									</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_InventoryProductCounts( l.copyproductrules, l.source_product, l.dest_product, l.state:inventoryproductcounts ) }">										</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_DigitalDownloadProductSettings( l.copyproductrules, l.source_product, l.dest_product, l.state:digitaldownloadproductsettings ) }">						</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_GiftCertificateSales( l.copyproductrules, l.source_product, l.dest_product, l.state:giftcertificatesales ) }">											</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_ProductShippingRules( l.copyproductrules, l.source_product, l.dest_product, l.state:productshippingrules ) }">											</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_ProductShippingMethods( l.copyproductrules, l.source_product, l.dest_product, l.state:productshippingmethods ) }">										</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_ProductPaymentRules( l.copyproductrules, l.source_product, l.dest_product, l.state:productpaymentrules ) }">												</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_ProductPaymentMethods( l.copyproductrules, l.source_product, l.dest_product, l.state:productpaymentmethods ) }">											</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_RelatedProducts_product_id( l.copyproductrules, l.source_product, l.dest_product, l.state:relatedproducts_product_id ) }">								</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_RelatedProducts_relprod_id( l.copyproductrules, l.source_product, l.dest_product, l.state:relatedproducts_relprod_id ) }">								</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_ProductSubscriptionTerms( l.copyproductrules, l.source_product, l.dest_product, l.state:productsubscriptionterms ) }">									</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_ProductSubscriptionTermDates( l.copyproductrules, l.source_product, l.dest_product, l.state:productsubscriptiontermdates ) }">							</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_PriceGroupXProduct( l.copyproductrules, l.source_product, l.dest_product, l.state:pricegroupxproduct ) }">												</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_PriceGroupXQualifyingProduct( l.copyproductrules, l.source_product, l.dest_product, l.state:pricegroupxqualifyingproduct ) }">							</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_PriceGroupXExcludedProduct( l.copyproductrules, l.source_product, l.dest_product, l.state:pricegroupxexcludedproduct ) }">								</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_PriceGroupXProductSubscription( l.copyproductrules, l.source_product, l.dest_product, l.state:pricegroupxproductsubscription ) }">						</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_PriceGroupXExcludedProductSubscription( l.copyproductrules, l.source_product, l.dest_product, l.state:pricegroupxexcludedproductsubscription ) }">		</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_PriceGroupXQualifyingProductSubscription( l.copyproductrules, l.source_product, l.dest_product, l.state:pricegroupxqualifyingproductsubscription ) }">	</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_Upsell( l.copyproductrules, l.source_product, l.dest_product, l.state:upsell ) }">																		</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_UpsellXProduct_product_id( l.copyproductrules, l.source_product, l.dest_product, l.state:upsellxproduct_product_id ) }">									</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_UpsellXProduct_req_prod( l.copyproductrules, l.source_product, l.dest_product, l.state:upsellxproduct_req_prod ) }">										</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_ProductSubscriptionSettings( l.copyproductrules, l.source_product, l.dest_product, l.state:productsubscriptionsettings ) }">								</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_Attributes( l.copyproductrules, l.source_product, l.dest_product, l.state:attributes ) }">																</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_ProductKits( l.copyproductrules, l.source_product, l.dest_product, l.state:productkits ) }">																</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_ProductVariants( l.copyproductrules, l.source_product, l.dest_product, l.state:productvariants ) }">														</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_Images( l.copyproductrules, l.source_product, l.dest_product, l.state:images ) }">																		</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_Modules( l.copyproductrules, l.source_product, l.dest_product, l.state:modules ) }">																		</MvIF>
	<MvIF EXPR = "{ l.result GT 0 }"> <MvASSIGN NAME = "l.result" VALUE = "{ CopyProduct_Copy_CustomFields( l.copyproductrules, l.source_product, l.dest_product, l.state:customfields ) }">															</MvIF>

	<MvIF EXPR = "{ l.result GT 0 }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Product_Update_LastUpdated_Product( l.dest_product ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features_Cached( 'not_prod', l.modules ) }">
			<MvIF EXPR = "{ l.module:api_ver GE 10.04 }">
				<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Notify_Product_Copy( l.module, l.source_product, l.dest_product ) }">
			</MvIF>
		</MvFOREACH>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ l.result }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_Products" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.state:completed }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvIF EXPR = "{ l.copyproductrules:product }">
		<MvASSIGN NAME = "l.dest_product:descrip"		VALUE = "{ l.source_product:descrip }">
		<MvASSIGN NAME = "l.dest_product:page_code"		VALUE = "{ l.source_product:page_code }">
		<MvASSIGN NAME = "l.dest_product:page_title"	VALUE = "{ l.source_product:page_title }">
		<MvASSIGN NAME = "l.dest_product:price"			VALUE = "{ l.source_product:price }">
		<MvASSIGN NAME = "l.dest_product:cost"			VALUE = "{ l.source_product:cost }">
		<MvASSIGN NAME = "l.dest_product:weight"		VALUE = "{ l.source_product:weight }">
		<MvASSIGN NAME = "l.dest_product:taxable"		VALUE = "{ l.source_product:taxable }">
		<MvASSIGN NAME = "l.dest_product:active"		VALUE = "{ l.source_product:active }">

		<MvIF EXPR = "{ ISNULL l.dest_product:sku }">
			<MvASSIGN NAME = "l.dest_product:sku"		VALUE = "{ l.source_product:sku }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ l.copyproductrules:categories }">
		<MvASSIGN NAME = "l.dest_product:cancat_id"		VALUE = "{ l.source_product:cancat_id }">
		<MvASSIGN NAME = "l.dest_product:catcount"		VALUE = "{ l.source_product:catcount }">
	</MvIF>

	<MvIF EXPR = "{ l.copyproductrules:images }">
		<MvASSIGN NAME = "l.dest_product:thumbnail"		VALUE = "{ l.source_product:thumbnail }">
		<MvASSIGN NAME = "l.dest_product:image"			VALUE = "{ l.source_product:image }">
	</MvIF>

	<MvIF EXPR = "{ l.copyproductrules:availgroup }">
		<MvASSIGN NAME = "l.dest_product:agrpcount"		VALUE = "{ l.source_product:agrpcount }">
	</MvIF>

	<MvIF EXPR = "{ l.copyproductrules:pricegroup }">
		<MvASSIGN NAME = "l.dest_product:pgrpcount"		VALUE = "{ l.source_product:pgrpcount }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Products
						  SET
						  	sku			= ?,
						  	page_code	= ?,
						  	page_title	= ?,
						  	price		= ?,
						  	cost		= ?,
						  	descrip		= ?,
						  	weight		= ?,
						  	taxable		= ?,
						  	active		= ?,
						  	catcount	= ?,
						  	cancat_id	= ?,
						  	agrpcount	= ?,
						  	pgrpcount	= ?,
						  	thumbnail	= ?,
						  	image		= ?,
						  	dt_updated	= ?
						  WHERE
						  	id			= ?' }"
			 FIELDS = "l.dest_product:sku, l.dest_product:page_code, l.dest_product:page_title, l.dest_product:price, l.dest_product:cost, l.dest_product:descrip,
					   l.dest_product:weight, l.dest_product:taxable, l.dest_product:active, l.dest_product:catcount, l.dest_product:cancat_id, l.dest_product:agrpcount,
					   l.dest_product:pgrpcount, l.dest_product:thumbnail, l.dest_product:image, s.dyn_time_t,
					   l.dest_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00001', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_Attributes" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:attributes }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">				<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvFOREACH ITERATOR = "l.attribute" ARRAY = "l.attributes" COUNT = "{ [ g.Module_Library_DB ].AttributeList_Load_Product( l.source_product:id, l.attributes ) }">
		<MvIF EXPR = "{ l.attribute:attemp_id GT 0 }">	<MvASSIGN NAME = "l.option_count" VALUE = 0>
		<MvELSE>										<MvASSIGN NAME = "l.option_count" VALUE = "{ [ g.Module_Library_DB ].OptionList_Load_Attribute( l.attribute:id, l.options ) }">
		</MvIF>

		<MvASSIGN NAME = "l.attribute:product_id" VALUE = "{ l.dest_product:id }">

		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Attribute_Insert( l.attribute ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFOREACH ITERATOR = "l.option" ARRAY = "l.options" COUNT = "{ l.option_count }">
			<MvASSIGN NAME = "l.option:product_id"	VALUE = "{ l.dest_product:id }">
			<MvASSIGN NAME = "l.option:attr_id"		VALUE = "{ l.attribute:id }">

			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Option_Insert( l.option ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvFOREACH>
	</MvFOREACH>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_ProductKits" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:kit }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'ProductKits ( product_id, attr_id, attmpat_id, option_id, part_id, quantity, pos )
						  SELECT
							dest_a.product_id, dest_a.id, pk.attmpat_id, pk.option_id, pk.part_id, pk.quantity, pk.pos
						  FROM ' $
							g.Store_Table_Prefix $ 'ProductKits pk,			' $
							g.Store_Table_Prefix $ 'Attributes source_a,	' $
							g.Store_Table_Prefix $ 'Attributes dest_a
						  WHERE
							source_a.product_id	= ?						AND
							dest_a.product_id	= ?						AND
							pk.product_id		= source_a.product_id	AND
						 	pk.attr_id			= source_a.id			AND
							source_a.code		= dest_a.code			AND
							(
								source_a.type	= \'template\'	OR
								source_a.type	= \'text\'		OR
								source_a.type	= \'memo\'		OR
								source_a.type	= \'checkbox\'
							)
						  UNION ALL
						  SELECT
							dest_a.product_id, dest_a.id, pk.attmpat_id, dest_o.id, pk.part_id, pk.quantity, pk.pos
						  FROM ' $
							g.Store_Table_Prefix $ 'ProductKits pk,			' $
							g.Store_Table_Prefix $ 'Attributes source_a,	' $
							g.Store_Table_Prefix $ 'Options source_o,		' $
							g.Store_Table_Prefix $ 'Attributes dest_a,		' $
							g.Store_Table_Prefix $ 'Options dest_o
						  WHERE
							source_a.product_id	= ?						AND
							dest_a.product_id	= ?						AND
							source_a.id			= source_o.attr_id		AND
							dest_a.id			= dest_o.attr_id		AND
							pk.product_id		= source_a.product_id	AND
						  	pk.attr_id			= source_a.id			AND
						  	pk.option_id		= source_o.id			AND
							source_a.code		= dest_a.code			AND
							source_o.code		= dest_o.code			AND
							(
								source_a.type	= \'radio\'		OR
								source_a.type	= \'select\'	OR
								source_a.type	= \'swatch-select\'
							)' }"
			 FIELDS = "l.source_product:id, l.dest_product:id, l.source_product:id, l.dest_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00002', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_ProductVariants" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:variants }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.state }">
		<MvASSIGN NAME = "l.state:last_variant_id" VALUE = 0>
	</MvIF>

	<MvOPENVIEW NAME	= "Merchant"
				VIEW 	= "ProductVariants"
				QUERY 	= "{ 'SELECT
								dest_a.product_id, pv.variant_id, pv.dimensions, pv.part_count, dest_a.id AS attr_id, pv.attmpat_id, pv.option_id
							  FROM ' $
								g.Store_Table_Prefix $ 'ProductVariants pv, ' $
								g.Store_Table_Prefix $ 'Attributes source_a, ' $
								g.Store_Table_Prefix $ 'Attributes dest_a
							  WHERE
								source_a.product_id		= ?						AND
								dest_a.product_id		= ?						AND
								pv.product_id			= source_a.product_id	AND
								pv.variant_id			> ?						AND
								pv.attr_id				= source_a.id			AND
								source_a.code			= dest_a.code			AND
								(
									source_a.type	= \'template\'	OR
									source_a.type	= \'text\'		OR
									source_a.type	= \'memo\'		OR
									source_a.type	= \'checkbox\'
								)
							  UNION ALL
							  SELECT
								dest_a.product_id, pv.variant_id, pv.dimensions, pv.part_count, dest_a.id AS attr_id, pv.attmpat_id, dest_o.id AS option_id
							  FROM ' $
								g.Store_Table_Prefix $ 'ProductVariants pv,		' $
								g.Store_Table_Prefix $ 'Attributes source_a,	' $
								g.Store_Table_Prefix $ 'Options source_o,		' $
								g.Store_Table_Prefix $ 'Attributes dest_a,		' $
								g.Store_Table_Prefix $ 'Options dest_o
							  WHERE
								source_a.product_id		= ?						AND
								dest_a.product_id		= ?						AND
								source_a.id				= source_o.attr_id		AND
								dest_a.id				= dest_o.attr_id		AND
								pv.product_id			= source_a.product_id	AND
								pv.variant_id			> ?						AND
								pv.attr_id				= source_a.id			AND
								pv.option_id			= source_o.id			AND
								source_a.code			= dest_a.code			AND
								source_o.code			= dest_o.code			AND
								(
									source_a.type	= \'radio\'		OR
									source_a.type	= \'select\'	OR
									source_a.type	= \'swatch-select\'
								)
							  ORDER BY
								variant_id' }"
				FIELDS	= "l.source_product:id, l.dest_product:id, l.state:last_variant_id,
						   l.source_product:id, l.dest_product:id, l.state:last_variant_id">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00004', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.count"						VALUE = 0>
	<MvASSIGN NAME = "l.productvariants_mapping"	VALUE = "">

	<MvWHILE EXPR = "{ NOT ProductVariants.d.EOF }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].ProductVariant_Read( l.productvariant ) }">

		<MvIF EXPR = "{ ISNULL l.productvariants_mapping[ l.productvariant:variant_id ] }">
			<MvIF EXPR = "{ l.count GT 1000 OR CopyProduct_Reycle_Recommend() }">
				<MvWHILESTOP>
			</MvIF>

			<MvASSIGN NAME = "l.dest_variant_id"													VALUE = "{ [ g.Module_Library_DB ].StoreKey_Generate( 'ProductVariants' ) }">
			<MvASSIGN NAME = "l.state:last_variant_id"												VALUE = "{ l.productvariant:variant_id }">
			<MvASSIGN NAME = "l.productvariants_mapping" INDEX = "{ l.productvariant:variant_id }"	VALUE = "{ l.dest_variant_id }">

			<MvQUERY NAME 	= "Merchant"
					 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'ProductVariantPricing ( product_id, variant_id, method, price, cost, weight )
								  SELECT
									?, ?, method, price, cost, weight
								  FROM ' $
									g.Store_Table_Prefix $ 'ProductVariantPricing
								  WHERE
									product_id = ? AND
									variant_id = ?' }"
					 FIELDS = "l.dest_product:id, l.dest_variant_id,
							   l.source_product:id, l.productvariant:variant_id">
			<MvIF EXPR = "{ g.MvQUERY_Error }">
				<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductVariants">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00005', g.MvQUERY_Error ) }">
			</MvIF>

			<MvQUERY NAME 	= "Merchant"
					 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'ProductVariantParts ( product_id, variant_id, quantity, part_id )
								  SELECT
									?, ?, quantity, part_id
								  FROM ' $
									g.Store_Table_Prefix $ 'ProductVariantParts
								  WHERE
									product_id = ? AND
									variant_id = ?' }"
					 FIELDS = "l.dest_product:id, l.dest_variant_id,
							   l.source_product:id, l.productvariant:variant_id">
			<MvIF EXPR = "{ g.MvQUERY_Error }">
				<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductVariants">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00006', g.MvQUERY_Error ) }">
			</MvIF>
		</MvIF>

		<MvASSIGN NAME = "l.count"						VALUE = "{ l.count + 1 }">
		<MvASSIGN NAME = "l.productvariant:variant_id"	VALUE = "{ l.productvariants_mapping[ l.productvariant:variant_id ] }">

		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].ProductVariant_Insert_LowLevel( l.productvariant ) }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductVariants">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "ProductVariants" ROWS = 1>
	</MvWHILE>

	<MvASSIGN NAME = "l.eof" VALUE = "{ ProductVariants.d.EOF }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "ProductVariants">

	<MvIF EXPR = "{ NOT l.eof }">
		<MvFUNCTIONRETURN VALUE = -1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_CategoryXProduct" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:categories }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">				<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.state }">
		<MvASSIGN NAME = "l.state:last_disp_order" VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'CategoryXProduct',
																			 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'CategoryXProduct WHERE product_id = ? AND disp_order > ? ORDER BY disp_order',
																			 [ g.Module_Library_DB ].SQL_Query_Field( l.source_product:id ) $ ', ' $ [ g.Module_Library_DB ].SQL_Query_Field( l.state:last_disp_order ),
																			 0, 1001 ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00007', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.count" VALUE = 0>

	<MvWHILE EXPR = "{ ( NOT CategoryXProduct.d.EOF ) AND ( l.count LT 1000 ) }">
		<MvASSIGN NAME = "l.count"							VALUE = "{ l.count + 1 }">
		<MvASSIGN NAME = "l.state:last_disp_order"			VALUE = "{ CategoryXProduct.d.disp_order }">

		<MvASSIGN NAME = "l.categoryxproduct"				VALUE = "">
		<MvASSIGN NAME = "l.categoryxproduct:cat_id"		VALUE = "{ CategoryXProduct.d.cat_id }">
		<MvASSIGN NAME = "l.categoryxproduct:product_id"	VALUE = "{ l.dest_product:id }">
		<MvASSIGN NAME = "l.categoryxproduct:automatic"		VALUE = 0>
		<MvASSIGN NAME = "l.categoryxproduct:colcount"		VALUE = 0>

		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].CategoryXProduct_Insert_LowLevel( l.categoryxproduct ) }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "CategoryXProduct">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ CopyProduct_Reycle_Recommend() }">
			<MvWHILESTOP>
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "CategoryXProduct" ROWS = 1>
	</MvWHILE>

	<MvASSIGN NAME = "l.eof" VALUE = "{ CategoryXProduct.d.EOF }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CategoryXProduct">

	<MvIF EXPR = "{ NOT l.eof }">
		<MvFUNCTIONRETURN VALUE = -1>
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'Categories
						  SET
						  	dt_updated = ?
						  WHERE
						  	id IN ( SELECT cat_id FROM ' $ g.Store_Table_Prefix $ 'CategoryXProduct WHERE product_id = ? )' }"
			 FIELDS = "s.dyn_time_t,
					   l.dest_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00008', g.MvQUERY_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_Images" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:images }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvFOREACH ITERATOR = "l.productimage" ARRAY = "l.productimages" COUNT = "{ [ g.Module_Library_DB ].ProductImageList_Load_Product( l.source_product:id, l.productimages ) }">
		<MvASSIGN NAME = "l.productimage:product_id" VALUE = "{ l.dest_product:id }">

		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].ProductImage_Insert( l.productimage ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_DigitalDownloadProductSettings" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:ddownload }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">				<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'DigitalDownloadProductSettings ( product_id, enabled, cdn_id, miva_name, miva_path, expiration, max_dl, data )
						  SELECT
						  	?, enabled, cdn_id, miva_name, miva_path, expiration, max_dl, data
						  FROM ' $
						  	g.Store_Table_Prefix $ 'DigitalDownloadProductSettings
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00009', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_GiftCertificateSales" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:giftcert }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'GiftCertificateSales ( product_id, enabled, type, amount, email_ship, email_bill, email_attr, emlattcode, dscattcode )
						  SELECT
						  	?, enabled, type, amount, email_ship, email_bill, email_attr, emlattcode, dscattcode
						  FROM ' $
							g.Store_Table_Prefix $ 'GiftCertificateSales
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00010', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_ProductShippingRules" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:shipping }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'ProductShippingRules ( product_id, ownpackage, width, length, height, limitmeths )
						  SELECT
						  	?, ownpackage, width, length, height, limitmeths
						   FROM ' $
						   	g.Store_Table_Prefix $ 'ProductShippingRules
						   WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00011', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_ProductShippingMethods" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:shipping }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'ProductShippingMethods ( product_id, mod_code, meth_code )
						  SELECT
						  	?, mod_code, meth_code
						   FROM ' $
							g.Store_Table_Prefix $ 'ProductShippingMethods
						   WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00012', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_ProductPaymentRules" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:payment }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'ProductPaymentRules ( product_id, limitmeths )
						  SELECT
						  	?, limitmeths
						  FROM ' $
							g.Store_Table_Prefix $ 'ProductPaymentRules
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00013', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_ProductPaymentMethods" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:payment }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'ProductPaymentMethods ( product_id, mod_code, meth_code, pctype_id )
						  SELECT
						  	?, mod_code, meth_code, pctype_id
						  FROM ' $
							g.Store_Table_Prefix $ 'ProductPaymentMethods
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00014', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_InventoryProductSettings" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:invset }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'InventoryProductSettings ( product_id, active, in_short, in_long, low_track, low_lvl_d, low_level, low_short, low_long, out_track, out_lvl_d, out_level, out_hide, out_short, out_long, ltd_long )
						  SELECT
							?, active, in_short, in_long, low_track, low_lvl_d, low_level, low_short, low_long, out_track, out_lvl_d, out_level, out_hide, out_short, out_long, ltd_long
						  FROM ' $
							g.Store_Table_Prefix $ 'InventoryProductSettings
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00015', g.MvQUERY_Error ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT l.copyproductrules:invlevel }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_INV_DB ].InventoryProductCount_Insert( l.dest_product:id, 0 ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_InventoryProductCounts" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:invlevel }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'InventoryProductCounts ( product_id, inventory )
						  SELECT
							?, ipc.inventory
						  FROM ' $
							g.Store_Table_Prefix $ 'InventoryProductSettings ips, ' $
							g.Store_Table_Prefix $ 'InventoryProductCounts ipc
						  WHERE
							ips.product_id = ? AND
							ipc.product_id = ips.product_id' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00016', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_AvailGroupXProduct" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:availgroup }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">				<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'AvailGroupXProduct ( agrp_id, product_id, automatic, colcount )
						  SELECT
							agrp_id, ?, 0, 0
						  FROM ' $
							g.Store_Table_Prefix $ 'AvailGroupXProduct
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00017', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_PriceGroupXProduct" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:pricegroup }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">				<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'PriceGroupXProduct ( pgrp_id, product_id, automatic, colcount )
						  SELECT
							pgrp_id, ?, 0, 0
						  FROM ' $
							g.Store_Table_Prefix $ 'PriceGroupXProduct
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00018', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_PriceGroupXQualifyingProduct" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:pricegroup }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">				<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'PriceGroupXQualifyingProduct ( pgrp_id, product_id, automatic, colcount )
						  SELECT
							pgrp_id, ?, 0, 0
						  FROM ' $
							g.Store_Table_Prefix $ 'PriceGroupXQualifyingProduct
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00019', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_PriceGroupXExcludedProduct" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:pricegroup }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">				<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>
	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'PriceGroupXExcludedProduct ( pgrp_id, product_id, automatic, colcount )
						  SELECT
							pgrp_id, ?, 0, 0
						  FROM ' $
							g.Store_Table_Prefix $ 'PriceGroupXExcludedProduct
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00020', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_PriceGroupXProductSubscription" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:pricegroup }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ NOT l.copyproductrules:subscrip }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">				<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'PriceGroupXProductSubscription ( pgrp_id, product_id, subterm_id )
						  SELECT
						  	pgxps.pgrp_id, dest_pst.product_id, dest_pst.id
						  FROM ' $
						  	g.Store_Table_Prefix $ 'PriceGroupXProductSubscription pgxps,	' $
						  	g.Store_Table_Prefix $ 'ProductSubscriptionTerms source_pst,	' $
						  	g.Store_Table_Prefix $ 'ProductSubscriptionTerms dest_pst
						  WHERE
						  	dest_pst.product_id		= ?					AND
						  	source_pst.product_id	= ?					AND
						  	source_pst.id			= pgxps.subterm_id	AND
						  	source_pst.descrip		= dest_pst.descrip' }"
			 FIELDS = "l.dest_product:id, l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00023', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_PriceGroupXExcludedProductSubscription" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:pricegroup }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ NOT l.copyproductrules:subscrip }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">				<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'PriceGroupXExcludedProductSubscription ( pgrp_id, product_id, subterm_id )
						  SELECT
						  	pgxeps.pgrp_id, dest_pst.product_id, dest_pst.id
						  FROM ' $
						  	g.Store_Table_Prefix $ 'PriceGroupXExcludedProductSubscription pgxeps,	' $
						  	g.Store_Table_Prefix $ 'ProductSubscriptionTerms source_pst,			' $
						  	g.Store_Table_Prefix $ 'ProductSubscriptionTerms dest_pst
						  WHERE
						  	dest_pst.product_id		= ?					AND
						  	source_pst.product_id	= ?					AND
						  	source_pst.id			= pgxeps.subterm_id	AND
						  	source_pst.descrip		= dest_pst.descrip' }"
			 FIELDS = "l.dest_product:id, l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00024', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_PriceGroupXQualifyingProductSubscription" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:pricegroup }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ NOT l.copyproductrules:subscrip }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">				<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'PriceGroupXQualifyingProductSubscription ( pgrp_id, product_id, subterm_id )
						  SELECT
						  	pgxqps.pgrp_id, dest_pst.product_id, dest_pst.id
						  FROM ' $
						  	g.Store_Table_Prefix $ 'PriceGroupXQualifyingProductSubscription pgxqps,	' $
						  	g.Store_Table_Prefix $ 'ProductSubscriptionTerms source_pst,				' $
						  	g.Store_Table_Prefix $ 'ProductSubscriptionTerms dest_pst
						  WHERE
						  	dest_pst.product_id		= ?					AND
						  	source_pst.product_id	= ?					AND
						  	source_pst.id			= pgxqps.subterm_id	AND
						  	source_pst.descrip		= dest_pst.descrip' }"
			 FIELDS = "l.dest_product:id, l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00025', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_ProductSubscriptionSettings" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:subscrip }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'ProductSubscriptionSettings ( product_id, enabled, mandatory, can_cancel, cncl_min, can_qty, qty_min, can_term, term_min, can_date, date_min )
						  SELECT
							?, enabled, mandatory, can_cancel, cncl_min, can_qty, qty_min, can_term, term_min, can_date, date_min
						  FROM ' $
							g.Store_Table_Prefix $ 'ProductSubscriptionSettings
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00021', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_ProductSubscriptionTerms" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:subscrip }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvFOREACH ITERATOR = "l.productsubscriptionterm" ARRAY = "l.productsubscriptionterms" COUNT = "{ [ g.Module_Feature_SUB_DB ].ProductSubscriptionTermList_Load_Product( l.source_product:id, l.productsubscriptionterms ) }">
		<MvASSIGN NAME = "l.productsubscriptionterm:product_id"	VALUE = "{ l.dest_product:id }">
		<MvASSIGN NAME = "l.productsubscriptionterm:sub_count"	VALUE = 0>

		<MvIF EXPR = "{ NOT [ g.Module_Feature_SUB_DB ].ProductSubscriptionTerm_Insert( l.productsubscriptionterm ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_ProductSubscriptionTermDates" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:subscrip }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'ProductSubscriptionTermDates ( subterm_id, term_dom, term_mon )
						  SELECT
						  	dest_pst.id, pstd.term_dom, pstd.term_mon
						  FROM ' $
						  	g.Store_Table_Prefix $ 'ProductSubscriptionTermDates pstd,		' $
						  	g.Store_Table_Prefix $ 'ProductSubscriptionTerms source_pst,	' $
						  	g.Store_Table_Prefix $ 'ProductSubscriptionTerms dest_pst
						  WHERE
						  	dest_pst.product_id		= ?					AND
						  	source_pst.product_id	= ?					AND
						  	source_pst.id			= pstd.subterm_id	AND
						  	source_pst.descrip		= dest_pst.descrip' }"
			 FIELDS = "l.dest_product:id, l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00022', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_RelatedProducts_product_id" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:relprod }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.state }">
		<MvASSIGN NAME = "l.state:last_disp_order" VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'RelatedProducts',
																			 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'RelatedProducts WHERE product_id = ? AND disp_order > ? ORDER BY disp_order',
																			 [ g.Module_Library_DB ].SQL_Query_Field( l.source_product:id ) $ ', ' $ [ g.Module_Library_DB ].SQL_Query_Field( l.state:last_disp_order ),
																			 0, 1001 ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00026', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.count" VALUE = 0>

	<MvWHILE EXPR = "{ ( NOT RelatedProducts.d.EOF ) AND ( l.count LT 1000 ) }">
		<MvASSIGN NAME = "l.count"						VALUE = "{ l.count + 1 }">
		<MvASSIGN NAME = "l.state:last_disp_order"		VALUE = "{ RelatedProducts.d.disp_order }">

		<MvASSIGN NAME = "l.relatedproduct"				VALUE = "">
		<MvASSIGN NAME = "l.relatedproduct:product_id"	VALUE = "{ l.dest_product:id }">
		<MvASSIGN NAME = "l.relatedproduct:relprod_id"	VALUE = "{ RelatedProducts.d.relprod_id }">

		<MvIF EXPR = "{ NOT [ g.Module_Feature_RPD_DB ].RelatedProduct_Insert( l.relatedproduct ) }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "RelatedProducts">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ CopyProduct_Reycle_Recommend() }">
			<MvWHILESTOP>
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "RelatedProducts" ROWS = 1>
	</MvWHILE>

	<MvASSIGN NAME = "l.eof" VALUE = "{ RelatedProducts.d.EOF }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "RelatedProducts">

	<MvIF EXPR = "{ NOT l.eof }">
		<MvFUNCTIONRETURN VALUE = -1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_RelatedProducts_relprod_id" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:relprod }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ ISNULL l.state }">
		<MvASSIGN NAME = "l.state:last_disp_order" VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'RelatedProducts',
																			 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'RelatedProducts WHERE relprod_id = ? AND disp_order > ? ORDER BY disp_order',
																			 [ g.Module_Library_DB ].SQL_Query_Field( l.source_product:id ) $ ', ' $ [ g.Module_Library_DB ].SQL_Query_Field( l.state:last_disp_order ),
																			 0, 1001 ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00027', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.count" VALUE = 0>

	<MvWHILE EXPR = "{ ( NOT RelatedProducts.d.EOF ) AND ( l.count LT 1000 ) }">
		<MvASSIGN NAME = "l.count"						VALUE = "{ l.count + 1 }">
		<MvASSIGN NAME = "l.state:last_disp_order"		VALUE = "{ RelatedProducts.d.disp_order }">

		<MvASSIGN NAME = "l.relatedproduct"				VALUE = "">
		<MvASSIGN NAME = "l.relatedproduct:product_id"	VALUE = "{ RelatedProducts.d.product_id }">
		<MvASSIGN NAME = "l.relatedproduct:relprod_id"	VALUE = "{ l.dest_product:id }">

		<MvIF EXPR = "{ NOT [ g.Module_Feature_RPD_DB ].RelatedProduct_Insert( l.relatedproduct ) }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "RelatedProducts">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ CopyProduct_Reycle_Recommend() }">
			<MvWHILESTOP>
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "RelatedProducts" ROWS = 1>
	</MvWHILE>

	<MvASSIGN NAME = "l.eof" VALUE = "{ RelatedProducts.d.EOF }">
	<MvCLOSEVIEW NAME = "Merchant" VIEW = "RelatedProducts">

	<MvIF EXPR = "{ NOT l.eof }">
		<MvFUNCTIONRETURN VALUE = -1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_Upsell" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:upsale }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'Upsell ( product_id, dmode, req_amount, rprdcount, pmode, price, score )
						  SELECT
							?, dmode, req_amount, rprdcount, pmode, price, score
						  FROM ' $
							g.Store_Table_Prefix $ 'Upsell
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00028', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_UpsellXProduct_product_id" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:upsale }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'UpsellXProduct ( product_id, req_prod )
						  SELECT
							?, req_prod
						  FROM ' $
							g.Store_Table_Prefix $ 'UpsellXProduct
						  WHERE
							product_id = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00029', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_UpsellXProduct_req_prod" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.copyproductrules:upsale }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.state:completed }">			<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvQUERY NAME	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'UpsellXProduct ( product_id, req_prod )
						  SELECT
							product_id, ?
						  FROM ' $
							g.Store_Table_Prefix $ 'UpsellXProduct
						  WHERE
							req_prod = ?' }"
			 FIELDS	= "l.dest_product:id,
					   l.source_product:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00030', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_Modules" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.state:completed }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ l.copyproductrules:id EQ 0 }">
		<MvASSIGN NAME = "l.module_count" VALUE = "{ [ g.Module_Library_DB ].StoreModuleList_Load_Features( 'copy_prod', l.modules ) }">
	<MvELSE>
		<MvFOREACH ITERATOR = "l.copyproductrulesxmodule" ARRAY = "l.copyproductrulesxmodules" COUNT = "{ [ g.Feature_Filename_CPD_DB ].CopyProductRulesXModuleList_Load_RulesID( l.copyproductrules:id, l.copyproductrulesxmodules ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].ModuleAndFeatures_Load_Code_Cached( l.copyproductrulesxmodule:mod_code, l.module ) }">
				<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>

				<MvFOREACHCONTINUE>
			</MvIF>

			<MvIF EXPR = "{ NOT l.module:active }">																<MvFOREACHCONTINUE>
			<MvELSEIF EXPR = "{ NOT l.module:feature_hash:copy_prod }">											<MvFOREACHCONTINUE>
			<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].StoreModule_Count_Module_Cached( l.module:id ) }">	<MvFOREACHCONTINUE>
			</MvIF>

			<MvASSIGN NAME = "l.module_count" VALUE = "{ miva_array_insert_var( l.modules, l.module, -1 ) }">
		</MvFOREACH>
	</MvIF>

	<MvFOREACH ITERATOR = "l.module" ARRAY = "l.modules" COUNT = "{ l.module_count }">
		<MvREFERENCEARRAY NAME = "l.completed" VARIABLE = "l.state:completed_modules">
			<MvMEMBER NAME = "{ l.module:code }">
		</MvREFERENCEARRAY>

		<MvIF EXPR = "{ l.completed }">
			<MvFOREACHCONTINUE>
		</MvIF>

		<MvASSIGN NAME = "l.completed"	VALUE = 1>
		<MvASSIGN NAME = "l.null"		VALUE = "{ [ g.Module_Root $ l.module:module ].Module_Copy_Product( l.module, l.source_product, l.dest_product ) }">

		<MvIF EXPR = "{ CopyProduct_Reycle_Recommend() }">
			<MvFUNCTIONRETURN VALUE = -1>
		</MvIF>
	</MvFOREACH>

	<MvASSIGN NAME = "l.state:completed" VALUE = 1>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Copy_CustomFields" PARAMETERS = "copyproductrules var, source_product var, dest_product var, state var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.state:completed }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.state:completed"		VALUE = 1>

	<MvASSIGN NAME = "l.individual_fields"		VALUE = "">
	<MvASSIGN NAME = "l.individual_field_count"	VALUE = 0>
	<MvASSIGN NAME = "l.mapped_fields"			VALUE = "">
	<MvASSIGN NAME = "l.modules"				VALUE = "">

	<MvFOREACH ITERATOR = "l.copyproductrulesxcustomfield" ARRAY = "l.copyproductrulesxcustomfields" COUNT = "{ [ g.Feature_Filename_CPD_DB ].CopyProductRulesXCustomFieldList_Load_RulesID( l.copyproductrules:id, l.copyproductrulesxcustomfields ) }">
		<MvREFERENCEARRAY NAME = "l.module" VARIABLE = "l.modules">
			<MvMEMBER NAME = "{ l.copyproductrulesxcustomfield:mod_code }">
		</MvREFERENCEARRAY>

		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].ModuleAndFeatures_Load_Code_Cached( l.copyproductrulesxcustomfield:mod_code, l.module ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvFOREACHCONTINUE>
		</MvIF>

		<MvIF EXPR = "{ NOT l.module:active }">																<MvFOREACHCONTINUE>
		<MvELSEIF EXPR = "{ NOT l.module:feature_hash:fields_prod }">										<MvFOREACHCONTINUE>
		<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].StoreModule_Count_Module_Cached( l.module:id ) }">	<MvFOREACHCONTINUE>
		</MvIF>

		<MvIF EXPR = "{ NOT l.module:feature_hash:fields_prod_map }">
			<MvASSIGN NAME = "l.record"					VALUE = "">
			<MvASSIGN NAME = "l.record:field_code"		VALUE = "{ l.copyproductrulesxcustomfield:field_code }">
			<MvREFERENCE NAME = "l.record:module"		VARIABLE = "l.module">

			<MvASSIGN NAME = "l.individual_field_count" VALUE = "{ miva_array_insert_var( l.individual_fields, l.record, -1 ) }">
		<MvELSE>
			<MvREFERENCEARRAY NAME = "l.reference_record" VARIABLE = "l.mapped_fields">
				<MvMEMBER NAME = "{ l.module:code }">
			</MvREFERENCEARRAY>

			<MvIF EXPR = "{ ISNULL l.reference_record }">
				<MvASSIGN NAME = "l.reference_record:module"			VALUE = "{ l.module }">
				<MvASSIGN NAME = "l.reference_record:mapped_fields"		VALUE = "">
			</MvIF>

			<MvASSIGNARRAY NAME = "l.reference_record:mapped_fields"	VALUE = "{ l.copyproductrulesxcustomfield:field_code }">
				<MvMEMBER NAME = "{ l.copyproductrulesxcustomfield:field_code }">
			</MvASSIGNARRAY>
		</MvIF>
	</MvFOREACH>

	<MvFOREACH ITERATOR = "l.record" ARRAY = "l.individual_fields" COUNT = "{ l.individual_field_count }">
		<MvASSIGN NAME = "l.value"	VALUE = "{ [ g.Module_Root $ l.record:module:module ].Module_Product_Field_Value( l.record:module, l.source_product:id, l.record:field_code ) }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Root $ l.record:module:module ].Module_Product_Set_Field( l.record:module, l.dest_product:id, l.record:field_code, l.value ) }">
	</MvFOREACH>

	<MvFOREACH ITERATOR = "l.module_code" ARRAY = "l.module_codes" COUNT = "{ miva_struct_members( l.mapped_fields, l.module_codes ) }">
		<MvREFERENCEARRAY NAME = "l.record" VARIABLE = "l.mapped_fields">
			<MvMEMBER NAME = "{ l.module_code }">
		</MvREFERENCEARRAY>

		<MvASSIGN NAME = "l.output_fields"	VALUE = "">
		<MvASSIGN NAME = "l.null"			VALUE = "{ [ g.Module_Root $ l.record:module:module ].Module_Product_Fields_Mapped( l.record:module, l.source_product:id, l.record:mapped_fields, l.output_fields ) }">

		<MvFOREACH ITERATOR = "l.member" ARRAY = "l.members" COUNT = "{ miva_struct_members( l.output_fields, l.members ) }">
			<MvREFERENCEARRAY NAME = "l.value" VARIABLE = "l.output_fields">
				<MvMEMBER NAME = "{ l.member }">
			</MvREFERENCEARRAY>

			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Root $ l.record:module:module ].Module_Product_Set_Field( l.record:module, l.dest_product:id, l.member, l.value ) }">
		</MvFOREACH>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = "{ CopyProduct_Success_Or_Recycle() }">
</MvFUNCTION>

<MvCOMMENT>
|
| Helper Functions
|
</MvCOMMENT>

<MvFUNCTION NAME = "CopyProduct_Reycle_Recommend" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "{ ( s.dyn_time_remaining GE 0 ) AND ( s.dyn_time_remaining LT 3 ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProduct_Success_Or_Recycle" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ CopyProduct_Reycle_Recommend() }">
		<MvFUNCTIONRETURN VALUE = -1>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CopyProductRules_Validate" PARAMETERS = "copyproductrules var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.copyproductrules:kit AND NOT l.copyproductrules:attributes }">			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00031', 'The Attributes rule must be selected in order for the Product Kits rule to be selected' ) }">
	<MvELSEIF EXPR = "{ l.copyproductrules:variants AND NOT l.copyproductrules:attributes }">	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-CPD-UT-00032', 'The Attributes rule must be selected in order for the Product Variants rule to be selected' ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

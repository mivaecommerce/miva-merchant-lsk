<MIVA STANDARDOUTPUTLEVEL = "">

<MvCOMMENT>
|
| Miva Merchant
|
| This file and the source codes contained herein are the property of
| Miva, Inc.  Use of this file is restricted to the specific terms and
| conditions in the License Agreement associated with this file.  Distribution
| of this file or portions of this file for uses not covered by the License
| Agreement is not allowed without a written agreement signed by an officer of
| Miva, Inc.
|
| Copyright 1998-2024 Miva, Inc.  All rights reserved.
| http://www.miva.com
|
| Prefix         : MER-EXP-AFF-
| Next Error Code: 20   
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Description" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.module:code"		VALUE = "mmlsk-afilexprt">
	<MvASSIGN NAME = "l.module:name"		VALUE = "Export Affiliates To Flat File">
	<MvASSIGN NAME = "l.module:provider"	VALUE = "Miva Merchant">
	<MvASSIGN NAME = "l.module:version"		VALUE = "10.0803">
	<MvASSIGN NAME = "l.module:api_ver"		VALUE = "5.00">
	<MvASSIGN NAME = "l.module:features"	VALUE = "export">
</MvFUNCTION>

<MvFUNCTION NAME = "ExportModule_Validate" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.FlatAffiliate_File" 								VALUE = "{ trim( g.FlatAffiliate_File ) }">
	<MvASSIGN NAME = "g.FlatAffiliate_Email"								VALUE = "{ trim( g.FlatAffiliate_Email ) }">
	<MvASSIGN NAME = "g.FlatAffiliate_Delimiter_Tab"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.FlatAffiliate_Delimiter_Tab ) }">
	<MvASSIGN NAME = "g.FlatAffiliate_SendEmail"							VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.FlatAffiliate_SendEmail ) }">
	<MvASSIGN NAME = "g.FlatAffiliate_Affiliates"							VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.FlatAffiliate_Affiliates ) }">
	<MvASSIGN NAME = "g.FlatAffiliate_AffiliateEarnings"					VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.FlatAffiliate_AffiliateEarnings ) }">
	<MvASSIGN NAME = "g.FlatAffiliate_AffiliatePayouts"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.FlatAffiliate_AffiliatePayouts ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Login"								VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Login ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_LostPassword"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_LostPassword ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_SiteName"							VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_SiteName ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_SiteUrl"							VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_SiteUrl ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_ContactName"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_ContactName ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Email"								VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Email ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Company"							VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Company ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Phone"								VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Phone ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Fax"								VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Fax ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Address"							VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Address ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_City"								VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_City ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_State"								VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_State ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Zip"								VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Zip ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Country"							VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Country ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Hits"								VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Hits ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Percent"							VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Percent ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Flat"								VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Flat ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Balance"							VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Balance ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_Status"								VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_Status ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_StatusDate"							VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_StatusDate ) }">
	<MvASSIGN NAME = "g.Affiliate_Check_StatusBy"							VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.Affiliate_Check_StatusBy ) }">
	<MvASSIGN NAME = "g.AffiliateEarnings_Check_Date"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliateEarnings_Check_Date ) }">
	<MvASSIGN NAME = "g.AffiliateEarnings_Check_Time"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliateEarnings_Check_Time ) }">
	<MvASSIGN NAME = "g.AffiliateEarnings_Check_Type"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliateEarnings_Check_Type ) }">
	<MvASSIGN NAME = "g.AffiliateEarnings_Check_OrdID"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliateEarnings_Check_OrdID ) }">
	<MvASSIGN NAME = "g.AffiliateEarnings_Check_OrdAmt"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliateEarnings_Check_OrdAmt ) }">
	<MvASSIGN NAME = "g.AffiliateEarnings_Check_Earned"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliateEarnings_Check_Earned ) }">
	<MvASSIGN NAME = "g.AffiliateEarnings_Check_Void"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliateEarnings_Check_Void ) }">
	<MvASSIGN NAME = "g.AffiliateEarnings_Check_VoidReas"					VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliateEarnings_Check_VoidReas ) }">
	<MvASSIGN NAME = "g.AffiliateEarnings_Check_VoidBy"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliateEarnings_Check_VoidBy ) }">
	<MvASSIGN NAME = "g.AffiliatePayouts_Check_Date"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliatePayouts_Check_Date ) }">
	<MvASSIGN NAME = "g.AffiliatePayouts_Check_Time"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliatePayouts_Check_Time ) }">
	<MvASSIGN NAME = "g.AffiliatePayouts_Check_Count"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliatePayouts_Check_Count ) }">
	<MvASSIGN NAME = "g.AffiliatePayouts_Check_Amount"						VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliatePayouts_Check_Amount ) }">
	<MvASSIGN NAME = "g.AffiliatePayouts_Check_By"							VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliatePayouts_Check_By ) }">
	<MvASSIGN NAME = "g.AffiliatePayouts_Check_Processed"					VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliatePayouts_Check_Processed ) }">

	<MvASSIGN NAME = "g.AffiliateExport_Export_AffiliatesHeader"			VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliateExport_Export_AffiliatesHeader ) }">
	<MvASSIGN NAME = "g.AffiliateExport_Export_AffiliateEarningsHeader"		VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliateExport_Export_AffiliateEarningsHeader ) }">
	<MvASSIGN NAME = "g.AffiliateExport_Export_AffiliatePayoutsHeader"		VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.AffiliateExport_Export_AffiliatePayoutsHeader ) }">

	<MvIF EXPR = "{ len( g.FlatAffiliate_File ) EQ 0 }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( 'FILE', 'FlatAffiliate_File', 'Please specify a file' ) }">
	<MvELSE>
		<MvIF EXPR = "{ '/' IN g.FlatAffiliate_File }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( 'FILE', 'FlatAffiliate_File', 'Please do not include a path in the file name' ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ g.FlatAffiliate_SendEmail }">
		<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_Email( g.FlatAffiliate_Email ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( 'FILE', 'FlatAffiliate_Email', g.Validation_Message ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ ( len_var( g.FlatAffiliate_Delimiter_Other ) EQ 0 ) AND ( NOT g.FlatAffiliate_Delimiter_Tab ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( 'FILE', 'FlatAffiliate_Delimiter_Other', 'Please specify a delimiter' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT g.FlatAffiliate_Affiliates 			AND
					NOT g.FlatAffiliate_AffiliateEarnings	AND
					NOT g.FlatAffiliate_AffiliatePayouts }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( 'FILE', 'FlatAffiliate_Affiliates', 'Please select at least one field to export' ) }">
	</MvIF>

	<MvIF EXPR = "{ g.FlatAffiliate_Affiliates }">
		<MvIF EXPR = "{ NOT g.Affiliate_Check_Login			AND
						NOT g.Affiliate_Check_LostPassword	AND
						NOT g.Affiliate_Check_SiteName		AND
						NOT g.Affiliate_Check_SiteUrl		AND
						NOT g.Affiliate_Check_ContactName	AND
						NOT g.Affiliate_Check_Email			AND
						NOT g.Affiliate_Check_Company		AND
						NOT g.Affiliate_Check_Phone			AND
						NOT g.Affiliate_Check_Fax			AND
						NOT g.Affiliate_Check_Address		AND
						NOT g.Affiliate_Check_City			AND
						NOT g.Affiliate_Check_State			AND
						NOT g.Affiliate_Check_Zip			AND
						NOT g.Affiliate_Check_Country		AND
						NOT g.Affiliate_Check_Hits			AND
						NOT g.Affiliate_Check_Percent		AND
						NOT g.Affiliate_Check_Flat			AND
						NOT g.Affiliate_Check_Balance		AND
						NOT g.Affiliate_Check_Status		AND
						NOT g.Affiliate_Check_StatusDate	AND
						NOT g.Affiliate_Check_StatusBy }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( 'AFLT', 'Affiliate_Check_Login', 'Please select at least one affiliate field to export' ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ g.FlatAffiliate_AffiliateEarnings }">
		<MvIF EXPR = "{ NOT g.AffiliateEarnings_Check_Date 		AND
						NOT g.AffiliateEarnings_Check_Time 		AND
						NOT g.AffiliateEarnings_Check_Type 		AND
						NOT g.AffiliateEarnings_Check_OrdID 	AND
						NOT g.AffiliateEarnings_Check_OrdAmt 	AND
						NOT g.AffiliateEarnings_Check_Earned 	AND
						NOT g.AffiliateEarnings_Check_Void 		AND
						NOT g.AffiliateEarnings_Check_VoidReas 	AND
						NOT g.AffiliateEarnings_Check_VoidBy }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( 'EARN', 'AffiliateEarnings_Check_Date', 'Please select at least one affiliate earning field to export' ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ g.FlatAffiliate_AffiliatePayouts }">
		<MvIF EXPR = "{ NOT g.AffiliatePayouts_Check_Date	AND
						NOT g.AffiliatePayouts_Check_Time	AND
						NOT g.AffiliatePayouts_Check_Count	AND
						NOT g.AffiliatePayouts_Check_Amount	AND
						NOT g.AffiliatePayouts_Check_By		AND
						NOT g.AffiliatePayouts_Check_Processed }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( 'PAYO', 'AffiliatePayouts_Check_Date', 'Please select at least one affiliate payout field to export' ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ g.FlatAffiliate_Delimiter_Tab }">
		<MvASSIGN NAME = "g.FlatAffiliate_Delimiter" VALUE = "{ asciichar( 9 ) }">
	<MvELSE>
		<MvASSIGN NAME = "g.FlatAffiliate_Delimiter" VALUE = "{ g.FlatAffiliate_Delimiter_Other }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ExportModule_Export" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.directory"							VALUE = "{ g.MerchantPath $ 's' $ padl( g.Store:id, 2, '0' ) $ '/export/' }">
	<MvASSIGN NAME = "l.output"								VALUE = "{ l.directory $ g.FlatAffiliate_File }">
	<MvASSIGN NAME = "g.AffiliateExport_Export_Time_Start" 	VALUE = "{ s.time_t }">

	<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Draw_ExportProgressBar_Start( 'Affiliate Export Progress', 'EXPT' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Draw_ExportProgressBar_Show() }">

	<MvIF EXPR = "{ NOT AffiliateExport_Initialize_Export( l.directory, l.output ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	<MvELSEIF EXPR = "{ AffiliateExport_Finalize_Export( l.directory, l.output ) }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ g.FlatAffiliate_Affiliates }">
		<MvIF EXPR = "{ NOT AffiliateExport_Export_AffiliatesHeader( l.output ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ NOT AffiliateExport_Export_Affiliates( l.output ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ g.FlatAffiliate_AffiliateEarnings AND NOT g.AffiliateExport_Export_NeedRefresh }">
		<MvIF EXPR = "{ NOT AffiliateExport_Export_AffiliateEarningsHeader( l.output ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ NOT AffiliateExport_Export_AffiliateEarnings( l.output ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ g.FlatAffiliate_AffiliatePayouts AND NOT g.AffiliateExport_Export_NeedRefresh }">
		<MvIF EXPR = "{ NOT AffiliateExport_Export_AffiliatePayoutsHeader( l.output ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ NOT AffiliateExport_Export_AffiliatePayouts( l.output ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ g.FlatAffiliate_Export_Count EQ g.FlatAffiliate_Total_Count }">
		<MvASSIGN NAME = "g.AffiliateExport_Export_NeedRefresh" VALUE = 1>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ExportModule_Screen" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ g.AffiliateExport_Export_NeedRefresh }">
		<MvHIDE FIELDS = "g.Module_Code, AffiliateExport_Export_Initialized, g.Reset, g.AffiliateExport_Export_Time_Start,
						  g.FlatAffiliate_AffiliateCount, g.FlatAffiliate_AffiliateEarningCount, g.FlatAffiliate_AffiliatePayoutCount, g.FlatAffiliate_Export_Count, g.FlatAffiliate_Total_Count,
						  g.FlatAffiliate_LastAffiliate, g.FlatAffiliate_LastAffiliateEarning, g.FlatAffiliate_LastAffiliatePayout,
						  g.FlatAffiliate_File, g.FlatAffiliate_Append, g.FlatAffiliate_Email, g.FlatAffiliate_SendEmail,
						  g.FlatAffiliate_Delimiter_Tab, g.FlatAffiliate_Delimiter, g.FlatAffiliate_Delimiter_Other, g.FlatAffiliate_Affiliates, g.FlatAffiliate_AffiliateEarnings, g.FlatAffiliate_AffiliatePayouts,
						  g.Affiliate_Check_Login, g.Affiliate_Check_LostPassword, g.Affiliate_Check_SiteName, g.Affiliate_Check_SiteUrl, g.Affiliate_Check_ContactName, g.Affiliate_Check_Email,
						  g.Affiliate_Check_Company, g.Affiliate_Check_Phone, g.Affiliate_Check_Fax, g.Affiliate_Check_Address, g.Affiliate_Check_City, g.Affiliate_Check_State,
						  g.Affiliate_Check_Zip, g.Affiliate_Check_Country, g.Affiliate_Check_Hits, g.Affiliate_Check_Percent, g.Affiliate_Check_Flat, g.Affiliate_Check_Balance,
						  g.Affiliate_Check_Status, g.Affiliate_Check_StatusDate, g.Affiliate_Check_StatusBy,
						  g.AffiliateEarnings_Check_Date, g.AffiliateEarnings_Check_Time, g.AffiliateEarnings_Check_Type, g.AffiliateEarnings_Check_OrdID, g.AffiliateEarnings_Check_OrdAmt,
						  g.AffiliateEarnings_Check_Earned, g.AffiliateEarnings_Check_Void, g.AffiliateEarnings_Check_VoidReas, g.AffiliateEarnings_Check_VoidBy,
						  g.AffiliatePayouts_Check_Date, g.AffiliatePayouts_Check_Time, g.AffiliatePayouts_Check_Count, g.AffiliatePayouts_Check_Amount,
						  g.AffiliatePayouts_Check_By, g.AffiliatePayouts_Check_Processed,
						  g.AffiliateExport_Export_AffiliatesHeader, g.AffiliateExport_Export_AffiliateEarningsHeader, g.AffiliateExport_Export_AffiliatePayoutsHeader">

		<script type="text/javascript">
			function exp_continue()
			{
				document.forms[ Screen ].submit();
			}
			window.onload = exp_continue;
		</script>

		<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Draw_ExportProgressBar_End() }">

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ g.Load_Fields }">
		<MvIF EXPR = "{ g.Reset NE 'No' }">
			<MvASSIGN NAME = "g.FlatAffiliate_File" 							VALUE = "">
			<MvASSIGN NAME = "g.FlatAffiliate_Email" 							VALUE = "">
			<MvASSIGN NAME = "g.FlatAffiliate_Append" 							VALUE = "">
			<MvASSIGN NAME = "g.FlatAffiliate_Delimiter_Tab" 					VALUE = "">
			<MvASSIGN NAME = "g.FlatAffiliate_Delimiter_Other" 					VALUE = "">
			<MvASSIGN NAME = "g.FlatAffiliate_Delimiter" 						VALUE = "">
			<MvASSIGN NAME = "g.FlatAffiliate_Affiliates" 						VALUE = "">
			<MvASSIGN NAME = "g.FlatAffiliate_AffiliateEarnings" 				VALUE = "">
			<MvASSIGN NAME = "g.FlatAffiliate_AffiliatePayouts" 				VALUE = "">
			<MvASSIGN NAME = "g.FlatAffiliate_SendEmail" 						VALUE = 0>

			<MvASSIGN NAME = "g.Affiliate_Check_Login" 							VALUE = 1>
			<MvASSIGN NAME = "g.Affiliate_Check_LostPassword" 					VALUE = 1>
			<MvASSIGN NAME = "g.Affiliate_Check_SiteName" 						VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_SiteUrl" 						VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_ContactName" 					VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_Email" 							VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_Company" 						VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_Phone" 							VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_Fax" 							VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_Address" 						VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_City" 							VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_State" 							VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_Zip" 							VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_Country" 						VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_Hits" 							VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_Percent" 						VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_Flat" 							VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_Balance" 						VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_Status" 						VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_StatusDate" 					VALUE = "">
			<MvASSIGN NAME = "g.Affiliate_Check_StatusBy" 						VALUE = "">

			<MvASSIGN NAME = "g.AffiliateEarnings_Check_Date" 					VALUE = 1>
			<MvASSIGN NAME = "g.AffiliateEarnings_Check_Time" 					VALUE = 1>
			<MvASSIGN NAME = "g.AffiliateEarnings_Check_Type" 					VALUE = "">
			<MvASSIGN NAME = "g.AffiliateEarnings_Check_OrdID" 					VALUE = "">
			<MvASSIGN NAME = "g.AffiliateEarnings_Check_OrdAmt" 				VALUE = "">
			<MvASSIGN NAME = "g.AffiliateEarnings_Check_Earned" 				VALUE = "">
			<MvASSIGN NAME = "g.AffiliateEarnings_Check_Void" 					VALUE = "">
			<MvASSIGN NAME = "g.AffiliateEarnings_Check_VoidReas" 				VALUE = "">
			<MvASSIGN NAME = "g.AffiliateEarnings_Check_VoidBy" 				VALUE = "">

			<MvASSIGN NAME = "g.AffiliatePayouts_Check_Date" 					VALUE = 1>
			<MvASSIGN NAME = "g.AffiliatePayouts_Check_Time" 					VALUE = 1>
			<MvASSIGN NAME = "g.AffiliatePayouts_Check_Count" 					VALUE = "">
			<MvASSIGN NAME = "g.AffiliatePayouts_Check_Amount" 					VALUE = "">
			<MvASSIGN NAME = "g.AffiliatePayouts_Check_By" 						VALUE = "">
			<MvASSIGN NAME = "g.AffiliatePayouts_Check_Processed" 				VALUE = "">

			<MvASSIGN NAME = "g.AffiliateExport_Export_AffiliatesHeader" 		VALUE = 0>
			<MvASSIGN NAME = "g.AffiliateExport_Export_AffiliateEarningsHeader" VALUE = 0>
			<MvASSIGN NAME = "g.AffiliateExport_Export_AffiliatePayoutsHeader" 	VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ ISNULL g.FlatAffiliate_File }">					<MvASSIGN NAME = "g.FlatAffiliate_File" 				VALUE = "affiliates.csv">		</MvIF>
		<MvIF EXPR = "{ ISNULL g.FlatAffiliate_Email }">				<MvASSIGN NAME = "g.FlatAffiliate_Email" 				VALUE = "{ g.Store:email }">	</MvIF>
		<MvIF EXPR = "{ ISNULL g.FlatAffiliate_Append }">				<MvASSIGN NAME = "g.FlatAffiliate_Append" 				VALUE = 1>						</MvIF>
		<MvIF EXPR = "{ ISNULL g.FlatAffiliate_Delimiter_Tab }">		<MvASSIGN NAME = "g.FlatAffiliate_Delimiter_Tab" 		VALUE = 1> 						</MvIF>
		<MvIF EXPR = "{ ISNULL g.FlatAffiliate_Delimiter_Other }">		<MvASSIGN NAME = "g.FlatAffiliate_Delimiter_Other" 		VALUE = ","> 					</MvIF>
		<MvIF EXPR = "{ ISNULL g.FlatAffiliate_Affiliates }">			<MvASSIGN NAME = "g.FlatAffiliate_Affiliates" 			VALUE = 1> 						</MvIF>
		<MvIF EXPR = "{ ISNULL g.FlatAffiliate_AffiliateEarnings }">	<MvASSIGN NAME = "g.FlatAffiliate_AffiliateEarnings" 	VALUE = ""> 					</MvIF>
		<MvIF EXPR = "{ ISNULL g.FlatAffiliate_AffiliatePayouts }">		<MvASSIGN NAME = "g.FlatAffiliate_AffiliatePayouts" 	VALUE = ""> 					</MvIF>
		<MvIF EXPR = "{ ISNULL g.FlatAffiliate_SendEmail }">			<MvASSIGN NAME = "g.FlatAffiliate_SendEmail" 			VALUE = 0>	 					</MvIF>
	</MvIF>
	
	<MvEVAL EXPR = "{ [ g.Module_Admin ].BeginScreen_Start( 'Export Affiliates To Flat File', 'EXPT', '' ) }">

	<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Element_ExportProgressBar_JavaScript( 'Exporting Affiliates To Flat File', 'EXPT', 'EXPT' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Element_ExportProgressBar_CSS() }">

	<script language="JavaScript">
		HaveCustomReset = 1;

		function CustomReset()
		{
			document.EXPT.Reset.value = 'Yes';
		}
	</script>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].BeginScreen_End( 'Export Affiliates To Flat File', 'EXPT', '' ) }">

	<input type="hidden" name="Reset" value="No">
	<MvHIDE FIELDS = "g.Module_Code">

	<MvEVAL EXPR = "{ [ g.Module_Admin ].BeginContent() }">
	<MvEVAL EXPR = "{ [ g.Module_Admin ].DrawTabs( 'FILE', 'FILE:File,AFLT:Affiliates,EARN:Earnings,PAYO:Payouts' ) }">

	<MvIF EXPR = "{ g.Tab EQ 'FILE' }">
		<table border="0" cellpadding="2" cellspacing="0" width="100%">
			<tr><td nowrap width = "500">
				<MvEVAL EXPR = "{ [ g.Module_Admin ].Draw_FieldSet_Open( 'Destination', 110 ) }">
					<tr><td nowrap>
						<font face="Arial, Helvetica" size=-1><b>
						Export Affiliates to File:
						</font></b>
					</td><td width="100%">
						<input type="text" name="FlatAffiliate_File" size="40" value = "{ encodeentities( g.FlatAffiliate_File ) }">
					</td></tr>

					<tr><td valign="top" nowrap>
						<b>If File Exists:</b>
					</td><td width="100%">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawRadio( 'FlatAffiliate_Append', '1',	g.FlatAffiliate_Append,	'Append To File' ) }"><br>
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawRadio( 'FlatAffiliate_Append', '',		g.FlatAffiliate_Append,	'Replace File' ) }">
					</td></tr>

					<tr><td valign="top" nowrap>
						Email File To:
					</td><td width="100%" nowrap>
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawRadio( 'FlatAffiliate_SendEmail', '', g.FlatAffiliate_SendEmail, 'Do Not Email' ) }"><br>
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawRadio( 'FlatAffiliate_SendEmail', '1', g.FlatAffiliate_SendEmail, '' ) }">

						<input type="text" size="40" name="FlatAffiliate_Email" value="{ encodeentities( g.FlatAffiliate_Email ) }">
					</td></tr>
				<MvEVAL EXPR = "{ [ g.Module_Admin ].Draw_FieldSet_Close() }">
			</td><td nowrap width = "500">
				<MvEVAL EXPR = "{ [ g.Module_Admin ].Draw_FieldSet_Open( 'Export Format', 110 ) }">
					<tr><td valign="top" nowrap>
						<b>Delimiter:</b>
					</td><td width="100%">
						<table border="0" cellpadding="0" cellspacing="0">
						<tr><td>
							<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawRadio( 'FlatAffiliate_Delimiter_Tab', '1',	g.FlatAffiliate_Delimiter_Tab,	'Tab' ) }">
						</td><td align="left" valign="middle">
							&nbsp;
						</td></tr>

						<tr><td>
							<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawRadio( 'FlatAffiliate_Delimiter_Tab', '',	g.FlatAffiliate_Delimiter_Tab,	'Other:' ) }">
						</td><td align="left" valign="middle">
							<input type="text" name="FlatAffiliate_Delimiter_Other" value="{ encodeentities( g.FlatAffiliate_Delimiter_Other ) }" size=10>
						</td></tr>
						</table>
					</td></tr>
				<MvEVAL EXPR = "{ [ g.Module_Admin ].Draw_FieldSet_Close() }">
			</td></tr>

			<tr><td nowrap>
				<MvEVAL EXPR = "{ [ g.Module_Admin ].Draw_FieldSet_Open( 'Fields to Export', 65 ) }">
					<tr><td align="left" nowrap>
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.FlatAffiliate_Affiliates, 'FlatAffiliate_Affiliates', 'Yes', 'Affiliates' ) }">
					</td></tr>

					<tr><td align="left" nowrap>
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.FlatAffiliate_AffiliateEarnings, 'FlatAffiliate_AffiliateEarnings', 'Yes', 'Affiliate Earnings' ) }">
					</td></tr>

					<tr><td align="left" nowrap>
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.FlatAffiliate_AffiliatePayouts, 'FlatAffiliate_AffiliatePayouts', 'Yes', 'Affiliate Payouts' ) }">
					</td></tr>
				<MvEVAL EXPR = "{ [ g.Module_Admin ].Draw_FieldSet_Close() }">
			</td></tr>
		</table>
	<MvELSE>
		<MvHIDE FIELDS = "g.FlatAffiliate_File, 			g.FlatAffiliate_Email, 			g.FlatAffiliate_Append, 		g.FlatAffiliate_Delimiter,
						  g.FlatAffiliate_SendEmail, 		g.FlatAffiliate_Affiliates, 	g.FlatAffiliate_Delimiter_Tab, 	g.FlatAffiliate_Delimiter_Other,
						  g.FlatAffiliate_AffiliatePayouts,	g.FlatAffiliate_AffiliateEarnings">
	</MvIF>

	<MvIF EXPR = "{ g.Tab EQ 'AFLT' }">
		<table border="0" cellpadding="2" cellspacing="0" width="100%">
			<tr><td valign="top" nowrap>
				<b>Export:</b>
				</td><td align="left" valign="middle" colspan="3">
				<table border="0" cellpadding="2" cellspacing="0">
					<tr><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Login, 'Affiliate_Check_Login', 'Yes', 'Login' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_LostPassword, 'Affiliate_Check_LostPassword', 'Yes', 'Pass. Recovery Email' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_SiteName, 'Affiliate_Check_SiteName', 'Yes', 'Site Name' ) }">
					</td></tr>

					<tr><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_SiteUrl, 'Affiliate_Check_SiteUrl', 'Yes', 'Site Url' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_ContactName, 'Affiliate_Check_ContactName', 'Yes', 'Contact Name' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Email, 'Affiliate_Check_Email', 'Yes', 'Email Address' ) }">
					</td></tr>

					<tr><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Company, 'Affiliate_Check_Company', 'Yes', 'Company' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Phone, 'Affiliate_Check_Phone', 'Yes', 'Phone Number' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Fax, 'Affiliate_Check_Fax', 'Yes', 'Fax Number' ) }">
					</td></tr>

					<tr><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Address, 'Affiliate_Check_Address', 'Yes', 'Address' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_City, 'Affiliate_Check_City', 'Yes', 'City' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_State, 'Affiliate_Check_State', 'Yes', 'State' ) }">
					</td></tr>

					<tr><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Zip, 'Affiliate_Check_Zip', 'Yes', 'Zip' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Country, 'Affiliate_Check_Country', 'Yes', 'Country' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Hits, 'Affiliate_Check_Hits', 'Yes', 'Hits' ) }">
					</td></tr>

					<tr><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Percent, 'Affiliate_Check_Percent', 'Yes', 'Percent' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Flat, 'Affiliate_Check_Flat', 'Yes', 'Flat' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Balance, 'Affiliate_Check_Balance', 'Yes', 'Balance' ) }">
					</td></tr>

					<tr><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_Status, 'Affiliate_Check_Status', 'Yes', 'Status' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_StatusDate, 'Affiliate_Check_StatusDate', 'Yes', 'Status Date' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.Affiliate_Check_StatusBy, 'Affiliate_Check_StatusBy', 'Yes', 'Status By' ) }">
					</td></tr>
				</table>
			</td></tr>
		</table>
	<MvELSE>
		<MvHIDE FIELDS = "g.Affiliate_Check_Login, 		 g.Affiliate_Check_LostPassword, g.Affiliate_Check_SiteName, g.Affiliate_Check_SiteUrl,
						  g.Affiliate_Check_ContactName, g.Affiliate_Check_Email, 		 g.Affiliate_Check_Company,  g.Affiliate_Check_Phone,
						  g.Affiliate_Check_Fax, 		 g.Affiliate_Check_Address, 	 g.Affiliate_Check_City, 	 g.Affiliate_Check_State, 
						  g.Affiliate_Check_Zip, 		 g.Affiliate_Check_Country, 	 g.Affiliate_Check_Hits, 	 g.Affiliate_Check_Percent, 
						  g.Affiliate_Check_Flat, 		 g.Affiliate_Check_Balance, 	 g.Affiliate_Check_Status, 	 g.Affiliate_Check_StatusDate,
						  g.Affiliate_Check_StatusBy">
	</MvIF>

	<MvIF EXPR = "{ g.Tab EQ 'EARN' }">
		<table border="0" cellpadding="2" cellspacing="0" width="100%">
			<tr><td valign="top" nowrap>
				<b>Export:</b>
				</td><td align="left" valign="middle" colspan="3">
				<table border="0" cellpadding="2" cellspacing="0">
					<tr><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliateEarnings_Check_Date, 'AffiliateEarnings_Check_Date', 'Yes', 'Date' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliateEarnings_Check_Time, 'AffiliateEarnings_Check_Time', 'Yes', 'Time' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliateEarnings_Check_Type, 'AffiliateEarnings_Check_Type', 'Yes', 'Type' ) }">
					</td></tr>

					<tr><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliateEarnings_Check_OrdID, 'AffiliateEarnings_Check_OrdID', 'Yes', 'Order ID' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliateEarnings_Check_OrdAmt, 'AffiliateEarnings_Check_OrdAmt', 'Yes', 'Order Amount' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliateEarnings_Check_Earned, 'AffiliateEarnings_Check_Earned', 'Yes', 'Earned' ) }">
					</td></tr>

					<tr><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliateEarnings_Check_Void, 'AffiliateEarnings_Check_Void', 'Yes', 'Void' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliateEarnings_Check_VoidReas, 'AffiliateEarnings_Check_VoidReas', 'Yes', 'Void Reason' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliateEarnings_Check_VoidBy, 'AffiliateEarnings_Check_VoidBy', 'Yes', 'Voided By' ) }">
					</td></tr>
				</table>
			</td></tr>
		</table>
	<MvELSE>
		<MvHIDE FIELDS = "g.AffiliateEarnings_Check_Date, 	g.AffiliateEarnings_Check_Time, 	g.AffiliateEarnings_Check_Type,
						  g.AffiliateEarnings_Check_OrdID, 	g.AffiliateEarnings_Check_OrdAmt, 	g.AffiliateEarnings_Check_Earned,
						  g.AffiliateEarnings_Check_Void, 	g.AffiliateEarnings_Check_VoidReas, g.AffiliateEarnings_Check_VoidBy">
	</MvIF>

	<MvIF EXPR = "{ g.Tab EQ 'PAYO' }">
		<table border="0" cellpadding="2" cellspacing="0" width="100%">
			<tr><td valign="top" nowrap>
				<b>Export:</b>
				</td><td align="left" valign="middle" colspan="3">
				<table border="0" cellpadding="2" cellspacing="0">
					<tr><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliatePayouts_Check_Date, 'AffiliatePayouts_Check_Date', 'Yes', 'Date' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliatePayouts_Check_Time, 'AffiliatePayouts_Check_Time', 'Yes', 'Time' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliatePayouts_Check_Count, 'AffiliatePayouts_Check_Count', 'Yes', 'Count' ) }">
					</td></tr>

					<tr><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliatePayouts_Check_Amount, 'AffiliatePayouts_Check_Amount', 'Yes', 'Amount' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliatePayouts_Check_By, 'AffiliatePayouts_Check_By', 'Yes', 'Created By' ) }">
					</td><td align="left">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( g.AffiliatePayouts_Check_Processed, 'AffiliatePayouts_Check_Processed', 'Yes', 'Processed' ) }">
					</td></tr>
				</table>
			</td></tr>
		</table>
	<MvELSE>
		<MvHIDE FIELDS = "g.AffiliatePayouts_Check_Date, 	g.AffiliatePayouts_Check_Time, 	g.AffiliatePayouts_Check_Count, 
						  g.AffiliatePayouts_Check_Amount, 	g.AffiliatePayouts_Check_By, 	g.AffiliatePayouts_Check_Processed">
	</MvIF>

	<MvHIDE FIELDS = "g.AffiliateExport_Export_AffiliatesHeader, g.AffiliateExport_Export_AffiliateEarningsHeader, g.AffiliateExport_Export_AffiliatePayoutsHeader">

	<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Element_ExportProgressBar_HTML() }">
	<MvEVAL EXPR = "{ [ g.Module_Admin ].EndContent() }">
	<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Draw_ExportProgressBar_Buttons( 'Export', 'EXPT' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Admin ].EndScreen() }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "AffiliateExport_Export_AffiliatesHeader" PARAMETERS = "output" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.AffiliateExport_Export_AffiliatesHeader }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.header" VALUE = "">
														<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATES' ) }">
	<MvIF EXPR = "{ g.Affiliate_Check_Login }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_LOGIN' ) }">					</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_LostPassword }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_LOST_PASSWORD_EMAIL' ) }">	</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_SiteName }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_SITE_NAME' ) }">				</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_SiteUrl }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_SITE_URL' ) }">				</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_ContactName }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_CONTACT_NAME' ) }">			</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_Email }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_EMAIL' ) }">					</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_Company }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_COMPANY' ) }">				</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_Phone }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_PHONE' ) }">					</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_Fax }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_FAX' ) }">					</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_Address }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_ADDRESS' ) }">				</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_City }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_CITY' ) }">					</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_State }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_STATE' ) }">					</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_Zip }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_ZIP' ) }">					</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_Country }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_COUNTRY' ) }">				</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_Hits }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_HITS' ) }">					</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_Percent }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_PERCENT' ) }">				</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_Flat }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_FLAT' ) }">					</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_Balance }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_BALANCE' ) }">				</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_Status }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_STATUS' ) }">					</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_StatusDate }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_STATUS_DATE' ) }">			</MvIF>
	<MvIF EXPR = "{ g.Affiliate_Check_StatusBy }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_STATUS_BY' ) }">				</MvIF>

	<MvIF EXPR = "{ NOT Miva_Fwriteln( l.output, l.header ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "g.AffiliateExport_Export_AffiliatesHeader" VALUE = 1>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "AffiliateExport_Export_Affiliates" PARAMETERS = "output" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.FlatAffiliate_Export_Count GE g.FlatAffiliate_Total_Count }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Affiliates"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'Affiliates WHERE id > ? ORDER BY id' }"
				FIELDS	= "g.FlatAffiliate_LastAffiliate">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-EXP-AFF-00003', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvWHILE EXPR = "{ NOT Affiliates.d.EOF AND NOT g.AffiliateExport_Export_NeedRefresh }">
		<MvASSIGN NAME = "g.FlatAffiliate_AffiliateCount" 	VALUE = "{ g.FlatAffiliate_AffiliateCount + 1 }">
		<MvASSIGN NAME = "g.FlatAffiliate_Export_Count" 	VALUE = "{ g.FlatAffiliate_Export_Count + 1 }">
		<MvASSIGN NAME = "l.record" 						VALUE = "">

		<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Draw_ExportProgressBar_Update( g.FlatAffiliate_Export_Count, g.FlatAffiliate_Total_Count ) }">

		<MvIF EXPR = "{ len( Affiliates.d.status_dt ) }">
			<MvASSIGN NAME = "l.status_date" 				VALUE = "{ [ g.Module_Library_Utilities ].Format_Date( Affiliates.d.status_dt, s.miva_language ) }">
		<MvELSE>
			<MvASSIGN NAME = "l.status_date" 				VALUE = "">
		</MvIF>

		<MvIF EXPR = "{ len( Affiliates.d.status_by ) }">
			<MvIF EXPR = "{ [ g.Module_Library_DB ].User_Load_ID( Affiliates.d.status_by, l.user ) }">
				<MvASSIGN NAME = "l.status_by" 				VALUE = "{ l.user:name }">
			</MvIF>
		<MvELSE>
			<MvASSIGN NAME = "l.status_by" 					VALUE = "">
		</MvIF>

															<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, 'AFFILIATE' ) }">				
		<MvIF EXPR = "{ g.Affiliate_Check_Login }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.code ) }">			</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_LostPassword }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.lpasseml ) }">		</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_SiteName }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.site_name ) }">		</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_SiteUrl }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.site_url ) }">		</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_ContactName }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.con_name ) }">		</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_Email }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.email ) }">			</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_Company }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.company ) }">		</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_Phone }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.phone ) }">			</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_Fax }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.fax ) }">			</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_Address }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.addr ) }">			</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_City }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.city ) }">			</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_State }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.state ) }">			</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_Zip }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.zip ) }">			</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_Country }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.cntry ) }">			</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_Hits }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.hits ) }">			</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_Percent }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.order_pct ) }">		</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_Flat }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.order_flat ) }">	</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_Balance }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.balance ) }">		</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_Status }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, Affiliates.d.status ) }">		</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_StatusDate }"> 	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, l.status_date ) }">				</MvIF>
		<MvIF EXPR = "{ g.Affiliate_Check_StatusBy }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, l.status_by ) }">				</MvIF>

		<MvIF EXPR = "{ NOT Miva_Fwriteln( l.output, l.record ) }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "Affiliates">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ ( s.globaltimeout EQ 0 ) OR ( s.globaltimeout GT 20 ) }">
			<MvASSIGN NAME = "l.end_time" 								VALUE = "20">
		<MvELSE>
			<MvASSIGN NAME = "l.end_time" 								VALUE = "{ s.globaltimeout / 3 }">
		</MvIF>

		<MvIF EXPR = "{ ( s.dyn_time_t - g.AffiliateExport_Export_Time_Start ) GT l.end_time }">
			<MvASSIGN NAME = "g.FlatAffiliate_LastAffiliate"			VALUE = "{ Affiliates.d.id }">
			<MvASSIGN NAME = "g.AffiliateExport_Export_NeedRefresh" 	VALUE = 1>
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "Affiliates" ROWS = 1>
	</MvWHILE>

	<MvIF EXPR = "{ g.AffiliateExport_Export_NeedRefresh AND Affiliates.d.EOF }">
		<MvASSIGN NAME = "g.AffiliateExport_Export_NeedRefresh" 		VALUE = 0>
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Affiliates">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "AffiliateExport_Export_AffiliateEarningsHeader" PARAMETERS = "output" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.AffiliateExport_Export_AffiliateEarningsHeader }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.header" VALUE = "">

															<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'EARNINGS' ) }">
	<MvIF EXPR = "{ g.AffiliateEarnings_Check_Date }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'EARNINGS_DATE' ) }">			</MvIF>
	<MvIF EXPR = "{ g.AffiliateEarnings_Check_Time }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'EARNINGS_TIME' ) }">			</MvIF>	
	<MvIF EXPR = "{ g.AffiliateEarnings_Check_Type }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'EARNINGS_TYPE' ) }">			</MvIF>
	<MvIF EXPR = "{ g.AffiliateEarnings_Check_OrdID }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'EARNINGS_ORDER_ID' ) }">		</MvIF>
	<MvIF EXPR = "{ g.AffiliateEarnings_Check_OrdAmt }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'EARNINGS_ORDER_AMOUNT' ) }">	</MvIF>
	<MvIF EXPR = "{ g.AffiliateEarnings_Check_Earned }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'EARNINGS_AMOUNT_EARNED' ) }">	</MvIF>
	<MvIF EXPR = "{ g.AffiliateEarnings_Check_Void }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'EARNINGS_VOID' ) }">			</MvIF>
	<MvIF EXPR = "{ g.AffiliateEarnings_Check_VoidReas }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'EARNINGS_VOID_REASON' ) }">		</MvIF>
	<MvIF EXPR = "{ g.AffiliateEarnings_Check_VoidBy }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'EARNINGS_VOIDED_BY' ) }">		</MvIF>
															<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'AFFILIATE_EARNINGS_OWNER' ) }">

	<MvIF EXPR = "{ NOT Miva_Fwriteln( l.output, l.header ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "g.AffiliateExport_Export_AffiliateEarningsHeader" VALUE = 1>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "AffiliateExport_Export_AffiliateEarnings" PARAMETERS = "output" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.FlatAffiliate_Export_Count GE g.FlatAffiliate_Total_Count }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "AffiliateEarnings"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'AffiliateEarnings WHERE id > ? ORDER BY id' }"
				FIELDS	= "g.FlatAffiliate_LastAffiliateEarning">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-EXP-AFF-00006', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvWHILE EXPR = "{ NOT AffiliateEarnings.d.EOF AND NOT g.AffiliateExport_Export_NeedRefresh }">
		<MvASSIGN NAME = "g.FlatAffiliate_AffiliateEarningCount" 	VALUE = "{ g.FlatAffiliate_AffiliateEarningCount + 1 }">
		<MvASSIGN NAME = "g.FlatAffiliate_Export_Count" 			VALUE = "{ g.FlatAffiliate_Export_Count + 1 }">
		<MvASSIGN NAME = "l.record" 								VALUE = "">

		<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Draw_ExportProgressBar_Update( g.FlatAffiliate_Export_Count, g.FlatAffiliate_Total_Count ) }">

		<MvIF EXPR = "{ g.AffiliateEarnings_Check_Date }"> 	<MvASSIGN NAME = "l.earnings_date" VALUE = "{ [ g.Module_Library_Utilities ].Format_Date( AffiliateEarnings.d.ern_date, s.miva_language ) }"> </MvIF>
		<MvIF EXPR = "{ g.AffiliateEarnings_Check_Time }"> 	<MvASSIGN NAME = "l.earnings_time" VALUE = "{ [ g.Module_Library_Utilities ].Format_Time( AffiliateEarnings.d.ern_date, s.miva_language ) }"> </MvIF>

		<MvIF EXPR = "{ g.AffiliateEarnings_Check_Void }">	
			<MvIF EXPR = "{ AffiliateEarnings.d.void }">	
				<MvASSIGN NAME = "l.earnings_void" 					VALUE = "Yes"> 
			<MvELSE>
				<MvASSIGN NAME = "l.earnings_void" 					VALUE = "No"> 
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ g.AffiliateEarnings_Check_VoidBy }">
			<MvIF EXPR = "{ AffiliateEarnings.d.void }">
				<MvIF EXPR = "{ [ g.Module_Library_DB ].User_Load_ID( AffiliateEarnings.d.void_by, l.user ) }">
					<MvASSIGN NAME = "l.earnings_voidby" 			VALUE = "{ l.user:name }">
				</MvIF>
			<MvELSE>
				<MvASSIGN NAME = "l.earnings_voidby" 				VALUE = "">
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ len( AffiliateEarnings.d.aff_id ) }">
			<MvIF EXPR = "{ [ g.Module_Feature_AFF_DB ].Affiliate_Load_ID( AffiliateEarnings.d.aff_id, l.affiliate ) }">
				<MvASSIGN NAME = "l.earnings_owner" 				VALUE = "{ l.affiliate:code }">
			</MvIF>
		<MvELSE>
			<MvASSIGN NAME = "l.earnings_owner" 					VALUE = "">
		</MvIF>

																<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, 'EARNING' ) }">
		<MvIF EXPR = "{ g.AffiliateEarnings_Check_Date }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, l.earnings_date ) }">				</MvIF>
		<MvIF EXPR = "{ g.AffiliateEarnings_Check_Time }"> 		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, l.earnings_time ) }">				</MvIF>
		<MvIF EXPR = "{ g.AffiliateEarnings_Check_Type }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, AffiliateEarnings.d.ern_type ) }">	</MvIF>
		<MvIF EXPR = "{ g.AffiliateEarnings_Check_OrdID }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, AffiliateEarnings.d.order_id ) }">	</MvIF>
		<MvIF EXPR = "{ g.AffiliateEarnings_Check_OrdAmt }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, AffiliateEarnings.d.order_amt ) }">	</MvIF>
		<MvIF EXPR = "{ g.AffiliateEarnings_Check_Earned }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, AffiliateEarnings.d.amount ) }">		</MvIF>
		<MvIF EXPR = "{ g.AffiliateEarnings_Check_Void }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, l.earnings_void ) }">				</MvIF>
		<MvIF EXPR = "{ g.AffiliateEarnings_Check_VoidReas }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, AffiliateEarnings.d.void_reasn ) }">	</MvIF>
		<MvIF EXPR = "{ g.AffiliateEarnings_Check_VoidBy }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, l.earnings_voidby ) }">				</MvIF>
																<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, l.earnings_owner ) }">

		<MvIF EXPR = "{ NOT Miva_Fwriteln( l.output, l.record ) }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "AffiliateEarnings">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ ( s.globaltimeout EQ 0 ) OR ( s.globaltimeout GT 20 ) }">
			<MvASSIGN NAME = "l.end_time" 								VALUE = "20">
		<MvELSE>
			<MvASSIGN NAME = "l.end_time" 								VALUE = "{ s.globaltimeout / 3 }">
		</MvIF>

		<MvIF EXPR = "{ ( s.dyn_time_t - g.AffiliateExport_Export_Time_Start ) GT l.end_time }">
			<MvASSIGN NAME = "g.FlatAffiliate_LastAffiliateEarning"		VALUE = "{ AffiliateEarnings.d.id }">
			<MvASSIGN NAME = "g.AffiliateExport_Export_NeedRefresh" 	VALUE = 1>
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "AffiliateEarnings" ROWS = 1>
	</MvWHILE>

	<MvIF EXPR = "{ g.AffiliateExport_Export_NeedRefresh AND AffiliateEarnings.d.EOF }">
		<MvASSIGN NAME = "g.AffiliateExport_Export_NeedRefresh" 		VALUE = 0>
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "AffiliateEarnings">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "AffiliateExport_Export_AffiliatePayoutsHeader" PARAMETERS = "output" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.AffiliateExport_Export_AffiliatePayoutsHeader }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.header" VALUE = "">

															<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'PAYOUTS' ) }">	
	<MvIF EXPR = "{ g.AffiliatePayouts_Check_Date }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'PAYOUTS_DATE' ) }">			</MvIF>
	<MvIF EXPR = "{ g.AffiliatePayouts_Check_Time }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'PAYOUTS_TIME' ) }">			</MvIF>
	<MvIF EXPR = "{ g.AffiliatePayouts_Check_Count }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'PAYOUTS_COUNT' ) }">		</MvIF>
	<MvIF EXPR = "{ g.AffiliatePayouts_Check_Amount }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'PAYOUTS_AMOUNT' ) }">		</MvIF>
	<MvIF EXPR = "{ g.AffiliatePayouts_Check_By }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'PAYOUTS_CREATED_BY' ) }">	</MvIF>
	<MvIF EXPR = "{ g.AffiliatePayouts_Check_Processed }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.header, g.FlatAffiliate_Delimiter, 'PAYOUTS_PROCESSED' ) }">	</MvIF>

	<MvIF EXPR = "{ NOT Miva_Fwriteln( l.output, l.header ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "g.AffiliateExport_Export_AffiliatePayoutsHeader" VALUE = 1>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "AffiliateExport_Export_AffiliatePayouts" PARAMETERS = "output" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.FlatAffiliate_Export_Count GE g.FlatAffiliate_Total_Count }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "AffiliatePayouts"
				QUERY	= "{ 'SELECT * FROM ' $ g.Store_Table_Prefix $ 'AffiliatePayouts WHERE id > ? ORDER BY id' }"
				FIELDS	= "g.FlatAffiliate_LastAffiliatePayout">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-EXP-AFF-00009', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvWHILE EXPR = "{ NOT AffiliatePayouts.d.EOF AND NOT g.AffiliateExport_Export_NeedRefresh }">
		<MvASSIGN NAME = "g.FlatAffiliate_AffiliatePayoutCount" VALUE = "{ g.FlatAffiliate_AffiliatePayoutCount + 1 }">
		<MvASSIGN NAME = "g.FlatAffiliate_Export_Count" 		VALUE = "{ g.FlatAffiliate_Export_Count + 1 }">
		<MvASSIGN NAME = "l.record" 							VALUE = "">

		<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Draw_ExportProgressBar_Update( g.FlatAffiliate_Export_Count, g.FlatAffiliate_Total_Count ) }">

		<MvIF EXPR = "{ g.AffiliatePayouts_Check_Date }"> 	<MvASSIGN NAME = "l.payout_date" VALUE = "{ [ g.Module_Library_Utilities ].Format_Date( AffiliatePayouts.d.pay_date, s.miva_language ) }"> </MvIF>
		<MvIF EXPR = "{ g.AffiliatePayouts_Check_Time }"> 	<MvASSIGN NAME = "l.payout_time" VALUE = "{ [ g.Module_Library_Utilities ].Format_Time( AffiliatePayouts.d.pay_date, s.miva_language ) }">	</MvIF>

		<MvIF EXPR = "{ g.AffiliatePayouts_Check_By }">
			<MvIF EXPR = "{ len( AffiliatePayouts.d.pay_by ) }">
				<MvIF EXPR = "{ [ g.Module_Library_DB ].User_Load_ID( AffiliatePayouts.d.pay_by, l.user ) }">
					<MvASSIGN NAME = "l.payout_by" 				VALUE = "{ l.user:name }">
				</MvIF>
			<MvELSE>
				<MvASSIGN NAME = "l.payout_by" 					VALUE = "">
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ g.AffiliatePayouts_Check_Processed }">
			<MvIF EXPR = "{ AffiliatePayouts.d.processed EQ 1 }">
				<MvASSIGN NAME = "l.payout_processed" 			VALUE = "Yes">
			<MvELSE>
				<MvASSIGN NAME = "l.payout_processed" 			VALUE = "No">
			</MvIF>
		</MvIF>

																<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, 'PAYOUT' ) }">
		<MvIF EXPR = "{ g.AffiliatePayouts_Check_Date }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, l.payout_date ) }">					</MvIF>
		<MvIF EXPR = "{ g.AffiliatePayouts_Check_Time }"> 		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, l.payout_time ) }">					</MvIF>
		<MvIF EXPR = "{ g.AffiliatePayouts_Check_Count }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, AffiliatePayouts.d.pay_count ) }">	</MvIF>
		<MvIF EXPR = "{ g.AffiliatePayouts_Check_Amount }">		<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, AffiliatePayouts.d.amount ) }">		</MvIF>
		<MvIF EXPR = "{ g.AffiliatePayouts_Check_By }">			<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, l.payout_by ) }">					</MvIF>
		<MvIF EXPR = "{ g.AffiliatePayouts_Check_Processed }">	<MvEVAL EXPR = "{ Buffer_Add_Encoded( l.record, g.FlatAffiliate_Delimiter, l.payout_processed ) }">				</MvIF>

		<MvIF EXPR = "{ NOT Miva_Fwriteln( l.output, l.record ) }">
			<MvCLOSEVIEW NAME = "Merchant" VIEW = "AffiliatePayouts">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ ( s.globaltimeout EQ 0 ) OR ( s.globaltimeout GT 20 ) }">
			<MvASSIGN NAME = "l.end_time" 								VALUE = "20">
		<MvELSE>
			<MvASSIGN NAME = "l.end_time" 								VALUE = "{ s.globaltimeout / 3 }">
		</MvIF>

		<MvIF EXPR = "{ ( s.dyn_time_t - g.AffiliateExport_Export_Time_Start ) GT l.end_time }">
			<MvASSIGN NAME = "g.FlatAffiliate_LastAffiliatePayout"		VALUE = "{ AffiliatePayouts.d.id }">
			<MvASSIGN NAME = "g.AffiliateExport_Export_NeedRefresh" 	VALUE = 1>
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "AffiliatePayouts" ROWS = 1>
	</MvWHILE>

	<MvIF EXPR = "{ g.AffiliateExport_Export_NeedRefresh AND AffiliatePayouts.d.EOF }">
		<MvASSIGN NAME = "g.AffiliateExport_Export_NeedRefresh" 		VALUE = 0>
	</MvIF>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "AffiliatePayouts">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "AffiliateExport_Initialize_Export" PARAMETERS = "directory, output" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.AffiliateExport_Export_Initialized }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "g.FlatAffiliate_Affiliates" 				VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.FlatAffiliate_Affiliates ) }">
	<MvASSIGN NAME = "g.FlatAffiliate_AffiliateEarnings" 		VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.FlatAffiliate_AffiliateEarnings ) }">
	<MvASSIGN NAME = "g.FlatAffiliate_AffiliatePayouts" 		VALUE = "{ [ g.Module_Admin ].Trim_Boolean( g.FlatAffiliate_AffiliatePayouts ) }">

	<MvASSIGN NAME = "g.FlatAffiliate_LastAffiliate" 			VALUE = 0>
	<MvASSIGN NAME = "g.FlatAffiliate_LastAffiliateEarning"		VALUE = 0>
	<MvASSIGN NAME = "g.FlatAffiliate_LastAffiliatePayout" 		VALUE = 0>

	<MvASSIGN NAME = "g.FlatAffiliate_AffiliateCount"			VALUE = 0>
	<MvASSIGN NAME = "g.FlatAffiliate_AffiliateEarningCount"	VALUE = 0>
	<MvASSIGN NAME = "g.FlatAffiliate_AffiliatePayoutCount"		VALUE = 0>
	<MvASSIGN NAME = "g.FlatAffiliate_Export_Count" 			VALUE = 0>
	<MvASSIGN NAME = "g.FlatAffiliate_Total_Count"				VALUE = 0>

	<MvIF EXPR = "{ NOT [ g.Module_Library_Utilities ].EnsurePathExists( 'data', l.directory ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ fexists( l.output ) }">
		<MvIF EXPR = "{ NOT g.FlatAffiliate_Append }">
			<MvASSIGN NAME = "l.null"	VALUE = "{ fdelete( l.output ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ g.FlatAffiliate_Affiliates }">
		<MvOPENVIEW NAME	= "Merchant"
					VIEW	= "Affiliates"
					QUERY	= "{ 'SELECT COUNT( * ) as aff_count FROM ' $ g.Store_Table_Prefix $ 'Affiliates' }">
		<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-EXP-AFF-00015', g.MvOPENVIEW_Error ) }">
		</MvIF>

		<MvASSIGN NAME = "g.FlatAffiliate_Total_Count" 				VALUE = "{ g.FlatAffiliate_Total_Count + Affiliates.d.aff_count }">

		<MvCLOSEVIEW NAME = "Merchant" VIEW = "Affiliates">
	</MvIF>

	<MvIF EXPR = "{ g.FlatAffiliate_AffiliateEarnings }">
		<MvOPENVIEW NAME	= "Merchant"
					VIEW	= "AffiliateEarnings"
					QUERY	= "{ 'SELECT COUNT( * ) as affearn_count FROM ' $ g.Store_Table_Prefix $ 'AffiliateEarnings' }">
		<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-EXP-AFF-00016', g.MvOPENVIEW_Error ) }">
		</MvIF>

		<MvASSIGN NAME = "g.FlatAffiliate_Total_Count" 				VALUE = "{ g.FlatAffiliate_Total_Count + AffiliateEarnings.d.affearn_count }">

		<MvCLOSEVIEW NAME = "Merchant" VIEW = "AffiliateEarnings">
	</MvIF>

	<MvIF EXPR = "{ g.FlatAffiliate_AffiliatePayouts }">
		<MvOPENVIEW NAME	= "Merchant"
					VIEW	= "AffiliatePayouts"
					QUERY	= "{ 'SELECT COUNT( * ) as affpay_count FROM ' $ g.Store_Table_Prefix $ 'AffiliatePayouts' }">
		<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-EXP-AFF-00017', g.MvOPENVIEW_Error ) }">
		</MvIF>

		<MvASSIGN NAME = "g.FlatAffiliate_Total_Count" 				VALUE = "{ g.FlatAffiliate_Total_Count + AffiliatePayouts.d.affpay_count }">

		<MvCLOSEVIEW NAME = "Merchant" VIEW = "AffiliatePayouts">
	</MvIF>

	<MvASSIGN NAME = "g.AffiliateExport_Export_Initialized" 		VALUE = 1>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "AffiliateExport_Finalize_Export" PARAMETERS = "directory, output" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.FlatAffiliate_Export_Count GE g.FlatAffiliate_Total_Count }">
		<MvASSIGN NAME = "l.message"	VALUE = "">

		<MvIF EXPR = "{ g.FlatAffiliate_Affiliates }">
			<MvIF EXPR = "{ g.FlatAffiliate_AffiliateCount EQ 1 }">			<MvASSIGN NAME = "l.message" VALUE = "{ '1 affiliate' }">
			<MvELSE>														<MvASSIGN NAME = "l.message" VALUE = "{ g.FlatAffiliate_AffiliateCount $ ' affiliates' }">
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ g.FlatAffiliate_AffiliateEarnings }">
			<MvIF EXPR = "{ NOT ISNULL l.message }">						<MvASSIGN NAME = "l.message" VALUE = "{ l.message $ ', ' }">
			</MvIF>

			<MvIF EXPR = "{ g.FlatAffiliate_AffiliateEarningCount EQ 1 }">	<MvASSIGN NAME = "l.message" VALUE = "{ l.message $ '1 affiliate earning' }">
			<MvELSE>														<MvASSIGN NAME = "l.message" VALUE = "{ l.message $ g.FlatAffiliate_AffiliateEarningCount $ ' affiliate earnings' }">
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ g.FlatAffiliate_AffiliatePayouts }">
			<MvIF EXPR = "{ NOT ISNULL l.message }">						<MvASSIGN NAME = "l.message" VALUE = "{ l.message $ ', ' }">
			</MvIF>

			<MvIF EXPR = "{ g.FlatAffiliate_AffiliatePayoutCount EQ 1 }">	<MvASSIGN NAME = "l.message" VALUE = "{ l.message $ '1 affiliate payout' }">
			<MvELSE>														<MvASSIGN NAME = "l.message" VALUE = "{ l.message $ g.FlatAffiliate_AffiliatePayoutCount $ ' affiliate payouts' }">
			</MvIF>
		</MvIF>

		<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Draw_ExportProgressBar_ProgressComplete( l.message $ ' exported to \'' $ l.output $ '\'' ) }">

		<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-EXP-AFF-00019', 'Affiliates exported' ) }">

		<MvIF EXPR = "{ g.FlatAffiliate_SendEmail }">
			<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Library_Utilities ].Send_Email_Attachment( g.Store:email, g.FlatAffiliate_Email, '', 'Miva Merchant Affiliate Export', g.FlatAffiliate_File, l.directory, 'data' ) }">
			<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-EXP-AFF-00018', 'Affiliate Export Email Sent' ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 0>
</MvFUNCTION>

<MvINCLUDE FILE = "modules/export/export_include.mv">

<MIVA STANDARDOUTPUTLEVEL = "">

<MvCOMMENT>
|
| Miva Merchant
|
| This file and the source codes contained herein are the property of
| Miva, Inc.  Use of this file is restricted to the specific terms and
| conditions in the License Agreement associated with this file.  Distribution
| of this file or portions of this file for uses not covered by the License
| Agreement is not allowed without a written agreement signed by an officer of
| Miva, Inc.
|
| Copyright 1998-2024 Miva, Inc.  All rights reserved.
| http://www.miva.com
|
| Prefix         : MER-FUF-TOE-
| Next Error Code: 122   
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Description" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.module:code"		VALUE = "mmlsk-templateorderemails">
	<MvASSIGN NAME = "l.module:name"		VALUE = "Template Based Emails">
	<MvASSIGN NAME = "l.module:provider"	VALUE = "Miva Merchant">
	<MvASSIGN NAME = "l.module:version"		VALUE = "10.1100">
	<MvASSIGN NAME = "l.module:api_ver"		VALUE = "10.10">
	<MvASSIGN NAME = "l.module:description"	VALUE = "Template Based Emails allow you to create and modify order related emails that are sent to customers.  You must enable the Template Based Emails module before you can create Template Based Emails. You can add, view and edit customer emails from the Emails page within User Interface.">
	<MvASSIGN NAME = "l.module:features"	VALUE = "fulfill, vis_email, vis_order, not_orderitem, not_ordershpmnt, data_store, json, clientside, clientside_sri, provision_store, not_cust, vis_cust, component, component_prov, skins, not_giftcert, not_digital, not_subscript, not_payment, scheduledtask, cleanup_store, not_paymentcard">
</MvFUNCTION>

<MvCOMMENT>
|
| Store-level Module Data Support Feature (data_store)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Install_Store" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXPaymentCard
						  (
							custpc_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
							email_sent	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
							pc_days		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ '
						  ) ' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00040', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXPaymentCard_1 ON ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXPaymentCard ( custpc_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00041', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket
			  		      (
			  		    	basket_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
			  		    	lastupdate	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
			  		    	true_lu		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ ',
			  		    	subtotal	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_NUMBER( 10, 2 )	$ ',
			  		    	email_sent	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )		$ ',
			  		    	ab_time		' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()			$ '
			  		      )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00058', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket_1 ON ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket ( basket_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00059', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'CREATE INDEX ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket_2 ON ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket ( true_lu )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00112', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'CREATE TABLE ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXSubscription
			  		      (
			  		    	subscrp_id	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
			  		    	nextdate	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ ',
			  		    	email_sent	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_CHAR( 50 )	$ ',
			  		    	sub_days	' $ [ g.Module_Library_Native_DBAPI ].DB_Type_INTEGER()		$ '
			  		      )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00083', g.MvQUERY_Error ) }">
	</MvIF>

	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'CREATE UNIQUE INDEX ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXSubscription_1 ON ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXSubscription ( subscrp_id )' }">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00084', g.MvQUERY_Error ) }">
	</MvIF>

	<MvCOMMENT>
	|
	| Default Scheduled Task: Notify of Payment Card Expiration
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.task"							VALUE = "">
	<MvASSIGN NAME = "l.task:descrip"					VALUE = "Notify of Payment Card Expiration">
	<MvASSIGN NAME = "l.task:enabled"					VALUE = 1>
	<MvASSIGN NAME = "l.task:loglevel"					VALUE = "">
	<MvASSIGN NAME = "l.task:trig"						VALUE = "">
	<MvASSIGN NAME = "l.task:trig_delay"				VALUE = 0>
	<MvASSIGN NAME = "l.task:runint"					VALUE = 86400>
	<MvASSIGN NAME = "l.task:runonce"					VALUE = 0>
	<MvASSIGN NAME = "l.task:mnt_mode"					VALUE = 0>
	<MvASSIGN NAME = "l.task:mnt_advnce"				VALUE = 1800>
	<MvASSIGN NAME = "l.task:lastrun"					VALUE = 0>
	<MvASSIGN NAME = "l.task:nextrun"					VALUE = "{ s.dyn_time_t + l.task:runint }">
	<MvASSIGN NAME = "l.task:module_id"					VALUE = "{ l.module:id }">
	<MvASSIGN NAME = "l.task:operation"					VALUE = "notify_card_expiration">
	<MvASSIGN NAME = "l.task:config"					VALUE = "">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_SCH_DB ].ScheduledTask_Insert( l.task ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvCOMMENT>
	|
	| Default Scheduled Task: Send Abandoned Basket Emails
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.task"							VALUE = "">
	<MvASSIGN NAME = "l.task:descrip"					VALUE = "Send Abandoned Basket Emails">
	<MvASSIGN NAME = "l.task:enabled"					VALUE = 1>
	<MvASSIGN NAME = "l.task:loglevel"					VALUE = "">
	<MvASSIGN NAME = "l.task:trig"						VALUE = "">
	<MvASSIGN NAME = "l.task:trig_delay"				VALUE = 0>
	<MvASSIGN NAME = "l.task:runint"					VALUE = 3600>
	<MvASSIGN NAME = "l.task:runonce"					VALUE = 0>
	<MvASSIGN NAME = "l.task:mnt_mode"					VALUE = 0>
	<MvASSIGN NAME = "l.task:mnt_advnce"				VALUE = 1800>
	<MvASSIGN NAME = "l.task:lastrun"					VALUE = 0>
	<MvASSIGN NAME = "l.task:nextrun"					VALUE = "{ s.dyn_time_t + l.task:runint }">
	<MvASSIGN NAME = "l.task:module_id"					VALUE = "{ l.module:id }">
	<MvASSIGN NAME = "l.task:operation"					VALUE = "send_abandoned_basket_emails">
	<MvASSIGN NAME = "l.task:config"					VALUE = "">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_SCH_DB ].ScheduledTask_Insert( l.task ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvCOMMENT>
	|
	| Default Scheduled Task: Send Pending Subscription Emails
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.task"							VALUE = "">
	<MvASSIGN NAME = "l.task:descrip"					VALUE = "Send Pending Subscription Emails">
	<MvASSIGN NAME = "l.task:enabled"					VALUE = 1>
	<MvASSIGN NAME = "l.task:loglevel"					VALUE = "">
	<MvASSIGN NAME = "l.task:trig"						VALUE = "">
	<MvASSIGN NAME = "l.task:trig_delay"				VALUE = 0>
	<MvASSIGN NAME = "l.task:runint"					VALUE = 86400>
	<MvASSIGN NAME = "l.task:runonce"					VALUE = 0>
	<MvASSIGN NAME = "l.task:mnt_mode"					VALUE = 0>
	<MvASSIGN NAME = "l.task:mnt_advnce"				VALUE = 1800>
	<MvASSIGN NAME = "l.task:lastrun"					VALUE = 0>
	<MvASSIGN NAME = "l.task:nextrun"					VALUE = "{ s.dyn_time_t + l.task:runint }">
	<MvASSIGN NAME = "l.task:module_id"					VALUE = "{ l.module:id }">
	<MvASSIGN NAME = "l.task:operation"					VALUE = "send_pending_subscription_emails">
	<MvASSIGN NAME = "l.task:config"					VALUE = "">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_SCH_DB ].ScheduledTask_Insert( l.task ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvCOMMENT>
	|
	| Create default emails
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ NOT TemplateOrderEmails_Create_Defaults( l.module ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Upgrade_Store" PARAMETERS = "module var, version" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.module:version EQ l.version }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00081', 'Module \'' $ l.module:name $ '\' does not support manual upgrade.  New versions may only be obtained through the streaming update system.' ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Uninstall_Store" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.working_branch_id" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Working_Branch_ID() }">

	<MvFOREACH ITERATOR = "l.branch" ARRAY = "l.branches" COUNT = "{ [ g.Module_Feature_TUI_DB ].BranchList_Load_All( l.branches ) }">
		<MvIF EXPR = "{ l.working_branch_id NE l.branch:id }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Push_WorkingBranchStack( l.branch ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>

		<MvFOREACH ITERATOR = "l.email" ARRAY = "l.emails" COUNT = "{ TemplateOrderEmailList_Load( l.emails ) }">
			<MvASSIGN NAME = "l.null" VALUE = "{ TemplateOrderEmail_Delete( l.email ) }">
		</MvFOREACH>

		<MvIF EXPR = "{ l.working_branch_id NE l.branch:id }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Pop_WorkingBranchStack() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>
	</MvFOREACH>

	<MvQUERY NAME = "Merchant" QUERY = "{ 'DROP TABLE ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXPaymentCard' }">
	<MvQUERY NAME = "Merchant" QUERY = "{ 'DROP TABLE ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket' }">
	<MvQUERY NAME = "Merchant" QUERY = "{ 'DROP TABLE ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXSubscription' }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| Email Feature (vis_email)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Email_Tabs" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'FUFL', 1, 0, 0, 0 ) }">
		<MvFUNCTIONRETURN VALUE = "">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "TBOE:Template Based Emails">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Email_Head" PARAMETERS = "module var, tab" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'FUFL', 1, 0, 0, 0 ) }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ l.tab NE 'TBOE' }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvEVAL EXPR = "{ Element_TemplateOrderEmail_List_CSS( l.module ) }">

	<MvIF EXPR = "{ Element_TemplateOrderEmail_JavaScript_Combined_Begin( l.module ) }">
		<MvEVAL EXPR = "{ Element_TemplateOrderEmail_List_JavaScript( l.module ) }">
		<MvEVAL EXPR = "{ Element_TemplateOrderEmail_JavaScript_Combined_End( l.module ) }">
	</MvIF>

	<script language="JavaScript">
		MMScreen_LoadFinished( function() { new TemplateOrderEmailList(); } );
	</script>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Email_Content" PARAMETERS = "module var, tab, load_fields" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'FUFL', 1, 0, 0, 0 ) }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ l.tab NE 'TBOE' }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].DrawButtons_Suppress( '[UPDATE]' ) }">
	<MvEVAL EXPR = "{ Element_TemplateOrderEmail_List_HTML( l.module ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Email_Validate" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Email_Update" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| Order Tabs Feature (vis_order)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Order_Validate" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Module_Order_Update_LowLevel( l.module ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( g.Tab, '', 'One or more notification emails could not be sent at this time:' $ asciichar( 10 ) $ asciichar( 10 ) $ g.Error_Message ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Order_Update" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Order_Update_LowLevel" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ ISNULL g.TemplateOrderEmail_Send_Codes }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.run:override_from"		VALUE = "{ g.TemplateOrderEmail_Override_From }">
	<MvASSIGN NAME = "l.run:override_reply_to"	VALUE = "{ g.TemplateOrderEmail_Override_Reply_To }">
	<MvASSIGN NAME = "l.run:override_to"		VALUE = "{ g.TemplateOrderEmail_Override_To }">
	<MvASSIGN NAME = "l.run:override_cc"		VALUE = "{ g.TemplateOrderEmail_Override_CC }">
	<MvASSIGN NAME = "l.run:override_bcc"		VALUE = "{ g.TemplateOrderEmail_Override_BCC }">
	<MvASSIGN NAME = "l.run:override_subject"	VALUE = "{ g.TemplateOrderEmail_Override_Subject }">

	<MvCOMMENT>
	|
	| Load non-conflicting items into the run:
	|	order		
	|	toe_order_contents
	|	order_contents
	|	order_customer
	|	backordered items
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Order_Load_ID( g.Edit_Order, l.run:order ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.null"					VALUE = "{ [ g.Module_Library_DB ].OrderItemList_Load_Status( l.run:order:id, 400, l.run:backordered_orderitems ) }">

	<MvFOREACH ITERATOR = "l.email_code" ARRAY = "g.TemplateOrderEmail_Send_Codes">
		<MvIF EXPR = "{ NOT TemplateOrderEmail_Load_Code( l.email_code, l.email ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		<MvELSEIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Page_Load_Code( l.email:page_code, l.page ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvCOMMENT>
		|
		| Load conflicting items based on email configuration
		|	unreceived returns
		|	received returns
		|	unshipped shipments
		|	shipped shipments
		|	gift certificates
		|
		| If the email has no configuration regarding an item, do not load it
		|
		</MvCOMMENT>

		<MvASSIGN NAME = "l.rma_count"						VALUE = 0>
		<MvASSIGN NAME = "l.rmas"							VALUE = "">
		<MvASSIGN NAME = "l.giftcertificate_count"			VALUE = 0>
		<MvASSIGN NAME = "l.giftcertificates"				VALUE = "">
		<MvASSIGN NAME = "l.multiplex_returns"				VALUE = 0>
		<MvASSIGN NAME = "l.multiplex_giftcerts"			VALUE = 0>
		<MvASSIGN NAME = "l.multiplex_digitaldownloads"		VALUE = 0>

		<MvASSIGN NAME = "l.run:rma_id"						VALUE = 0>
		<MvASSIGN NAME = "l.run:ordershipments"				VALUE = "">

		<MvIF EXPR = "{ l.email:on_retc }">
			<MvASSIGN NAME = "l.rma_count"					VALUE = "{ [ g.Module_Library_DB ].OrderReturnList_Load_Status( l.run:order:id, 500, l.rmas ) }">
		</MvIF>

		<MvIF EXPR = "{ l.email:on_retr }">
			<MvASSIGN NAME = "l.returned_count"				VALUE = "{ [ g.Module_Library_DB ].OrderReturnList_Load_Status( l.run:order:id, 600, l.returned_orderreturns ) }">
			<MvASSIGN NAME = "l.rma_count"					VALUE = "{ miva_array_merge( l.returned_orderreturns, 1, l.returned_count, l.rmas, -1 ) }">
		</MvIF>

		<MvIF EXPR = "{ l.email:on_shpc AND l.email:on_shps }">
			<MvASSIGN NAME = "l.null"						VALUE = "{ [ g.Module_Library_DB ].OrderShipmentList_Load_Order( l.run:order:id, l.run:ordershipments ) }">
		<MvELSEIF EXPR = "{ l.email:on_shpc }">
			<MvASSIGN NAME = "l.null"						VALUE = "{ [ g.Module_Library_DB ].OrderShipmentList_Load_Status( l.run:order:id, 100, l.run:ordershipments ) }">
		<MvELSEIF EXPR = "{ l.email:on_shps }">
			<MvASSIGN NAME = "l.null"						VALUE = "{ [ g.Module_Library_DB ].OrderShipmentList_Load_Status( l.run:order:id, 200, l.run:ordershipments ) }">
		</MvIF>

		<MvIF EXPR = "{ l.email:on_gftcert }">
			<MvASSIGN NAME = "l.giftcertificate_count"		VALUE = "{ [ g.Module_Feature_GFT_DB ].GiftCertificateList_Load_Order( l.run:order:id, l.giftcertificates ) }">

			<MvFOREACH ITERATOR = "l.giftcertificate" ARRAY = "l.giftcertificates" COUNT = "{ l.giftcertificate_count }">
				<MvIF EXPR = "{ NOT TemplateOrderEmails_Load_GiftCertificateSalesData( l.run:order, l.giftcertificate ) }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			</MvFOREACH>
		</MvIF>

		<MvIF EXPR = "{ l.email:on_digital }">
			<MvASSIGN NAME = "l.digitaldownload_count"		VALUE = "{ [ g.Module_Feature_DDL_DB ].DigitalDownloadList_Load_Order( l.run:order:id, l.digitaldownloads ) }">
		</MvIF>

		<MvCOMMENT>
		|
		| If this email has the "return" item, it must be triggered once per issued or returned
		| OrderReturn.  Otherwise it is triggered only once.  We only care about this if there is more
		| than one return.
		|
		</MvCOMMENT>

		<MvIF EXPR = "{ l.rma_count GT 1 }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Item_Load_Code( 'return', l.item ) }">
				<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			<MvELSEIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].PageXItem_Load( l.page:id, l.item:id, l.pagexitem ) }">
				<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			<MvELSE>
				<MvASSIGN NAME = "l.multiplex_returns"		VALUE = 1>
			</MvIF>
		</MvIF>

		<MvCOMMENT>
		|
		| If this email has the "giftcertificate" item, it must be triggered once per gift certificate.
		| Again, it only matters if there is more than one gift certificate.
		|
		</MvCOMMENT>

		<MvIF EXPR = "{ l.giftcertificate_count GT 1 }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Item_Load_Code( 'giftcertificate', l.item ) }">
				<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			<MvELSEIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].PageXItem_Load( l.page:id, l.item:id, l.pagexitem ) }">
				<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			<MvELSE>
				<MvASSIGN NAME = "l.multiplex_giftcerts"		VALUE = 1>
			</MvIF>
		</MvIF>

		<MvCOMMENT>
		|
		| If this email has the "digitaldownload" item, it must be triggered once per digital download.
		| Again, it only matters if there is more than one digital download.
		|
		</MvCOMMENT>

		<MvIF EXPR = "{ l.digitaldownload_count GT 1 }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Item_Load_Code( 'digitaldownload', l.item ) }">
				<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			<MvELSEIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].PageXItem_Load( l.page:id, l.item:id, l.pagexitem ) }">
				<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			<MvELSE>
				<MvASSIGN NAME = "l.multiplex_digitaldownloads"	VALUE = 1>
			</MvIF>
		</MvIF>

		<MvCOMMENT>
		|
		| Determine how many iterations we need (unique emails to be sent)
		|
		</MvCOMMENT>

		<MvASSIGN NAME = "l.iteration_count"					VALUE = 1>

		<MvIF EXPR = "{ l.multiplex_returns AND ( l.iteration_count LT l.rma_count ) }">
			<MvASSIGN NAME = "l.iteration_count"				VALUE = "{ l.rma_count }">
		</MvIF>

		<MvIF EXPR = "{ l.multiplex_giftcerts }">
			<MvIF EXPR = "{ l.iteration_count LT l.giftcertificate_count }">
				<MvASSIGN NAME = "l.iteration_count" VALUE = "{ l.giftcertificate_count }">
			</MvIF>
		<MvELSE>
			<MvASSIGN NAME = "l.grouped_giftcertificate_count" VALUE = "{ TemplateOrderEmail_Group_GiftCertificates( l.giftcertificates, l.giftcertificate_count, l.grouped_giftcertificates ) }">

			<MvIF EXPR = "{ l.iteration_count LT l.grouped_giftcertificate_count }">
				<MvASSIGN NAME = "l.iteration_count" VALUE = "{ l.grouped_giftcertificate_count }">
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ l.multiplex_digitaldownloads AND ( l.iteration_count LT l.digitaldownload_count ) }">
			<MvASSIGN NAME = "l.iteration_count"				VALUE = "{ l.digitaldownload_count }">
		</MvIF>

		<MvCOMMENT>
		|
		| Send the emails
		|
		</MvCOMMENT>

		<MvFOR INDEX = "l.iteration" COUNT = "{ l.iteration_count }">
			<MvIF EXPR = "{ l.iteration GT l.rma_count }">		<MvASSIGN NAME = "l.run:rma_id"	VALUE = 0>
			<MvELSE>											<MvASSIGN NAME = "l.run:rma_id"	VALUE = "{ l.rmas[ l.iteration ]:id }">
			</MvIF>

			<MvIF EXPR = "{ l.iteration GT l.giftcertificate_count }">
				<MvASSIGN NAME = "l.run:giftcertificates"			VALUE = "">
				<MvASSIGN NAME = "l.run:giftcertificate_count"		VALUE = 0>
			<MvELSEIF EXPR = "{ l.multiplex_giftcerts }">
				<MvASSIGN NAME = "l.run:giftcertificates" INDEX = 1	VALUE = "{ l.giftcertificates[ l.iteration ] }">
				<MvASSIGN NAME = "l.run:giftcertificate_count"		VALUE = 1>
			<MvELSE>
				<MvASSIGN NAME = "l.run:giftcertificates"			VALUE = "{ l.grouped_giftcertificates[ l.iteration ]:giftcertificates }">
				<MvASSIGN NAME = "l.run:giftcertificate_count"		VALUE = "{ l.grouped_giftcertificates[ l.iteration ]:giftcertificate_count }">
			</MvIF>

			<MvIF EXPR = "{ l.iteration GT l.digitaldownload_count }">
				<MvASSIGN NAME = "l.run:digitaldownloads"				VALUE = "">
				<MvASSIGN NAME = "l.run:digitaldownload_count"			VALUE = 0>
			<MvELSEIF EXPR = "{ l.multiplex_digitaldownloads }">
				<MvASSIGN NAME = "l.run:digitaldownloads"	INDEX = 1	VALUE = "{ l.digitaldownloads[ l.iteration ] }">
				<MvASSIGN NAME = "l.run:digitaldownload_count"			VALUE = 1>
			<MvELSE>
				<MvASSIGN NAME = "l.run:digitaldownloads"				VALUE = "{ l.digitaldownloads }">
				<MvASSIGN NAME = "l.run:digitaldownload_count"			VALUE = "{ l.digitaldownload_count }">
			</MvIF>

			<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.run, l.email ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvFOR>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Order_Delete_Order" PARAMETERS = "module var, order var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Order_Head" PARAMETERS = "module var, tab, order var" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ TemplateOrderEmail_Branch_Warning_CSS() }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Order_Tabs" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "TBOE:Order Emails">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Order_Content" PARAMETERS = "module var, tab, load_fields" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ l.load_fields }">
		<MvASSIGN NAME = "g.TemplateOrderEmail_Send_Codes" VALUE = "">
	</MvIF>

	<MvIF EXPR = "{ l.tab NE 'TBOE' }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>
		
	<MvASSIGN NAME = "l.email_count" VALUE = "{ TemplateOrderEmailList_Load_Order( l.emails ) }">
	
	<table>
		<MvEVAL EXPR = "{ TemplateOrderEmail_Branch_Warning_HTML() }">

		<MvIF EXPR = "{ NOT l.email_count }">
			<tr><td colspan="2">No order emails configured</td></tr>
		<MvELSE>
			<tr>
				<td nowrap valign="top">Send the Following Email(s):</td>
				<td width="100%" valign="top">
					<MvEVAL EXPR = "{ [ g.Module_Admin ].DrawButtons_Override_OrderTabSaveButton_Text( 'Send' ) }">

					<MvFOREACH INDEX = "l.email_pos" ITERATOR = "l.email" ARRAY = "l.emails" COUNT = "{ l.email_count }">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckboxModAlert( g.TemplateOrderEmail_Send_Codes[ l.email_pos ], 'TemplateOrderEmail_Send_Codes[' $ l.email_pos $ ']', l.email:code, encodeentities( l.email:name ) ) }">
						<br>
					</MvFOREACH>
				</td>
			</tr>

			<tr><td colspan="2">&nbsp;</td></tr>

			<tr><td valign="middle">Override From:</td><td valign="middle"><input type="text" name="TemplateOrderEmail_Override_From" size="30" onchange="SetModified();"></td></tr>
			<tr><td valign="middle">Override Reply-To:</td><td valign="middle"><input type="text" name="TemplateOrderEmail_Override_Reply_To" size="30" onchange="SetModified();"></td></tr>
			<tr><td valign="middle">Override To:</td><td valign="middle"><input type="text" name="TemplateOrderEmail_Override_To" size="30" onchange="SetModified();"></td></tr>
			<tr><td valign="middle">Override CC:</td><td valign="middle"><input type="text" name="TemplateOrderEmail_Override_CC" size="30" onchange="SetModified();"></td></tr>
			<tr><td valign="middle">Override BCC:</td><td valign="middle"><input type="text" name="TemplateOrderEmail_Override_BCC" size="30" onchange="SetModified();"></td></tr>
			<tr><td valign="middle">Override Subject:</td><td valign="middle"><input type="text" name="TemplateOrderEmail_Override_Subject" size="40" onchange="SetModified();"></td></tr>
		</MvIF>	
	</table>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| Helper Functions
|
</MvCOMMENT>

<MvFUNCTION NAME = "TemplateOrderEmails_Create_Item" PARAMETERS = "item_code, module_code" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Item_Load_Code( l.item_code, l.item ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_Item( l.item_code, l.module_code ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Create_Defaults" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| Order Confirmation: Customer
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email:enabled"		VALUE = 1>
	<MvASSIGN NAME = "l.email:code"			VALUE = "ORDERCONF_CUSTOMER">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Order Confirmation: Customer">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:order:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Your &mvt:store:name; Order">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "{ TemplateOrderEmails_String_To_Structure( 'shopper,user' ) }">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 1>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-orderconf-customer.mvt' ) }">

	<MvCOMMENT>
	|
	| Order Confirmation: Merchant
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email:enabled"		VALUE = 1>
	<MvASSIGN NAME = "l.email:code"			VALUE = "ORDERCONF_MERCHANT">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Order Confirmation: Merchant">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Online Order Placed with Miva Merchant">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "{ TemplateOrderEmails_String_To_Structure( 'shopper,user' ) }">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 1>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-orderconf-merchant.mvt' ) }">

	<MvCOMMENT>
	|
	| Backorder Notice
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email:enabled"		VALUE = 0>
	<MvASSIGN NAME = "l.email:code"			VALUE = "BACKORDER_NOTICE">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Backorder Notice">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:order:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Backorder Notice">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 1>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-backorder-notice.mvt' ) }">

	<MvCOMMENT>
	|
	| Shipment Shipped
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email:enabled"		VALUE = 0>
	<MvASSIGN NAME = "l.email:code"			VALUE = "SHIPMENT_SHIPPED">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Shipment Shipped">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:order:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Shipment Confirmation">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 1>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-shipment-shipped.mvt' ) }">

	<MvCOMMENT>
	|
	| RMA Issued
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email:enabled"		VALUE = 0>
	<MvASSIGN NAME = "l.email:code"			VALUE = "RMA_ISSUED">
	<MvASSIGN NAME = "l.email:name"			VALUE = "RMA Issued">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:order:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Return Authorization and Instructions">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 1>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-rma-issued.mvt' ) }">

	<MvCOMMENT>
	|
	| Return Received
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email:enabled"		VALUE = 0>
	<MvASSIGN NAME = "l.email:code"			VALUE = "RETURN_RECEIVED">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Return Received">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:order:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Your Return Has Been Received">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 1>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-return-received.mvt' ) }">
	
	<MvCOMMENT>
	|
	| Customer Created
	|
	</MvCOMMENT>
	
	<MvASSIGN NAME = "l.email:enabled"		VALUE = 0>
	<MvASSIGN NAME = "l.email:code"			VALUE = "CUSTOMER_CREATED">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Customer Created">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:global:customer:pw_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "&mvt:store:name; Account Registration">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 1>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 0>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-customer-created.mvt' ) }">

	<MvCOMMENT>
	|
	| Abandoned Basket
	|
	</MvCOMMENT>
	
	<MvASSIGN NAME = "l.email:enabled"		VALUE = 0>
	<MvASSIGN NAME = "l.email:code"			VALUE = "ABANDONED_BASKET">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Abandoned Basket">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:global:Basket:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Your &mvt:store:name; Basket">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 1>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 1>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 0>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-abandoned-basket.mvt' ) }">

	<MvCOMMENT>
	|
	| Gift Certificate Created
	|
	</MvCOMMENT>
	
	<MvASSIGN NAME = "l.email:enabled"		VALUE = 1>
	<MvASSIGN NAME = "l.email:code"			VALUE = "GIFTCERTIFICATE_CREATED">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Gift Certificate Created">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:giftcertificate:recipients;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Your &mvt:store:name; Gift Certificate">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 1>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 1>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-giftcertificate-created.mvt' ) }">

	<MvCOMMENT>
	|
	| Digital Download Created
	|
	</MvCOMMENT>
	
	<MvASSIGN NAME = "l.email:enabled"		VALUE = 1>
	<MvASSIGN NAME = "l.email:code"			VALUE = "DIGITALDOWNLOAD_CREATED">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Digital Download Created">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:order:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Your &mvt:store:name; Digital Download">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 1>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 1>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-digitaldownload-created.mvt' ) }">

	<MvCOMMENT>
	|
	| Subscription Created
	|
	</MvCOMMENT>
	
	<MvASSIGN NAME = "l.email:enabled"		VALUE = 1>
	<MvASSIGN NAME = "l.email:code"			VALUE = "SUBSCRIPTION_CREATED">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Subscription Created">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:subscriptionorder:customer:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Your &mvt:store:name; Subscription">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 1>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 0>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-subscription-created.mvt' ) }">

	<MvCOMMENT>
	|
	| Subscription Changed
	|
	</MvCOMMENT>
	
	<MvASSIGN NAME = "l.email:enabled"		VALUE = 1>
	<MvASSIGN NAME = "l.email:code"			VALUE = "SUBSCRIPTION_CHANGED">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Subscription Changed">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:subscription:customer:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Your &mvt:store:name; Subscription Changed">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 1>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 0>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-subscription-changed.mvt' ) }">

	<MvCOMMENT>
	|
	| Subscription Reminder
	|
	</MvCOMMENT>
	
	<MvASSIGN NAME = "l.email:enabled"		VALUE = 1>
	<MvASSIGN NAME = "l.email:code"			VALUE = "SUBSCRIPTION_REMINDER">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Subscription Reminder">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:subscriptionorder:customer:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Your &mvt:store:name; Subscription is Pending">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 1>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 0>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-subscription-reminder.mvt' ) }">

	<MvCOMMENT>
	|
	| Subscription Cancelled
	|
	</MvCOMMENT>
	
	<MvASSIGN NAME = "l.email:enabled"		VALUE = 1>
	<MvASSIGN NAME = "l.email:code"			VALUE = "SUBSCRIPTION_CANCELLED">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Subscription Cancelled">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:subscription:customer:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Your &mvt:store:name; Subscription Cancelled">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 1>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 0>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-subscription-cancelled.mvt' ) }">

	<MvCOMMENT>
	|
	| Authorization Failure
	|
	</MvCOMMENT>
	
	<MvASSIGN NAME = "l.email:enabled"		VALUE = 1>
	<MvASSIGN NAME = "l.email:code"			VALUE = "SUBSCRIPTION_AUTH_FAILURE">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Subscription Authorization Failure">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:subscriptionorder:customer:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Your &mvt:store:name; Authorization Failure">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "{ TemplateOrderEmails_String_To_Structure( 'subscription' ) }">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 0>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-subscription-authorization-failure.mvt' ) }">

	<MvCOMMENT>
	|
	| Payment Card Expiring
	|
	</MvCOMMENT>
	
	<MvASSIGN NAME = "l.email:enabled"		VALUE = 1>
	<MvASSIGN NAME = "l.email:code"			VALUE = "PAYMENTCARD_EXPIRING">
	<MvASSIGN NAME = "l.email:name"			VALUE = "Payment Card Expiring">
	<MvASSIGN NAME = "l.email:email_from"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"		VALUE = "&mvt:paymentcard:customer:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"	VALUE = "Your &mvt:store:name; Payment Card Expiration">
	<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = 1>
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time" 		VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 	VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = 0>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-paymentcard-expiring.mvt' ) }">

	<MvCOMMENT>
	|
	| Subscription Out of Stock
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email"				VALUE = "">
	<MvASSIGN NAME = "l.email:enabled"      VALUE = 1>
	<MvASSIGN NAME = "l.email:code"         VALUE = "SUBSCRIPTION_OUTOFSTOCK">
	<MvASSIGN NAME = "l.email:name"         VALUE = "Subscription Out of Stock">
	<MvASSIGN NAME = "l.email:email_from"   VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_rp_to"  VALUE = "&mvt:store:email;">
	<MvASSIGN NAME = "l.email:email_to"     VALUE = "&mvt:subscriptionorder:customer:bill_email;">
	<MvASSIGN NAME = "l.email:email_subj"   VALUE = "Your &mvt:store:name; Subscription">
	<MvASSIGN NAME = "l.email:mime_type"    VALUE = "{ TemplateOrderEmails_Default_MimeType() }">
	<MvASSIGN NAME = "l.email:on_ordr"      VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"      VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"      VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"      VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"      VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"      VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust"      VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon"   VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert"   VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital"   VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"   VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"   VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"   VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"   VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"   VALUE = 1>
	<MvASSIGN NAME = "l.email:sub_days"     VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"    VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"      VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"      VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_time"      VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub"    VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub"    VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins"    VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive"   VALUE = 0>
	<MvASSIGN NAME = "l.email:on_athfail"   VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64"     VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust"     VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr"     VALUE = 0>

	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_Create_Email_FromFile( l.module, l.email, 'email-subscription-out-of-stock.mvt' ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Create_Email" PARAMETERS = "module var, email var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmails_Create_Email_FromVariable( l.module, l.email, l.null ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Create_Email_FromFile" PARAMETERS = "module var, email var, initial_template_file" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ file_read( g.Module_Root $ 'templates/' $ l.initial_template_file, 'script', l.template_data ) LT 0 }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00004', 'Unable to read \'' $ g.Module_Root $ 'templates/' $ l.initial_template_file $ '\'' ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmails_Create_Email_FromVariable( l.module, l.email, l.template_data ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Create_Email_FromVariable" PARAMETERS = "module var, email var, template_data var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT TemplateOrderEmails_Create_Email_LowLevel( l.module, l.email, l.template_data ) }">
		<MvASSIGN NAME = "l.error_code"		VALUE = "{ g.Error_Code }">
		<MvASSIGN NAME = "l.error_message"	VALUE = "{ g.Error_Message }">

		<MvIF EXPR = "{ NOT ISNULL l.email:tfn_from }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_from ) }">	</MvIF>
		<MvIF EXPR = "{ NOT ISNULL l.email:tfn_rp_to }">	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_rp_to ) }">	</MvIF>
		<MvIF EXPR = "{ NOT ISNULL l.email:tfn_to }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_to ) }">		</MvIF>
		<MvIF EXPR = "{ NOT ISNULL l.email:tfn_cc }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_cc ) }">		</MvIF>
		<MvIF EXPR = "{ NOT ISNULL l.email:tfn_bcc }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_bcc ) }">	</MvIF>
		<MvIF EXPR = "{ NOT ISNULL l.email:tfn_subj }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_subj ) }">	</MvIF>
		<MvIF EXPR = "{ NOT ISNULL l.email:tfn_mime }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_mime ) }">	</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( l.error_code, l.error_message ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Create_Email_LowLevel" PARAMETERS = "module var, email var, template_data var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.email:page_code"	VALUE = "{ 'EMAIL_' $ l.email:code }">
	<MvASSIGN NAME = "l.email:tfn_from"		VALUE = "">
	<MvASSIGN NAME = "l.email:tfn_rp_to"	VALUE = "">
	<MvASSIGN NAME = "l.email:tfn_to"		VALUE = "">
	<MvASSIGN NAME = "l.email:tfn_cc"		VALUE = "">
	<MvASSIGN NAME = "l.email:tfn_bcc"		VALUE = "">
	<MvASSIGN NAME = "l.email:tfn_subj"		VALUE = "">
	<MvASSIGN NAME = "l.email:tfn_mime"		VALUE = "">

	<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].Page_Load_Code( l.email:page_code, l.existing_page ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00023', 'A page with the code \'' $ l.email:page_code $ '\' already exists' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Validate_Compilation( l.email:email_from ) }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Validate_Compilation( l.email:email_rp_to ) }">	<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Validate_Compilation( l.email:email_to ) }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Validate_Compilation( l.email:email_cc ) }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Validate_Compilation( l.email:email_bcc ) }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Validate_Compilation( l.email:email_subj ) }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Validate_Compilation( l.email:mime_type ) }">		<MvFUNCTIONRETURN VALUE = 0> </MvIF>

	<MvASSIGN NAME = "l.settings"			VALUE = "">

	<MvCOMMENT>
	|
	| From Template
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email_tfn_from"		VALUE = "{ 'email-' $ l.email:code $ '-from.mvc' }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_Unsynced_ManagedTemplate_NoDuplicates( l.email:email_from, l.settings, l.email_tfn_from ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.email:tfn_from"		VALUE = "{ l.email_tfn_from }">

	<MvCOMMENT>
	|
	| Reply-To Template
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email_tfn_rp_to"	VALUE = "{ 'email-' $ l.email:code $ '-rp-to.mvc' }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_Unsynced_ManagedTemplate_NoDuplicates( l.email:email_rp_to, l.settings, l.email_tfn_rp_to ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.email:tfn_rp_to"	VALUE = "{ l.email_tfn_rp_to }">

	<MvCOMMENT>
	|
	| To Template
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email_tfn_to"		VALUE = "{ 'email-' $ l.email:code $ '-to.mvc' }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_Unsynced_ManagedTemplate_NoDuplicates( l.email:email_to, l.settings, l.email_tfn_to ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.email:tfn_to"		VALUE = "{ l.email_tfn_to }">

	<MvCOMMENT>
	|
	| CC Template
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email_tfn_cc"		VALUE = "{ 'email-' $ l.email:code $ '-cc.mvc' }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_Unsynced_ManagedTemplate_NoDuplicates( l.email:email_cc, l.settings, l.email_tfn_cc ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.email:tfn_cc"		VALUE = "{ l.email_tfn_cc }">

	<MvCOMMENT>
	|
	| BCC Template
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email_tfn_bcc"		VALUE = "{ 'email-' $ l.email:code $ '-bcc.mvc' }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_Unsynced_ManagedTemplate_NoDuplicates( l.email:email_bcc, l.settings, l.email_tfn_bcc ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.email:tfn_bcc"		VALUE = "{ l.email_tfn_bcc }">

	<MvCOMMENT>
	|
	| Subject Template
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email_tfn_subj"		VALUE = "{ 'email-' $ l.email:code $ '-subj.mvc' }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_Unsynced_ManagedTemplate_NoDuplicates( l.email:email_subj, l.settings, l.email_tfn_subj ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.email:tfn_subj"		VALUE = "{ l.email_tfn_subj }">

	<MvCOMMENT>
	|
	| Mime Template
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email_tfn_mime"		VALUE = "{ 'email-' $ l.email:code $ '-mime.mvc' }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_Unsynced_ManagedTemplate_NoDuplicates( l.email:mime_type, l.settings, l.email_tfn_mime ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.email:tfn_mime"		VALUE = "{ l.email_tfn_mime }">

	<MvCOMMENT>
	|
	| Create Items
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ NOT TemplateOrderEmails_Create_Item( 'backorder',					'cmp-mv-stdorderitemfields' )		OR
					NOT TemplateOrderEmails_Create_Item( 'return',						'cmp-mv-stdreturnfields' )			OR
					NOT TemplateOrderEmails_Create_Item( 'shipment',					'cmp-mv-stdshipmentfields' )		OR
					NOT TemplateOrderEmails_Create_Item( 'toe_order_contents',			l.module:code )						OR
					NOT TemplateOrderEmails_Create_Item( 'toe_basket_contents',			l.module:code )						OR
					NOT TemplateOrderEmails_Create_Item( 'giftcertificate',				'cmp-mv-stdgiftcertificatefields' )	OR
					NOT TemplateOrderEmails_Create_Item( 'digitaldownload',				'cmp-mv-stddigitaldownloadfields' )	OR
					NOT TemplateOrderEmails_Create_Item( 'toe_subscription_fields',		l.module:code )	OR
					NOT TemplateOrderEmails_Create_Item( 'toe_subscriptions',			l.module:code ) OR
					NOT TemplateOrderEmails_Create_Item( 'toe_giftcertificates',		l.module:code ) OR
					NOT TemplateOrderEmails_Create_Item( 'toe_digitaldownloads',		l.module:code ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.page:admin"			VALUE = 1>
	<MvASSIGN NAME = "l.page:code"			VALUE = "{ l.email:page_code }">
	<MvASSIGN NAME = "l.page:name"			VALUE = "{ l.email:name }">
	<MvASSIGN NAME = "l.page:ui_id"			VALUE = "{ l.module:id }">
	<MvASSIGN NAME = "l.page:settings"		VALUE = "">
	
	<MvIF EXPR = "{ l.email:on_bord }">
		<MvASSIGN NAME = "l.page:settings:backorder:imagetypes"							VALUE = "">
		<MvASSIGN NAME = "l.page:settings:backorder:imagetypes"	INDEX = 1				VALUE = "main">
		<MvASSIGN NAME = "l.page:settings:backorder:image"								VALUE = "main">
		<MvASSIGN NAME = "l.page:settings:backorder:constrain"							VALUE = "B">
		<MvASSIGN NAME = "l.page:settings:backorder:b_width"							VALUE = 63>
		<MvASSIGN NAME = "l.page:settings:backorder:b_height"							VALUE = 63>
	</MvIF>

	<MvIF EXPR = "{ l.email:on_retc OR l.email:on_retr }">
		<MvASSIGN NAME = "l.page:settings:return:imagetypes"							VALUE = "">
		<MvASSIGN NAME = "l.page:settings:return:imagetypes" INDEX = 1					VALUE = "main">
		<MvASSIGN NAME = "l.page:settings:return:image"									VALUE = "main">
		<MvASSIGN NAME = "l.page:settings:return:constrain"								VALUE = "B">
		<MvASSIGN NAME = "l.page:settings:return:b_width"								VALUE = 63>
		<MvASSIGN NAME = "l.page:settings:return:b_height"								VALUE = 63>
	</MvIF>

	<MvIF EXPR = "{ l.email:on_shpc OR l.email:on_shps }">
		<MvASSIGN NAME = "l.page:settings:shipment:imagetypes"							VALUE = "">
		<MvASSIGN NAME = "l.page:settings:shipment:imagetypes" INDEX = 1				VALUE = "main">
		<MvASSIGN NAME = "l.page:settings:shipment:image"								VALUE = "main">
		<MvASSIGN NAME = "l.page:settings:shipment:constrain"							VALUE = "B">
		<MvASSIGN NAME = "l.page:settings:shipment:b_width"								VALUE = 63>
		<MvASSIGN NAME = "l.page:settings:shipment:b_height"							VALUE = 63>
	</MvIF>

	<MvIF EXPR = "{ l.email:on_sub_chg OR l.email:on_sub_can }">
		<MvASSIGN NAME = "l.page:settings:toe_subscription_fields:lineitemprice"		VALUE = "base">
		<MvASSIGN NAME = "l.page:settings:toe_subscription_fields:advanced"				VALUE = 0>
		<MvASSIGN NAME = "l.page:settings:toe_subscription_fields:fields_custom"		VALUE = "">
		<MvASSIGN NAME = "l.page:settings:toe_subscription_fields:imagetypes"			VALUE = "">
		<MvASSIGN NAME = "l.page:settings:toe_subscription_fields:imagetypes" INDEX = 1	VALUE = "main">
		<MvASSIGN NAME = "l.page:settings:toe_subscription_fields:image"				VALUE = "main">
		<MvASSIGN NAME = "l.page:settings:toe_subscription_fields:constrain"			VALUE = "B">
		<MvASSIGN NAME = "l.page:settings:toe_subscription_fields:b_width"				VALUE = 200>
		<MvASSIGN NAME = "l.page:settings:toe_subscription_fields:b_height"				VALUE = 200>
		<MvASSIGN NAME = "l.page:settings:toe_subscription_fields:lineitemdiscounts"	VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ l.email:on_sub_crt OR l.email:on_athfail:subscription OR l.email:on_sub_oos }">
		<MvASSIGN NAME = "l.page:settings:toe_subscriptions:lineitemprice"				VALUE = "base">
		<MvASSIGN NAME = "l.page:settings:toe_subscriptions:advanced"					VALUE = 0>
		<MvASSIGN NAME = "l.page:settings:toe_subscriptions:fields_custom"				VALUE = "">
		<MvASSIGN NAME = "l.page:settings:toe_subscriptions:imagetypes"					VALUE = "">
		<MvASSIGN NAME = "l.page:settings:toe_subscriptions:imagetypes"	INDEX = 1		VALUE = "main">
		<MvASSIGN NAME = "l.page:settings:toe_subscriptions:image"						VALUE = "main">
		<MvASSIGN NAME = "l.page:settings:toe_subscriptions:constrain"					VALUE = "B">
		<MvASSIGN NAME = "l.page:settings:toe_subscriptions:b_width"					VALUE = 200>
		<MvASSIGN NAME = "l.page:settings:toe_subscriptions:b_height"					VALUE = 200>
		<MvASSIGN NAME = "l.page:settings:toe_subscriptions:lineitemdiscounts"			VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_Page_LowLevel( l.page, l.template_data ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.null"		VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'store' ) }">
	<MvASSIGN NAME = "l.null"		VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'urls' ) }">

	<MvIF EXPR = "{ l.email:on_ordr }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'order' ) }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'toe_order_contents' ) }">
	</MvIF>

	<MvIF EXPR = "{ l.email:on_bord }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'order' ) }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'backorder' ) }">
	</MvIF>

	<MvIF EXPR = "{ l.email:on_retc OR l.email:on_retr }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'order' ) }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'return' ) }">
	</MvIF>

	<MvIF EXPR = "{ l.email:on_shpc OR l.email:on_shps }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'order' ) }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'shipment' ) }">
	</MvIF>

	<MvIF EXPR = "{ l.email:on_abandon }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'toe_basket_contents' ) }">
	</MvIF>

	<MvIF EXPR = "{ l.email:on_gftcert }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'order' ) }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'toe_giftcertificates' ) }">
	</MvIF>

	<MvIF EXPR = "{ l.email:on_digital }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'order' ) }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'toe_digitaldownloads' ) }">
	</MvIF>

	<MvIF EXPR = "{ l.email:on_sub_chg OR l.email:on_sub_can }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'toe_subscription_fields' ) }">
	</MvIF>

	<MvIF EXPR = "{ l.email:on_sub_crt OR l.email:on_athfail:subscription OR l.email:on_sub_oos }">
		<MvASSIGN NAME = "l.null"	VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Page_Assign_Item( l.page, 'toe_subscriptions' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Page_Replace_Settings( l.page ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmail_Insert_LowLevel( l.email ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Set_Originals" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.Session:cache:templateorderemails:originals:customer" 					VALUE = "{ g.Customer }">
	<MvASSIGN NAME = "g.Session:cache:templateorderemails:originals:store_module_currency"		VALUE = "{ g.Store_Module_Currency }">
	<MvASSIGN NAME = "g.Session:cache:templateorderemails:originals:store_module_tax"			VALUE = "{ g.Store_Module_Tax }">
	<MvASSIGN NAME = "g.Session:cache:templateorderemails:originals:store_module_ui"			VALUE = "{ g.Store_Module_UI }">
	<MvASSIGN NAME = "g.Session:cache:templateorderemails:originals:basehref"					VALUE = "{ g.basehref }">
	<MvASSIGN NAME = "g.Session:cache:templateorderemails:originals:sessionurl"					VALUE = "{ g.sessionurl }">
	<MvASSIGN NAME = "g.Session:cache:templateorderemails:originals:secure_sessionurl"			VALUE = "{ g.secure_sessionurl }">
	<MvASSIGN NAME = "g.Session:cache:templateorderemails:originals:sessionurl_nosep"			VALUE = "{ g.sessionurl_nosep }">
	<MvASSIGN NAME = "g.Session:cache:templateorderemails:originals:secure_sessionurl_nosep"	VALUE = "{ g.secure_sessionurl_nosep }">
	<MvASSIGN NAME = "g.Session:cache:templateorderemails:originals:domain_mm_params"			VALUE = "{ g.Domain:mm_params }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Reset_Originals" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.Customer" 						VALUE = "{ g.Session:cache:templateorderemails:originals:customer }">
	<MvASSIGN NAME = "g.Store_Module_Currency"			VALUE = "{ g.Session:cache:templateorderemails:originals:store_module_currency }">
	<MvASSIGN NAME = "g.Store_Module_Tax"				VALUE = "{ g.Session:cache:templateorderemails:originals:store_module_tax }">
	<MvASSIGN NAME = "g.Store_Module_UI"				VALUE = "{ g.Session:cache:templateorderemails:originals:store_module_ui }">
	<MvASSIGN NAME = "g.basehref"						VALUE = "{ g.Session:cache:templateorderemails:originals:basehref }">
	<MvASSIGN NAME = "g.sessionurl"						VALUE = "{ g.Session:cache:templateorderemails:originals:sessionurl }">
	<MvASSIGN NAME = "g.secure_sessionurl"				VALUE = "{ g.Session:cache:templateorderemails:originals:secure_sessionurl }">
	<MvASSIGN NAME = "g.sessionurl_nosep"				VALUE = "{ g.Session:cache:templateorderemails:originals:sessionurl_nosep }">
	<MvASSIGN NAME = "g.secure_sessionurl_nosep"		VALUE = "{ g.Session:cache:templateorderemails:originals:secure_sessionurl_nosep }">
	<MvASSIGN NAME = "g.Domain:mm_params"				VALUE = "{ g.Session:cache:templateorderemails:originals:domain_mm_params }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Group_GiftCertificates" PARAMETERS = "giftcertificates var, giftcertificate_count, grouped_giftcertificates var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.grouped_giftcertificates"		VALUE = "">
	<MvASSIGN NAME = "l.grouped_giftcertificate_count"	VALUE = 0>

	<MvFOREACH ITERATOR = "l.giftcertificate" ARRAY = "l.giftcertificates" COUNT = "{ l.giftcertificate_count }">
		<MvIF EXPR = "{ miva_array_search( l.grouped_giftcertificates, 1, l.existing_giftcertificate, 'strcasecmp( miva_array_serialize( l.existing_giftcertificate:recipients ), miva_array_serialize( l.giftcertificate:recipients ) ) EQ 0' ) }">
			<MvASSIGN NAME = "l.existing_giftcertificate:giftcertificate_count"	VALUE = "{ miva_array_insert_var( l.existing_giftcertificate:giftcertificates, l.giftcertificate, -1 ) }">
		<MvELSE>
			<MvASSIGN NAME = "l.grouped_giftcertificate"						VALUE = "">
			<MvASSIGN NAME = "l.grouped_giftcertificate:recipients"				VALUE = "{ l.giftcertificate:recipients }">
			<MvASSIGN NAME = "l.grouped_giftcertificate:giftcertificates"		VALUE = "">
			<MvASSIGN NAME = "l.grouped_giftcertificate:giftcertificate_count"	VALUE = "{ miva_array_insert_var( l.grouped_giftcertificate:giftcertificates, l.giftcertificate, -1 ) }">

			<MvASSIGN NAME = "l.grouped_giftcertificate_count"					VALUE = "{ miva_array_insert_var( l.grouped_giftcertificates, l.grouped_giftcertificate, -1 ) }">
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = "{ l.grouped_giftcertificate_count }">
</MvFUNCTION>

<MvCOMMENT>
|
| Database Functions
|
</MvCOMMENT>

<MvFUNCTION NAME = "TemplateOrderEmail_Copy_Settings" PARAMETERS = "settings var, email var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.email:enabled"		VALUE = "{ l.settings:enabled }">
	<MvASSIGN NAME = "l.email:page_code"	VALUE = "{ l.settings:page_code }">
	<MvASSIGN NAME = "l.email:name"			VALUE = "{ l.settings:name }">
	<MvASSIGN NAME = "l.email:tfn_from"		VALUE = "{ l.settings:tfn_from }">
	<MvASSIGN NAME = "l.email:tfn_rp_to"	VALUE = "{ l.settings:tfn_rp_to }">
	<MvASSIGN NAME = "l.email:tfn_to"		VALUE = "{ l.settings:tfn_to }">
	<MvASSIGN NAME = "l.email:tfn_cc"		VALUE = "{ l.settings:tfn_cc }">
	<MvASSIGN NAME = "l.email:tfn_bcc"		VALUE = "{ l.settings:tfn_bcc }">
	<MvASSIGN NAME = "l.email:tfn_subj"		VALUE = "{ l.settings:tfn_subj }">
	<MvASSIGN NAME = "l.email:tfn_mime"		VALUE = "{ l.settings:tfn_mime }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "{ l.settings:on_ordr }">
	<MvASSIGN NAME = "l.email:on_bord"		VALUE = "{ l.settings:on_bord }">
	<MvASSIGN NAME = "l.email:on_retc"		VALUE = "{ l.settings:on_retc }">
	<MvASSIGN NAME = "l.email:on_retr"		VALUE = "{ l.settings:on_retr }">
	<MvASSIGN NAME = "l.email:on_shpc"		VALUE = "{ l.settings:on_shpc }">
	<MvASSIGN NAME = "l.email:on_shps"		VALUE = "{ l.settings:on_shps }">
	<MvASSIGN NAME = "l.email:on_cust"		VALUE = "{ l.settings:on_cust }">
	<MvASSIGN NAME = "l.email:on_abandon"	VALUE = "{ l.settings:on_abandon }">
	<MvASSIGN NAME = "l.email:on_gftcert"	VALUE = "{ l.settings:on_gftcert }">
	<MvASSIGN NAME = "l.email:on_digital"	VALUE = "{ l.settings:on_digital }">
	<MvASSIGN NAME = "l.email:on_sub_crt"	VALUE = "{ l.settings:on_sub_crt }">
	<MvASSIGN NAME = "l.email:on_sub_chg"	VALUE = "{ l.settings:on_sub_chg }">
	<MvASSIGN NAME = "l.email:on_sub_can"	VALUE = "{ l.settings:on_sub_can }">
	<MvASSIGN NAME = "l.email:on_sub_pnd"	VALUE = "{ l.settings:on_sub_pnd }">
	<MvASSIGN NAME = "l.email:on_sub_oos"	VALUE = "{ l.settings:on_sub_oos }">
	<MvASSIGN NAME = "l.email:sub_days"		VALUE = "{ l.settings:sub_days }">
	<MvASSIGN NAME = "l.email:on_pc_exp"	VALUE = "{ l.settings:on_pc_exp }">
	<MvASSIGN NAME = "l.email:pc_type"		VALUE = "{ l.settings:pc_type }">
	<MvASSIGN NAME = "l.email:pc_days"		VALUE = "{ l.settings:pc_days }">
	<MvASSIGN NAME = "l.email:ab_time"		VALUE = "{ l.settings:ab_time }">
	<MvASSIGN NAME = "l.email:ab_minsub"	VALUE = "{ l.settings:ab_minsub }">
	<MvASSIGN NAME = "l.email:ab_maxsub"	VALUE = "{ l.settings:ab_maxsub }">
	<MvASSIGN NAME = "l.email:ab_kpmins"	VALUE = "{ l.settings:ab_kpmins }">
	<MvASSIGN NAME = "l.email:ab_kpalive"	VALUE = "{ l.settings:ab_kpalive }">
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "{ l.settings:on_athfail }">
	<MvASSIGN NAME = "l.email:send_b64" 	VALUE = "{ l.settings:send_b64 }">
	<MvASSIGN NAME = "l.email:vis_cust" 	VALUE = "{ l.settings:vis_cust }">
	<MvASSIGN NAME = "l.email:vis_ordr" 	VALUE = "{ l.settings:vis_ordr }">
	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "{ TemplateOrderEmails_String_To_Structure( l.settings:on_ordr ) }">
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "{ TemplateOrderEmails_String_To_Structure( l.settings:on_athfail ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Settings_Copy_TemplateOrderEmail" PARAMETERS = "email var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.settings:enabled"		VALUE = "{ l.email:enabled }">
	<MvASSIGN NAME = "l.settings:page_code"		VALUE = "{ l.email:page_code }">
	<MvASSIGN NAME = "l.settings:name"			VALUE = "{ l.email:name }">
	<MvASSIGN NAME = "l.settings:tfn_from"		VALUE = "{ l.email:tfn_from }">
	<MvASSIGN NAME = "l.settings:tfn_rp_to"		VALUE = "{ l.email:tfn_rp_to }">
	<MvASSIGN NAME = "l.settings:tfn_to"		VALUE = "{ l.email:tfn_to }">
	<MvASSIGN NAME = "l.settings:tfn_cc"		VALUE = "{ l.email:tfn_cc }">
	<MvASSIGN NAME = "l.settings:tfn_bcc"		VALUE = "{ l.email:tfn_bcc }">
	<MvASSIGN NAME = "l.settings:tfn_subj"		VALUE = "{ l.email:tfn_subj }">
	<MvASSIGN NAME = "l.settings:tfn_mime"		VALUE = "{ l.email:tfn_mime }">
	<MvASSIGN NAME = "l.settings:on_ordr"		VALUE = "{ l.email:on_ordr }">
	<MvASSIGN NAME = "l.settings:on_bord"		VALUE = "{ l.email:on_bord }">
	<MvASSIGN NAME = "l.settings:on_retc"		VALUE = "{ l.email:on_retc }">
	<MvASSIGN NAME = "l.settings:on_retr"		VALUE = "{ l.email:on_retr }">
	<MvASSIGN NAME = "l.settings:on_shpc"		VALUE = "{ l.email:on_shpc }">
	<MvASSIGN NAME = "l.settings:on_shps"		VALUE = "{ l.email:on_shps }">
	<MvASSIGN NAME = "l.settings:on_cust"		VALUE = "{ l.email:on_cust }">
	<MvASSIGN NAME = "l.settings:on_abandon"	VALUE = "{ l.email:on_abandon }">
	<MvASSIGN NAME = "l.settings:on_gftcert"	VALUE = "{ l.email:on_gftcert }">
	<MvASSIGN NAME = "l.settings:on_digital"	VALUE = "{ l.email:on_digital }">
	<MvASSIGN NAME = "l.settings:on_sub_crt"	VALUE = "{ l.email:on_sub_crt }">
	<MvASSIGN NAME = "l.settings:on_sub_chg"	VALUE = "{ l.email:on_sub_chg }">
	<MvASSIGN NAME = "l.settings:on_sub_can"	VALUE = "{ l.email:on_sub_can }">
	<MvASSIGN NAME = "l.settings:on_sub_pnd"	VALUE = "{ l.email:on_sub_pnd }">
	<MvASSIGN NAME = "l.settings:on_sub_oos"	VALUE = "{ l.email:on_sub_oos }">
	<MvASSIGN NAME = "l.settings:sub_days"		VALUE = "{ l.email:sub_days }">
	<MvASSIGN NAME = "l.settings:on_pc_exp"		VALUE = "{ l.email:on_pc_exp }">
	<MvASSIGN NAME = "l.settings:pc_type"		VALUE = "{ l.email:pc_type }">
	<MvASSIGN NAME = "l.settings:pc_days"		VALUE = "{ l.email:pc_days }">
	<MvASSIGN NAME = "l.settings:ab_time"		VALUE = "{ l.email:ab_time }">
	<MvASSIGN NAME = "l.settings:ab_minsub"		VALUE = "{ l.email:ab_minsub }">
	<MvASSIGN NAME = "l.settings:ab_maxsub"		VALUE = "{ l.email:ab_maxsub }">
	<MvASSIGN NAME = "l.settings:ab_kpmins"		VALUE = "{ l.email:ab_kpmins }">
	<MvASSIGN NAME = "l.settings:ab_kpalive"	VALUE = "{ l.email:ab_kpalive }">
	<MvASSIGN NAME = "l.settings:on_athfail"	VALUE = "{ l.email:on_athfail }">
	<MvASSIGN NAME = "l.settings:send_b64" 		VALUE = "{ l.email:send_b64 }">
	<MvASSIGN NAME = "l.settings:vis_cust" 		VALUE = "{ l.email:vis_cust }">
	<MvASSIGN NAME = "l.settings:vis_ordr" 		VALUE = "{ l.email:vis_ordr }">
	<MvASSIGN NAME = "l.settings:on_ordr"		VALUE = "{ TemplateOrderEmails_Structure_To_String( l.email:on_ordr ) }">
	<MvASSIGN NAME = "l.settings:on_athfail"	VALUE = "{ TemplateOrderEmails_Structure_To_String( l.email:on_athfail ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Defaults" PARAMETERS = "email var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.email"					VALUE = "">
	<MvASSIGN NAME = "l.email:email_cc"			VALUE = "">
	<MvASSIGN NAME = "l.email:email_bcc"		VALUE = "">
	<MvASSIGN NAME = "l.email:enabled"			VALUE = 0>
	<MvASSIGN NAME = "l.email:on_ordr"			VALUE = "">
	<MvASSIGN NAME = "l.email:on_bord"			VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retc"			VALUE = 0>
	<MvASSIGN NAME = "l.email:on_retr"			VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shpc"			VALUE = 0>
	<MvASSIGN NAME = "l.email:on_shps"			VALUE = 0>
	<MvASSIGN NAME = "l.email:on_cust" 			VALUE = 0>
	<MvASSIGN NAME = "l.email:on_abandon" 		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_gftcert" 		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_digital" 		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_crt"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_chg"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_can"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_pnd"		VALUE = 0>
	<MvASSIGN NAME = "l.email:on_sub_oos"		VALUE = 0>
	<MvASSIGN NAME = "l.email:sub_days"			VALUE = 1>
	<MvASSIGN NAME = "l.email:on_pc_exp"		VALUE = 0>
	<MvASSIGN NAME = "l.email:pc_type"			VALUE = "S">
	<MvASSIGN NAME = "l.email:pc_days"			VALUE = 30>
	<MvASSIGN NAME = "l.email:on_athfail"		VALUE = "">
	<MvASSIGN NAME = "l.email:send_b64" 		VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_cust" 		VALUE = 0>
	<MvASSIGN NAME = "l.email:vis_ordr" 		VALUE = 1>
	<MvASSIGN NAME = "l.email:ab_time" 			VALUE = 30>
	<MvASSIGN NAME = "l.email:ab_minsub" 		VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_maxsub" 		VALUE = 0>
	<MvASSIGN NAME = "l.email:ab_kpmins" 		VALUE = 2880>
	<MvASSIGN NAME = "l.email:ab_kpalive" 		VALUE = 0>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Load_Code" PARAMETERS = "code, email var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].ManagedPropertyAndVersion_Load_Code_Current( 'templateorderemail', l.code, l.managedproperty ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvEVAL EXPR = "{ TemplateOrderEmail_Copy_Settings( l.managedproperty:version:settings, l.email ) }">

	<MvASSIGN NAME = "l.email:code" VALUE = "{ l.managedproperty:code }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Load_TemplateSource" PARAMETERS = "email var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.email:email_from"		VALUE = "">
	<MvASSIGN NAME = "l.email:email_rp_to"		VALUE = "">
	<MvASSIGN NAME = "l.email:email_to"			VALUE = "">
	<MvASSIGN NAME = "l.email:email_cc"			VALUE = "">
	<MvASSIGN NAME = "l.email:email_bcc"		VALUE = "">
	<MvASSIGN NAME = "l.email:email_subj"		VALUE = "">
	<MvASSIGN NAME = "l.email:mime_type"		VALUE = "">

	<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].ManagedTemplateAndVersion_Load_Filename( l.email:tfn_from, l.template ) }">
		<MvASSIGN NAME = "l.email:email_from"	VALUE = "{ l.template:version:source }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].ManagedTemplateAndVersion_Load_Filename( l.email:tfn_rp_to, l.template ) }">
		<MvASSIGN NAME = "l.email:email_rp_to"	VALUE = "{ l.template:version:source }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].ManagedTemplateAndVersion_Load_Filename( l.email:tfn_to, l.template ) }">
		<MvASSIGN NAME = "l.email:email_to"		VALUE = "{ l.template:version:source }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].ManagedTemplateAndVersion_Load_Filename( l.email:tfn_cc, l.template ) }">
		<MvASSIGN NAME = "l.email:email_cc"	VALUE = "{ l.template:version:source }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].ManagedTemplateAndVersion_Load_Filename( l.email:tfn_bcc, l.template ) }">
		<MvASSIGN NAME = "l.email:email_bcc"	VALUE = "{ l.template:version:source }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].ManagedTemplateAndVersion_Load_Filename( l.email:tfn_subj, l.template ) }">
		<MvASSIGN NAME = "l.email:email_subj"	VALUE = "{ l.template:version:source }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].ManagedTemplateAndVersion_Load_Filename( l.email:tfn_mime, l.template ) }">
		<MvASSIGN NAME = "l.email:mime_type"	VALUE = "{ l.template:version:source }">
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailList_Load" PARAMETERS = "emails var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.emails"				VALUE = "">
	<MvASSIGN NAME = "l.email_count"		VALUE = 0>

	<MvFOREACH ITERATOR = "l.managedproperty" ARRAY = "l.managedproperties" COUNT = "{ [ g.Module_Feature_TUI_DB ].ManagedPropertyAndVersionList_Load_Type_Current( 'templateorderemail', l.managedproperties ) }">
		<MvASSIGN NAME = "l.email"			VALUE = "">

		<MvEVAL EXPR = "{ TemplateOrderEmail_Copy_Settings( l.managedproperty:version:settings, l.email ) }">

		<MvASSIGN NAME = "l.email:code"		VALUE = "{ l.managedproperty:code }">
		<MvASSIGN NAME = "l.email_count"	VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-FUF-TOE-00010', l.email_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailList_Load_Run" PARAMETERS = "run var, emails var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.emails"			VALUE = "">
	<MvASSIGN NAME = "l.email_count"	VALUE = 0>

	<MvFOREACH ITERATOR = "l.email" ARRAY = "l.all_emails" COUNT = "{ TemplateOrderEmailList_Load( l.all_emails ) }">
		<MvIF EXPR = "{ NOT l.email:enabled }">
			<MvFOREACHCONTINUE>
		</MvIF>

		<MvIF EXPR = "{ l.run:on_bord AND l.email:on_bord }">				<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_retc AND l.email:on_retc }">			<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_retr AND l.email:on_retr }">			<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_shpc AND l.email:on_shpc }">			<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_shps AND l.email:on_shps }">			<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_cust AND l.email:on_cust }">			<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_abandon AND l.email:on_abandon }">		<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_gftcert AND l.email:on_gftcert }">		<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_digital AND l.email:on_digital }">		<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_sub_crt AND l.email:on_sub_crt }">		<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_sub_chg AND l.email:on_sub_chg }">		<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_sub_can AND l.email:on_sub_can }">		<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_sub_pnd AND l.email:on_sub_pnd }">		<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_sub_oos AND l.email:on_sub_oos }">		<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSEIF EXPR = "{ l.run:on_pc_exp AND l.email:on_pc_exp }">		<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">
		<MvELSE>
			<MvIF EXPR = "{ NOT ISNULL l.run:on_ordr }">
				<MvIF EXPR = "{ miva_member_exists( l.email:on_ordr, l.run:on_ordr ) }">
					<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">

					<MvFOREACHCONTINUE>
				</MvIF>
			</MvIF>

			<MvIF EXPR = "{ NOT ISNULL l.run:on_athfail }">
				<MvIF EXPR = "{ miva_member_exists( l.email:on_athfail, l.run:on_athfail ) }">
					<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_insert_var( l.emails, l.email, -1 ) }">

					<MvFOREACHCONTINUE>
				</MvIF>
			</MvIF>
		</MvIF>
	</MvFOREACH>

	<MvASSIGN NAME = "l.email_count" VALUE = "{ miva_array_sort( l.emails, 'TemplateOrderEmailList_Load_Run_Sort_Callback', l.null ) }">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-FUF-TOE-00012', l.email_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailList_Load_Run_Sort_Callback" PARAMETERS = "left var, right var, data var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "{ strcasecmp( l.left:code, l.right:code ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailList_Load_Customer" PARAMETERS = "emails var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.all_email_count"	VALUE = "{ TemplateOrderEmailList_Load( l.all_emails ) }">
	<MvASSIGN NAME = "l.email_count"		VALUE = "{ miva_array_filter_ref( l.all_emails, 1, l.email, 'l.email:vis_cust', l.emails ) }">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-FUF-TOE-00026', l.email_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailList_Load_Order" PARAMETERS = "emails var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.all_email_count"	VALUE = "{ TemplateOrderEmailList_Load( l.all_emails ) }">
	<MvASSIGN NAME = "l.email_count"		VALUE = "{ miva_array_filter_ref( l.all_emails, 1, l.email, 'l.email:vis_ordr', l.emails ) }">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-FUF-TOE-00028', l.email_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailList_Load_Enabled_PaymentCard" PARAMETERS = "emails var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.all_email_count"	VALUE = "{ TemplateOrderEmailList_Load( l.all_emails ) }">
	<MvASSIGN NAME = "l.email_count"		VALUE = "{ miva_array_filter_ref( l.all_emails, 1, l.email, 'l.email:enabled AND l.email:on_pc_exp', l.emails ) }">
	<MvASSIGN NAME = "l.email_count"		VALUE = "{ miva_array_sort( l.emails, 'TemplateOrderEmailList_Load_Enabled_PaymentCard_Sort_Callback', l.null ) }">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-FUF-TOE-00043', l.email_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailList_Load_Enabled_PaymentCard_Sort_Callback" PARAMETERS = "left var, right var, data var" STANDARDOUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| Sort emails by pc_days ascending. Ties are broken first by prioritizing subscription cards over all cards and then by email code ascending.
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ l.left:pc_days LT l.right:pc_days }">						<MvFUNCTIONRETURN VALUE = -1>
	<MvELSEIF EXPR = "{ l.left:pc_days GT l.right:pc_days }">					<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.left:pc_type EQ 'S' AND l.right:pc_type NE 'S' }">	<MvFUNCTIONRETURN VALUE = -1>
	<MvELSEIF EXPR = "{ l.left:pc_type NE 'S' AND l.right:pc_type EQ 'S' }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ strcasecmp( l.left:code, l.right:code ) }">
	</MvIF>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailList_Load_Enabled_AbandonedBasket" PARAMETERS = "emails var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.all_email_count"	VALUE = "{ TemplateOrderEmailList_Load( l.all_emails ) }">
	<MvASSIGN NAME = "l.email_count"		VALUE = "{ miva_array_filter_ref( l.all_emails, 1, l.email, 'l.email:enabled AND l.email:on_abandon', l.emails ) }">
	<MvASSIGN NAME = "l.email_count"		VALUE = "{ miva_array_sort( l.emails, 'TemplateOrderEmailList_Load_Enabled_AbandonedBasket_Sort_Callback', l.null ) }">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-FUF-TOE-00061', l.email_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailList_Load_Enabled_AbandonedBasket_Sort_Callback" PARAMETERS = "left var, right var, data var" STANDARDOUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| Sort emails by ab_time descending. Ties are broken first by ab_minsub descending and then by email code ascending.
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ l.left:ab_time LT l.right:ab_time }">			<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.left:ab_time GT l.right:ab_time }">		<MvFUNCTIONRETURN VALUE = -1>
	<MvELSEIF EXPR = "{ l.left:ab_minsub LT l.right:ab_minsub }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ l.left:ab_minsub GT l.right:ab_minsub }">	<MvFUNCTIONRETURN VALUE = -1>
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ strcasecmp( l.left:code, l.right:code ) }">
	</MvIF>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailList_Load_Enabled_SubscriptionPending" PARAMETERS = "emails var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.all_email_count"	VALUE = "{ TemplateOrderEmailList_Load( l.all_emails ) }">
	<MvASSIGN NAME = "l.email_count"		VALUE = "{ miva_array_filter_ref( l.all_emails, 1, l.email, 'l.email:enabled AND l.email:on_sub_pnd', l.emails ) }">
	<MvASSIGN NAME = "l.email_count"		VALUE = "{ miva_array_sort( l.emails, 'TemplateOrderEmailList_Load_Enabled_SubscriptionPending_Sort_Callback', l.null ) }">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-FUF-TOE-00086', l.email_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailList_Load_Enabled_SubscriptionPending_Sort_Callback" PARAMETERS = "left var, right var, data var" STANDARDOUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| Sort emails by sub_days ascending. Ties are broken by email code ascending.
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ l.left:sub_days LT l.right:sub_days }">		<MvFUNCTIONRETURN VALUE = -1>
	<MvELSEIF EXPR = "{ l.left:sub_days GT l.right:sub_days }">	<MvFUNCTIONRETURN VALUE = 1>
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ strcasecmp( l.left:code, l.right:code ) }">
	</MvIF>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Insert_LowLevel" PARAMETERS = "email var" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ Settings_Copy_TemplateOrderEmail( l.email, l.settings ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_ManagedProperty( 'templateorderemail', l.email:code, 'notemplate', l.null, l.settings, l.managedproperty ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Update_Template" PARAMETERS = "filename, source var, managedtemplate var, previous_managedtemplateversion var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].ManagedTemplateAndVersion_Load_Filename( l.filename, l.managedtemplate ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00105', 'Template not found' ) }">
	</MvIF>

	<MvASSIGN NAME = "l.previous_managedtemplateversion" VALUE = "{ l.managedtemplate:version }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_ManagedTemplateVersion( l.managedtemplate, '', l.source, l.null, l.null_compile_error ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Update" PARAMETERS = "email var, original_email var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].ManagedPropertyAndVersion_Load_Code_Current( 'templateorderemail', l.email:code, l.managedproperty ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00106', 'Template Order Email not found' ) }">
	</MvIF>

	<MvCOMMENT>
	|
	| Update linked templates if modified
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.result"	VALUE = 1>

	<MvIF EXPR = "{ l.result AND ( strcmp( l.email:email_from, l.original_email:email_from ) NE 0 ) }">		<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmail_Update_Template( l.email:tfn_from,	l.email:email_from,		l.email_from_managedtemplate,	l.previous_email_from ) }">		</MvIF>
	<MvIF EXPR = "{ l.result AND ( strcmp( l.email:email_rp_to, l.original_email:email_rp_to ) NE 0 ) }">	<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmail_Update_Template( l.email:tfn_rp_to,	l.email:email_rp_to,	l.email_rp_to_managedtemplate,	l.previous_email_rp_to ) }">	</MvIF>
	<MvIF EXPR = "{ l.result AND ( strcmp( l.email:email_to, l.original_email:email_to ) NE 0 ) }">			<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmail_Update_Template( l.email:tfn_to,		l.email:email_to,		l.email_to_managedtemplate,		l.previous_email_to ) }">		</MvIF>
	<MvIF EXPR = "{ l.result AND ( strcmp( l.email:email_cc, l.original_email:email_cc ) NE 0 ) }">			<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmail_Update_Template( l.email:tfn_cc,		l.email:email_cc,		l.email_cc_managedtemplate,		l.previous_email_cc ) }">		</MvIF>
	<MvIF EXPR = "{ l.result AND ( strcmp( l.email:email_bcc, l.original_email:email_bcc ) NE 0 ) }">		<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmail_Update_Template( l.email:tfn_bcc,		l.email:email_bcc,		l.email_bcc_managedtemplate,	l.previous_email_bcc ) }">		</MvIF>
	<MvIF EXPR = "{ l.result AND ( strcmp( l.email:email_subj, l.original_email:email_subj ) NE 0 ) }">		<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmail_Update_Template( l.email:tfn_subj,	l.email:email_subj,		l.email_subj_managedtemplate,	l.previous_email_subj ) }">		</MvIF>
	<MvIF EXPR = "{ l.result AND ( strcmp( l.email:mime_type, l.original_email:mime_type ) NE 0 ) }">		<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmail_Update_Template( l.email:tfn_mime,	l.email:mime_type,		l.mime_type_managedtemplate,	l.previous_mime_type ) }">		</MvIF>

	<MvIF EXPR = "{ NOT l.result }">
		<MvASSIGN NAME = "l.error_code"			VALUE = "{ g.Error_Code }">
		<MvASSIGN NAME = "l.error_message"		VALUE = "{ g.Error_Message }">

		<MvIF EXPR = "{ NOT ISNULL l.previous_email_from }">	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Revert_ManagedTemplateVersion( l.email_from_managedtemplate,	l.previous_email_from,	l.null ) }">	</MvIF>
		<MvIF EXPR = "{ NOT ISNULL l.previous_email_rp_to }">	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Revert_ManagedTemplateVersion( l.email_rp_to_managedtemplate,	l.previous_email_rp_to,	l.null ) }">	</MvIF>
		<MvIF EXPR = "{ NOT ISNULL l.previous_email_to }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Revert_ManagedTemplateVersion( l.email_to_managedtemplate,	l.previous_email_to,	l.null ) }">	</MvIF>
		<MvIF EXPR = "{ NOT ISNULL l.previous_email_cc }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Revert_ManagedTemplateVersion( l.email_cc_managedtemplate,	l.previous_email_cc,	l.null ) }">	</MvIF>
		<MvIF EXPR = "{ NOT ISNULL l.previous_email_bcc }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Revert_ManagedTemplateVersion( l.email_bcc_managedtemplate,	l.previous_email_bcc,	l.null ) }">	</MvIF>
		<MvIF EXPR = "{ NOT ISNULL l.previous_email_subj }">	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Revert_ManagedTemplateVersion( l.email_subj_managedtemplate,	l.previous_email_subj,	l.null ) }">	</MvIF>
		<MvIF EXPR = "{ NOT ISNULL l.previous_mime_type }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Revert_ManagedTemplateVersion( l.mime_type_managedtemplate,	l.previous_mime_type,	l.null ) }">	</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( l.error_code, l.error_message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ Settings_Copy_TemplateOrderEmail( l.email, l.settings ) }">

	<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmail_Update_LowLevel( l.settings, l.managedproperty ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Update_Enabled" PARAMETERS = "code, enabled" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].ManagedPropertyAndVersion_Load_Code_Current( 'templateorderemail', l.code, l.managedproperty ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00107', 'Template Order Email not found' ) }">
	</MvIF>

	<MvEVAL EXPR = "{ TemplateOrderEmail_Copy_Settings( l.managedproperty:version:settings, l.email ) }">

	<MvASSIGN NAME = "l.email:enabled" VALUE = "{ l.enabled }">

	<MvEVAL EXPR = "{ Settings_Copy_TemplateOrderEmail( l.email, l.settings ) }">

	<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmail_Update_LowLevel( l.settings, l.managedproperty ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Update_LowLevel" PARAMETERS = "settings var, managedproperty var" STANDARDOUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| Do not create a new version if none of the settings have changed
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ strcmp( miva_array_serialize( l.managedproperty:version:settings ), miva_array_serialize( l.settings ) ) EQ 0 }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_ManagedPropertyVersion( l.managedproperty, l.settings ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Delete" PARAMETERS = "email var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].Page_Load_Code( l.email:page_code, l.page ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_Page( l.page ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_from ) }">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_rp_to ) }">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_to ) }">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_cc ) }">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_bcc ) }">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_subj ) }">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.email:tfn_mime ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].ManagedProperty_Load_Code( 'templateorderemail', l.email:code, l.managedproperty ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedProperty( l.managedproperty ) }">
</MvFUNCTION>

<MvCOMMENT>
|
| sNN_TemplateOrderEmailXPaymentCard
|
</MvCOMMENT>

<MvFUNCTION NAME = "TemplateOrderEmailXPaymentCard_Read" PARAMETERS = "templateorderemailxpaymentcard var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.templateorderemailxpaymentcard:custpc_id"	VALUE = "{ TemplateOrderEmailXPaymentCard.d.custpc_id }">
	<MvASSIGN NAME = "l.templateorderemailxpaymentcard:email_sent"	VALUE = "{ TemplateOrderEmailXPaymentCard.d.email_sent }">
	<MvASSIGN NAME = "l.templateorderemailxpaymentcard:pc_days"		VALUE = "{ TemplateOrderEmailXPaymentCard.d.pc_days }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailXPaymentCard_InsertOrUpdate" PARAMETERS = "templateorderemailxpaymentcard var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ TemplateOrderEmailXPaymentCard_Insert( l.templateorderemailxpaymentcard ) }">				<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_Error_IsIndexDuplicate( g.Error_Message ) }">	<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmailXPaymentCard_Update( l.templateorderemailxpaymentcard ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailXPaymentCard_Insert" PARAMETERS = "templateorderemailxpaymentcard var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXPaymentCard
			 			  ( custpc_id, email_sent, pc_days )
			 			  VALUES
			 			  ( ?, ?, ? )' }"
			 FIELDS	= "l.templateorderemailxpaymentcard:custpc_id, l.templateorderemailxpaymentcard:email_sent, l.templateorderemailxpaymentcard:pc_days">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00044', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailXPaymentCard_Update" PARAMETERS = "templateorderemailxpaymentcard var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXPaymentCard
						  SET
							email_sent	= ?,
							pc_days		= ?
						  WHERE
							custpc_id	= ?' }"
			 FIELDS	= "l.templateorderemailxpaymentcard:email_sent, l.templateorderemailxpaymentcard:pc_days,
					   l.templateorderemailxpaymentcard:custpc_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00113', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| sNN_TemplateOrderEmailXBasket
|
</MvCOMMENT>

<MvFUNCTION NAME = "TemplateOrderEmailXBasket_Read" PARAMETERS = "templateorderemailxbasket var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.templateorderemailxbasket:basket_id" 	VALUE = "{ TemplateOrderEmailXBasket.d.basket_id }">
	<MvASSIGN NAME = "l.templateorderemailxbasket:lastupdate" 	VALUE = "{ TemplateOrderEmailXBasket.d.lastupdate }">
	<MvASSIGN NAME = "l.templateorderemailxbasket:true_lu" 		VALUE = "{ TemplateOrderEmailXBasket.d.true_lu }">
	<MvASSIGN NAME = "l.templateorderemailxbasket:subtotal" 	VALUE = "{ TemplateOrderEmailXBasket.d.subtotal }">
	<MvASSIGN NAME = "l.templateorderemailxbasket:email_sent" 	VALUE = "{ TemplateOrderEmailXBasket.d.email_sent }">
	<MvASSIGN NAME = "l.templateorderemailxbasket:ab_time" 		VALUE = "{ TemplateOrderEmailXBasket.d.ab_time }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailXBasket_InsertOrUpdate" PARAMETERS = "templateorderemailxbasket var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ TemplateOrderEmailXBasket_Insert( l.templateorderemailxbasket ) }">							<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_Error_IsIndexDuplicate( g.Error_Message ) }">	<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmailXBasket_Update( l.templateorderemailxbasket ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailXBasket_Insert" PARAMETERS = "templateorderemailxbasket var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket
			 			  ( basket_id, lastupdate, true_lu, subtotal, email_sent, ab_time )
			 			  VALUES
			 			  ( ?, ?, ?, ?, ?, ? )' }"
			 FIELDS	= "l.templateorderemailxbasket:basket_id, l.templateorderemailxbasket:lastupdate, l.templateorderemailxbasket:true_lu,
					   l.templateorderemailxbasket:subtotal, l.templateorderemailxbasket:email_sent, l.templateorderemailxbasket:ab_time">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00062', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailXBasket_Update" PARAMETERS = "templateorderemailxbasket var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket
						  SET
							lastupdate	= ?,
							true_lu		= ?,
							subtotal	= ?,
							email_sent	= ?,
							ab_time		= ?
						  WHERE
							basket_id	= ?' }"
			 FIELDS	= "l.templateorderemailxbasket:lastupdate, l.templateorderemailxbasket:true_lu, l.templateorderemailxbasket:subtotal,
					   l.templateorderemailxbasket:email_sent, l.templateorderemailxbasket:ab_time,
					   l.templateorderemailxbasket:basket_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00114', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailXBasket_Update_EmailSent" PARAMETERS = "basket_id, lastupdate, email_sent, ab_time" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket
						  SET
							lastupdate	= ?,
							email_sent	= ?,
							ab_time		= ?
						  WHERE
							basket_id	= ?' }"
			 FIELDS	= "l.lastupdate, l.email_sent, l.ab_time,
					   l.basket_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00115', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| sNN_TemplateOrderEmailXSubscription
|
</MvCOMMENT>

<MvFUNCTION NAME = "TemplateOrderEmailXSubscription_Read" PARAMETERS = "templateorderemailxsubscription var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.templateorderemailxsubscription:subscrp_id"	VALUE = "{ TemplateOrderEmailXSubscription.d.subscrp_id }">
	<MvASSIGN NAME = "l.templateorderemailxsubscription:nextdate"	VALUE = "{ TemplateOrderEmailXSubscription.d.nextdate }">
	<MvASSIGN NAME = "l.templateorderemailxsubscription:email_sent"	VALUE = "{ TemplateOrderEmailXSubscription.d.email_sent }">
	<MvASSIGN NAME = "l.templateorderemailxsubscription:sub_days"	VALUE = "{ TemplateOrderEmailXSubscription.d.sub_days }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailXSubscription_InsertOrUpdate" PARAMETERS = "templateorderemailxsubscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ TemplateOrderEmailXSubscription_Insert( l.templateorderemailxsubscription ) }">				<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_Error_IsIndexDuplicate( g.Error_Message ) }">	<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmailXSubscription_Update( l.templateorderemailxsubscription ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailXSubscription_Insert" PARAMETERS = "templateorderemailxsubscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'INSERT INTO ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXSubscription
			 			  ( subscrp_id, nextdate, email_sent, sub_days )
			 			  VALUES
			 			  ( ?, ?, ?, ? )' }"
			 FIELDS	= "l.templateorderemailxsubscription:subscrp_id, l.templateorderemailxsubscription:nextdate, l.templateorderemailxsubscription:email_sent, l.templateorderemailxsubscription:sub_days">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00087', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailXSubscription_Update" PARAMETERS = "templateorderemailxsubscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME 	= "Merchant"
			 QUERY 	= "{ 'UPDATE ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXSubscription
						  SET
							nextdate	= ?,
							email_sent	= ?,
							sub_days	= ?
						  WHERE
							subscrp_id	= ?' }"
			 FIELDS	= "l.templateorderemailxsubscription:nextdate, l.templateorderemailxsubscription:email_sent, l.templateorderemailxsubscription:sub_days,
					   l.templateorderemailxsubscription:subscrp_id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00116', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| Order Item Status Change Notification Feature (not_orderitem)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Notify_OrderItem_Insert" PARAMETERS = "module var, orderitem var" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_OrderItem_Update" PARAMETERS = "module var, original_orderitem var, orderitem var" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_OrderItem_Delete" PARAMETERS = "module var, count, original_orderitems var, orderitems var" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_OrderItem_StatusChange" PARAMETERS = "module var, orderitem_count, original_orderitems var, orderitems var" STANDARDOUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| Determine which items have changed in a way we are interested in
	|
	</MvCOMMENT>	
		
	<MvASSIGN NAME = "l.backordered_items"		VALUE = "">
	<MvASSIGN NAME = "l.rma_items"				VALUE = "">
	<MvASSIGN NAME = "l.returned_items"			VALUE = "">

	<MvFOREACH ITERATOR = "l.item" ARRAY = "l.orderitems" COUNT = "{ l.orderitem_count }" INDEX = "l.orderitem_pos">
		<MvREFERENCEARRAY NAME = "l.original_item" VARIABLE = "l.original_orderitems">
			<MvDIMENSION INDEX = "{ l.orderitem_pos }">
		</MvREFERENCEARRAY>

		<MvIF EXPR = "{ l.item:shpmnt_id AND
						( l.item:shpmnt_id NE l.original_item:shpmnt_id ) }">	<MvASSIGN NAME = "l.shipment_items"		INDEX = "{ l.orderitem_pos }" VALUE = "{ l.item }">
		</MvIF>

		<MvIF EXPR = "{ l.item:status NE l.original_item:status }">
			<MvIF EXPR = "{ l.item:status EQ 400 }">							<MvASSIGN NAME = "l.backordered_items"	INDEX = "{ l.orderitem_pos }" VALUE = "{ l.item }">
			<MvELSEIF EXPR = "{ l.item:status EQ 500 }">						<MvASSIGN NAME = "l.rma_items"			INDEX = "{ l.orderitem_pos }" VALUE = "{ l.item }">
			<MvELSEIF EXPR = "{ l.item:status EQ 600 }">						<MvASSIGN NAME = "l.returned_items"		INDEX = "{ l.orderitem_pos }" VALUE = "{ l.item }">
			</MvIF>
		</MvIF>
	</MvFOREACH>

	<MvCOMMENT>
	|
	| Group the items by order so that we can eliminate any duplicate messages
	|
	</MvCOMMENT>

	<MvEVAL EXPR = "{ TemplateOrderEmails_SparseOrderArray_Add_OrderItems(						l.orders, l.backordered_items,	'backordered_orderitems' ) }">
	<MvEVAL EXPR = "{ TemplateOrderEmails_SparseOrderArray_Add_OrderShipmentsFromOrderItems(	l.orders, l.shipment_items,		'created_ordershipments' ) }">
	<MvEVAL EXPR = "{ TemplateOrderEmails_SparseOrderArray_Add_OrderReturnsFromOrderItems(		l.orders, l.rma_items,			'rma_orderreturns' ) }">
	<MvEVAL EXPR = "{ TemplateOrderEmails_SparseOrderArray_Add_OrderReturnsFromOrderItems(		l.orders, l.returned_items,		'returned_orderreturns' ) }">

	<MvFOREACH ITERATOR = "l.order" ARRAY = "l.orders" COUNT = "{ miva_array_collapse( l.orders ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Order_Load_ID( l.order:id, l.order ) OR
						NOT [ g.Module_Library_DB ].Order_Update_Status( l.order ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvASSIGN NAME = "l.run"					VALUE = "">
		<MvASSIGN NAME = "l.backordered_count"		VALUE = "{ miva_array_collapse( l.order:backordered_orderitems ) }">
		<MvASSIGN NAME = "l.created_shipment_count"	VALUE = "{ miva_array_collapse( l.order:created_ordershipments ) }">
		<MvASSIGN NAME = "l.rma_count"				VALUE = "{ miva_array_collapse( l.order:rma_orderreturns ) }">
		<MvASSIGN NAME = "l.returned_count"			VALUE = "{ miva_array_collapse( l.order:returned_orderreturns ) }">

		<MvREFERENCE NAME = "l.run:order"					VARIABLE = "l.order">
		<MvREFERENCE NAME = "l.run:backordered_orderitems"	VARIABLE = "l.order:backordered_orderitems">
		<MvREFERENCE NAME = "l.run:ordershipments"			VARIABLE = "l.order:created_ordershipments">

		<MvCOMMENT>
		|
		| If there is only a single return to deal with, we fire it
		| off with backordered items to eliminate duplicate emails.
		|
		| Otherwise, we fire off the first return with any backorders,
		| then send the other returns separately.
		|
		</MvCOMMENT>

		<MvIF EXPR = "{ l.backordered_count }">
			<MvASSIGN NAME = "l.run:on_bord"		VALUE = 1>
		</MvIF>

		<MvIF EXPR = "{ l.created_shipment_count }">
			<MvASSIGN NAME = "l.run:on_shpc"		VALUE = 1>
		</MvIF>

		<MvIF EXPR = "{ l.rma_count }">
			<MvASSIGN NAME = "l.returned_pos"		VALUE = 1>
			<MvASSIGN NAME = "l.rma_pos"			VALUE = 2>
			<MvASSIGN NAME = "l.run:on_retc"		VALUE = 1>
			<MvASSIGN NAME = "l.run:rma_id"			VALUE = "{ l.order:rma_orderreturns[ 1 ]:id }">
		<MvELSE>
			<MvASSIGN NAME = "l.rma_pos"			VALUE = 1>

			<MvIF EXPR = "{ l.returned_count EQ 0 }">
				<MvASSIGN NAME = "l.returned_pos"	VALUE = 1>
			<MvELSE>
				<MvASSIGN NAME = "l.returned_pos"	VALUE = 2>
				<MvASSIGN NAME = "l.run:on_retr"	VALUE = 1>
				<MvASSIGN NAME = "l.run:rma_id"		VALUE = "{ l.order:returned_orderreturns[ 1 ]:id }">
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmails( l.run ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvCOMMENT>
		|
		| Fire additional Return Created emails
		|
		</MvCOMMENT>

		<MvASSIGN NAME = "l.run:on_bord"			VALUE = 0>
		<MvASSIGN NAME = "l.run:on_retc"			VALUE = 1>
		<MvASSIGN NAME = "l.run:on_retr"			VALUE = 0>

		<MvWHILE EXPR = "{ l.rma_pos LE l.rma_count }">
			<MvASSIGN NAME = "l.run:rma_id"			VALUE = "{ l.order:rma_orderreturns[ l.rma_pos ]:id }">

			<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmails( l.run ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvASSIGN NAME = "l.rma_pos"			VALUE = "{ l.rma_pos + 1 }">
		</MvWHILE>

		<MvCOMMENT>
		|
		| Fire additional Return Received emails
		|
		</MvCOMMENT>

		<MvASSIGN NAME = "l.run:on_bord"			VALUE = 0>
		<MvASSIGN NAME = "l.run:on_retc"			VALUE = 0>
		<MvASSIGN NAME = "l.run:on_retr"			VALUE = 1>

		<MvWHILE EXPR = "{ l.returned_pos LE l.returned_count }">
			<MvASSIGN NAME = "l.run:rma_id"			VALUE = "{ l.order:returned_orderreturns[ l.returned_pos ]:id }">

			<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmails( l.run ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvASSIGN NAME = "l.returned_pos"		VALUE = "{ l.returned_pos + 1 }">
		</MvWHILE>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| Order Shipment Status Change Notification Feature (not_ordershpmnt)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Notify_OrderShipment_Insert" PARAMETERS = "module var, ordershipment var" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_OrderShipment_Delete" PARAMETERS = "module var, ordershipment var" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_OrderShipment_StatusChange" PARAMETERS = "module var, ordershipment_count, original_shipments var, ordershipments var" STANDARDOUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| Determine which shipments have changed in a way we are interested in
	|
	</MvCOMMENT>	
		
	<MvASSIGN NAME = "l.shipped_shipments"		VALUE = "">

	<MvFOREACH ITERATOR = "l.shipment" ARRAY = "l.ordershipments" COUNT = "{ l.ordershipment_count }" INDEX = "l.ordershipment_pos">
		<MvREFERENCEARRAY NAME = "l.original_shipment" VARIABLE = "l.original_shipments">
			<MvDIMENSION INDEX = "{ l.ordershipment_pos }">
		</MvREFERENCEARRAY>

		<MvIF EXPR = "{ l.shipment:status NE l.original_shipment:status }">
			<MvIF EXPR = "{ l.shipment:status EQ 200 }">	<MvASSIGN NAME = "l.shipped_shipments"	INDEX = "{ l.ordershipment_pos }" VALUE = "{ l.shipment }">
			</MvIF>
		</MvIF>
	</MvFOREACH>

	<MvCOMMENT>
	|
	| Group the shipments by order so that we can eliminate any duplicate messages
	|
	</MvCOMMENT>

	<MvEVAL EXPR = "{ TemplateOrderEmails_SparseOrderArray_Add_OrderShipments( l.orders, l.shipped_shipments, 'shipped_shipments' ) }">

	<MvFOREACH ITERATOR = "l.order" ARRAY = "l.orders" COUNT = "{ miva_array_collapse( l.orders ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Order_Load_ID( l.order:id, l.order ) OR
						NOT [ g.Module_Library_DB ].Order_Update_Status( l.order ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvASSIGN NAME = "l.run"				VALUE = "">
		<MvASSIGN NAME = "l.shipped_count"		VALUE = "{ miva_array_collapse( l.order:shipped_shipments ) }">

		<MvREFERENCE NAME = "l.run:order"			VARIABLE = "l.order">
		<MvREFERENCE NAME = "l.run:ordershipments"	VARIABLE = "l.order:shipped_shipments">

		<MvASSIGN NAME = "l.run:on_shps"		VALUE = 1>

		<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmails( l.run ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| Order Fulfillment Feature (fulfill)
|
</MvCOMMENT>

<MvFUNCTION NAME = "FulfillmentModule_ProcessOrder" PARAMETERS = "module var, order var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.order_source"		VALUE = "{ tolower( l.order:source ) }">

	<MvIF EXPR = "{ [ g.Module_Library_Utilities ].Value_In_List( l.order_source, 'shopper,user,subscription,shopascustomer,reviewbaskets,marketplaces_ebay,marketplaces_amazon,marketplaces_etsy,quote' ) }">
		<MvASSIGN NAME = "l.run:on_ordr"	VALUE = "{ l.order_source }">
	<MvELSE>
		<MvASSIGN NAME = "l.run:on_ordr"	VALUE = "other">
	</MvIF>

	<MvASSIGN NAME = "l.run:order"			VALUE = "{ l.order }">

	<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmails( l.run ) }">
		<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Message_Error( 'One or more notification emails could not be sent at this time: ' $ encodeentities( g.Error_Message ) ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| Module Client Side Feature (clientside)
|
</MvCOMMENT>

<MvINCLUDE FILE = "modules/fulfill/templateorderemails/combined.mv">

<MvFUNCTION NAME = "Module_Clientside" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ ( '.js' EIN g.Filename ) EQ len_var( g.Filename ) }">
		<MvEVAL EXPR = "{ [ g.Module_Clientside ].Module_Content_Type( l.module, 'text/javascript' ) }">
	</MvIF>

	<MvIF EXPR = "{ g.Filename EQ 'combined.js' }">									<MvFUNCTIONRETURN VALUE = "{ Element_TemplateOrderEmail_JavaScript_Combined( l.module ) }">
	<MvELSEIF EXPR = "{ Module_Clientside_Output_File( l.module, g.Filename ) }">	<MvFUNCTIONRETURN>
	</MvIF>

	<MvASSIGN NAME = "l.null"	VALUE = "{ miva_output_header( 'Status', '404 Not Found' ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Clientside_Output_File" PARAMETERS = "module var, filename" STANDARDOUTPUTLEVEL = "">
	<MvINCLUDE FILE = "modules/fulfill/templateorderemails/output.mv">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Clientside_File_Integrity" PARAMETERS = "module var, filename, minified" STANDARDOUTPUTLEVEL = "">
	<MvINCLUDE FILE = "modules/fulfill/templateorderemails/integrity.mv">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Clientside_Combined_Integrity" PARAMETERS = "module var, filename, minified" STANDARDOUTPUTLEVEL = "">
	<MvINCLUDE FILE = "modules/fulfill/templateorderemails/combined_integrity.mv">
</MvFUNCTION>

<MvCOMMENT>
|
| Module JSON Feature (json)
|
</MvCOMMENT>

<MvFUNCTION NAME = "JSON_TemplateOrderEmail" PARAMETERS = "email var" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	"enabled":					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:enabled ) }">,
	"code":						"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.email:code ) }">",
	"page_code":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.email:page_code ) }">",
	"name":						"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.email:name ) }">",
	"email_from":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.email:email_from ) }">",
	"email_rp_to":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.email:email_rp_to ) }">",
	"email_to":					"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.email:email_to ) }">",
	"email_cc":					"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.email:email_cc ) }">",
	"email_bcc":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.email:email_bcc ) }">",
	"email_subj":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.email:email_subj ) }">",
	"mime_type":				"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.email:mime_type ) }">",
	"on_bord":					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_bord ) }">,
	"on_retc":					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_retc ) }">,
	"on_retr":					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_retr ) }">,
	"on_shpc":					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_shpc ) }">,
	"on_shps":					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_shps ) }">,
	"on_cust":					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_cust ) }">,
	"on_abandon":				<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_abandon ) }">,
	"on_gftcert":				<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_gftcert ) }">,
	"on_digital":				<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_digital ) }">,
	"on_sub_crt":				<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_sub_crt ) }">,
	"on_sub_chg":				<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_sub_chg ) }">,
	"on_sub_can":				<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_sub_can ) }">,
	"on_sub_pnd":				<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_sub_pnd ) }">,
	"on_sub_oos":				<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_sub_oos ) }">,
	"sub_days":					<MvEVAL EXPR = "{ int( l.email:sub_days ) }">,
	"on_pc_exp":				<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:on_pc_exp ) }">,
	"pc_type":					"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.email:pc_type ) }">",
	"pc_days":					<MvEVAL EXPR = "{ int( l.email:pc_days ) }">,
	"ab_time":					<MvEVAL EXPR = "{ int( l.email:ab_time ) }">,
	"ab_minsub":				<MvEVAL EXPR = "{ l.email:ab_minsub ROUND 2 }">,
	"ab_maxsub":				<MvEVAL EXPR = "{ l.email:ab_maxsub ROUND 2 }">,
	"ab_kpmins":				<MvEVAL EXPR = "{ int( l.email:ab_kpmins ) }">,
	"ab_kpalive":				<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:ab_kpalive ) }">,
	"send_b64":					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:send_b64 ) }">,
	"vis_cust":					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:vis_cust ) }">,
	"vis_ordr":					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( l.email:vis_ordr ) }">,
	"on_ordr":
	{
		<MvFOREACH ITERATOR = "l.member" ARRAY = "l.members" INDEX = "l.pos" COUNT = "{ miva_struct_members( l.email:on_ordr, l.members ) }">
			<MvIF EXPR = "{ l.pos GT 1 }">
				,
			</MvIF>

			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.member ) }">": <MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( miva_variable_value( 'l.email:on_ordr:' $ l.member ) ) }">
		</MvFOREACH>
	},
	"on_athfail":
	{
		<MvFOREACH ITERATOR = "l.member" ARRAY = "l.members" INDEX = "l.pos" COUNT = "{ miva_struct_members( l.email:on_athfail, l.members ) }">
			<MvIF EXPR = "{ l.pos GT 1 }">
				,
			</MvIF>

			"<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Encode( l.member ) }">": <MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Boolean( miva_variable_value( 'l.email:on_athfail:' $ l.member ) ) }">
		</MvFOREACH>
	}
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_TemplateOrderEmailList_Load_Query" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ g.Session_Type NE 'admin' }">							<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'FUFL', 1, 0, 0, 0 ) }">	<MvFUNCTIONRETURN> </MvIF>

	<MvASSIGN NAME = "l.available_filters"	VALUE = "">
	<MvASSIGN NAME = "l.filter"				VALUE = "">
	<MvASSIGN NAME = "l.sort"				VALUE = "">
	<MvASSIGN NAME = "l.offset"				VALUE = 0>
	<MvASSIGN NAME = "l.count"				VALUE = 0>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'enabled',		'l.email:enabled' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_CHAR(		l.available_filters, 'code',		'l.email:code' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_CHAR(		l.available_filters, 'name',		'l.email:name' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_bord',		'l.email:on_bord' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_retc',		'l.email:on_retc' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_retr',		'l.email:on_retr' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_shpc',		'l.email:on_shpc' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_shps',		'l.email:on_shps' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_cust',		'l.email:on_cust' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_abandon',	'l.email:on_abandon' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_gftcert',	'l.email:on_gftcert' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_digital',	'l.email:on_digital' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_sub_crt',	'l.email:on_sub_crt' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_sub_chg',	'l.email:on_sub_chg' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_sub_can',	'l.email:on_sub_can' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_sub_pnd',	'l.email:on_sub_pnd' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_sub_oos',	'l.email:on_sub_oos' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_INTEGER(	l.available_filters, 'sub_days',	'l.email:sub_days' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'on_pc_exp',	'l.email:on_pc_exp' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_CHAR(		l.available_filters, 'pc_type',		'l.email:pc_type' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_INTEGER(	l.available_filters, 'pc_days',		'l.email:pc_days' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'send_b64',	'l.email:send_b64' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'vis_cust',	'l.email:vis_cust' ) }">
	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_AvailableFilter_MivaScript_BOOL(		l.available_filters, 'vis_ordr',	'l.email:vis_ordr' ) }">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Filter(	'o',		'Filter',	l.filter )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text(		'o',		'Sort',		l.sort )	OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o:nonneg', 'Offset',	l.offset )	OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(	'o',		'Count',	l.count ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvASSIGN NAME = "l.email_count"	VALUE = "{ TemplateOrderEmailList_Load( l.emails ) }">

	<MvIF EXPR = "{ l.email_count EQ 0 }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>
	</MvIF>

	<MvASSIGN NAME = "l.search_expression"		VALUE = "1 EQ 1">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Filter_MivaScript( l.search_expression, l.filter, l.available_filters ) }">

	<MvASSIGN NAME = "l.total_count"			VALUE = "{ miva_array_filter_ref( l.emails, 1, l.email, l.search_expression, l.filtered_emails ) }">
	<MvASSIGN NAME = "l.null"					VALUE = "{ miva_array_sort( l.filtered_emails, 'TemplateOrderEmailList_Sort_Callback', l.sort ) }">

	<MvASSIGN NAME = "l.output_count"			VALUE = 0>

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		"data":
		[
			<MvFOREACH ITERATOR = "l.email" ARRAY = "l.filtered_emails" FIRST = "{ l.offset + 1 }" LAST = "{ l.total_count }">
				<MvIF EXPR = "{ ( l.output_count LT l.count ) OR ( l.count EQ 0 ) }">
					<MvASSIGN NAME = "l.null" VALUE = "{ TemplateOrderEmail_Load_TemplateSource( l.email ) }">

					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_Start( l.output_count ) }">
						<MvEVAL EXPR = "{ JSON_TemplateOrderEmail( l.email ) }">
					<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_ArrayElement_End() }">
				</MvIF>
			</MvFOREACH>
		],
		"total_count": 	<MvEVAL EXPR = "{ int( l.total_count ) }">,
		"start_offset": <MvEVAL EXPR = "{ int( l.offset ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_TemplateOrderEmail_Load" PARAMETERS = "email var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Retrieve( 'Edit_Email', l.email_code ) }">
		<MvIF EXPR = "{ NOT TemplateOrderEmail_Load_Code( l.email_code, l.email ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00108', 'Email not found' ) }">
		</MvIF>
	<MvELSEIF EXPR = "{ [ g.Module_JSON ].JSON_Input_Retrieve( 'Email_Code', l.email_code ) }">
		<MvIF EXPR = "{ NOT TemplateOrderEmail_Load_Code( l.email_code, l.email ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00019', 'Email not found' ) }">
		</MvIF>
	<MvELSE>
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00101', 'Unable to load email: One of Edit_Email or Email_Code must be specified' ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmail_Load_TemplateSource( l.email ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_TemplateOrderEmail_Insert" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ g.Session_Type NE 'admin' }">							<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'FUFL', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN> </MvIF>

	<MvEVAL EXPR = "{ TemplateOrderEmail_Defaults( l.email ) }">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'Enabled',						l.email:enabled )								OR
					NOT [ g.Module_JSON ].JSON_Input_Code(			'R',		'Code', 						l.email:code )									OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'R:100',	'Name', 						l.email:name )									OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'R',		'Email_From',					l.email:email_from )							OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'R',		'Email_To',						l.email:email_to )								OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'o',		'Email_CC',						l.email:email_cc )								OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'o',		'Email_BCC',					l.email:email_bcc )								OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'o',		'Email_Reply_To',				l.email:email_rp_to )							OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'R',		'Email_Subject',				l.email:email_subj )							OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'R',		'Mime_Type',					l.email:mime_type )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Order_Backordered',			l.email:on_bord )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Return_Authorized',			l.email:on_retc )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Return_Received',			l.email:on_retr )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Shipment_Created',			l.email:on_shpc )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Shipment_Shipped',			l.email:on_shps )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Customer_Created',			l.email:on_cust )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_AbandonedBasket',			l.email:on_abandon )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_GiftCertificate_Created',	l.email:on_gftcert )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_DigitalDownload_Created',	l.email:on_digital )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Subscription_Created',		l.email:on_sub_crt )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Subscription_Changed',		l.email:on_sub_chg )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Subscription_Cancelled',	l.email:on_sub_can )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Subscription_Pending',		l.email:on_sub_pnd )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Subscription_OutOfStock',	l.email:on_sub_oos )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_PaymentCard_Expired',		l.email:on_pc_exp )								OR
					NOT [ g.Module_JSON ].JSON_Input_Text_Array(	'o', 		'On_AuthFail_Sources',			l.authfail_sources, l.authfail_source_count )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text_Array(	'o', 		'On_Order_Sources',				l.order_sources, l.order_source_count )			OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(		'O',		'Subscription_Days',			l.email:sub_days )								OR
					NOT [ g.Module_JSON ].JSON_Input_List(			'O',		'PaymentCard_Type',				l.email:pc_type, 'A,S', 'A,S' )					OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(		'O',		'PaymentCard_Days',				l.email:pc_days )								OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(		'O:nonneg',	'Abandoned_Time',				l.email:ab_time )								OR
					NOT [ g.Module_JSON ].JSON_Input_Number(		'O:nonneg',	'Abandoned_MinSubtotal',		l.email:ab_minsub, 10, 2 )						OR
					NOT [ g.Module_JSON ].JSON_Input_Number(		'O:nonneg',	'Abandoned_MaxSubtotal',		l.email:ab_maxsub, 10, 2 )						OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(		'O:nonneg',	'Abandoned_AliveMins',			l.email:ab_kpmins )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'Abandoned_KeepAlive',			l.email:ab_kpalive )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'Send_Base64_Encoded',			l.email:send_b64 )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'Visible_For_Customers',		l.email:vis_cust )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'Visible_For_Orders',			l.email:vis_ordr ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ TemplateOrderEmail_Load_Code( l.email:code, l.null ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Code', 'An email with the code \'' $ l.email:code $ '\' already exists' ) }">
	</MvIF>

	<MvIF EXPR = "{ l.email:ab_minsub GT l.email:ab_maxsub AND l.email:ab_maxsub NE 0 }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Abandoned_MinSubtotal', 'Abandoned basket subtotal range minimum cannot be greater than the maximum' ) }">
	</MvIF>

	<MvFOREACH ITERATOR = "l.order_source" ARRAY = "l.order_sources" COUNT = "{ l.order_source_count }">
		<MvIF EXPR = "{ TemplateOrderEmails_Validate_AlphaUnderscore( l.order_source ) }">
			<MvASSIGN NAME = "l.new_order_sources" MEMBER = "{ tolower( l.order_source ) }" VALUE = 1>
		</MvIF>
	</MvFOREACH>

	<MvFOREACH ITERATOR = "l.authfail_source" ARRAY = "l.authfail_sources" COUNT = "{ l.authfail_source_count }">
		<MvIF EXPR = "{ TemplateOrderEmails_Validate_AlphaUnderscore( l.authfail_source ) }">
			<MvASSIGN NAME = "l.new_authfail_sources" MEMBER = "{ tolower( l.authfail_source ) }" VALUE = 1>
		</MvIF>
	</MvFOREACH>

	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "{ l.new_order_sources }">
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "{ l.new_authfail_sources }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_Begin( 'Template Based Email \'' $ l.email:code $ '\' Created' ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT TemplateOrderEmails_Create_Email( l.module, l.email ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_End() }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-FUF-TOE-00094', 'Template Based Email \'' $ l.email:code $ '\' created' ) }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		<MvEVAL EXPR = "{ JSON_TemplateOrderEmail( l.email ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_TemplateOrderEmail_Update" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ g.Session_Type NE 'admin' }">							<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN> </MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'FUFL', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN> </MvIF>

	<MvIF EXPR = "{ NOT JSON_TemplateOrderEmail_Load( l.email ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Page_Load_Code( l.email:page_code, l.page ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( 'MER-FUF-TOE-00020', 'Page \'' $ l.email:page_code $ '\' not found' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT TemplateOrderEmail_Load_TemplateSource( l.email ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.original_email" VALUE = "{ l.email }">

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'Enabled',						l.email:enabled )								OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'O:100',	'Name', 						l.email:name )									OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'O',		'Email_From',					l.email:email_from )							OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'O',		'Email_To',						l.email:email_to )								OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'o',		'Email_CC',						l.email:email_cc )								OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'o',		'Email_BCC',					l.email:email_bcc )								OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'o',		'Email_Reply_To',				l.email:email_rp_to )							OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'O',		'Email_Subject',				l.email:email_subj )							OR
					NOT [ g.Module_JSON ].JSON_Input_Text(			'O',		'Mime_Type',					l.email:mime_type )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Order_Backordered',			l.email:on_bord )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Return_Authorized',			l.email:on_retc )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Return_Received',			l.email:on_retr )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Shipment_Created',			l.email:on_shpc )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Shipment_Shipped',			l.email:on_shps )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Customer_Created',			l.email:on_cust )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_AbandonedBasket',			l.email:on_abandon )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_GiftCertificate_Created',	l.email:on_gftcert )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_DigitalDownload_Created',	l.email:on_digital )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Subscription_Created',		l.email:on_sub_crt )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Subscription_Changed',		l.email:on_sub_chg )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Subscription_Cancelled',	l.email:on_sub_can )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Subscription_Pending',		l.email:on_sub_pnd )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_Subscription_OutOfStock',	l.email:on_sub_oos )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'On_PaymentCard_Expired',		l.email:on_pc_exp )								OR
					NOT [ g.Module_JSON ].JSON_Input_Text_Array(	'o', 		'On_AuthFail_Sources',			l.authfail_sources, l.authfail_source_count )	OR
					NOT [ g.Module_JSON ].JSON_Input_Text_Array(	'o', 		'On_Order_Sources',				l.order_sources, l.order_source_count )			OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(		'O',		'Subscription_Days',			l.email:sub_days )								OR
					NOT [ g.Module_JSON ].JSON_Input_List(			'O',		'PaymentCard_Type',				l.email:pc_type, 'A,S', 'A,S' )					OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(		'O',		'PaymentCard_Days',				l.email:pc_days )								OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(		'O:nonneg',	'Abandoned_Time',				l.email:ab_time )								OR
					NOT [ g.Module_JSON ].JSON_Input_Number(		'O:nonneg',	'Abandoned_MinSubtotal',		l.email:ab_minsub, 10, 2 )						OR
					NOT [ g.Module_JSON ].JSON_Input_Number(		'O:nonneg',	'Abandoned_MaxSubtotal',		l.email:ab_maxsub, 10, 2 )						OR
					NOT [ g.Module_JSON ].JSON_Input_Integer(		'O:nonneg',	'Abandoned_AliveMins',			l.email:ab_kpmins )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'Abandoned_KeepAlive',			l.email:ab_kpalive )							OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'Send_Base64_Encoded',			l.email:send_b64 )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'Visible_For_Customers',		l.email:vis_cust )								OR
					NOT [ g.Module_JSON ].JSON_Input_Boolean(		'O',		'Visible_For_Orders',			l.email:vis_ordr ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ l.email:ab_minsub GT l.email:ab_maxsub AND l.email:ab_maxsub NE 0 }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_FieldError( 'Abandoned_MinSubtotal', 'Abandoned basket subtotal range minimum cannot be greater than the maximum' ) }">
	</MvIF>

	<MvFOREACH ITERATOR = "l.order_source" ARRAY = "l.order_sources" COUNT = "{ l.order_source_count }">
		<MvIF EXPR = "{ TemplateOrderEmails_Validate_AlphaUnderscore( l.order_source ) }">
			<MvASSIGN NAME = "l.new_order_sources" MEMBER = "{ tolower( l.order_source ) }" VALUE = 1>
		</MvIF>
	</MvFOREACH>

	<MvFOREACH ITERATOR = "l.authfail_source" ARRAY = "l.authfail_sources" COUNT = "{ l.authfail_source_count }">
		<MvIF EXPR = "{ TemplateOrderEmails_Validate_AlphaUnderscore( l.authfail_source ) }">
			<MvASSIGN NAME = "l.new_authfail_sources" MEMBER = "{ tolower( l.authfail_source ) }" VALUE = 1>
		</MvIF>
	</MvFOREACH>

	<MvASSIGN NAME = "l.email:on_ordr"		VALUE = "{ l.new_order_sources }">
	<MvASSIGN NAME = "l.email:on_athfail"	VALUE = "{ l.new_authfail_sources }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_Begin( 'Template Based Email \'' $ l.email:code $ '\' Updated' ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT TemplateOrderEmail_Update( l.email, l.original_email ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvASSIGN NAME = "l.page:name" VALUE = "{ l.email:name }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Page_Update_LowLevel( l.page ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_End() }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>
	
	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-FUF-TOE-00095', 'Template Based Email \'' $ l.email:code $ '\' updated' ) }">

	<MvEVAL EXPR = "{ [ g.Module_JSON ].JSON_Response_Start() }">
	{
		<MvEVAL EXPR = "{ JSON_TemplateOrderEmail( l.email ) }">
	}
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_End() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_TemplateOrderEmail_Delete" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.Session_Type NE 'admin' }">							<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'FUFL', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN>	</MvIF>

	<MvIF EXPR = "{ NOT JSON_TemplateOrderEmail_Load( l.email ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_Begin( 'Template Based Email \'' $ l.email:code $ '\' Deleted' ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT TemplateOrderEmail_Delete( l.email ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_End() }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-FUF-TOE-00096', 'Template Based Email \'' $ l.email:code $ '\' deleted' ) }">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvFUNCTION NAME = "JSON_TemplateOrderEmail_Update_Enabled" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.Session_Type NE 'admin' }">							<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Store_Open() }">				<MvFUNCTIONRETURN>	</MvIF>
	<MvIF EXPR = "{ NOT [ g.Module_Admin ].CanI( 'FUFL', 0, 0, 1, 0 ) }">	<MvFUNCTIONRETURN>	</MvIF>

	<MvIF EXPR = "{ NOT JSON_TemplateOrderEmail_Load( l.email ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_JSON ].JSON_Input_Boolean( 'R', 'Enabled', l.enabled ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_InputErrors() }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_Begin( 'Template Based Email \'' $ l.email:code $ '\' ' $ ternary( l.enabled, 'Enabled', 'Disabled' ) ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT TemplateOrderEmail_Update_Enabled( l.email:code, l.enabled ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_End() }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Error( g.Error_Code, g.Error_Message ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-FUF-TOE-00097', 'Template Based Email \'' $ l.email:code $ '\' ' $ ternary( l.enabled, 'enabled', 'disabled' ) ) }">

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_JSON ].JSON_Response_Success() }">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_JSON" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.Module_Function EQ 'TemplateOrderEmailList_Load_Query' }">			<MvFUNCTIONRETURN VALUE = "{ JSON_TemplateOrderEmailList_Load_Query( l.module ) }">
	<MvELSEIF EXPR = "{ g.Module_Function EQ 'TemplateOrderEmail_Insert' }">				<MvFUNCTIONRETURN VALUE = "{ JSON_TemplateOrderEmail_Insert( l.module ) }">
	<MvELSEIF EXPR = "{ g.Module_Function EQ 'TemplateOrderEmail_Update' }">				<MvFUNCTIONRETURN VALUE = "{ JSON_TemplateOrderEmail_Update( l.module ) }">
	<MvELSEIF EXPR = "{ g.Module_Function EQ 'TemplateOrderEmail_Delete' }">				<MvFUNCTIONRETURN VALUE = "{ JSON_TemplateOrderEmail_Delete( l.module ) }">
	<MvELSEIF EXPR = "{ g.Module_Function EQ 'TemplateOrderEmail_Update_Enabled' }">		<MvFUNCTIONRETURN VALUE = "{ JSON_TemplateOrderEmail_Update_Enabled( l.module ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| Module Provisioning Feature (provision_store)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Provision_Store" PARAMETERS = "module var, provide_xml var" STANDARDOUTPUTLEVEL = "">
	<MvFOREACH ITERATOR = "l.child_xml" ARRAY = "l.provide_xml:children">
		<MvASSIGN NAME = "l.name"		VALUE = "{ tolower( l.child_xml:name ) }">

		<MvIF EXPR = "{ l.name EQ 'email_add' }">			<MvEVAL EXPR = "{ Module_Provision_Store_Email_Add( l.module, l.child_xml ) }">
		<MvELSEIF EXPR = "{ l.name EQ 'email_update' }">	<MvEVAL EXPR = "{ Module_Provision_Store_Email_Update( l.module, l.child_xml ) }">
		<MvELSEIF EXPR = "{ l.name EQ 'email_delete' }">	<MvEVAL EXPR = "{ Module_Provision_Store_Email_Delete( l.module, l.child_xml ) }">
		</MvIF>
	</MvFOREACH>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Provision_Store_Email_Add" PARAMETERS = "module var, provide_xml var" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ TemplateOrderEmail_Defaults( l.email ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Code(		'R',		l.provide_xml, 'Code',							l.email:code )				OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'R',		l.provide_xml, 'Name',							l.email:name )				OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'R',		l.provide_xml, 'From',							l.email:email_from )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'R',		l.provide_xml, 'To',							l.email:email_to )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'o',		l.provide_xml, 'CC',							l.email:email_cc )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'o',		l.provide_xml, 'BCC',							l.email:email_bcc )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'o',		l.provide_xml, 'ReplyTo',						l.email:email_rp_to )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'R',		l.provide_xml, 'Subject',						l.email:email_subj )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'R',		l.provide_xml, 'MimeType',						l.email:mime_type )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'Enabled',						l.email:enabled )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnOrderBackordered',		l.email:on_bord )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnReturnAuthorized',		l.email:on_retc )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnReturnReceived',			l.email:on_retr )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnShipmentCreated',			l.email:on_shpc )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnShipmentShipped',			l.email:on_shps )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnCustomerCreated',			l.email:on_cust )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnAbandonedBasket',			l.email:on_abandon )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnGiftCertificateCreated',	l.email:on_gftcert )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnDigitalDownloadCreated',	l.email:on_digital )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnSubscriptionCreated',		l.email:on_sub_crt )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnSubscriptionChanged',		l.email:on_sub_chg )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnSubscriptionCancelled',	l.email:on_sub_can )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnSubscriptionPending',		l.email:on_sub_pnd )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnSubscriptionOutOfStock',	l.email:on_sub_oos )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Integer(	'o',		l.provide_xml, 'SubscriptionDays',				l.email:sub_days )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnPaymentCardExpired',		l.email:on_pc_exp )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_List( 		'o',		l.provide_xml, 'PaymentCardType',				l.email:pc_type,
																								   'All,SubscriptionOnly',			'A,S' )						OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Integer(	'o',		l.provide_xml, 'PaymentCardDays',				l.email:pc_days )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Integer( 	'o:nonneg',	l.provide_xml, 'Abandoned_Time', 				l.email:ab_time )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Number( 	'o:nonneg',	l.provide_xml, 'Abandoned_MaxSubtotal', 		l.email:ab_maxsub, 10, 2 )	OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Number( 	'o:nonneg',	l.provide_xml, 'Abandoned_MinSubtotal', 		l.email:ab_minsub, 10, 2 )	OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Integer( 	'o:nonneg',	l.provide_xml, 'Abandoned_AliveMins', 			l.email:ab_kpmins )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean( 	'o',		l.provide_xml, 'Abandoned_KeepAlive', 			l.email:ab_kpalive )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendBase64Encoded',				l.email:send_b64 )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'VisibleForCustomers',			l.email:vis_cust )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'VisibleForOrders',				l.email:vis_ordr ) }">
		<MvFUNCTIONRETURN>
	</MvIF>

	<MvIF EXPR = "{ TemplateOrderEmail_Load_Code( l.email:code, l.existing_email ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogMessage( l.provide_xml, 'An email with the code \'' $ l.email:code $ '\' already exists' ) }">
	</MvIF>

	<MvIF EXPR = "{ l.email:ab_minsub GT l.email:ab_maxsub AND l.email:ab_maxsub NE 0 }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogMessage( l.provide_xml, 'Abandoned basket subtotal range minimum cannot be greater than the maximum' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT Module_Provision_Store_Email_Build_Sources( l.provide_xml, 'SendOnOrderPlaced', l.email:on_ordr ) }">
		<MvFUNCTIONRETURN>
	</MvIF>

	<MvIF EXPR = "{ NOT Module_Provision_Store_Email_Build_Sources( l.provide_xml, 'SendOnAuthorizationFailure', l.email:on_athfail ) }">
		<MvFUNCTIONRETURN>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_PRV_AD ].PRV_Tag_Exists( l.provide_xml, 'Template' ) }">
		<MvASSIGN NAME = "l.template_source"	VALUE = "{ trim( l.provide_xml:tags:Template[ 1 ]:value ) }">
	<MvELSE>
		<MvASSIGN NAME = "l.template_source"	VALUE = ""> 
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_Active() }">
		<MvASSIGN NAME = "l.end_changeset"		VALUE = 0>
	<MvELSE>
		<MvASSIGN NAME = "l.end_changeset"		VALUE = 1>

		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_Begin( 'Quote Email \'' $ l.email:code $ '\' Created' ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
		</MvIF>
	</MvIF>

	<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmails_Create_Email_FromVariable( l.module, l.email, l.template_source ) }">

	<MvIF EXPR = "{ l.end_changeset }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_End() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT l.result }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-FUF-TOE-00109', 'Template Based Email \'' $ l.email:code $ '\' created' ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Provision_Store_Email_Update" PARAMETERS = "module var, provide_xml var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_PRV_AD ].PRV_Attribute_Text( l.provide_xml, 'email_code', l.email_code ) }">
		<MvFUNCTIONRETURN>
	</MvIF>

	<MvIF EXPR = "{ NOT TemplateOrderEmail_Load_Code( l.email_code, l.email ) }">
		<MvIF EXPR = "{ [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogMessage( l.provide_xml, 'Email \'' $ l.email_code $ '\' not found' ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT TemplateOrderEmail_Load_TemplateSource( l.email ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
	</MvIF>

	<MvASSIGN NAME = "l.original_email" VALUE = "{ l.email }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Page_Load_Code( l.email:page_code, l.page ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogMessage( l.provide_xml, 'Page \'' $ l.email:page_code $ '\' not found' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'O',		l.provide_xml, 'Name',							l.email:name )				OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'O',		l.provide_xml, 'From',							l.email:email_from )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'O',		l.provide_xml, 'To',							l.email:email_to )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'o',		l.provide_xml, 'CC',							l.email:email_cc )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'o',		l.provide_xml, 'BCC',							l.email:email_bcc )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'o',		l.provide_xml, 'ReplyTo',						l.email:email_rp_to )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'O',		l.provide_xml, 'Subject',						l.email:email_subj )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'O',		l.provide_xml, 'MimeType',						l.email:mime_type )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'Enabled',						l.email:enabled )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnOrderBackordered',		l.email:on_bord )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnReturnAuthorized',		l.email:on_retc )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnReturnReceived',			l.email:on_retr )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnShipmentCreated',			l.email:on_shpc )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnShipmentShipped',			l.email:on_shps )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnCustomerCreated',			l.email:on_cust )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnAbandonedBasket',			l.email:on_abandon )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnGiftCertificateCreated',	l.email:on_gftcert )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnDigitalDownloadCreated',	l.email:on_digital )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnSubscriptionCreated',		l.email:on_sub_crt )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnSubscriptionChanged',		l.email:on_sub_chg )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnSubscriptionCancelled',	l.email:on_sub_can )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnSubscriptionPending',		l.email:on_sub_pnd )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnSubscriptionOutOfStock',	l.email:on_sub_oos )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Integer(	'o',		l.provide_xml, 'SubscriptionDays',				l.email:sub_days )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendOnPaymentCardExpired',		l.email:on_pc_exp )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_List( 		'o',		l.provide_xml, 'PaymentCardType',				l.email:pc_type,
																								   'All,SubscriptionOnly',			'A,S' )						OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Integer(	'o',		l.provide_xml, 'PaymentCardDays',				l.email:pc_days )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Integer(	'o:nonneg',	l.provide_xml, 'Abandoned_Time', 				l.email:ab_time )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Number( 	'o:nonneg',	l.provide_xml, 'Abandoned_MaxSubtotal', 		l.email:ab_maxsub, 10, 2 )	OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Number( 	'o:nonneg',	l.provide_xml, 'Abandoned_MinSubtotal', 		l.email:ab_minsub, 10, 2 )	OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Integer(	'o:nonneg',	l.provide_xml, 'Abandoned_AliveMins', 			l.email:ab_kpmins )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean( 	'o',		l.provide_xml, 'Abandoned_KeepAlive', 			l.email:ab_kpalive )		OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'SendBase64Encoded',				l.email:send_b64 )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'VisibleForCustomers',			l.email:vis_cust )			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o',		l.provide_xml, 'VisibleForOrders',				l.email:vis_ordr ) }">
		<MvFUNCTIONRETURN>
	</MvIF>

	<MvIF EXPR = "{ l.email:ab_minsub GT l.email:ab_maxsub AND l.email:ab_maxsub NE 0 }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogMessage( l.provide_xml, 'Abandoned basket subtotal range minimum cannot be greater than the maximum' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT Module_Provision_Store_Email_Build_Sources( l.provide_xml, 'SendOnOrderPlaced', l.email:on_ordr ) }">
		<MvFUNCTIONRETURN>
	</MvIF>

	<MvIF EXPR = "{ NOT Module_Provision_Store_Email_Build_Sources( l.provide_xml, 'SendOnAuthorizationFailure', l.email:on_athfail ) }">
		<MvFUNCTIONRETURN>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_Active() }">
		<MvASSIGN NAME = "l.end_changeset"	VALUE = 0>
	<MvELSE>
		<MvASSIGN NAME = "l.end_changeset"	VALUE = 1>

		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_Begin( 'Quote Email \'' $ l.email:code $ '\' Updated' ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
		</MvIF>
	</MvIF>

	<MvASSIGN NAME = "l.result"				VALUE = "{ TemplateOrderEmail_Update( l.email, l.original_email ) }">

	<MvIF EXPR = "{ l.result }">
		<MvASSIGN NAME = "l.page:name"		VALUE = "{ l.email:name }">
		<MvASSIGN NAME = "l.result"			VALUE = "{ [ g.Module_Feature_TUI_DB ].Page_Update_LowLevel( l.page ) }">
	</MvIF>

	<MvIF EXPR = "{ l.end_changeset }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_End() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT l.result }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-FUF-TOE-00110', 'Template Based Email \'' $ l.email:code $ '\' updated' ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Provision_Store_Email_Delete" PARAMETERS = "module var, provide_xml var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_PRV_AD ].PRV_Attribute_Text( l.provide_xml, 'email_code', l.email_code ) }">
		<MvFUNCTIONRETURN>
	</MvIF>

	<MvIF EXPR = "{ NOT TemplateOrderEmail_Load_Code( l.email_code, l.email ) }">
		<MvIF EXPR = "{ [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogMessage( l.provide_xml, 'Email \'' $ l.email_code $ '\' not found' ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_Active() }">
		<MvASSIGN NAME = "l.end_changeset"	VALUE = 0>
	<MvELSE>
		<MvASSIGN NAME = "l.end_changeset"	VALUE = 1>

		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_Begin( 'Template Based Email \'' $ l.email:code $ '\' Deleted' ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
		</MvIF>
	</MvIF>

	<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmail_Delete( l.email ) }">

	<MvIF EXPR = "{ l.end_changeset }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Changeset_End() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT l.result }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-FUF-TOE-00111', 'Template Based Email \'' $ l.email:code $ '\' deleted' ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Provision_Store_Email_Build_Sources" PARAMETERS = "provide_xml var, tag, output var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ [ g.Module_Feature_PRV_AD ].PRV_Tag_Exists( l.provide_xml, l.tag ) }">
		<MvASSIGN NAME = "l.output" VALUE = "">

		<MvREFERENCE NAME = "l.tag_value" VARIABLE = "{ 'l.provide_xml:tags:' $ l.tag $ '[ 1 ]:value' }">

		<MvFOREACH ITERATOR = "l.value" ARRAY = "l.values" COUNT = "{ miva_splitstring( l.tag_value, ',', l.values, 'trim,lower' ) }">
			<MvIF EXPR = "{ NOT TemplateOrderEmails_Validate_AlphaUnderscore( l.value ) }">
				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogMessage( l.provide_xml, 'Invalid value for ' $ l.tag $ ': \'' $ l.value $ '\' may only contain alpha characters and underscores.' ) }">
			</MvIF>

			<MvASSIGN NAME = "l.output" MEMBER = "{ l.value }" VALUE = 1>
		</MvFOREACH>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| Helper Functions
|
</MvCOMMENT>

<MvFUNCTION NAME = "TemplateOrderEmail_Branch_Warning_CSS" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<style type="text/css">
		.templateorderemails_nonprimary_branch_warning
		{
			position: relative;
			display: flex;
			align-items: flex-start;
		}

		.templateorderemails_nonprimary_branch_warning_icon
		{
			position: relative;
			display: inline-block;
			margin-right: 15px;
			width: 50px;
			height: 50px;
			font-size: 50px;
			line-height: 0;
			color: #969da8;
			flex-shrink: 0;
		}

		.templateorderemails_nonprimary_branch_warning_message
		{
			position: relative;
			display: inline-block;
			flex-grow: 1;
		}

		.templateorderemails_nonprimary_branch_warning_branch_color
		{
			position: relative;
			display: inline-block;
			vertical-align: text-bottom;
			width: 12px;
			height: 12px;
			border-radius: 4px;
		}
	</style>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmail_Branch_Warning_HTML" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Working_Branch_Is_Primary() }">
		<tr>
			<td colspan="2">
				<span class="templateorderemails_nonprimary_branch_warning">
					<span class="templateorderemails_nonprimary_branch_warning_icon mm9_mivaicon icon-branches"></span>
					<span class="templateorderemails_nonprimary_branch_warning_message">
						The current working branch is <span class="templateorderemails_nonprimary_branch_warning_branch_color" style="{ 'background-color: ' $ encodeentities( g.Store:branch:color ) $ ';' }"></span> <b><MvEVAL EXPR = "{ encodeentities( g.Store:branch:name ) }"></b>, which is not the primary branch.
						<br /><br />
						The emails displayed below are those configured on the working branch, and will be sent using content and configuration from the working branch.
					</span>
				</span>
			</td>
		</tr>

		<tr><td colspan="2">&nbsp;</td></tr>
	</MvIF>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_SparseOrderArray_Add_OrderItems" PARAMETERS = "orders var, orderitems var, member" STANDARDOUTPUTLEVEL = "">
	<MvFOREACH ITERATOR = "l.orderitem" ARRAY = "l.orderitems" COUNT = "{ miva_array_collapse( l.orderitems ) }">
		<MvASSIGN NAME = "l.order_id"	VALUE = "{ int( l.orderitem:order_id ) }">
		<MvASSIGN NAME = "l.line_id"	VALUE = "{ int( l.orderitem:line_id ) }">

		<MvIF EXPR = "{ l.order_id LE 0 }">		<MvFOREACHCONTINUE>
		<MvELSEIF EXPR = "{ l.line_id LE 0 }">	<MvFOREACHCONTINUE>
		</MvIF>

		<MvASSIGNARRAY NAME = "l.orders" VALUE = "{ l.order_id }">
			<MvDIMENSION INDEX = "{ l.order_id }">
			<MvMEMBER NAME = "id">
		</MvASSIGNARRAY>

		<MvASSIGNARRAY NAME = "l.orders" VALUE = "{ l.orderitem }">
			<MvDIMENSION INDEX = "{ l.order_id }">
			<MvMEMBER NAME = "{ l.member }">
			<MvDIMENSION INDEX = "{ l.line_id }">
		</MvASSIGNARRAY>
	</MvFOREACH>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_SparseOrderArray_Add_OrderShipments" PARAMETERS = "orders var, ordershipments var, member" STANDARDOUTPUTLEVEL = "">
	<MvFOREACH ITERATOR = "l.ordershipment" ARRAY = "l.ordershipments" COUNT = "{ miva_array_collapse( l.ordershipments ) }">	
		<MvASSIGN NAME = "l.order_id"		VALUE = "{ int( l.ordershipment:order_id ) }">
		<MvASSIGN NAME = "l.shipment_id"	VALUE = "{ int( l.ordershipment:id ) }">

		<MvIF EXPR = "{ l.order_id LE 0 }">			<MvFOREACHCONTINUE>
		<MvELSEIF EXPR = "{ l.shipment_id LE 0 }">	<MvFOREACHCONTINUE>
		</MvIF>

		<MvASSIGNARRAY NAME = "l.orders" VALUE = "{ l.order_id }">
			<MvDIMENSION INDEX = "{ l.order_id }">
			<MvMEMBER NAME = "id">
		</MvASSIGNARRAY>

		<MvASSIGNARRAY NAME = "l.orders" VALUE = "{ l.ordershipment }">
			<MvDIMENSION INDEX = "{ l.order_id }">
			<MvMEMBER NAME = "{ l.member }">
			<MvDIMENSION INDEX = "{ l.shipment_id }">
		</MvASSIGNARRAY>
	</MvFOREACH>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_SparseOrderArray_Add_OrderShipmentsFromOrderItems" PARAMETERS = "orders var, orderitems var, member" STANDARDOUTPUTLEVEL = "">
	<MvFOREACH ITERATOR = "l.orderitem" ARRAY = "l.orderitems" COUNT = "{ miva_array_collapse( l.orderitems ) }">
		<MvASSIGN NAME = "l.order_id"		VALUE = "{ int( l.orderitem:order_id ) }">
		<MvASSIGN NAME = "l.shipment_id"	VALUE = "{ int( l.orderitem:shpmnt_id ) }">

		<MvIF EXPR = "{ l.order_id LE 0 }">			<MvFOREACHCONTINUE>
		<MvELSEIF EXPR = "{ l.shipment_id LE 0 }">	<MvFOREACHCONTINUE>
		</MvIF>
		
		<MvASSIGNARRAY NAME = "l.orders" VALUE = "{ l.order_id }">
			<MvDIMENSION INDEX = "{ l.order_id }">
			<MvMEMBER NAME = "id">
		</MvASSIGNARRAY>

		<MvASSIGNARRAY NAME = "l.orders" VALUE = "{ l.shipment_id }">
			<MvDIMENSION INDEX = "{ l.order_id }">
			<MvMEMBER NAME = "{ l.member }">
			<MvDIMENSION INDEX = "{ l.shipment_id }">
			<MvMEMBER NAME = "id">
		</MvASSIGNARRAY>
	</MvFOREACH>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_SparseOrderArray_Add_OrderReturnsFromOrderItems" PARAMETERS = "orders var, orderitems var, member" STANDARDOUTPUTLEVEL = "">
	<MvFOREACH ITERATOR = "l.orderitem" ARRAY = "l.orderitems" COUNT = "{ miva_array_collapse( l.orderitems ) }">
		<MvASSIGN NAME = "l.order_id"	VALUE = "{ int( l.orderitem:order_id ) }">
		<MvASSIGN NAME = "l.rma_id"		VALUE = "{ int( l.orderitem:rma_id ) }">

		<MvIF EXPR = "{ l.order_id LE 0 }">		<MvFOREACHCONTINUE>
		<MvELSEIF EXPR = "{ l.rma_id LE 0 }">	<MvFOREACHCONTINUE>
		</MvIF>

		<MvASSIGNARRAY NAME = "l.orders" VALUE = "{ l.order_id }">
			<MvDIMENSION INDEX = "{ l.order_id }">
			<MvMEMBER NAME = "id">
		</MvASSIGNARRAY>

		<MvASSIGNARRAY NAME = "l.orders" VALUE = "{ l.rma_id }">
			<MvDIMENSION INDEX = "{ l.order_id }">
			<MvMEMBER NAME = "{ l.member }">
			<MvDIMENSION INDEX = "{ l.rma_id }">
			<MvMEMBER NAME = "id">
		</MvASSIGNARRAY>
	</MvFOREACH>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_SendEmails" PARAMETERS = "run var" STANDARDOUTPUTLEVEL = "">
	<MvFOREACH ITERATOR = "l.email" ARRAY = "l.emails" COUNT = "{ TemplateOrderEmailList_Load_Run( l.run, l.emails ) }">
		<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.run, l.email ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_SendSubscriptionEmails" PARAMETERS = "run var, subscriptions var, subscription_count" STANDARDOUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| Special handling is not required when sending emails for a single subscription
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ l.subscription_count EQ 1 }">
		<MvASSIGN NAME = "l.run:subscription"			VALUE = "{ l.subscriptions[ 1 ] }">
		<MvASSIGN NAME = "l.run:subscriptions"			VALUE = "{ l.subscriptions }">
		<MvASSIGN NAME = "l.run:subscription_count"		VALUE = "{ l.subscription_count }">

		<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmails_SendEmails( l.run ) }">
	</MvIF>

	<MvCOMMENT>
	|
	| For multiple subscriptions, load the emails and segregate them into a list of emails that support
	| multiple-subscriptions (they have the toe_subscriptions item assigned) and emails that only handle
	| a single subscription, then process them separately.
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.have_multi_subscription_item"	VALUE = "{ [ g.Module_Feature_TUI_DB ].Item_Load_Code( 'toe_subscriptions', l.multi_subscription_item ) }">
	<MvASSIGN NAME = "l.single_count"					VALUE = 0>
	<MvASSIGN NAME = "l.multi_count"					VALUE = 0>

	<MvFOREACH ITERATOR = "l.email" ARRAY = "l.all_emails" COUNT = "{ TemplateOrderEmailList_Load_Run( l.run, l.all_emails ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Page_Load_Code( l.email:page_code, l.page ) OR ( NOT l.page:admin ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00079', 'Unknown page \'' $ l.email:page_code $ '\'' ) }">
		</MvIF>

		<MvIF EXPR = "{ l.have_multi_subscription_item }">
			<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].PageXItem_Load( l.page:id, l.multi_subscription_item:id, l.null ) }">
				<MvASSIGN NAME = "l.multi_count"		VALUE = "{ miva_array_insert_ref( l.multi_emails, l.email, -1 ) }">
				<MvFOREACHCONTINUE>
			<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>

		<MvASSIGN NAME = "l.single_count"				VALUE = "{ miva_array_insert_ref( l.single_emails, l.email, -1 ) }">
	</MvFOREACH>

	<MvCOMMENT>
	|
	| Send the multi-subscription emails
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.multi_run"						VALUE = "{ l.run }">
	<MvASSIGN NAME = "l.multi_run:subscriptions"		VALUE = "{ l.subscriptions }">
	<MvASSIGN NAME = "l.multi_run:subscription_count"	VALUE = "{ l.subscription_count }">

	<MvFOREACH ITERATOR = "l.email" ARRAY = "l.multi_emails" COUNT = "{ l.multi_count }">
		<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.multi_run, l.email ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvCOMMENT>
	|
	| Send the single subscription emails once per subscription
	|
	</MvCOMMENT>

	<MvFOREACH ITERATOR = "l.subscription" ARRAY = "l.subscriptions" COUNT = "{ l.subscription_count }">
		<MvASSIGN NAME = "l.single_run"					VALUE = "{ l.run }">
		<MvASSIGN NAME = "l.single_run:subscription"	VALUE = "{ l.subscription }">

		<MvFOREACH ITERATOR = "l.email" ARRAY = "l.single_emails" COUNT = "{ l.single_count }">
			<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.single_run, l.email ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvFOREACH>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_SendSubscriptionEmail" PARAMETERS = "run var, email var, subscriptions var, subscription_count" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.subscription_count EQ 1 }">
		<MvASSIGN NAME = "l.run:subscription"			VALUE = "{ l.subscriptions[ 1 ] }">
		<MvASSIGN NAME = "l.run:subscriptions"			VALUE = "{ l.subscriptions }">
		<MvASSIGN NAME = "l.run:subscription_count"		VALUE = "{ l.subscription_count }">

		<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmails_SendEmail( l.run, l.email ) }">
	</MvIF>

	<MvASSIGN NAME = "l.multi_subscription"				VALUE = 0>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Item_Load_Code( 'toe_subscriptions', l.multi_subscription_item ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvCOMMENT>
		|
		| If EOF, just assume that this email does not support multi-subscription and do nothing
		|
		</MvCOMMENT>
	<MvELSE>
		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Page_Load_Code( l.email:page_code, l.page ) OR ( NOT l.page:admin ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00092', 'Unknown page \'' $ l.email:page_code $ '\'' ) }">
		</MvIF>

		<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].PageXItem_Load( l.page:id, l.multi_subscription_item:id, l.null ) }">
			<MvASSIGN NAME = "l.multi_subscription"		VALUE = 1>
		<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ l.multi_subscription }">
		<MvASSIGN NAME = "l.run:subscription"			VALUE = "{ l.subscriptions[ 1 ] }">
		<MvASSIGN NAME = "l.run:subscriptions"			VALUE = "{ l.subscriptions }">
		<MvASSIGN NAME = "l.run:subscription_count"		VALUE = "{ l.subscription_count }">

		<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmails_SendEmail( l.run, l.email ) }">
	</MvIF>

	<MvCOMMENT>
	|
	| Send the email once per subscription
	|
	</MvCOMMENT>

	<MvFOREACH ITERATOR = "l.subscription" ARRAY = "l.subscriptions" COUNT = "{ l.subscription_count }">
		<MvASSIGN NAME = "l.single_run"					VALUE = "{ l.run }">
		<MvASSIGN NAME = "l.single_run:subscription"	VALUE = "{ l.subscription }">

		<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.single_run, l.email ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_SendDigitalDownloadEmails" PARAMETERS = "run var, digitaldownloads var, digitaldownload_count" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.digitaldownloads[ 1 ]:order_id EQ 0 OR l.digitaldownloads[ 1 ]:line_id EQ 0 }">					<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Order_Load_ID( l.digitaldownloads[ 1 ]:order_id, l.run:order ) }">	<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvCOMMENT>
	|
	| Special handling is not required when sending emails for a single digitaldownload
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ l.digitaldownload_count EQ 1 }">
		<MvASSIGN NAME = "l.run:digitaldownloads"		VALUE = "{ l.digitaldownloads }">
		<MvASSIGN NAME = "l.run:digitaldownload_count"	VALUE = "{ l.digitaldownload_count }">

		<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmails_SendEmails( l.run ) }">
	</MvIF>

	<MvCOMMENT>
	|
	| For multiple digitaldownloads, load the emails and segregate them into a list of emails that support
	| multiple-digitaldownloads (they have the toe_digitaldownloads item assigned) and emails that only handle
	| a single digitaldownload, then process them separately.
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.have_multi_digitaldownload_item"	VALUE = "{ [ g.Module_Feature_TUI_DB ].Item_Load_Code( 'toe_digitaldownloads', l.multi_digitaldownload_item ) }">
	<MvASSIGN NAME = "l.single_count"						VALUE = 0>
	<MvASSIGN NAME = "l.multi_count"						VALUE = 0>

	<MvFOREACH ITERATOR = "l.email" ARRAY = "l.all_emails" COUNT = "{ TemplateOrderEmailList_Load_Run( l.run, l.all_emails ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Page_Load_Code( l.email:page_code, l.page ) OR ( NOT l.page:admin ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00102', 'Page \'' $ l.email:page_code $ '\' not found' ) }">
		</MvIF>

		<MvIF EXPR = "{ l.have_multi_digitaldownload_item }">
			<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].PageXItem_Load( l.page:id, l.multi_digitaldownload_item:id, l.null ) }">
				<MvASSIGN NAME = "l.multi_count" VALUE = "{ miva_array_insert_ref( l.multi_emails, l.email, -1 ) }">
				<MvFOREACHCONTINUE>
			<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>

		<MvASSIGN NAME = "l.single_count" VALUE = "{ miva_array_insert_ref( l.single_emails, l.email, -1 ) }">
	</MvFOREACH>

	<MvCOMMENT>
	|
	| Send the multi-digitaldownload emails
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.multi_run"							VALUE = "{ l.run }">
	<MvASSIGN NAME = "l.multi_run:digitaldownloads"			VALUE = "{ l.digitaldownloads }">
	<MvASSIGN NAME = "l.multi_run:digitaldownload_count"	VALUE = "{ l.digitaldownload_count }">

	<MvFOREACH ITERATOR = "l.email" ARRAY = "l.multi_emails" COUNT = "{ l.multi_count }">
		<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.multi_run, l.email ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvCOMMENT>
	|
	| Send the single digitaldownload emails once per digitaldownload
	|
	</MvCOMMENT>

	<MvFOREACH ITERATOR = "l.digitaldownload" ARRAY = "l.digitaldownloads" COUNT = "{ l.digitaldownload_count }">
		<MvASSIGN NAME = "l.single_run"								VALUE = "{ l.run }">
		<MvASSIGN NAME = "l.single_run:digitaldownloads" INDEX = 1	VALUE = "{ l.digitaldownload }">
		<MvASSIGN NAME = "l.single_run:digitaldownload_count"		VALUE = 1>

		<MvFOREACH ITERATOR = "l.email" ARRAY = "l.single_emails" COUNT = "{ l.single_count }">
			<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.single_run, l.email ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvFOREACH>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_SendGiftCertificateEmails" PARAMETERS = "run var, giftcertificates var, giftcertificate_count" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.giftcertificates[ 1 ]:order_id EQ 0 OR l.giftcertificates[ 1 ]:line_id EQ 0 }">					<MvFUNCTIONRETURN VALUE = 1>
	<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Order_Load_ID( l.giftcertificates[ 1 ]:order_id, l.run:order ) }">	<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.filtered_giftcertificates"		VALUE = "">
	<MvASSIGN NAME = "l.filtered_giftcertificate_count"	VALUE = 0>

	<MvFOREACH ITERATOR = "l.giftcertificate" ARRAY = "l.giftcertificates" COUNT = "{ l.giftcertificate_count }">
		<MvIF EXPR = "{ NOT TemplateOrderEmails_Load_GiftCertificateSalesData( l.run:order, l.giftcertificate ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ miva_array_elements( l.giftcertificate:recipients ) EQ 0 }">
			<MvFOREACHCONTINUE>
		</MvIF>

		<MvASSIGN NAME = "l.filtered_giftcertificate_count" VALUE = "{ miva_array_insert_var( l.filtered_giftcertificates, l.giftcertificate, -1 ) }">
	</MvFOREACH>

	<MvIF EXPR = "{ l.filtered_giftcertificate_count EQ 0 }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvCOMMENT>
	|
	| Special handling is not required when sending emails for a single giftcertificate
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ l.filtered_giftcertificate_count EQ 1 }">
		<MvASSIGN NAME = "l.run:giftcertificates"		VALUE = "{ l.filtered_giftcertificates }">
		<MvASSIGN NAME = "l.run:giftcertificate_count"	VALUE = "{ l.filtered_giftcertificate_count }">

		<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmails_SendEmails( l.run ) }">
	</MvIF>

	<MvCOMMENT>
	|
	| For multiple giftcertificates, load the emails and segregate them into a list of emails that support
	| multiple-giftcertificates (they have the toe_giftcertificates item assigned) and emails that only handle
	| a single giftcertificate, then process them separately.
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.have_multi_giftcertificate_item"	VALUE = "{ [ g.Module_Feature_TUI_DB ].Item_Load_Code( 'toe_giftcertificates', l.multi_giftcertificate_item ) }">
	<MvASSIGN NAME = "l.single_count"						VALUE = 0>
	<MvASSIGN NAME = "l.multi_count"						VALUE = 0>

	<MvFOREACH ITERATOR = "l.email" ARRAY = "l.all_emails" COUNT = "{ TemplateOrderEmailList_Load_Run( l.run, l.all_emails ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Page_Load_Code( l.email:page_code, l.page ) OR ( NOT l.page:admin ) }">
			<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>

			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00103', 'Page \'' $ l.email:page_code $ '\' not found' ) }">
		</MvIF>

		<MvIF EXPR = "{ l.have_multi_giftcertificate_item }">
			<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].PageXItem_Load( l.page:id, l.multi_giftcertificate_item:id, l.null ) }">
				<MvASSIGN NAME = "l.multi_count" VALUE = "{ miva_array_insert_ref( l.multi_emails, l.email, -1 ) }">
				<MvFOREACHCONTINUE>
			<MvELSEIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>

		<MvASSIGN NAME = "l.single_count" VALUE = "{ miva_array_insert_ref( l.single_emails, l.email, -1 ) }">
	</MvFOREACH>

	<MvCOMMENT>
	|
	| Send the multi-giftcertificate emails
	|
	</MvCOMMENT>

	<MvFOREACH ITERATOR = "l.grouped_giftcertificate" ARRAY = "l.grouped_giftcertificates" COUNT = "{ TemplateOrderEmail_Group_GiftCertificates( l.filtered_giftcertificates, l.filtered_giftcertificate_count, l.grouped_giftcertificates ) }">
		<MvASSIGN NAME = "l.multi_run"							VALUE = "{ l.run }">
		<MvASSIGN NAME = "l.multi_run:recipients"				VALUE = "{ l.grouped_giftcertificate:recipients }">
		<MvASSIGN NAME = "l.multi_run:giftcertificates"			VALUE = "{ l.grouped_giftcertificate:giftcertificates }">
		<MvASSIGN NAME = "l.multi_run:giftcertificate_count"	VALUE = "{ l.grouped_giftcertificate:giftcertificate_count }">

		<MvFOREACH ITERATOR = "l.email" ARRAY = "l.multi_emails" COUNT = "{ l.multi_count }">
			<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.multi_run, l.email ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvFOREACH>
	</MvFOREACH>

	<MvCOMMENT>
	|
	| Send the single giftcertificate emails once per giftcertificate
	|
	</MvCOMMENT>

	<MvFOREACH ITERATOR = "l.giftcertificate" ARRAY = "l.filtered_giftcertificates" COUNT = "{ l.filtered_giftcertificate_count }">
		<MvASSIGN NAME = "l.single_run"								VALUE = "{ l.run }">
		<MvASSIGN NAME = "l.single_run:recipients"					VALUE = "{ l.giftcertificate:recipients }">
		<MvASSIGN NAME = "l.single_run:giftcertificates" INDEX = 1	VALUE = "{ l.giftcertificate }">
		<MvASSIGN NAME = "l.single_run:giftcertificate_count"		VALUE = 1>

		<MvFOREACH ITERATOR = "l.email" ARRAY = "l.single_emails" COUNT = "{ l.single_count }">
			<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.single_run, l.email ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvFOREACH>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_SendEmail" PARAMETERS = "run var, email var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].Page_Load_Code( l.email:page_code, l.page ) OR ( NOT l.page:admin ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00016', 'Unknown page \'' $ l.email:page_code $ '\'' ) }">
	</MvIF>

	<MvCOMMENT>
	|
	| Pre-initialize page items using run data
	|
	</MvCOMMENT>

	<MvFOREACH ITERATOR = "l.item" ARRAY = "l.render:items" COUNT = "{ [ g.Module_Feature_TUI_DB ].ItemModuleList_Load_Page_Render( l.page:id, l.render ) }">
		<MvASSIGN NAME = "l.item_code"	VALUE = "{ l.item:item_code }">

		<MvIF EXPR = "{ l.item_code EQ 'order' }">							<MvASSIGN NAME = "l.result"	VALUE = "{ TemplateOrderEmails_Initialize_Item_order( l.run, l.page:settings ) }">
		<MvELSEIF EXPR = "{ l.item_code EQ 'backorder' }">					<MvASSIGN NAME = "l.result"	VALUE = "{ TemplateOrderEmails_Initialize_Item_backorder( l.run, l.page:settings ) }">
		<MvELSEIF EXPR = "{ l.item_code EQ 'toe_basket_contents' }">		<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmails_Initialize_Item_basket( l.run, l.page:settings ) }">
		<MvELSEIF EXPR = "{ l.item_code EQ 'return' }">						<MvASSIGN NAME = "l.result"	VALUE = "{ TemplateOrderEmails_Initialize_Item_return( l.run, l.page:settings ) }">
		<MvELSEIF EXPR = "{ l.item_code EQ 'shipment' }">					<MvASSIGN NAME = "l.result"	VALUE = "{ TemplateOrderEmails_Initialize_Item_shipment( l.run, l.page:settings ) }">
		<MvELSEIF EXPR = "{ l.item_code EQ 'order_customer' }">				<MvASSIGN NAME = "l.result"	VALUE = "{ TemplateOrderEmails_Initialize_Item_order_customer( l.run, l.page:settings ) }">
		<MvELSEIF EXPR = "{ ( l.item_code EQ 'order_contents' ) OR
							( l.item_code EQ 'toe_order_contents' ) }">		<MvASSIGN NAME = "l.result"	VALUE = "{ TemplateOrderEmails_Initialize_Item_order_contents( l.run, l.page:settings ) }">
		<MvELSEIF EXPR = "{ l.item_code EQ 'giftcertificate' }">			<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmails_Initialize_Item_giftcertificate( l.run, l.page:settings ) }">
		<MvELSEIF EXPR = "{ l.item_code EQ 'digitaldownload' }">			<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmails_Initialize_Item_digitaldownload( l.run, l.page:settings ) }">
		<MvELSEIF EXPR = "{ l.item_code EQ 'toe_subscription_fields' }">	<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmails_Initialize_Item_subscription( l.run, l.page:settings ) }">
		<MvELSEIF EXPR = "{ l.item_code EQ 'toe_subscriptions' }">			<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmails_Initialize_Item_subscriptions( l.run, l.page:settings ) }">
		<MvELSEIF EXPR = "{ l.item_code EQ 'toe_giftcertificates' }">		<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmails_Initialize_Item_giftcertificates( l.run, l.page:settings ) }">
		<MvELSEIF EXPR = "{ l.item_code EQ 'toe_digitaldownloads' }">		<MvASSIGN NAME = "l.result" VALUE = "{ TemplateOrderEmails_Initialize_Item_digitaldownloads( l.run, l.page:settings ) }">
		<MvELSE>															<MvASSIGN NAME = "l.result" VALUE = 1>
		</MvIF>

		<MvIF EXPR = "{ NOT l.result }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvCOMMENT>
	|
	| We must explicitly set these module variables as we cannot be
	| guaranteed that we are running in a context that does so for us
	| (runtime, json)
	|
	</MvCOMMENT>
	
	<MvEVAL EXPR = "{ TemplateOrderEmail_Set_Originals() }">

	<MvIF EXPR = "{ NOT ISNULL g.Domain:base_surl }">	<MvASSIGN NAME = "g.basehref"	VALUE = "{ g.Domain:base_surl }">
	<MvELSE>											<MvASSIGN NAME = "g.basehref"	VALUE = "{ g.Domain:base_url }">
	</MvIF>

	<MvIF EXPR = "{ ISNULL g.Session:cache:templateorderemails:store_count }">
		<MvASSIGN NAME = "g.Session:cache:templateorderemails:store_count"	VALUE = "{ [ g.Module_Library_DB ].Store_Count() }">
	</MvIF>

	<MvASSIGN NAME = "g.Store_Count"										VALUE = "{ g.Session:cache:templateorderemails:store_count }">

	<MvIF EXPR = "{ ISNULL g.Domain:mm_surl }">
		<MvASSIGN NAME = "g.sessionurl"										VALUE = "{ g.Domain:mm_url }">
		<MvASSIGN NAME = "g.secure_sessionurl"								VALUE = "{ g.sessionurl }">
	<MvELSE>
		<MvASSIGN NAME = "g.sessionurl"										VALUE = "{ g.Domain:mm_url }">
		<MvASSIGN NAME = "g.secure_sessionurl"								VALUE = "{ g.Domain:mm_surl }">
	</MvIF>

	<MvASSIGN NAME = "g.sessionurl_nosep"									VALUE = "{ substring_var( g.sessionurl, 1, len_var( g.sessionurl ) - 1 ) }">
	<MvASSIGN NAME = "g.secure_sessionurl_nosep"							VALUE = "{ substring_var( g.secure_sessionurl, 1, len_var( g.secure_sessionurl ) - 1 ) }">

	<MvASSIGN NAME = "g.Store_Module_Currency"								VALUE = "{ g.Store:currncy_mod }">
	<MvASSIGN NAME = "g.Store_Module_Tax"									VALUE = "{ g.Store:tax_mod }">
	<MvASSIGN NAME = "g.Store_Module_UI"									VALUE = "{ g.Store:ui_mod }">

	<MvASSIGN NAME = "g.Module_Store_Module_Currency" 						VALUE = "{ g.Module_Root $ g.Store:currncy_mod:module }">
	<MvASSIGN NAME = "g.Module_Store_Module_Tax" 							VALUE = "{ g.Module_Root $ g.Store:tax_mod:module }">
	<MvASSIGN NAME = "g.Module_Store_Module_UI"								VALUE = "{ g.Module_Root $ g.Store:ui_mod:module }">

	<MvASSIGN NAME = "g.Domain:mm_params"									VALUE = "never">

	<MvIF EXPR = "{ l.run:on_cust }">
		<MvASSIGN NAME = "g.Customer"										VALUE = "{ l.run:customer }">
	</MvIF>

	<MvIF EXPR = "{ l.run:on_athfail EQ 'subscription' }">
		<MvASSIGN NAME = "l.page:settings:autherror"						VALUE = "{ l.run:autherror }">
	</MvIF>

	<MvIF EXPR = "{ l.run:on_pc_exp }">
		<MvASSIGN NAME = "l.page:settings:paymentcard"						VALUE = "{ l.run:paymentcard }">
	</MvIF>
	
	<MvCOMMENT>
	|
	| Render the page and capture the output
	|
	</MvCOMMENT>

	<MvCAPTURE VARIABLE = "l.message"><MvASSIGN NAME = "l.result" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Render_Page_LowLevel( l.page:code, l.page ) }"></MvCAPTURE>

	<MvIF EXPR = "{ NOT l.result }">
		<MvEVAL EXPR = "{ TemplateOrderEmail_Reset_Originals() }">

		<MvFUNCTIONRETURN VALUE = 0>
	<MvELSEIF EXPR = "{ ISNULL l.message }">
		<MvEVAL EXPR = "{ TemplateOrderEmail_Reset_Originals() }">

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvCOMMENT>
	|
	| Render the from, to, cc, bcc, subject, and mime type templates and capture their output.  This needs to be done after
	| the call to TemplateManager_Render_Page_LowLevel above so that all items are properly initialized.
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ NOT ISNULL l.run:override_from }">
		<MvASSIGN NAME = "l.from" VALUE = "{ l.run:override_from }">
	<MvELSE>
		<MvCAPTURE VARIABLE = "l.from"><MvASSIGN NAME = "l.null" VALUE = "{ [ g.Store_Template_Path $ l.email:tfn_from ].Template_Render( l.page, l.page:settings ) }"></MvCAPTURE>
	</MvIF>
	
	<MvIF EXPR = "{ NOT ISNULL l.run:override_reply_to }">
		<MvASSIGN NAME = "l.reply_to" VALUE = "{ l.run:override_reply_to }">
	<MvELSE>
		<MvCAPTURE VARIABLE = "l.reply_to"><MvASSIGN NAME = "l.null" VALUE = "{ [ g.Store_Template_Path $ l.email:tfn_rp_to ].Template_Render( l.page, l.page:settings ) }"></MvCAPTURE>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.run:override_to }">
		<MvASSIGN NAME = "l.to" VALUE = "{ l.run:override_to }">
	<MvELSE>
		<MvCAPTURE VARIABLE = "l.to"><MvASSIGN NAME = "l.null" VALUE = "{ [ g.Store_Template_Path $ l.email:tfn_to ].Template_Render( l.page, l.page:settings ) }"></MvCAPTURE>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.run:override_cc }">
		<MvASSIGN NAME = "l.cc" VALUE = "{ l.run:override_cc }">
	<MvELSE>
		<MvCAPTURE VARIABLE = "l.cc"><MvASSIGN NAME = "l.null" VALUE = "{ [ g.Store_Template_Path $ l.email:tfn_cc ].Template_Render( l.page, l.page:settings ) }"></MvCAPTURE>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.run:override_bcc }">
		<MvASSIGN NAME = "l.bcc" VALUE = "{ l.run:override_bcc }">
	<MvELSE>
		<MvCAPTURE VARIABLE = "l.bcc"><MvASSIGN NAME = "l.null" VALUE = "{ [ g.Store_Template_Path $ l.email:tfn_bcc ].Template_Render( l.page, l.page:settings ) }"></MvCAPTURE>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.run:override_subject }">
		<MvASSIGN NAME = "l.subject" VALUE = "{ l.run:override_subject }">
	<MvELSE>
		<MvCAPTURE VARIABLE = "l.subject"><MvASSIGN NAME = "l.null" VALUE = "{ [ g.Store_Template_Path $ l.email:tfn_subj ].Template_Render( l.page, l.page:settings ) }"></MvCAPTURE>
	</MvIF>

	<MvCAPTURE VARIABLE = "l.mime_type"><MvASSIGN NAME = "l.null" VALUE = "{ [ g.Store_Template_Path $ l.email:tfn_mime ].Template_Render( l.page, l.page:settings ) }"></MvCAPTURE>

	<MvCOMMENT>
	|
	| Restore the original g.xxx variables
	|
	</MvCOMMENT>

	<MvEVAL EXPR = "{ TemplateOrderEmail_Reset_Originals() }">

	<MvIF EXPR = "{ ISNULL l.from }">						<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00021', 'Empty From address' ) }">
	<MvELSEIF EXPR = "{ ISNULL l.to }">						<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00022', 'Empty To address' ) }">
	</MvIF>

	<MvCOMMENT>
	|
	| Send the email
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.email:from"					VALUE = "{ trim( l.from ) }">
	<MvASSIGN NAME = "l.email:to"					VALUE = "{ trim( l.to ) }">
	<MvASSIGN NAME = "l.email:cc"					VALUE = "{ trim( l.cc ) }">
	<MvASSIGN NAME = "l.email:bcc" 					VALUE = "{ trim( l.bcc ) }">
	<MvASSIGN NAME = "l.email:subject"				VALUE = "{ trim( l.subject ) }">
	<MvASSIGN NAME = "l.mime_type"					VALUE = "{ trim( l.mime_type ) }">
	<MvASSIGN NAME = "l.eol"						VALUE = "{ asciichar( 13 ) $ asciichar( 10 ) }">
	
	<MvIF EXPR = "{ NOT l.email:send_b64 }">
		<MvASSIGN NAME = "l.null"					VALUE = "{ [ g.Module_Library_Utilities ].StartMimeEmail( l.mime_email ) }">
		<MvASSIGN NAME = "l.null"					VALUE = "{ [ g.Module_Library_Utilities ].GenerateBodyMIME( l.mime_email, l.mime_type, '', '', l.message ) }">
		
		<MvIF EXPR = "{ NOT ISNULL l.reply_to }">
			<MvASSIGN NAME = "l.mime_email:headers" VALUE = "{ 'Reply-To: ' $ l.reply_to $ l.eol $ l.mime_email:headers }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].v9_SendMimeEmail( l.mime_email, l.email ) }">
	</MvIF>

	<MvASSIGN NAME = "l.base64_message"				VALUE = "{ crypto_base64_encode( l.message ) }">
	<MvASSIGN NAME = "l.base64_message_len"			VALUE = "{ len_var( l.base64_message ) }">

	<MvCAPTURE VARIABLE = "l.email:headers">
		<MvIF EXPR = "{ NOT ISNULL l.reply_to }">
			<MvEVAL EXPR = "Reply-To: "><MvEVAL EXPR = "{ l.reply_to }">	<MvEVAL EXPR = "{ l.eol }">
		</MvIF>

		<MvEVAL EXPR = "Mime-Version: 1.0">									<MvEVAL EXPR = "{ l.eol }">
		<MvEVAL EXPR = "Content-Type: "><MvEVAL EXPR = "{ l.mime_type }">	<MvEVAL EXPR = "{ l.eol }">
		<MvEVAL EXPR = "Content-Transfer-Encoding: base64">
	</MvCAPTURE>

	<MvCAPTURE VARIABLE = "l.email:message"><MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Chunk_Split_Output( l.base64_message, l.base64_message_len, 72, l.eol ) }"></MvCAPTURE>

	<MvIF EXPR = "{ NOT [ g.Module_Library_Utilities ].v9_SendEmail( l.email ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.run:on_ordr AND miva_member_exists( l.email:on_ordr, l.run:on_ordr ) }">				<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_ordr', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ NOT ISNULL l.run:on_athfail AND miva_member_exists( l.email:on_athfail, l.run:on_athfail ) }">		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_athfail', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_bord AND l.email:on_bord }">																<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_bord', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_retc AND l.email:on_retc }">																<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_retc', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_retr AND l.email:on_retr }">																<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_retr', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_shpc AND l.email:on_shpc }">																<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_shpc', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_shps AND l.email:on_shps }">																<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_shps', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_cust AND l.email:on_cust }">																<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_cust', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_abandon AND l.email:on_abandon }">															<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_abandon', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_gftcert AND l.email:on_gftcert }">															<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_gftcert', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_digital AND l.email:on_digital }">															<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_digital', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_sub_crt AND l.email:on_sub_crt }">															<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_sub_crt', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_sub_chg AND l.email:on_sub_chg }">															<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_sub_chg', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_sub_can AND l.email:on_sub_can }">															<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_sub_can', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_sub_pnd AND l.email:on_sub_pnd }">															<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_sub_pnd', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_sub_oos AND l.email:on_sub_oos }">															<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_sub_oos', 1 ) }">	</MvIF>
	<MvIF EXPR = "{ l.run:on_pc_exp AND l.email:on_pc_exp }">															<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_FEL_DB ].FeatureEngagement_Increment_Counter( 'templateorderemail_sent_on_pc_exp', 1 ) }">	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_CreatePipeDelimitedIDList" PARAMETERS = "items var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.pos"		VALUE = 1>
	<MvASSIGN NAME = "l.count"		VALUE = "{ miva_array_elements( l.items ) }">

	<MvWHILE EXPR = "{ l.pos LE l.count }">
		<MvASSIGN NAME = "l.output" INDEX = "{ l.pos }" VALUE = "{ l.items[ l.pos ]:id }">
		<MvASSIGN NAME = "l.pos"	VALUE = "{ l.pos + 1 }">
	</MvWHILE>

	<MvFUNCTIONRETURN VALUE = "{ glosub( l.output, ',', '|' ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_order" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT ISNULL l.run:order }">
		<MvASSIGN NAME = "g.Order"	VALUE = "{ l.run:order }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_backorder" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.OrderForItems_ID"			VALUE = "{ l.run:order:id }">
	<MvASSIGN NAME = "g.OrderItem_IDs"				VALUE = "{ TemplateOrderEmails_CreatePipeDelimitedIDList( l.run:backordered_orderitems ) }">
	<MvASSIGN NAME = "l.settings:backorder:order"	VALUE = "{ l.run:order }">
	<MvASSIGN NAME = "l.settings:backorder:items"	VALUE = "{ l.run:backordered_orderitems }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_basket" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT ISNULL l.run:basket }">
		<MvASSIGN NAME = "g.Basket"	VALUE = "{ l.run:basket }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_return" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.OrderReturn_ID"		VALUE = "{ l.run:rma_id }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_shipment" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "g.OrderShipment_IDs"	VALUE = "{ TemplateOrderEmails_CreatePipeDelimitedIDList( l.run:ordershipments ) }">
	<MvASSIGN NAME = "l.settings:shipments"	VALUE = "{ l.run:ordershipments }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_order_contents" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT ISNULL l.run:order }">
		<MvASSIGN NAME = "g.Order"	VALUE = "{ l.run:order }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_order_customer" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_giftcertificate" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.settings:giftcertificate" VALUE = "{ l.run:giftcertificates[ 1 ] }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_giftcertificates" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.settings:giftcertificate:recipients"	VALUE = "{ l.run:giftcertificates[ 1 ]:recipients }">
	<MvASSIGN NAME = "l.settings:giftcertificate_count"			VALUE = "{ l.run:giftcertificate_count }">
	<MvASSIGN NAME = "l.settings:giftcertificates"				VALUE = "{ l.run:giftcertificates }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_digitaldownload" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.settings:digitaldownload"	VALUE = "{ l.run:digitaldownloads[ 1 ] }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_digitaldownloads" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.settings:digitaldownload_count"	VALUE = "{ l.run:digitaldownload_count }">
	<MvASSIGN NAME = "l.settings:digitaldownloads"		VALUE = "{ l.run:digitaldownloads }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_subscription" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.settings:subscription"	VALUE = "{ l.run:subscription }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Initialize_Item_subscriptions" PARAMETERS = "run var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.settings:subscription_count"	VALUE = "{ l.run:subscription_count }">
	<MvASSIGN NAME = "l.settings:subscriptions"			VALUE = "{ l.run:subscriptions }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Default_MimeType" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ ISNULL g.Store:charset }">	<MvFUNCTIONRETURN VALUE = "text/html">
	<MvELSE>									<MvFUNCTIONRETURN VALUE = "text/html; charset=&mvt:store:charset;">
	</MvIF>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Load_GiftCertificateSalesData" PARAMETERS = "order var, giftcert var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.giftcert:recipients"	VALUE = "">
	<MvASSIGN NAME = "l.giftcert:description"	VALUE = "">

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].OrderItem_Load_Line( l.giftcert:order_id, l.giftcert:line_id, l.orderitem ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_GFT_DB ].GiftCertificateSales_Load_Product( l.orderitem:product_id, l.giftcertificatesales ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.orderoptions_count"		VALUE = "{ [ g.Module_Library_DB ].OrderOptionList_Load_Line( l.giftcert:line_id, l.orderoptions ) }">
	<MvASSIGN NAME = "l.recipients"				VALUE = "">

	<MvIF EXPR = "{ l.giftcertificatesales:email_ship AND ( NOT ISNULL l.order:ship_email ) }">
		<MvIF EXPR = "{ [ g.Module_Admin ].Validate_Email( l.order:ship_email ) }">
			<MvASSIGN NAME = "l.recipients"		MEMBER = "{ l.order:ship_email }"	VALUE = 1>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ l.giftcertificatesales:email_bill AND ( NOT ISNULL l.order:bill_email ) }">
		<MvIF EXPR = "{ [ g.Module_Admin ].Validate_Email( l.order:bill_email ) }">
			<MvASSIGN NAME = "l.recipients"		MEMBER = "{ l.order:bill_email }"	VALUE = 1>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ l.giftcertificatesales:email_attr AND ( NOT ISNULL l.giftcertificatesales:emlattcode ) }">
		<MvIF EXPR = "{ miva_array_search( l.orderoptions, 1, l.orderoption, 'tolower( l.orderoption:attr_code ) EQ tolower( l.giftcertificatesales:emlattcode )' ) }">
			<MvIF EXPR = "{ [ g.Module_Admin ].Validate_Email( l.orderoption:data ) }">
				<MvASSIGN NAME = "l.recipients"	MEMBER = "{ l.orderoption:data }"	VALUE = 1>
			</MvIF>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT ISNULL l.giftcertificatesales:dscattcode }">
		<MvIF EXPR = "{ miva_array_search( l.orderoptions, 1, l.orderoption, 'tolower( l.orderoption:attr_code ) EQ tolower( l.giftcertificatesales:dscattcode )' ) }">
			<MvASSIGN NAME = "l.giftcert:description"								VALUE = "{ l.orderoption:data $ l.orderoption:data_long }">
		</MvIF>
	</MvIF>

	<MvFOREACH ITERATOR = "l.recipient" ARRAY = "l.members" COUNT = "{ miva_struct_members( l.recipients, l.members ) }">
		<MvASSIGN NAME = "l.null"				VALUE = "{ miva_array_insert( l.giftcert:recipients, l.recipient, -1 ) }">
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Validate_AlphaUnderscore" PARAMETERS = "value" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.value" VALUE = "{ trim( l.value ) }">

	<MvFOR INDEX = "l.pos" COUNT = "{ len_var( l.value ) }">
		<MvASSIGN NAME = "l.char" VALUE = "{ substring_var( l.value, l.pos, 1 ) }">

		<MvIF EXPR = "{ NOT isalpha( l.char ) AND l.char NE '_' }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOR>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_String_To_Structure" PARAMETERS = "string" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.structure" VALUE = "">

	<MvFOREACH ITERATOR = "l.element" ARRAY = "l.elements" COUNT = "{ miva_splitstring( l.string, ',', l.elements, 'trim,lower' ) }">
		<MvIF EXPR = "{ NOT ISNULL l.element }">
			<MvASSIGN NAME = "l.structure" MEMBER = "{ l.element }" VALUE = 1>
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = "{ l.structure }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Structure_To_String" PARAMETERS = "structure var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.null" VALUE = "{ miva_struct_members( l.structure, l.members ) }">
	
	<MvFUNCTIONRETURN VALUE = "{ miva_joinstring( l.members, ',', '' ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmailList_Sort_Callback" PARAMETERS = "left var, right var, data var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.data EQ 'enabled' }">				<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:enabled, l.right:enabled ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-enabled' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:enabled, l.left:enabled ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'name' }">			<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:name, l.right:name ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-name' }">			<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:name, l.left:name ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_bord' }">			<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_bord, l.right:on_bord ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_bord' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_bord, l.left:on_bord ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_retc' }">			<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_retc, l.right:on_retc ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_retc' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_retc, l.left:on_retc ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_retr' }">			<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_retr, l.right:on_retr ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_retr' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_retr, l.left:on_retr ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_shpc' }">			<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_shpc, l.right:on_shpc ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_shpc' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_shpc, l.left:on_shpc ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_shps' }">			<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_shps, l.right:on_shps ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_shps' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_shps, l.left:on_shps ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_cust' }">			<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_cust, l.right:on_cust ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_cust' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_cust, l.left:on_cust ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_abandon' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_abandon, l.right:on_abandon ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_abandon' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_abandon, l.left:on_abandon ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_gftcert' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_gftcert, l.right:on_gftcert ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_gftcert' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_gftcert, l.left:on_gftcert ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_digital' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_digital, l.right:on_digital ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_digital' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_digital, l.left:on_digital ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_sub_crt' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_sub_crt, l.right:on_sub_crt ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_sub_crt' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_sub_crt, l.left:on_sub_crt ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_sub_chg' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_sub_chg, l.right:on_sub_chg ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_sub_chg' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_sub_chg, l.left:on_sub_chg ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_sub_can' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_sub_can, l.right:on_sub_can ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_sub_can' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_sub_can, l.left:on_sub_can ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_sub_pnd' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_sub_pnd, l.right:on_sub_pnd ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_sub_pnd' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_sub_pnd, l.left:on_sub_pnd ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_sub_oos' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_sub_oos, l.right:on_sub_oos ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_sub_oos' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_sub_oos, l.left:on_sub_oos ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'on_pc_exp' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_pc_exp, l.right:on_pc_exp ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-on_pc_exp' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_pc_exp, l.left:on_pc_exp ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'send_b64' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:send_b64, l.right:send_b64 ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-send_b64' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:send_b64, l.left:send_b64 ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'vis_cust' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:vis_cust, l.right:vis_cust ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-vis_cust' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:vis_cust, l.left:vis_cust ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'vis_ordr' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:vis_ordr, l.right:vis_ordr ) }">
	<MvELSEIF EXPR = "{ l.data EQ '-vis_ordr' }">		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:vis_ordr, l.left:vis_ordr ) }">
	<MvELSEIF EXPR = "{ l.data EQ 'sub_days' }">
		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_sub_pnd, l.right:on_sub_pnd ) }">

		<MvIF EXPR = "{ l.result EQ 0 }">
			<MvIF EXPR = "{ l.left:sub_days LT l.right:sub_days }">		<MvASSIGN NAME = "l.result" VALUE = -1>
			<MvELSEIF EXPR = "{ l.left:sub_days GT l.right:sub_days }">	<MvASSIGN NAME = "l.result" VALUE = 1>
			</MvIF>
		</MvIF>
	<MvELSEIF EXPR = "{ l.data EQ '-sub_days' }">
		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_sub_pnd, l.left:on_sub_pnd ) }">

		<MvIF EXPR = "{ l.result EQ 0 }">
			<MvIF EXPR = "{ l.right:sub_days LT l.left:sub_days }">		<MvASSIGN NAME = "l.result" VALUE = -1>
			<MvELSEIF EXPR = "{ l.right:sub_days GT l.left:sub_days }">	<MvASSIGN NAME = "l.result" VALUE = 1>
			</MvIF>
		</MvIF>
	<MvELSEIF EXPR = "{ l.data EQ 'pc_type' }">
		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_pc_exp, l.right:on_pc_exp ) }">

		<MvIF EXPR = "{ l.result EQ 0 }">
			<MvIF EXPR = "{ l.left:pc_type LT l.right:pc_type }">		<MvASSIGN NAME = "l.result" VALUE = -1>
			<MvELSEIF EXPR = "{ l.left:pc_type GT l.right:pc_type }">	<MvASSIGN NAME = "l.result" VALUE = 1>
			</MvIF>
		</MvIF>
	<MvELSEIF EXPR = "{ l.data EQ '-pc_type' }">
		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_pc_exp, l.left:on_pc_exp ) }">

		<MvIF EXPR = "{ l.result EQ 0 }">
			<MvIF EXPR = "{ l.right:pc_type LT l.left:pc_type }">		<MvASSIGN NAME = "l.result" VALUE = -1>
			<MvELSEIF EXPR = "{ l.right:pc_type GT l.left:pc_type }">	<MvASSIGN NAME = "l.result" VALUE = 1>
			</MvIF>
		</MvIF>
	<MvELSEIF EXPR = "{ l.data EQ 'pc_days' }">
		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.left:on_pc_exp, l.right:on_pc_exp ) }">

		<MvIF EXPR = "{ l.result EQ 0 }">
			<MvIF EXPR = "{ l.left:pc_days LT l.right:pc_days }">		<MvASSIGN NAME = "l.result" VALUE = -1>
			<MvELSEIF EXPR = "{ l.left:pc_days GT l.right:pc_days }">	<MvASSIGN NAME = "l.result" VALUE = 1>
			</MvIF>
		</MvIF>
	<MvELSEIF EXPR = "{ l.data EQ '-pc_days' }">
		<MvASSIGN NAME = "l.result" VALUE = "{ strcasecmp( l.right:on_pc_exp, l.left:on_pc_exp ) }">

		<MvIF EXPR = "{ l.result EQ 0 }">
			<MvIF EXPR = "{ l.right:pc_days LT l.left:pc_days }">		<MvASSIGN NAME = "l.result" VALUE = -1>
			<MvELSEIF EXPR = "{ l.right:pc_days GT l.left:pc_days }">	<MvASSIGN NAME = "l.result" VALUE = 1>
			</MvIF>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ l.result NE 0 }">
		<MvFUNCTIONRETURN VALUE = "{ l.result }">
	</MvIF>

	<MvCOMMENT>
	|
	| Break ties using code
	|
	</MvCOMMENT>

	<MvIF EXPR = "{ substring_var( l.data, 1, 1 ) EQ '-' }">	<MvFUNCTIONRETURN VALUE = "{ strcasecmp( l.right:code, l.left:code ) }">
	<MvELSE>													<MvFUNCTIONRETURN VALUE = "{ strcasecmp( l.left:code, l.right:code ) }">
	</MvIF>
</MvFUNCTION>

<MvCOMMENT>
|
| Customer Configuration Change Notification Feature (not_cust)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Notify_Customer_Insert" PARAMETERS = "module var, customer var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.run:customer"	VALUE = "{ l.customer }">
	<MvASSIGN NAME = "l.run:on_cust"	VALUE = 1>

	<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmails( l.run ) }">
		<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Message_Error( 'One or more notification emails could not be sent at this time: ' $ encodeentities( g.Error_Message ) ) }">
	</MvIF>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_Customer_Update" PARAMETERS = "module var, customer var" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_Customer_Delete" PARAMETERS = "module var, customer var" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvCOMMENT>
|
| Customer Add/Edit Screen Feature (vis_cust)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Customer_Tabs" PARAMETERS = "module var, customer var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT l.customer:id }">
		<MvFUNCTIONRETURN VALUE = "">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "TBOE:Template Based Emails">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Customer_Validate" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT Module_Customer_Update_LowLevel( l.module ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( g.Tab, '', 'One or more notification emails could not be sent at this time:' $ asciichar( 10 ) $ asciichar( 10 ) $ g.Error_Message ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Customer_Update_LowLevel" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ ISNULL g.TemplateOrderEmail_Send_Codes }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Load_ID( g.Customer_ID, l.customer ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.run:on_cust" 			VALUE = 1>
	<MvASSIGN NAME = "l.run:customer" 			VALUE = "{ l.customer }">
	<MvASSIGN NAME = "l.run:override_from"		VALUE = "{ g.TemplateOrderEmail_Override_From }">
	<MvASSIGN NAME = "l.run:override_reply_to"	VALUE = "{ g.TemplateOrderEmail_Override_Reply_To }">
	<MvASSIGN NAME = "l.run:override_to"		VALUE = "{ g.TemplateOrderEmail_Override_To }">
	<MvASSIGN NAME = "l.run:override_cc"		VALUE = "{ g.TemplateOrderEmail_Override_CC }">
	<MvASSIGN NAME = "l.run:override_bcc"		VALUE = "{ g.TemplateOrderEmail_Override_BCC }">
	<MvASSIGN NAME = "l.run:override_subject"	VALUE = "{ g.TemplateOrderEmail_Override_Subject }">

	<MvFOREACH ITERATOR = "l.email_code" ARRAY = "g.TemplateOrderEmail_Send_Codes">
		<MvIF EXPR = "{ NOT TemplateOrderEmail_Load_Code( l.email_code, l.email ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.run, l.email ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Customer_Update" PARAMETERS = "module var, customer var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Customer_Head" PARAMETERS = "module var, tab, customer var" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ TemplateOrderEmail_Branch_Warning_CSS() }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Customer_Content" PARAMETERS = "module var, tab, load_fields, customer var" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ l.load_fields }">
		<MvASSIGN NAME = "g.TemplateOrderEmail_Send_Codes" VALUE = "">
	</MvIF>

	<MvIF EXPR = "{ ( l.tab NE 'TBOE' ) OR
					( NOT l.customer:id ) }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>
	
	<MvASSIGN NAME = "l.email_count" VALUE = "{ TemplateOrderEmailList_Load_Customer( l.emails ) }">
	
	<table>
		<MvEVAL EXPR = "{ TemplateOrderEmail_Branch_Warning_HTML() }">

		<MvIF EXPR = "{ NOT l.email_count }">
			<tr><td colspan="2">No customer emails configured</td></tr>
		<MvELSE>
			<tr>
				<td nowrap valign="top">Send the Following Email(s):</td>
				<td width="100%" valign="top">
					<MvFOREACH INDEX = "l.email_pos" ITERATOR = "l.email" ARRAY = "l.emails" COUNT = "{ l.email_count }">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckboxModAlert( g.TemplateOrderEmail_Send_Codes[ l.email_pos ], 'TemplateOrderEmail_Send_Codes[' $ l.email_pos $ ']', l.email:code, encodeentities( l.email:name ) ) }">
						<br>
					</MvFOREACH>
				</td>
			</tr>

			<tr><td colspan="2">&nbsp;</td></tr>

			<tr><td valign="middle">Override From:</td><td valign="middle"><input type="text" name="TemplateOrderEmail_Override_From" size="30" onchange="SetModified();"></td></tr>
			<tr><td valign="middle">Override Reply-To:</td><td valign="middle"><input type="text" name="TemplateOrderEmail_Override_Reply_To" size="30" onchange="SetModified();"></td></tr>
			<tr><td valign="middle">Override To:</td><td valign="middle"><input type="text" name="TemplateOrderEmail_Override_To" size="30" onchange="SetModified();"></td></tr>
			<tr><td valign="middle">Override CC:</td><td valign="middle"><input type="text" name="TemplateOrderEmail_Override_CC" size="30" onchange="SetModified();"></td></tr>
			<tr><td valign="middle">Override BCC:</td><td valign="middle"><input type="text" name="TemplateOrderEmail_Override_BCC" size="30" onchange="SetModified();"></td></tr>
			<tr><td valign="middle">Override Subject:</td><td valign="middle"><input type="text" name="TemplateOrderEmail_Override_Subject" size="40" onchange="SetModified();"></td></tr>
		</MvIF>
	</table>
	
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Customer_Insert" PARAMETERS = "module var, customer var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Customer_Delete" PARAMETERS = "module var, customer var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| Gift Certificate Notification Feature (not_giftcert)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Notify_GiftCertificate_Created" PARAMETERS = "module var, giftcert var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.giftcertificate_count" VALUE = "{ miva_array_insert_ref( l.giftcertificates, l.giftcert, -1 ) }">

	<MvFUNCTIONRETURN VALUE = "{ Module_Notify_GiftCertificates_Created( l.module, l.giftcertificates, l.giftcertificate_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_GiftCertificates_Created" PARAMETERS = "module var, giftcertificates var, giftcertificate_count" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.run:on_gftcert" VALUE = 1>

	<MvIF EXPR = "{ NOT TemplateOrderEmails_SendGiftCertificateEmails( l.run, l.giftcertificates, l.giftcertificate_count ) }">
		<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Message_Error( 'One or more notification emails could not be sent at this time: ' $ encodeentities( g.Error_Message ) ) }">
	</MvIF>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_GiftCertificate_Redeemed" PARAMETERS = "module var, customer var, giftcert var" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_GiftCertificate_Updated" PARAMETERS = "module var, giftcert var" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_GiftCertificate_Deleted" PARAMETERS = "module var, giftcert var" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvCOMMENT>
|
| Digital Download Notification Feature (not_digital)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Notify_DigitalDownload_Created" PARAMETERS = "module var, dl var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.digitaldownload_count" VALUE = "{ miva_array_insert_ref( l.digitaldownloads, l.dl, -1 ) }">

	<MvFUNCTIONRETURN VALUE = "{ Module_Notify_DigitalDownloads_Created( l.module, l.digitaldownloads, l.digitaldownload_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_DigitalDownloads_Created" PARAMETERS = "module var, digitaldownloads var, digitaldownload_count" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.run:on_digital" VALUE = 1>

	<MvIF EXPR = "{ NOT TemplateOrderEmails_SendDigitalDownloadEmails( l.run, l.digitaldownloads, l.digitaldownload_count ) }">
		<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].Message_Error( 'One or more notification emails could not be sent at this time: ' $ encodeentities( g.Error_Message ) ) }">
	</MvIF>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_DigitalDownload_Deleted" PARAMETERS = "module var, dl var" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvCOMMENT>
|
| Subscription Notification Feature (not_subscript)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Notify_Subscription_Created" PARAMETERS = "module var, subscription var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.run:on_sub_crt"					VALUE = 1>
	<MvASSIGN NAME = "l.run:subscription" 				VALUE = "{ l.subscription }">
	<MvASSIGN NAME = "l.run:subscription_count"			VALUE = 1>
	<MvASSIGN NAME = "l.run:subscriptions" INDEX = 1	VALUE = "{ l.subscription }">
	<MvASSIGN NAME = "l.null"							VALUE = "{ TemplateOrderEmails_SendEmails( l.run ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_Subscriptions_Created" PARAMETERS = "module var, subscriptions var, subscription_count" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.run:on_sub_crt"	VALUE = 1>
	<MvASSIGN NAME = "l.null"			VALUE = "{ TemplateOrderEmails_SendSubscriptionEmails( l.run, l.subscriptions, l.subscription_count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_Subscription_Changed" PARAMETERS = "module var, original_subscription var, subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.original_subscription:status NE 'C' AND l.subscription:status EQ 'C' }">
		<MvASSIGN NAME = "l.run:on_sub_can"	VALUE = 1>
	<MvELSE>
		<MvASSIGN NAME = "l.run:on_sub_chg"	VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.run:subscription"	VALUE = "{ l.subscription }">
	<MvASSIGN NAME = "l.null"				VALUE = "{ TemplateOrderEmails_SendEmails( l.run ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_Subscription_Deleted" PARAMETERS = "module var, subscription var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXSubscription WHERE subscrp_id = ?' }"
			 FIELDS	= "l.subscription:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00093', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_Subscriptions_OutOfStock" PARAMETERS = "module var, subscriptions var, subscription_count" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.run:on_sub_oos"	VALUE = 1>
	<MvASSIGN NAME = "l.null"			VALUE = "{ TemplateOrderEmails_SendSubscriptionEmails( l.run, l.subscriptions, l.subscription_count ) }">
</MvFUNCTION>

<MvCOMMENT>
|
| Payment Notification Feature (not_payment)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Notify_Payment_AuthorizationFailure" PARAMETERS = "module var, basket var, source, source_id, payment_module var, payment_module_data var, amount" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ [ g.Module_Library_Utilities ].Error_Is_PaymentMethod_Invalid() }">		<MvASSIGN NAME = "l.run:autherror" VALUE = "Invalid payment method">
	<MvELSEIF EXPR = "{ g.Session:cache:error_message_count }">								<MvASSIGN NAME = "l.run:autherror" VALUE = "{ 'Authorization failure: ' $ g.Session:cache:error_messages[ g.Session:cache:error_message_count ] }">
	<MvELSE>																				<MvASSIGN NAME = "l.run:autherror" VALUE = "Authorization failure">
	</MvIF>

	<MvASSIGN NAME = "l.run:on_athfail"				VALUE = "{ l.source }">

	<MvIF EXPR = "{ l.source EQ 'subscription' }">
		<MvASSIGN NAME = "l.subscriptions"			VALUE = "">
		<MvASSIGN NAME = "l.subscription_count"		VALUE = 0>

		<MvIF EXPR = "{ l.source_id NE 0 }">
			<MvIF EXPR = "{ NOT [ g.Module_Feature_SUB_DB ].Subscription_Load_ID( l.source_id, l.subscriptions[ ++l.subscription_count ] ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		<MvELSE>
			<MvASSIGN NAME = "l.ordersource_count"	VALUE = "{ [ g.Module_Library_DB ].OrderSourceList_Load_Order_Source( l.basket:order_id, 'subscription', l.ordersources ) }">

			<MvIF EXPR = "{ l.ordersource_count EQ 0 }">
				<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>

				<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00080', 'No subscription found' ) }">
			</MvIF>

			<MvFOREACH ITERATOR = "l.ordersource" ARRAY = "l.ordersources" COUNT = "{ l.ordersource_count }">
				<MvIF EXPR = "{ NOT [ g.Module_Feature_SUB_DB ].Subscription_Load_ID( l.ordersource:source_id, l.subscriptions[ ++l.subscription_count ] ) }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>
			</MvFOREACH>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmails_SendSubscriptionEmails( l.run, l.subscriptions, l.subscription_count ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmails_SendEmails( l.run ) }">
</MvFUNCTION>

<MvCOMMENT>
|
| Scheduled Task Feature (scheduledtask)
|
</MvCOMMENT>

<MvFUNCTION NAME = "ScheduledTaskModule_Capabilities" PARAMETERS = "module var, capabilities var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.capabilities:provision"	VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Fields" PARAMETERS = "module var, task var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "">
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Prompt" PARAMETERS = "module var, field_id" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "">
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Field" PARAMETERS = "module var, field_id" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "">
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Invalid" PARAMETERS = "module var, field_id" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 0>
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Validate" PARAMETERS = "module var, task var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Update" PARAMETERS = "module var, task var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Delete" PARAMETERS = "module var, task var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Operations" PARAMETERS = "module var, operations var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.operations" INDEX = 1 MEMBER = "code"		VALUE = "notify_card_expiration">
	<MvASSIGN NAME = "l.operations" INDEX = 1 MEMBER = "descrip"	VALUE = "Notify of Payment Card Expiration">
	<MvASSIGN NAME = "l.operations" INDEX = 2 MEMBER = "code"		VALUE = "send_abandoned_basket_emails">
	<MvASSIGN NAME = "l.operations" INDEX = 2 MEMBER = "descrip"	VALUE = "Send Abandoned Basket Emails">
	<MvASSIGN NAME = "l.operations" INDEX = 3 MEMBER = "code"		VALUE = "send_pending_subscription_emails">
	<MvASSIGN NAME = "l.operations" INDEX = 3 MEMBER = "descrip"	VALUE = "Send Pending Subscription Emails">

	<MvFUNCTIONRETURN VALUE = 3>
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Execute" PARAMETERS = "module var, task var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.task:operation EQ 'notify_card_expiration' }">
		<MvFUNCTIONRETURN VALUE = "{ ScheduledTaskModule_Execute_PaymentCard_Expiring( l.module, l.task ) }">
	<MvELSEIF EXPR = "{ l.task:operation EQ 'send_abandoned_basket_emails' }">
		<MvFUNCTIONRETURN VALUE = "{ ScheduledTaskModule_Execute_AbandonedBasket( l.task ) }">
	<MvELSEIF EXPR = "{ l.task:operation EQ 'send_pending_subscription_emails' }">
		<MvFUNCTIONRETURN VALUE = "{ ScheduledTaskModule_Execute_Subscription_Pending( l.module, l.task ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00036', 'Unsupported operation' ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Provision_Settings" PARAMETERS = "module var, task var, provide_xml var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Execute_PaymentCard_Expiring" PARAMETERS = "module var, task var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.data"			VALUE = "">
	<MvREFERENCE NAME = "l.data:task"	VARIABLE = "l.task">

	<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmails_Process_PaymentCard_Expiring( s.dyn_time_t, g.Module_Root $ l.module:module, 'ScheduledTaskModule_Execute_PaymentCard_Expiring_SendEmail', l.data ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Execute_PaymentCard_Expiring_SendEmail" PARAMETERS = "email var, paymentcard var, data var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.run"								VALUE = "">
	<MvASSIGN NAME = "l.run:on_pc_exp"						VALUE = 1>
	<MvASSIGN NAME = "l.run:paymentcard" 					VALUE = "{ l.paymentcard }">
	<MvASSIGN NAME = "l.run:paymentcard:customer:primaddr"	VALUE = "{ l.data:std_fields:primaddr }">

	<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.run, l.email ) }">
		<MvASSIGN NAME = "l.null"							VALUE = "{ [ g.Module_Feature_SCH_UT ].ScheduledTask_Log( l.data:task, 'E', 'Unable to send notification for card ending in \'' $ l.paymentcard:lastfour $ '\' for customer \'' $ l.paymentcard:customer:login $ '\': ' $ g.Error_Message ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Process_PaymentCard_Expiring" PARAMETERS = "asof, callback_filename, callback_function, data var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StandardFields_Load_Cached( l.data:std_fields ) }">
		<MvASSIGN NAME = "l.data:std_fields:primaddr"	VALUE = "shipping">
	</MvIF>

	<MvASSIGN NAME = "l.email_count"					VALUE = "{ TemplateOrderEmailList_Load_Enabled_PaymentCard( l.emails ) }">

	<MvIF EXPR = "{ NOT l.email_count }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvCOMMENT>
	|
	| Process each email.  They are already loaded in ascending pc_days order
	|
	</MvCOMMENT>

	<MvFOREACH ITERATOR = "l.email" ARRAY = "l.emails" COUNT = "{ l.email_count }">
		<MvASSIGN NAME = "l.expires_within_interval"	VALUE = "{ ( 60 * 60 * 24 ) * l.email:pc_days }">
		<MvASSIGN NAME = "l.time_t"						VALUE = "{ l.asof + l.expires_within_interval }">
		<MvASSIGN NAME = "l.month"						VALUE = "{ time_t_month( l.time_t, g.Merchant_Local_Timezone ) }">
		<MvASSIGN NAME = "l.year"						VALUE = "{ time_t_year( l.time_t, g.Merchant_Local_Timezone ) }">

		<MvCOMMENT>
		|
		| Process paymentcards
		|
		</MvCOMMENT>

		<MvWHILE EXPR = "{ 1 }">
			<MvIF EXPR = "{ l.email:pc_type EQ 'S' }">	<MvASSIGN NAME = "l.paymentcard_count" VALUE = "{ CustomerAndPaymentCardList_Load_Expiration_SubscriptionsOnly( l.email:code, l.month, l.year, l.email:pc_days, l.paymentcards ) }">
			<MvELSE>									<MvASSIGN NAME = "l.paymentcard_count" VALUE = "{ CustomerAndPaymentCardList_Load_Expiration( l.email:code, l.month, l.year, l.email:pc_days, l.paymentcards ) }">
			</MvIF>

			<MvIF EXPR = "{ l.paymentcard_count EQ 0 }">
				<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>

				<MvWHILESTOP>
			</MvIF>

			<MvFOREACH ITERATOR = "l.paymentcard" ARRAY = "l.paymentcards" COUNT = "{ l.paymentcard_count }">
				<MvCOMMENT>
				|
				| Mark the email as sent before sending it, so that any errors will not perpetually block future scheduled task executions
				|
				</MvCOMMENT>

				<MvASSIGN NAME = "l.templateorderemailxpaymentcard"				VALUE = "">
				<MvASSIGN NAME = "l.templateorderemailxpaymentcard:custpc_id"	VALUE = "{ l.paymentcard:id }">
				<MvASSIGN NAME = "l.templateorderemailxpaymentcard:email_sent"	VALUE = "{ l.email:code }">
				<MvASSIGN NAME = "l.templateorderemailxpaymentcard:pc_days"		VALUE = "{ l.email:pc_days }">

				<MvIF EXPR = "{ NOT TemplateOrderEmailXPaymentCard_InsertOrUpdate( l.templateorderemailxpaymentcard ) }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>

				<MvIF EXPR = "{ NOT ISNULL l.callback_filename AND NOT ISNULL l.callback_function }">
					<MvASSIGN NAME = "l.callback_function_string" VALUE = "{ l.callback_function $ '( l.email, l.paymentcard, l.data )' }">

					<MvASSEMBLY>
						.string asm_7 "l.callback_function_string"
						.string asm_8 "l.callback_filename"
						.string asm_9 "l.callback_function_return_value"

						pushc	asm_8
						pushn
						pushc	asm_7
						pushn
						do_function
						popnc	asm_9
					</MvASSEMBLY>

					<MvIF EXPR = "{ NOT l.callback_function_return_value }">
						<MvFUNCTIONRETURN VALUE = 0>
					</MvIF>
				</MvIF>
			</MvFOREACH>
		</MvWHILE>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAndPaymentCardList_Load_Expiration" PARAMETERS = "email_code, month, year, pc_days, paymentcards var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "{ CustomerAndPaymentCardList_Load_Expiration_LowLevel( l.email_code, l.month, l.year, l.pc_days, 0, l.paymentcards ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAndPaymentCardList_Load_Expiration_SubscriptionsOnly" PARAMETERS = "email_code, month, year, pc_days, paymentcards var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = "{ CustomerAndPaymentCardList_Load_Expiration_LowLevel( l.email_code, l.month, l.year, l.pc_days, 1, l.paymentcards ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "CustomerAndPaymentCardList_Load_Expiration_LowLevel" PARAMETERS = "email_code, month, year, pc_days, linked_to_subscription, paymentcards var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.subscription_from"		VALUE = "">
	<MvASSIGN NAME = "l.subscription_where"		VALUE = "">

	<MvIF EXPR = "{ l.linked_to_subscription }">
		<MvASSIGN NAME = "l.subscription_from"	VALUE = "{ g.Store_Table_Prefix $ 'Subscriptions sub, ' }">
		<MvASSIGN NAME = "l.subscription_where"	VALUE = "cpc.id = sub.custpc_id AND sub.status <> \'C\' AND ">
	</MvIF>

	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "CustomerPaymentCards"
				QUERY	= "{ 'SELECT DISTINCT
								cpc.*,

								pct.type,
								pct.mod_code,
								pct.meth_code,

								cust.id 			AS customer_id,
								cust.account_id 	AS customer_account_id,
								cust.pgrpcount 		AS customer_pgrpcount,
								cust.login 			AS customer_login,
								cust.pw_email 		AS customer_pw_email,
								cust.password 		AS customer_password,
								cust.ship_res 		AS customer_ship_res,
								cust.ship_id 		AS customer_ship_id,
								cust.ship_fname 	AS customer_ship_fname,
								cust.ship_lname 	AS customer_ship_lname,
								cust.ship_email 	AS customer_ship_email,
								cust.ship_comp 		AS customer_ship_comp,
								cust.ship_phone 	AS customer_ship_phone,
								cust.ship_fax 		AS customer_ship_fax,
								cust.ship_addr 		AS customer_ship_addr,
								cust.ship_addr2 	AS customer_ship_addr2,
								cust.ship_city 		AS customer_ship_city,
								cust.ship_state 	AS customer_ship_state,
								cust.ship_zip 		AS customer_ship_zip,
								cust.ship_cntry 	AS customer_ship_cntry,
								cust.bill_id 		AS customer_bill_id,
								cust.bill_fname 	AS customer_bill_fname,
								cust.bill_lname 	AS customer_bill_lname,
								cust.bill_email 	AS customer_bill_email,
								cust.bill_comp 		AS customer_bill_comp,
								cust.bill_phone 	AS customer_bill_phone,
								cust.bill_fax 		AS customer_bill_fax,
								cust.bill_addr 		AS customer_bill_addr,
								cust.bill_addr2 	AS customer_bill_addr2,
								cust.bill_city 		AS customer_bill_city,
								cust.bill_state 	AS customer_bill_state,
								cust.bill_zip 		AS customer_bill_zip,
								cust.bill_cntry 	AS customer_bill_cntry,
								cust.credit 		AS customer_credit,
								cust.note_count 	AS customer_note_count,
								cust.dt_created 	AS customer_dt_created,
								cust.dt_updated 	AS customer_dt_updated,
								cust.dt_login 		AS customer_dt_login
							  FROM ' $
							  	l.subscription_from $
							  	g.Store_Table_Prefix $ 'PaymentCardTypes pct, ' $ 
							  	g.Store_Table_Prefix $ 'Customers cust, ' $
							  	g.Store_Table_Prefix $ 'CustomerPaymentCards cpc
							  	LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXPaymentCard exp ON exp.custpc_id = cpc.id AND ( ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'exp.email_sent' ) $ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( '?' ) $ ' OR exp.pc_days <= ? )
							  WHERE
							  	cust.id	= cpc.cust_id		AND
							  	pct.id	= cpc.type_id		AND ' $
							  	l.subscription_where $ '
							  	(
							  		( cpc.exp_year < ? )	OR
							  		(
							  			cpc.exp_year = ?	AND
							  			cpc.exp_month < ?
							  		)
							  	)							AND
							  	exp.custpc_id IS NULL
							  LIMIT 1000' }"
				FIELDS	= "l.email_code, l.pc_days, l.year, l.year, l.month">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00053', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.count" VALUE = 0>

	<MvWHILE EXPR = "{ NOT CustomerPaymentCards.d.EOF }">
		<MvREFERENCEARRAY NAME = "l.paymentcard" VARIABLE = "l.paymentcards">
			<MvDIMENSION INDEX = "{ ++l.count }">
		</MvREFERENCEARRAY>

		<MvEVAL EXPR = "{ [ g.Module_Feature_PAY_DB ].CustomerPaymentCard_Read( l.paymentcard ) }">

		<MvASSIGN NAME = "l.paymentcard:type" 						VALUE = "{ CustomerPaymentCards.d.type }">
		<MvASSIGN NAME = "l.paymentcard:mod_code" 					VALUE = "{ CustomerPaymentCards.d.mod_code }">
		<MvASSIGN NAME = "l.paymentcard:meth_code"					VALUE = "{ CustomerPaymentCards.d.meth_code }">

		<MvASSIGN NAME = "l.paymentcard:customer:id"				VALUE = "{ CustomerPaymentCards.d.customer_id }">
		<MvASSIGN NAME = "l.paymentcard:customer:account_id"		VALUE = "{ CustomerPaymentCards.d.customer_account_id }">
		<MvASSIGN NAME = "l.paymentcard:customer:pgrpcount"			VALUE = "{ CustomerPaymentCards.d.customer_pgrpcount }">
		<MvASSIGN NAME = "l.paymentcard:customer:login"				VALUE = "{ CustomerPaymentCards.d.customer_login }">
		<MvASSIGN NAME = "l.paymentcard:customer:pw_email"			VALUE = "{ CustomerPaymentCards.d.customer_pw_email }">
		<MvASSIGN NAME = "l.paymentcard:customer:password"			VALUE = "{ CustomerPaymentCards.d.customer_password }">
		
		<MvASSIGN NAME = "l.paymentcard:customer:ship_res"			VALUE = "{ CustomerPaymentCards.d.customer_ship_res }">
		<MvASSIGN NAME = "l.paymentcard:customer:ship_id"			VALUE = "{ CustomerPaymentCards.d.customer_ship_id }">
		<MvASSIGN NAME = "l.paymentcard:customer:ship_fname"		VALUE = "{ CustomerPaymentCards.d.customer_ship_fname }">
		<MvASSIGN NAME = "l.paymentcard:customer:ship_lname"		VALUE = "{ CustomerPaymentCards.d.customer_ship_lname }">
		<MvASSIGN NAME = "l.paymentcard:customer:ship_email"		VALUE = "{ CustomerPaymentCards.d.customer_ship_email }">
		<MvASSIGN NAME = "l.paymentcard:customer:ship_comp"			VALUE = "{ CustomerPaymentCards.d.customer_ship_comp }">
		<MvASSIGN NAME = "l.paymentcard:customer:ship_phone"		VALUE = "{ CustomerPaymentCards.d.customer_ship_phone }">
		<MvASSIGN NAME = "l.paymentcard:customer:ship_fax"			VALUE = "{ CustomerPaymentCards.d.customer_ship_fax }">

		<MvIF EXPR = "{ len( CustomerPaymentCards.d.customer_ship_addr2 ) EQ 0 }">
			<MvASSIGN NAME = "l.paymentcard:customer:ship_addr"		VALUE = "{ CustomerPaymentCards.d.customer_ship_addr }">
		<MvELSE>
			<MvASSIGN NAME = "l.paymentcard:customer:ship_addr"		VALUE = "{ CustomerPaymentCards.d.customer_ship_addr $ ' ' $ CustomerPaymentCards.d.customer_ship_addr2 }">
		</MvIF>

		<MvASSIGN NAME = "l.paymentcard:customer:ship_addr1"		VALUE = "{ CustomerPaymentCards.d.customer_ship_addr }">
		<MvASSIGN NAME = "l.paymentcard:customer:ship_addr2"		VALUE = "{ CustomerPaymentCards.d.customer_ship_addr2 }">
		<MvASSIGN NAME = "l.paymentcard:customer:ship_city"			VALUE = "{ CustomerPaymentCards.d.customer_ship_city }">
		<MvASSIGN NAME = "l.paymentcard:customer:ship_state"		VALUE = "{ CustomerPaymentCards.d.customer_ship_state }">
		<MvASSIGN NAME = "l.paymentcard:customer:ship_zip"			VALUE = "{ CustomerPaymentCards.d.customer_ship_zip }">
		<MvASSIGN NAME = "l.paymentcard:customer:ship_cntry"		VALUE = "{ CustomerPaymentCards.d.customer_ship_cntry }">

		<MvASSIGN NAME = "l.paymentcard:customer:bill_id"			VALUE = "{ CustomerPaymentCards.d.customer_bill_id }">
		<MvASSIGN NAME = "l.paymentcard:customer:bill_fname"		VALUE = "{ CustomerPaymentCards.d.customer_bill_fname }">
		<MvASSIGN NAME = "l.paymentcard:customer:bill_lname"		VALUE = "{ CustomerPaymentCards.d.customer_bill_lname }">
		<MvASSIGN NAME = "l.paymentcard:customer:bill_email"		VALUE = "{ CustomerPaymentCards.d.customer_bill_email }">
		<MvASSIGN NAME = "l.paymentcard:customer:bill_comp"			VALUE = "{ CustomerPaymentCards.d.customer_bill_comp }">
		<MvASSIGN NAME = "l.paymentcard:customer:bill_phone"		VALUE = "{ CustomerPaymentCards.d.customer_bill_phone }">
		<MvASSIGN NAME = "l.paymentcard:customer:bill_fax"			VALUE = "{ CustomerPaymentCards.d.customer_bill_fax }">

		<MvIF EXPR = "{ len( CustomerPaymentCards.d.customer_bill_addr2 ) EQ 0 }">
			<MvASSIGN NAME = "l.paymentcard:customer:bill_addr"		VALUE = "{ CustomerPaymentCards.d.customer_bill_addr }">
		<MvELSE>
			<MvASSIGN NAME = "l.paymentcard:customer:bill_addr"		VALUE = "{ CustomerPaymentCards.d.customer_bill_addr $ ' ' $ CustomerPaymentCards.d.customer_bill_addr2 }">
		</MvIF>

		<MvASSIGN NAME = "l.paymentcard:customer:bill_addr1"		VALUE = "{ CustomerPaymentCards.d.customer_bill_addr }">
		<MvASSIGN NAME = "l.paymentcard:customer:bill_addr2"		VALUE = "{ CustomerPaymentCards.d.customer_bill_addr2 }">
		<MvASSIGN NAME = "l.paymentcard:customer:bill_city"			VALUE = "{ CustomerPaymentCards.d.customer_bill_city }">
		<MvASSIGN NAME = "l.paymentcard:customer:bill_state"		VALUE = "{ CustomerPaymentCards.d.customer_bill_state }">
		<MvASSIGN NAME = "l.paymentcard:customer:bill_zip"			VALUE = "{ CustomerPaymentCards.d.customer_bill_zip }">
		<MvASSIGN NAME = "l.paymentcard:customer:bill_cntry"		VALUE = "{ CustomerPaymentCards.d.customer_bill_cntry }">
		<MvASSIGN NAME = "l.paymentcard:customer:credit"			VALUE = "{ CustomerPaymentCards.d.customer_credit }">
		<MvASSIGN NAME = "l.paymentcard:customer:note_count"		VALUE = "{ CustomerPaymentCards.d.customer_note_count }">
		<MvASSIGN NAME = "l.paymentcard:customer:dt_created"		VALUE = "{ CustomerPaymentCards.d.customer_dt_created }">
		<MvASSIGN NAME = "l.paymentcard:customer:dt_updated"		VALUE = "{ CustomerPaymentCards.d.customer_dt_updated }">
		<MvASSIGN NAME = "l.paymentcard:customer:dt_login"			VALUE = "{ CustomerPaymentCards.d.customer_dt_login }">

		<MvSKIP NAME = "Merchant" VIEW = "CustomerPaymentCards" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "CustomerPaymentCards">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-FUF-TOE-00054', l.count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Execute_AbandonedBasket" PARAMETERS = "task var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.email_count" VALUE = "{ TemplateOrderEmailList_Load_Enabled_AbandonedBasket( l.emails ) }">

	<MvIF EXPR = "{ NOT l.email_count }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvCOMMENT>
	|
	| Process each email.  They are already loaded in descending ab_time order
	|
	</MvCOMMENT>

	<MvFOREACH INDEX = "l.pos" ITERATOR = "l.email" ARRAY = "l.emails" COUNT = "{ l.email_count }">
		<MvCOMMENT>
		|
		| Determine temporal bounds
		|
		</MvCOMMENT>

		<MvASSIGN NAME = "l.now"				VALUE = "{ s.dyn_time_t }">
		<MvASSIGN NAME = "l.max_lastupdate"		VALUE = "{ l.now - ( l.email:ab_time * 60 ) }">

		<MvIF EXPR = "{ l.email:ab_kpalive }">	<MvASSIGN NAME = "l.min_lastupdate" VALUE = 0>
		<MvELSE>								<MvASSIGN NAME = "l.min_lastupdate" VALUE = "{ l.now - ( g.Store:baskexp * 60 ) + 1 }">
		</MvIF>

		<MvCOMMENT>
		|
		| Cap the upper limit at the next highest ab_time in the email chain, if there is one.  Note that multiple emails may have the same ab_time.
		|
		</MvCOMMENT>

		<MvFOR INDEX = "l.offset" FIRST = 1 LAST = "{ l.pos - 1 }">
			<MvIF EXPR = "{ l.emails[ l.pos - l.offset ]:ab_time NE l.email:ab_time }">
				<MvASSIGN NAME = "l.min_lastupdate"	VALUE = "{ l.now - ( l.emails[ l.pos - l.offset ]:ab_time * 60 ) + 1 }">
				<MvFORSTOP>
			</MvIF>
		</MvFOR>

		<MvCOMMENT>
		|
		| Process baskets within the temporal bounds that already have an sNN_TemplateOrderEmailXBasket record
		|
		</MvCOMMENT>

		<MvWHILE EXPR = "{ 1 }">
			<MvASSIGN NAME = "l.basket_count" VALUE = "{ BasketList_Load_Abandoned_Tracked( l.email, l.min_lastupdate, l.max_lastupdate, l.baskets ) }">

			<MvIF EXPR = "{ l.basket_count EQ 0 }">
				<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>

				<MvWHILESTOP>
			</MvIF>

			<MvFOREACH ITERATOR = "l.basket" ARRAY = "l.baskets" COUNT = "{ l.basket_count }">
				<MvCOMMENT>
				|
				| Extend keepalive if necessary
				|
				</MvCOMMENT>

				<MvIF EXPR = "{ l.email:ab_kpalive }">
					<MvASSIGN NAME = "l.basket:lastupdate"	VALUE = "{ s.dyn_time_t + ( l.email:ab_kpmins * 60 ) }">

					<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Basket_Update_LastUpdate( l.basket ) }">
						<MvFUNCTIONRETURN VALUE = 0>
					</MvIF>
				</MvIF>

				<MvCOMMENT>
				|
				| Update tracking record prior to sending the email so that sending errors do not "stick" the process
				|
				</MvCOMMENT>

				<MvIF EXPR = "{ NOT TemplateOrderEmailXBasket_Update_EmailSent( l.basket:basket_id, l.basket:lastupdate, l.email:code, l.email:ab_time ) }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>

				<MvCOMMENT>
				|
				| Send the email
				|
				</MvCOMMENT>
				
				<MvASSIGN NAME = "l.run"					VALUE = "">
				<MvASSIGN NAME = "l.run:on_abandon"			VALUE = 1>
				<MvASSIGN NAME = "l.run:basket"				VALUE = "{ l.basket }">

				<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.run, l.email ) }">
					<MvASSIGN NAME = "l.null" 				VALUE = "{ [ g.Module_Feature_SCH_UT ].ScheduledTask_Log( l.task, 'E', 'Unable to send notification for abandoned basket: ' $ g.Error_Message ) }">
				</MvIF>
			</MvFOREACH>
		</MvWHILE>

		<MvCOMMENT>
		|
		| Process baskets within the temporal bounds that do not have an sNN_TemplateOrderEmailXBasket record
		|
		</MvCOMMENT>

		<MvWHILE EXPR = "{ 1 }">
			<MvASSIGN NAME = "l.basket_count" VALUE = "{ BasketList_Load_Abandoned_Untracked( l.email, l.min_lastupdate, l.max_lastupdate, l.baskets ) }">

			<MvIF EXPR = "{ l.basket_count EQ 0 }">
				<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>

				<MvWHILESTOP>
			</MvIF>

			<MvFOREACH ITERATOR = "l.basket" ARRAY = "l.baskets" COUNT = "{ l.basket_count }">
				<MvASSIGN NAME = "l.templateorderemailxbasket"				VALUE = "">
				<MvASSIGN NAME = "l.templateorderemailxbasket:basket_id"	VALUE = "{ l.basket:basket_id }">
				<MvASSIGN NAME = "l.templateorderemailxbasket:lastupdate"	VALUE = "{ l.basket:lastupdate }">
				<MvASSIGN NAME = "l.templateorderemailxbasket:true_lu"		VALUE = "{ l.basket:lastupdate }">
				<MvASSIGN NAME = "l.templateorderemailxbasket:subtotal" 	VALUE = "{ [ g.Module_Library_DB ].Basket_SubTotal( l.basket:basket_id ) }">
				<MvASSIGN NAME = "l.templateorderemailxbasket:email_sent" 	VALUE = "">
				<MvASSIGN NAME = "l.templateorderemailxbasket:ab_time"	 	VALUE = 0>

				<MvCOMMENT>
				|
				| If this email has a subtotal requirement and the basket does not meet it, we insert a tracking record with an empty email_sent,
				| which caches the subtotal for other emails and will allow the basket to be reevaluated if the email configuration changes.
				|
				</MvCOMMENT>

				<MvIF EXPR = "{ ( l.templateorderemailxbasket:subtotal LT l.email:ab_minsub ) OR
								( ( l.email:ab_maxsub NE 0 ) AND ( l.templateorderemailxbasket:subtotal GT l.email:ab_maxsub ) ) }">
					<MvIF EXPR = "{ NOT TemplateOrderEmailXBasket_InsertOrUpdate( l.templateorderemailxbasket ) }">
						<MvFUNCTIONRETURN VALUE = 0>
					</MvIF>

					<MvFOREACHCONTINUE>
				</MvIF>

				<MvCOMMENT>
				|
				| Extend keepalive if necessary
				|
				</MvCOMMENT>

				<MvIF EXPR = "{ l.email:ab_kpalive }">
					<MvASSIGN NAME = "l.basket:lastupdate"						VALUE = "{ s.dyn_time_t + ( l.email:ab_kpmins * 60 ) }">
					<MvASSIGN NAME = "l.templateorderemailxbasket:lastupdate"	VALUE = "{ l.basket:lastupdate }">

					<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Basket_Update_LastUpdate( l.basket ) }">
						<MvFUNCTIONRETURN VALUE = 0>
					</MvIF>
				</MvIF>

				<MvCOMMENT>
				|
				| Mark the email as sent before sending it, so that any errors will not perpetually block future scheduled task executions
				|
				</MvCOMMENT>

				<MvASSIGN NAME = "l.templateorderemailxbasket:email_sent"	VALUE = "{ l.email:code }">
				<MvASSIGN NAME = "l.templateorderemailxbasket:ab_time"		VALUE = "{ l.email:ab_time }">

				<MvIF EXPR = "{ NOT TemplateOrderEmailXBasket_InsertOrUpdate( l.templateorderemailxbasket ) }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>

				<MvCOMMENT>
				|
				| Send the email
				|
				</MvCOMMENT>

				<MvASSIGN NAME = "l.run"					VALUE = "">
				<MvASSIGN NAME = "l.run:on_abandon"			VALUE = 1>
				<MvASSIGN NAME = "l.run:basket"				VALUE = "{ l.basket }">

				<MvIF EXPR = "{ NOT TemplateOrderEmails_SendEmail( l.run, l.email ) }">
					<MvASSIGN NAME = "l.null" 				VALUE = "{ [ g.Module_Feature_SCH_UT ].ScheduledTask_Log( l.task, 'E', 'Unable to send notification for abandoned basket: ' $ g.Error_Message ) }">
				</MvIF>
			</MvFOREACH>
		</MvWHILE>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "BasketList_Load_Abandoned_Tracked" PARAMETERS = "email var, min_lastupdate, max_lastupdate, baskets var" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT_DISTINCT( l.query, 'b.*,
																				   c.bill_email	AS customer_bill_email' ) }">

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.query, g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket', 'exb' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.query, g.Store_Table_Prefix $ 'Baskets', 'b' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'b', g.Store_Table_Prefix $ 'Customers', 'c', 'c.id = b.cust_id', '' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.query, g.Store_Table_Prefix $ 'BasketItems', 'bi' ) }">

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, 'b.basket_id	= exb.basket_id		AND
																		 b.lastupdate	= exb.lastupdate	AND
																		 bi.basket_id	= b.basket_id		AND
																		 (
																			b.bill_email <> \'\'			OR
																			(
																				c.bill_email IS NOT NULL	AND
																				c.bill_email <> \'\'
																			)
																		 )', '' ) }">

	<MvIF EXPR = "{ l.min_lastupdate }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, 'exb.true_lu >= ?', [ g.Module_Library_DB ].SQL_Query_Field( l.min_lastupdate ) ) }">
	</MvIF>

	<MvIF EXPR = "{ l.max_lastupdate }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, 'exb.true_lu <= ?', [ g.Module_Library_DB ].SQL_Query_Field( l.max_lastupdate ) ) }">
	</MvIF>

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( 'exb.email_sent' ) $ ' <> ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( '?' ), [ g.Module_Library_DB ].SQL_Query_Field( l.email:code ) ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, 'exb.ab_time < ?', [ g.Module_Library_DB ].SQL_Query_Field( l.email:ab_time ) ) }">

	<MvIF EXPR = "{ l.email:ab_minsub }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, 'exb.subtotal >= ?', [ g.Module_Library_DB ].SQL_Query_Field( l.email:ab_minsub ) ) }">
	</MvIF>

	<MvIF EXPR = "{ l.email:ab_maxsub }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, 'exb.subtotal <= ?', [ g.Module_Library_DB ].SQL_Query_Field( l.email:ab_maxsub ) ) }">
	</MvIF>

	<MvASSIGN NAME = "l.sql" VALUE = "{ [ g.Module_Library_DB ].SQL_Query_Build( l.query, l.fields ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Baskets', l.sql, l.fields, 0, 1000 ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00070', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.count" VALUE = 0>

	<MvWHILE EXPR = "{ NOT Baskets.d.EOF }">
		<MvREFERENCEARRAY NAME = "l.basket" VARIABLE = "l.baskets">
			<MvDIMENSION INDEX = "{ ++l.count }">
		</MvREFERENCEARRAY>

		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].Basket_Read( l.basket ) }">

		<MvIF EXPR = "{ ISNULL l.basket:bill_email }">
			<MvASSIGN NAME = "l.basket:bill_email" VALUE = "{ Baskets.d.customer_bill_email }">
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "Baskets" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Baskets">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-FUF-TOE-00071', l.count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "BasketList_Load_Abandoned_Untracked" PARAMETERS = "email var, min_lastupdate, max_lastupdate, baskets var" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_SELECT_DISTINCT( l.query, 'b.*,
																				   c.bill_email	AS customer_bill_email' ) }">

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.query, g.Store_Table_Prefix $ 'Baskets', 'b' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'b', g.Store_Table_Prefix $ 'Customers', 'c', 'c.id = b.cust_id', '' ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_LEFT_OUTER_JOIN( l.query, 'b', g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket', 'exb', 'exb.basket_id = b.basket_id AND ( exb.lastupdate = b.lastupdate OR ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( 'exb.email_sent' ) $ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( '?' ) $ ')', [ g.Module_Library_DB ].SQL_Query_Field( l.email:code ) ) }">
	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_FROM( l.query, g.Store_Table_Prefix $ 'BasketItems', 'bi' ) }">

	<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, 'exb.basket_id IS NULL				AND
																		 bi.basket_id	= b.basket_id		AND
																		 (
																			b.bill_email <> \'\'			OR
																			(
																				c.bill_email IS NOT NULL	AND
																				c.bill_email <> \'\'
																			)
																		 )', '' ) }">

	<MvIF EXPR = "{ l.min_lastupdate }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, 'b.lastupdate >= ?', [ g.Module_Library_DB ].SQL_Query_Field( l.min_lastupdate ) ) }">
	</MvIF>

	<MvIF EXPR = "{ l.max_lastupdate }">
		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].SQL_Query_WHERE( l.query, 'b.lastupdate <= ?', [ g.Module_Library_DB ].SQL_Query_Field( l.max_lastupdate ) ) }">
	</MvIF>

	<MvASSIGN NAME = "l.sql" VALUE = "{ [ g.Module_Library_DB ].SQL_Query_Build( l.query, l.fields ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Library_Native_DBAPI ].DB_OPENVIEW_Range( 'Merchant', 'Baskets', l.sql, l.fields, 0, 1000 ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00117', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvASSIGN NAME = "l.count" VALUE = 0>

	<MvWHILE EXPR = "{ NOT Baskets.d.EOF }">
		<MvREFERENCEARRAY NAME = "l.basket" VARIABLE = "l.baskets">
			<MvDIMENSION INDEX = "{ ++l.count }">
		</MvREFERENCEARRAY>

		<MvEVAL EXPR = "{ [ g.Module_Library_DB ].Basket_Read( l.basket ) }">

		<MvIF EXPR = "{ ISNULL l.basket:bill_email }">
			<MvASSIGN NAME = "l.basket:bill_email" VALUE = "{ Baskets.d.customer_bill_email }">
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "Baskets" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Baskets">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-FUF-TOE-00118', l.count ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Execute_Subscription_Pending" PARAMETERS = "module var, task var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.data"			VALUE = "">
	<MvREFERENCE NAME = "l.data:task"	VARIABLE = "l.task">

	<MvFUNCTIONRETURN VALUE = "{ TemplateOrderEmails_Process_SubscriptionPending( s.dyn_time_t, g.Module_Root $ l.module:module, 'ScheduledTaskModule_Execute_Subscription_Pending_SendEmail', l.data ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "ScheduledTaskModule_Execute_Subscription_Pending_SendEmail" PARAMETERS = "email var, subscriptions var, subscription_count, data var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.run"			VALUE = "">
	<MvASSIGN NAME = "l.run:on_sub_pnd"	VALUE = 1>

	<MvIF EXPR = "{ NOT TemplateOrderEmails_SendSubscriptionEmail( l.run, l.email, l.subscriptions, l.subscription_count ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_SCH_UT ].ScheduledTask_Log( l.data:task, 'E', 'Unable to send pending subscription notification: ' $ g.Error_Message ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "TemplateOrderEmails_Process_SubscriptionPending" PARAMETERS = "asof, callback_filename, callback_function, data var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.email_count" VALUE = "{ TemplateOrderEmailList_Load_Enabled_SubscriptionPending( l.emails ) }">

	<MvIF EXPR = "{ NOT l.email_count }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvCOMMENT>
	|
	| Process each email.  They are already loaded in ascending sub_days order
	|
	</MvCOMMENT>

	<MvFOREACH ITERATOR = "l.email" ARRAY = "l.emails" COUNT = "{ l.email_count }">
		<MvASSIGN NAME = "l.last_cust_id"			VALUE = -1>
		<MvASSIGN NAME = "l.last_addr_id"			VALUE = -1>
		<MvASSIGN NAME = "l.last_ship_id"			VALUE = -1>
		<MvASSIGN NAME = "l.last_custpc_id"			VALUE = -1>
		<MvASSIGN NAME = "l.last_ship_data"			VALUE = "">
		<MvASSIGN NAME = "l.subscriptiongroup"		VALUE = "">

		<MvCOMMENT>
		|
		| Determine upper / lower bounds
		|
		</MvCOMMENT>

		<MvASSIGN NAME = "l.previous_max_nextdate"	VALUE = "{ l.max_nextdate }">
		<MvASSIGN NAME = "l.min_nextdate"			VALUE = "{ max( 0, l.previous_max_nextdate ) }">
		<MvASSIGN NAME = "l.max_nextdate"			VALUE = "{ l.asof + ( ( 60 * 60 * 24 ) * l.email:sub_days ) }">

		<MvCOMMENT>
		|
		| Process subscriptions within the upper / lower bounds that do not have an sNN_TemplateOrderEmailXSubscription record
		|
		</MvCOMMENT>

		<MvWHILE EXPR = "{ 1 }">
			<MvASSIGN NAME = "l.subscription_count" VALUE = "{ SubscriptionList_Load_Pending( l.email:code, l.email:sub_days, l.min_nextdate, l.max_nextdate, l.subscriptions ) }">

			<MvIF EXPR = "{ l.subscription_count EQ 0 }">
				<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>

				<MvIF EXPR = "{ NOT ISNULL l.subscriptiongroup }">
					<MvIF EXPR = "{ NOT ISNULL l.callback_filename AND NOT ISNULL l.callback_function }">
						<MvASSIGN NAME = "l.callback_function_string" VALUE = "{ l.callback_function $ '( l.email, l.subscriptiongroup:subscriptions, l.subscriptiongroup:subscription_count, l.data )' }">

						<MvASSEMBLY>
							.string asm_0 "l.callback_function_string"
							.string asm_1 "l.callback_filename"
							.string asm_2 "l.callback_function_return_value"

							pushc	asm_1
							pushn
							pushc	asm_0
							pushn
							do_function
							popnc	asm_2
						</MvASSEMBLY>

						<MvIF EXPR = "{ NOT l.callback_function_return_value }">
							<MvFUNCTIONRETURN VALUE = 0>
						</MvIF>
					</MvIF>
				</MvIF>

				<MvWHILESTOP>
			</MvIF>

			<MvFOREACH ITERATOR = "l.subscription" ARRAY = "l.subscriptions" COUNT = "{ l.subscription_count }">
				<MvIF EXPR = "{ ( l.subscription:cust_id NE l.last_cust_id ) OR
								( l.subscription:addr_id NE l.last_addr_id ) OR
								( l.subscription:ship_id NE l.last_ship_id ) OR
								( l.subscription:custpc_id NE l.last_custpc_id ) OR
								( l.subscription:ship_data NE l.last_ship_data ) }">
					<MvIF EXPR = "{ NOT ISNULL l.subscriptiongroup }">
						<MvIF EXPR = "{ NOT ISNULL l.callback_filename AND NOT ISNULL l.callback_function }">
							<MvASSIGN NAME = "l.callback_function_string" VALUE = "{ l.callback_function $ '( l.email, l.subscriptiongroup:subscriptions, l.subscriptiongroup:subscription_count, l.data )' }">

							<MvASSEMBLY>
								.string asm_4 "l.callback_function_string"
								.string asm_5 "l.callback_filename"
								.string asm_6 "l.callback_function_return_value"

								pushc	asm_5
								pushn
								pushc	asm_4
								pushn
								do_function
								popnc	asm_6
							</MvASSEMBLY>

							<MvIF EXPR = "{ NOT l.callback_function_return_value }">
								<MvFUNCTIONRETURN VALUE = 0>
							</MvIF>
						</MvIF>
					</MvIF>

					<MvASSIGN NAME = "l.last_cust_id"		VALUE = "{ l.subscription:cust_id }">
					<MvASSIGN NAME = "l.last_addr_id"		VALUE = "{ l.subscription:addr_id }">
					<MvASSIGN NAME = "l.last_ship_id"		VALUE = "{ l.subscription:ship_id }">
					<MvASSIGN NAME = "l.last_custpc_id"		VALUE = "{ l.subscription:custpc_id }">
					<MvASSIGN NAME = "l.last_ship_data"		VALUE = "{ l.subscription:ship_data }">
					<MvASSIGN NAME = "l.subscriptiongroup"	VALUE = "">
				</MvIF>

				<MvCOMMENT>
				|
				| Mark the email as sent before sending it, so that any errors will not perpetually block future scheduled task executions
				|
				</MvCOMMENT>

				<MvASSIGN NAME = "l.templateorderemailxsubscription"			VALUE = "{ l.email:code }">
				<MvASSIGN NAME = "l.templateorderemailxsubscription:subscrp_id"	VALUE = "{ l.subscription:id }">
				<MvASSIGN NAME = "l.templateorderemailxsubscription:nextdate"	VALUE = "{ l.subscription:nextdate }">
				<MvASSIGN NAME = "l.templateorderemailxsubscription:email_sent"	VALUE = "{ l.email:code }">
				<MvASSIGN NAME = "l.templateorderemailxsubscription:sub_days"	VALUE = "{ l.email:sub_days }">

				<MvIF EXPR = "{ NOT TemplateOrderEmailXSubscription_InsertOrUpdate( l.templateorderemailxsubscription ) }">
					<MvFUNCTIONRETURN VALUE = 0>
				</MvIF>

				<MvASSIGN NAME = "l.subscriptiongroup:subscription_count" VALUE = "{ miva_array_insert_var( l.subscriptiongroup:subscriptions, l.subscription, -1 ) }">
			</MvFOREACH>
		</MvWHILE>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionList_Load_Pending" PARAMETERS = "email_code, sub_days, min_nextdate, max_nextdate, subscriptions var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.subscriptions"		VALUE = "">
	<MvASSIGN NAME = "l.subscription_count"	VALUE = 0>

	<MvOPENVIEW NAME	= "Merchant"
				VIEW	= "Subscriptions"
				QUERY	= "{ 'SELECT
								sub.*,
								pst.id			AS pst_id,
								pst.product_id	AS pst_prod_id,
								pst.frequency	AS pst_frequency,
								pst.term		AS pst_term,
								pst.descrip		AS pst_descrip,
								pst.n			AS pst_n,
								pst.fixed_dow	AS pst_fixed_dow,
								pst.fixed_dom	AS pst_fixed_dom,
								pst.sub_count	AS pst_sub_count,
								pst.disp_order	AS pst_disp_order
							  FROM
								' $ g.Store_Table_Prefix $ 'SubscriptionSettings sset,
								' $ g.Store_Table_Prefix $ 'Subscriptions sub
								LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXSubscription exs ON exs.subscrp_id = sub.id AND exs.nextdate = sub.nextdate AND ( ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_UPPER( 'exs.email_sent' ) $ ' = ' $ [ g.Module_Library_Native_DBAPI ].DB_Compare_Upper( '?' ) $ ' OR exs.sub_days <= ? ),
								' $ g.Store_Table_Prefix $ 'ProductSubscriptionTerms pst
							  WHERE
								sub.status		<> \'C\'														AND
								sub.nextdate	> ?																AND
								sub.nextdate	<= ?															AND
								pst.id			= sub.subterm_id												AND
								( pst.term = 0 OR sub.termrem > 0 ) 											AND
								( sub.authfails = 0 OR ( sub.lastafail + ( sset.afaildelay * 86400 ) ) < ? )	AND
								exs.subscrp_id IS NULL
							  ORDER BY
								sub.cust_id, sub.addr_id, sub.ship_id, sub.ship_data, sub.custpc_id, sub.nextdate, sub.id
							  LIMIT 1000' }"
				FIELDS	= "l.email_code, l.sub_days, l.min_nextdate, l.max_nextdate, l.max_nextdate">
	<MvIF EXPR = "{ g.MvOPENVIEW_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00119', g.MvOPENVIEW_Error ) }">
	</MvIF>

	<MvWHILE EXPR = "{ NOT Subscriptions.d.EOF }">
		<MvASSIGN NAME = "l.subscription"					VALUE = "">
		
		<MvEVAL EXPR = "{ [ g.Module_Feature_SUB_DB ].Subscription_Read( l.subscription ) }">

		<MvASSIGN NAME = "l.subscription:term:id"			VALUE = "{ Subscriptions.d.pst_id }">
		<MvASSIGN NAME = "l.subscription:term:product_id"	VALUE = "{ Subscriptions.d.pst_prod_id }">
		<MvASSIGN NAME = "l.subscription:term:frequency"	VALUE = "{ Subscriptions.d.pst_frequency }">
		<MvASSIGN NAME = "l.subscription:term:term"			VALUE = "{ Subscriptions.d.pst_term }">
		<MvASSIGN NAME = "l.subscription:term:descrip"		VALUE = "{ Subscriptions.d.pst_descrip }">
		<MvASSIGN NAME = "l.subscription:term:n"			VALUE = "{ Subscriptions.d.pst_n }">
		<MvASSIGN NAME = "l.subscription:term:fixed_dow"	VALUE = "{ Subscriptions.d.pst_fixed_dow }">
		<MvASSIGN NAME = "l.subscription:term:fixed_dom"	VALUE = "{ Subscriptions.d.pst_fixed_dom }">
		<MvASSIGN NAME = "l.subscription:term:sub_count"	VALUE = "{ Subscriptions.d.pst_sub_count }">
		<MvASSIGN NAME = "l.subscription:term:disp_order"	VALUE = "{ Subscriptions.d.pst_disp_order }">

		<MvIF EXPR = "{ [ g.Module_Library_DB ].Product_Load_ID_WithRuntimeInventory( l.subscription:product_id, l.subscription:product ) }">
			<MvASSIGN NAME = "l.subscription:option_count"		VALUE = "{ [ g.Module_Feature_SUB_DB ].SubscriptionOptionList_Load_Subscription( l.subscription:id, l.subscription:options ) }">
			<MvASSIGN NAME = "l.subscription:attribute_count"	VALUE = "{ [ g.Module_Feature_SUB_UT ].SubscriptionOptions_BuildAttributes( l.subscription:options, l.subscription:option_count, l.subscription:attributes ) }">

			<MvIF EXPR = "{ [ g.Module_Feature_SUB_UT ].Subscription_Validate_Attributes_DetermineVariant( l.subscription, l.subscription:product, l.subscription:attributes, l.subscription:attribute_count, l.subscription:basketoptions, l.subscription:basketoption_count ) }">
				<MvIF EXPR = "{ [ g.Module_Feature_INV_RT ].Inventory_Adjust_VariantPricing( l.subscription:product, l.subscription:variant_id, l.subscription:attr_price_override ) }">
					<MvASSIGN NAME = "l.subscription_count" VALUE = "{ miva_array_insert_var( l.subscriptions, l.subscription, -1 ) }">
				</MvIF>
			</MvIF>
		</MvIF>

		<MvSKIP NAME = "Merchant" VIEW = "Subscriptions" ROWS = 1>
	</MvWHILE>

	<MvCLOSEVIEW NAME = "Merchant" VIEW = "Subscriptions">
	<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_DB ].ListLoad_EOF_Return( 'MER-FUF-TOE-00120', l.subscription_count ) }">
</MvFUNCTION>

<MvCOMMENT>
|
| Cleanup Store Feature (cleanup_store)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Cleanup_Store" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Cleanup_Baskets" PARAMETERS = "module var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvIF EXPR = "{ g.Native_DBAPI EQ 'postgresql' }">
		<MvQUERY NAME 	= "Merchant"
				 QUERY 	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket bxe1
				 			  USING ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket bxe2
				 			  	LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'Baskets b ON b.basket_id = bxe2.basket_id
				 			  WHERE
				 			  	bxe1.basket_id = bxe2.basket_id AND
				 			  	b.basket_id IS NULL' }">
		<MvIF EXPR = "{ g.MvQUERY_Error }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00099', g.MvQUERY_Error ) }">
		</MvIF>
	<MvELSE>
		<MvQUERY NAME	= "Merchant"
				 QUERY	= "{ 'DELETE
								bxe
							  FROM
								' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXBasket bxe
								LEFT OUTER JOIN ' $ g.Store_Table_Prefix $ 'Baskets b ON b.basket_id = bxe.basket_id
							  WHERE
								b.basket_id IS NULL' }">
		<MvIF EXPR = "{ g.MvQUERY_Error }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00082', g.MvQUERY_Error ) }">
		</MvIF>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvCOMMENT>
|
| Component Module Feature (component)
|
</MvCOMMENT>

<MvFUNCTION NAME = "ComponentModule_Tabs" PARAMETERS = "module var, item, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' }">		<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Tabs( l.module, l.item, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_subscriptions' }">		<MvFUNCTIONRETURN VALUE = "{ SubscriptionsComponentModule_Tabs( l.module, l.item, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Tabs( l.module, l.item, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Tabs( l.module, l.item, l.settings ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "">
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Tabs" PARAMETERS = "module var, item, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.tabs" VALUE = "{ 'GT_PAGE/' $ l.item $ ':Subscription Fields' }">

	<MvIF EXPR = "{ miva_array_elements( l.settings:imagetypes ) GT 0 }">
		<MvASSIGN NAME = "l.tabs" VALUE = "{ l.tabs $ ',GT_PAGE/' $ l.item $ '_dimensions:Subscription Fields Image Dimensions' }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ l.tabs }">
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionsComponentModule_Tabs" PARAMETERS = "module var, item, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.tabs" VALUE = "{ 'GT_PAGE/' $ l.item $ ':Subscription List Fields' }">

	<MvIF EXPR = "{ miva_array_elements( l.settings:imagetypes ) GT 0 }">
		<MvASSIGN NAME = "l.tabs" VALUE = "{ l.tabs $ ',GT_PAGE/' $ l.item $ '_dimensions:Subscription List Fields Image Dimensions' }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "{ l.tabs }">
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Validate" PARAMETERS = "module var, item, field_prefix, fields var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' OR
					l.item EQ 'toe_subscriptions' }">			<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Validate( l.module, l.item, l.field_prefix, l.fields, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Validate( l.module, l.item, l.field_prefix, l.fields, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Validate( l.module, l.item, l.field_prefix, l.fields, l.settings ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Validate" PARAMETERS = "module var, item, field_prefix, fields var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].ManagedTemplate_Load_Filename( l.fields:template_filename, l.managedtemplate ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.fields:b_width"						VALUE = "{ trim( l.fields:b_width ) }">
	<MvASSIGN NAME = "l.fields:b_height"					VALUE = "{ trim( l.fields:b_height ) }">
	<MvASSIGN NAME = "l.fields:lineitemprice"				VALUE = "{ trim( l.fields:lineitemprice ) }">
	<MvASSIGN NAME = "l.fields:lineitemdiscounts"			VALUE = "{ [ g.Module_Admin ].Trim_Boolean( l.fields:lineitemdiscounts ) }">
	<MvASSIGN NAME = "l.fields:display:shipping"			VALUE = "{ [ g.Module_Admin ].Trim_Boolean( l.fields:display:shipping ) }">
	<MvASSIGN NAME = "l.fields:display:handling"			VALUE = "{ [ g.Module_Admin ].Trim_Boolean( l.fields:display:handling ) }">
	<MvASSIGN NAME = "l.fields:display:salestax"			VALUE = "{ [ g.Module_Admin ].Trim_Boolean( l.fields:display:salestax ) }">
	<MvASSIGN NAME = "l.fields:display:discounts"			VALUE = "{ [ g.Module_Admin ].Trim_Boolean( l.fields:display:discounts ) }">

	<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_WholeNumber_Positive_Required( l.fields:b_width ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( l.item $ '_dimensions', l.field_prefix $ 'b_width', g.Validation_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Admin ].Validate_WholeNumber_Positive_Required( l.fields:b_height ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( l.item $ '_dimensions', l.field_prefix $ 'b_height', g.Validation_Message ) }">
	</MvIF>

	<MvIF EXPR = "{ l.fields:advanced }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Validate_Compilation( l.fields:template_code ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Admin ].FieldError( l.item, l.field_prefix $ 'template_code', g.Error_Message ) }">
		</MvIF>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Update" PARAMETERS = "module var, item, field_prefix, fields var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' OR
					l.item EQ 'toe_subscriptions' }">			<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Update( l.module, l.item, l.field_prefix, l.fields, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Update( l.module, l.item, l.field_prefix, l.fields, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Update( l.module, l.item, l.field_prefix, l.fields, l.settings ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Update" PARAMETERS = "module var, item, field_prefix, fields var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].ManagedTemplate_Load_Filename( l.settings:template_filename, l.managedtemplate ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.settings:advanced"						VALUE = "{ l.fields:advanced }">
	<MvASSIGN NAME = "l.settings:display:shipping"				VALUE = "{ l.fields:display:shipping }">
	<MvASSIGN NAME = "l.settings:display:handling"				VALUE = "{ l.fields:display:handling }">
	<MvASSIGN NAME = "l.settings:display:salestax"				VALUE = "{ l.fields:display:salestax }">
	<MvASSIGN NAME = "l.settings:display:discounts"				VALUE = "{ l.fields:display:discounts }">

	<MvASSIGN NAME = "l.selectedfield_count"					VALUE = "{ [ g.Module_Library_Utilities ].CustomFieldSelect_Selected( l.fields:fields_custom, l.settings:fields_custom ) }">

	<MvIF EXPR = "{ l.fields:advanced }">
		<MvASSIGN NAME = "l.imagetype_count"					VALUE = "{ [ g.Module_Library_Utilities ].ImageTypeSelect_Selected( l.fields:imagetypes, l.settings:imagetypes ) }">
	<MvELSE>
		<MvASSIGN NAME = "l.settings:imagetypes"				VALUE = "">
		<MvIF EXPR = "{ NOT ISNULL l.fields:image }">
			<MvIF EXPR = "{ [ g.Module_Library_DB ].ImageType_Load_Code( l.fields:image, l.imagetype ) }">
				<MvASSIGNARRAY NAME = "l.settings"				VALUE = "{ l.imagetype:code }">
					<MvMEMBER NAME = "imagetypes">
					<MvDIMENSION INDEX = 1>
				</MvASSIGNARRAY>
			</MvIF>
		</MvIF>

		<MvASSIGN NAME = "l.settings:lineitemprice"				VALUE = "{ l.fields:lineitemprice }">
		<MvASSIGN NAME = "l.settings:lineitemdiscounts"			VALUE = "{ l.fields:lineitemdiscounts }">
	</MvIF>

	<MvCOMMENT>
	|
	| These settings are common between advanced and point + click mode
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.settings:constrain"						VALUE = "{ l.fields:constrain }">
	<MvASSIGN NAME = "l.settings:b_width"						VALUE = "{ l.fields:b_width }">
	<MvASSIGN NAME = "l.settings:b_height"						VALUE = "{ l.fields:b_height }">

	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-FUF-TOE-00055', l.module:name $ ' \'' $ l.item $ '\' settings updated' ) }">

	<MvIF EXPR = "{ NOT l.fields:advanced }">
		<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' }">		<MvEVAL EXPR = "{ SubscriptionComponentModule_Generate_Code( l.settings, l.fields:template_code ) }">
		<MvELSEIF EXPR = "{ l.item EQ 'toe_subscriptions' }">		<MvEVAL EXPR = "{ SubscriptionsComponentModule_Generate_Code( l.settings, l.fields:template_code ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_CreateIfModified_ManagedTemplateVersion( l.managedtemplate, '', l.fields:template_code, l.settings ) }">
		<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Admin ].FieldError( l.item, l.field_prefix $ 'template_code', g.Error_Message ) }">
		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Content" PARAMETERS = "module var, item, tab, load_fields, field_prefix, fields var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' OR
					l.item EQ 'toe_subscriptions' }">			<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Content( l.module, l.item, l.tab, l.load_fields, l.field_prefix, l.fields, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Content( l.module, l.item, l.tab, l.load_fields, l.field_prefix, l.fields, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Content( l.module, l.item, l.tab, l.load_fields, l.field_prefix, l.fields, l.settings ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Content" PARAMETERS = "module var, item, tab, load_fields, field_prefix, fields var, settings var" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].ManagedTemplateVersion_Load_Filename_Current( l.settings:template_filename, l.templateversion ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvCOMMENT>
	|
	| Load all image types
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.imagetype_count"						VALUE = "{ [ g.Module_Library_DB ].ImageTypeList_Load_All( l.imagetypes ) }">

	<MvIF EXPR = "{ l.load_fields }">
		<MvIF EXPR = "{ ISNULL l.settings:constrain }">
			<MvASSIGN NAME = "l.fields:constrain"				VALUE = "B">
		<MvELSE>
			<MvASSIGN NAME = "l.fields:constrain"				VALUE = "{ l.settings:constrain }">
		</MvIF>

		<MvIF EXPR = "{ ISNULL l.settings:b_width }">
			<MvASSIGN NAME = "l.fields:b_width"					VALUE = 75>
		<MvELSE>
			<MvASSIGN NAME = "l.fields:b_width"					VALUE = "{ l.settings:b_width }">
		</MvIF>

		<MvIF EXPR = "{ ISNULL l.settings:b_height }">
			<MvASSIGN NAME = "l.fields:b_height"				VALUE = 75>
		<MvELSE>
			<MvASSIGN NAME = "l.fields:b_height"				VALUE = "{ l.settings:b_height }">
		</MvIF>

		<MvASSIGN NAME = "l.fields:display:shipping"			VALUE = "{ l.settings:display:shipping }">
		<MvASSIGN NAME = "l.fields:display:handling"			VALUE = "{ l.settings:display:handling }">
		<MvASSIGN NAME = "l.fields:display:salestax"			VALUE = "{ l.settings:display:salestax }">
		<MvASSIGN NAME = "l.fields:display:discounts"			VALUE = "{ l.settings:display:discounts }">
		<MvASSIGN NAME = "l.fields:lineitemprice"				VALUE = "{ l.settings:lineitemprice }">
		<MvASSIGN NAME = "l.fields:advanced"					VALUE = "{ l.settings:advanced }">
		<MvASSIGN NAME = "l.fields:template_code"				VALUE = "{ l.templateversion:source }">
		<MvASSIGN NAME = "l.fields:template_filename"			VALUE = "{ l.settings:template_filename }">
		<MvASSIGN NAME = "l.fields:lineitemdiscounts"			VALUE = "{ l.settings:lineitemdiscounts }">
		<MvASSIGN NAME = "l.fields:imagetypes"					VALUE = "{ l.settings:imagetypes }">
		<MvASSIGN NAME = "l.fields:image"						VALUE = "{ l.settings:imagetypes[ 1 ] }">

		<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].InitializeCustomFieldSelect( l.settings:fields_custom, l.fields:fields_custom ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Admin ].Tab_Visible( l.tab, l.item ) }">
		<MvEVAL EXPR = "{ [ g.Module_Feature_TUI_AD ].TUI_Hide_ComponentFields( l.field_prefix, 'fields_custom,image,imagetypes,lineitemprice,lineitemdiscounts,display:shipping,display:handling,display:salestax,display:discounts,template_code,template_filename,advanced' ) }">
	<MvELSE>
		<MvEVAL EXPR = "{ [ g.Module_Admin ].DrawGroupTabEntry_Start( 'GT_PAGE', l.item ) }">
		<MvEVAL EXPR = "{ [ g.Module_Feature_TUI_AD ].TUI_Hide_ComponentFields( l.field_prefix, 'template_filename' ) }">
		<table border="0" cellpadding="2" cellspacing="0" width="100%">
		<MvIF EXPR = "{ NOT l.fields:advanced }">
			<MvEVAL EXPR = "{ [ g.Module_Feature_TUI_AD ].TUI_Hide_ComponentFields( l.field_prefix, 'template_code' ) }">
		<MvELSE>
			<tr><td colspan="2" width="100%">
				<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawTemplateTextArea_WithRecall( l.field_prefix $ 'template_code', l.fields:template_code, 20, 100, l.templateversion:templ_id ) }">
			</td></tr>
		</MvIF>

		<MvASSIGN NAME = "l.customfield_count" VALUE = "{ [ g.Module_Library_Utilities ].ProductCustomFieldList_Load( l.customfields ) }">

		<MvIF EXPR = "{ l.customfield_count }">
			<tr><td align="left" valign="top" nowrap>
				<b>Custom Fields:</b>
			</td><td align="left" width="100%">
				<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCustomFieldSelect( l.field_prefix $ 'fields_custom', l.fields:fields_custom, l.customfields, l.customfield_count ) }">
			</td></tr>
		</MvIF>

		<MvIF EXPR = "{ l.imagetype_count EQ 0 }">
			<MvEVAL EXPR = "{ [ g.Module_Feature_TUI_AD ].TUI_Hide_ComponentFields( l.field_prefix, 'image,imagetypes' ) }">
		<MvELSE>
			<MvIF EXPR = "{ l.fields:advanced }">
				<MvEVAL EXPR = "{ [ g.Module_Feature_TUI_AD ].TUI_Hide_ComponentFields( l.field_prefix, 'image' ) }">

				<tr><td align="left" valign="top" nowrap>
					<b>Product Images:</b>
				</td><td align="left" width="100%">
					<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawImageTypeSelect( l.field_prefix $ 'imagetypes', l.fields:imagetypes, l.imagetypes, l.imagetype_count ) }">
				</td></tr>
			<MvELSE>
				<MvEVAL EXPR = "{ [ g.Module_Feature_TUI_AD ].TUI_Hide_ComponentFields( l.field_prefix, 'imagetypes' ) }">

				<tr><td align="left" valign="top" nowrap>
					<b>Image:</b>
				</td><td align="left" width="100%">
					<select name="{ encodeentities( l.field_prefix ) $ 'image' }">
						<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawOption( '', l.fields:image, 'None' ) }">

						<MvFOREACH ITERATOR = "l.imagetype" ARRAY = "l.imagetypes" COUNT = "{ l.imagetype_count }">
							<MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawOption( l.imagetype:code, l.fields:image, encodeentities( l.imagetype:descrip ) ) }">
						</MvFOREACH>
					</select>
				</td></tr>
			</MvIF>
		</MvIF>

		<MvIF EXPR = "{ l.fields:advanced }">
			<MvEVAL EXPR = "{ [ g.Module_Feature_TUI_AD ].TUI_Hide_ComponentFields( l.field_prefix, 'lineitemprice,lineitemdiscounts' ) }">
		<MvELSE>
			<tr><td align="left" nowrap valign="top">
				<b>Line Item Discounts:</b>
			</td><td width="100%">
				<label><MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckBox( l.fields:lineitemdiscounts, l.field_prefix $ 'lineitemdiscounts', 1, 'Display Line Item Discount Details' ) }"></label>
			</td></tr>

			<tr><td align="left" nowrap valign="top">
				<b>Additional Price Display</b>
			</td><td align="left" nowrap width="100%">
				<label><MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawRadio( l.field_prefix $ 'lineitemprice', '',		l.fields:lineitemprice,	'None' ) }"></label><br />
				<label><MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawRadio( l.field_prefix $ 'lineitemprice', 'retail',	l.fields:lineitemprice, 'Retail Price' ) }"></label><br />
				<label><MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawRadio( l.field_prefix $ 'lineitemprice', 'base',	l.fields:lineitemprice, 'Base Price (includes any legacy price group discounts but does not reflect sales, coupons or discounts applied in the basket)' ) }"></label>
			</td></tr>
		</MvIF>

		<tr><td align="left" valign="top" nowrap>
			<b>Subscription Charges/Discounts:</b>
		</td><td align="left" width="100%">
			<label><MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( l.fields:display:shipping,	l.field_prefix $ 'display:shipping',	1, 'Display Estimated Shipping Charges' ) }"></label><br />
			<label><MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( l.fields:display:handling,	l.field_prefix $ 'display:handling',	1, 'Display Estimated Handling Charge' ) }"></label><br />
			<label><MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( l.fields:display:salestax,	l.field_prefix $ 'display:salestax',	1, 'Display Estimated Sales Tax' ) }"></label><br />
			<label><MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawCheckbox( l.fields:display:discounts,	l.field_prefix $ 'display:discounts',	1, 'Display Other Subscription Level Discounts' ) }"></label>
		</td></tr>

		<tr><td>
			&nbsp;
		</td><td width="100%">
			<input type="hidden" name="{ encodeentities( l.field_prefix ) $ 'advanced' }" value="{ encodeentities( l.fields:advanced ) }">
			<MvIF EXPR = "{ l.fields:advanced }">
				<a href="#" onclick="{ 'Toggle( \'' $ [ g.Module_Admin ].JavaScriptEncode( l.field_prefix ) $ 'advanced' $ '\', 0 ); return false;' }">Point + Click Mode</a>
			<MvELSE>
				<a href="#" onclick="{ 'Toggle( \'' $ [ g.Module_Admin ].JavaScriptEncode( l.field_prefix ) $ 'advanced' $ '\', 1 ); return false;' }">Advanced Mode</a>
			</MvIF>
		</td></tr>
		</table>
		<MvEVAL EXPR = "{ [ g.Module_Admin ].DrawGroupTabEntry_End() }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Admin ].Tab_Visible( l.tab, l.item $ '_dimensions' ) }">
		<MvEVAL EXPR = "{ [ g.Module_Feature_TUI_AD ].TUI_Hide_ComponentFields( l.field_prefix, 'constrain,b_width,b_height' ) }">
	<MvELSE>
		<MvEVAL EXPR = "{ [ g.Module_Admin ].DrawGroupTabEntry_Start( 'GT_PAGE', l.item $ '_dimensions' ) }">
		<table border="0" cellpadding="2" cellspacing="0" width="100%">
			<tr>
				<td align="left" valign="top" nowrap><b>Product Image:</b></td>
				<td align="left" width="100%">
					<label><MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawRadio( l.field_prefix $ 'constrain', 'N', l.fields:constrain, 'No constraints' ) }"></label><br />
					<label><MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].DrawRadio( l.field_prefix $ 'constrain', 'B', l.fields:constrain, 'Resize to fit within bounding box:' ) }"></label>
					<input type="text" name="{ encodeentities( l.field_prefix ) $ 'b_width' }" value="{ encodeentities( l.fields:b_width ) }" style="text-align:right;" size="5" /> x
					<input type="text" name="{ encodeentities( l.field_prefix ) $ 'b_height' }" value="{ encodeentities( l.fields:b_height ) }" style="text-align:right;" size="5" /> pixels
				</td>
			</tr>
		</table>
		<MvEVAL EXPR = "{ [ g.Module_Admin ].DrawGroupTabEntry_End() }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Defaults" PARAMETERS = "module var, item, settings var" STANDARDOUTPUTLEVEL = "">
	<MvCOMMENT>
	|
	| Subscription
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.settings:display:shipping"	VALUE = 1>
	<MvASSIGN NAME = "l.settings:display:handling"	VALUE = 1>
	<MvASSIGN NAME = "l.settings:display:salestax"	VALUE = 1>
	<MvASSIGN NAME = "l.settings:display:discounts"	VALUE = 1>

	<MvCOMMENT>
	|
	| Order
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.settings:groups"			VALUE = 1>
	<MvASSIGN NAME = "l.settings:lineitemcoupons"	VALUE = 0>
	<MvASSIGN NAME = "l.settings:payments"			VALUE = 1>

	<MvCOMMENT>
	|
	| Overlapping Defaults
	|
	</MvCOMMENT>

	<MvASSIGN NAME = "l.settings:advanced"			VALUE = 0>
	<MvASSIGN NAME = "l.settings:fields_custom"		VALUE = "">
	<MvASSIGN NAME = "l.settings:imagetypes"		VALUE = "">
	<MvASSIGN NAME = "l.settings:constrain"			VALUE = "B">
	<MvASSIGN NAME = "l.settings:b_width"			VALUE = "75">
	<MvASSIGN NAME = "l.settings:b_height"			VALUE = "75">
	<MvASSIGN NAME = "l.settings:lineitemprice"		VALUE = "">
	<MvASSIGN NAME = "l.settings:lineitemdiscounts"	VALUE = 0>
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Page_Assign" PARAMETERS = "module var, page var, item, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' OR
					l.item EQ 'toe_subscriptions' }">			<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Page_Assign( l.module, l.page, l.item, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Page_Assign( l.module, l.page, l.item, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Page_Assign( l.module, l.page, l.item, l.settings ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Page_Assign" PARAMETERS = "module var, page var, item, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' }">			<MvEVAL EXPR = "{ SubscriptionComponentModule_Generate_Code( l.settings, l.template_source ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_subscriptions' }">			<MvEVAL EXPR = "{ SubscriptionsComponentModule_Generate_Code( l.settings, l.template_source ) }">
	</MvIF>

	<MvASSIGN NAME = "l.settings:template_filename"	VALUE = "{ tolower( l.page:code ) $ '-' $ tolower( l.item ) $ '.mvc' }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_Create_ManagedTemplate_NoDuplicates( l.template_source, l.settings, l.settings:template_filename ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Page_Unassign" PARAMETERS = "module var, page var, item, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' OR
					l.item EQ 'toe_subscriptions' }">			<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Page_Unassign( l.module, l.page, l.item, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Page_Unassign( l.module, l.page, l.item, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Page_Unassign( l.module, l.page, l.item, l.settings ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Page_Unassign" PARAMETERS = "module var, page var, item, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.null" VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Delete_ManagedTemplate_Filename( l.settings:template_filename ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Page_Copy" PARAMETERS = "module var, item, source_branch var, source_page var, source_settings var, dest_branch var, dest_page var, dest_settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' OR
					l.item EQ 'toe_subscriptions' }">			<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Page_Copy( l.module, l.item, l.source_branch, l.source_page, l.source_settings, l.dest_branch, l.dest_page, l.dest_settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Page_Copy( l.module, l.item, l.source_branch, l.source_page, l.source_settings, l.dest_branch, l.dest_page, l.dest_settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Page_Copy( l.module, l.item, l.source_branch, l.source_page, l.source_settings, l.dest_branch, l.dest_page, l.dest_settings ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Page_Copy" PARAMETERS = "module var, item, source_branch var, source_page var, source_settings var, dest_branch var, dest_page var, dest_settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].ManagedTemplateVersion_Load_Filename_Branch_Head( l.source_branch:id, l.source_settings:template_filename, l.source_templateversion ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].ManagedTemplateAndVersion_Load_Branch_Filename( l.dest_branch:id, l.dest_settings:template_filename, l.dest_managedtemplate ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>

		<MvFUNCTIONRETURN VALUE = 1>
	</MvIF>

	<MvASSIGN NAME = "l.dest_settings"						VALUE = "{ l.source_settings }">
	<MvASSIGN NAME = "l.dest_settings:template_filename"	VALUE = "{ l.dest_managedtemplate:version:settings:template_filename }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_CreateIfModified_ManagedTemplateVersion( l.dest_managedtemplate, '', l.source_templateversion:source, l.dest_settings ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvIF EXPR = "{ l.source_branch:id EQ l.dest_branch:id }">	<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-FUF-TOE-00100', l.module:name $ ' settings copied from page \'' $ l.source_page:code $ '\' to page \'' $ l.dest_page:code $ '\' for item \'' $ l.item $ '\' on branch \'' $ l.dest_branch:name $ '\'' ) }">
	<MvELSE>													<MvEVAL EXPR = "{ [ g.Module_Admin ].Admin_Log_Action( 'MER-FUF-TOE-00104', l.module:name $ ' settings copied from page \'' $ l.source_page:code $ '\' to page \'' $ l.dest_page:code $ '\' for item \'' $ l.item $ '\' from branch \'' $ l.source_branch:name $ '\' to branch \'' $ l.dest_branch:name $ '\'' ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Initialize" PARAMETERS = "module var, item, all_settings var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' }">		<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Initialize( l.module, l.item, l.all_settings, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_subscriptions' }">		<MvFUNCTIONRETURN VALUE = "{ SubscriptionsComponentModule_Initialize( l.module, l.item, l.all_settings, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Initialize( l.module, l.item, l.all_settings, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Initialize( l.module, l.item, l.all_settings, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_giftcertificates' }">	<MvFUNCTIONRETURN VALUE = "{ GiftCertificatesComponentModule_Initialize( l.module, l.item, l.all_settings, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_digitaldownloads' }">	<MvFUNCTIONRETURN VALUE = "{ DigitalDownloadsComponentModule_Initialize( l.module, l.item, l.all_settings, l.settings ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "GiftCertificatesComponentModule_Initialize" PARAMETERS = "module var, item, all_settings var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvFOREACH ITERATOR = "l.giftcertificate" ARRAY = "l.all_settings:giftcertificates" COUNT = "{ l.all_settings:giftcertificate_count }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_UT ].CommonComponentFields_Initialize_GiftCertificate( l.giftcertificate ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "DigitalDownloadsComponentModule_Initialize" PARAMETERS = "module var, item, all_settings var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvFOREACH ITERATOR = "l.digitaldownload" ARRAY = "l.all_settings:digitaldownloads" COUNT = "{ l.all_settings:digitaldownload_count }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_UT ].CommonComponentFields_Initialize_DigitalDownload( l.digitaldownload ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Initialize" PARAMETERS = "module var, item, all_settings var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_SUB_DB ].SubscriptionSettings_Load_Cached( l.all_settings:subscriptionsettings ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvREFERENCE NAME = "l.subscription" VARIABLE = "l.all_settings:subscription">

	<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Initialize_LowLevel( l.all_settings, l.settings, l.subscription ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionsComponentModule_Initialize" PARAMETERS = "module var, item, all_settings var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvFOREACH ITERATOR = "l.subscription" ARRAY = "l.all_settings:subscriptions" COUNT = "{ l.all_settings:subscription_count }">
		<MvIF EXPR = "{ NOT SubscriptionComponentModule_Initialize_LowLevel( l.all_settings, l.settings, l.subscription ) }">
			<MvFUNCTIONRETURN VALUE = 0>
		</MvIF>
	</MvFOREACH>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_SUB_DB ].SubscriptionSettings_Load_Cached( l.all_settings:subscriptionsettings ) }">
		<MvFUNCTIONRETURN VALUE = 0>
	</MvIF>

	<MvASSIGN NAME = "l.all_settings:subscriptionorder:customer"					VALUE = "{ l.all_settings:subscriptions[ 1 ]:customer }">
	<MvASSIGN NAME = "l.all_settings:subscriptionorder:address"						VALUE = "{ l.all_settings:subscriptions[ 1 ]:address }">
	<MvASSIGN NAME = "l.all_settings:subscriptionorder:paymentcard"					VALUE = "{ l.all_settings:subscriptions[ 1 ]:paymentcard }">
	<MvASSIGN NAME = "l.all_settings:subscriptionorder:ship_id"						VALUE = "{ l.all_settings:subscriptions[ 1 ]:ship_id }">
	<MvASSIGN NAME = "l.all_settings:subscriptionorder:method"						VALUE = "{ l.all_settings:subscriptions[ 1 ]:method }">
	<MvASSIGN NAME = "l.all_settings:subscriptionorder:firstdate"					VALUE = "{ l.all_settings:subscriptions[ 1 ]:firstdate }">
	<MvASSIGN NAME = "l.all_settings:subscriptionorder:formatted_firstdate_date"	VALUE = "{ l.all_settings:subscriptions[ 1 ]:formatted_firstdate_date }">
	<MvASSIGN NAME = "l.all_settings:subscriptionorder:lastdate"					VALUE = "{ l.all_settings:subscriptions[ 1 ]:lastdate }">
	<MvASSIGN NAME = "l.all_settings:subscriptionorder:formatted_lastdate_date"		VALUE = "{ l.all_settings:subscriptions[ 1 ]:formatted_lastdate_date }">
	<MvASSIGN NAME = "l.all_settings:subscriptionorder:nextdate"					VALUE = "{ l.all_settings:subscriptions[ 1 ]:nextdate }">
	<MvASSIGN NAME = "l.all_settings:subscriptionorder:formatted_nextdate_date"		VALUE = "{ l.all_settings:subscriptions[ 1 ]:formatted_nextdate_date }">
	<MvASSIGN NAME = "l.all_settings:subscriptionorder:cncldate"					VALUE = "{ l.all_settings:subscriptions[ 1 ]:cncldate }">
	<MvASSIGN NAME = "l.all_settings:subscriptionorder:formatted_cncldate_date"		VALUE = "{ l.all_settings:subscriptions[ 1 ]:formatted_cncldate_date }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Initialize_LowLevel" PARAMETERS = "all_settings var, settings var, subscription var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_CUS_DB ].Customer_Load_ID_Cached( l.subscription:cust_id, l.subscription:customer ) OR
					NOT [ g.Module_Feature_CUS_DB ].CustomerAddress_Load_ID_Cached( l.subscription:addr_id, l.subscription:address ) OR
					NOT [ g.Module_Feature_SUB_DB ].ProductSubscriptionSettings_Load_ProductOrDefault( l.subscription:product_id, l.subscription:productsubscriptionsettings ) OR
					NOT [ g.Module_Feature_SUB_DB ].ProductSubscriptionTerm_Load_ID_Cached( l.subscription:subterm_id, l.subscription:productsubscriptionterm ) OR
					NOT [ g.Module_Library_DB ].Product_Load_ID( l.subscription:product_id, l.subscription:product ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Throw_Exception( 'invalid_subscription' ) }">
	</MvIF>

	<MvIF EXPR = "{ l.subscription:custpc_id }">
		<MvIF EXPR = "{ NOT [ g.Module_Feature_PAY_DB ].CustomerPaymentCard_Load_ID_Cached( l.subscription:custpc_id, l.subscription:cust_id, l.subscription:paymentcard ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Throw_Exception( 'invalid_subscription' ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].StandardFields_Load_Cached( l.std_fields ) }">
		<MvASSIGN NAME = "l.std_fields:primaddr"		VALUE = "shipping">
	</MvIF>

	<MvASSIGN NAME = "l.subscription:customer:primaddr"	VALUE = "{ l.std_fields:primaddr }">
	<MvASSIGN NAME = "l.subscription:product:link"		VALUE = "{ [ g.Module_Feature_URI_UT ].Store_Product_URL( l.subscription:product, l.null ) }">
	<MvASSIGN NAME = "l.null"							VALUE = "{ [ g.Module_Feature_TUI_UT ].CommonComponentFields_Initialize_Subscription( l.all_settings, l.settings, l.subscription ) }">

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Prerender" PARAMETERS = "module var, item, all_settings var, settings var, param" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' OR
					l.item EQ 'toe_subscriptions' }">			<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Prerender( l.module, l.item, l.all_settings, l.settings, l.param ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Prerender( l.module, l.item, l.all_settings, l.settings, l.param ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Prerender( l.module, l.item, l.all_settings, l.settings, l.param ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Update_Requires_Version" PARAMETERS = "module var, page var, item, field_prefix, fields var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 0>
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_PostUpdate" PARAMETERS = "module var, page var, item, field_prefix, fields var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Prerender" PARAMETERS = "module var, item, all_settings var, settings var, param" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Render_Head" PARAMETERS = "module var, item, all_settings var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' OR
					l.item EQ 'toe_subscriptions' }">			<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Render_Head( l.module, l.item, l.all_settings, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Render_Head( l.module, l.item, l.all_settings, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Render_Head( l.module, l.item, l.all_settings, l.settings ) }">
	</MvIF>

	<MvFUNCTIONRETURN>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Render_Head" PARAMETERS = "module var, item, all_settings var, settings var" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Render_Start" PARAMETERS = "module var, item, all_settings var, settings var, param" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' OR
					l.item EQ 'toe_subscriptions' }">			<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Render_Start( l.module, l.item, l.all_settings, l.settings, l.param ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Render_Start( l.module, l.item, l.all_settings, l.settings, l.param ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Render_Start( l.module, l.item, l.all_settings, l.settings, l.param ) }">
	</MvIF>

	<MvFUNCTIONRETURN>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Render_Start" PARAMETERS = "module var, item, all_settings var, settings var, param" STANDARDOUTPUTLEVEL = "">
	<MvEVAL EXPR = "{ [ g.Module_Feature_TUI_MGR ].TemplateManager_Render_Template( l.settings:template_filename, l.all_settings ) }">
</MvFUNCTION>

<MvFUNCTION NAME = "ComponentModule_Render_End" PARAMETERS = "module var, item, all_settings var, settings var, param" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' OR
					l.item EQ 'toe_subscriptions' }">			<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Render_End( l.module, l.item, l.all_settings, l.settings, l.param ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Render_End( l.module, l.item, l.all_settings, l.settings, l.param ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Render_End( l.module, l.item, l.all_settings, l.settings, l.param ) }">
	</MvIF>

	<MvFUNCTIONRETURN>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Render_End" PARAMETERS = "module var, item, all_settings var, settings var, param" STANDARDOUTPUTLEVEL = "">
</MvFUNCTION>

<MvCOMMENT>
|
| Skins Feature (skins)
|
</MvCOMMENT>

<MvFUNCTION NAME = "SkinsComponentModule_Description" PARAMETERS = "module var, item var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item:code EQ 'toe_subscription_fields' }">	<MvFUNCTIONRETURN VALUE = "{ SubscriptionSkinsComponentModule_Description( l.module, l.item ) }">
	<MvELSEIF EXPR = "{ l.item:code EQ 'toe_subscriptions' }">		<MvFUNCTIONRETURN VALUE = "{ SubscriptionsSkinsComponentModule_Description( l.module, l.item ) }">
	<MvELSEIF EXPR = "{ l.item:code EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderSkinsComponentModule_Description( l.module, l.item ) }">
	<MvELSEIF EXPR = "{ l.item:code EQ 'toe_basket_contents' }">	<MvFUNCTIONRETURN VALUE = "{ BasketSkinsComponentModule_Description( l.module, l.item ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = "">
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionSkinsComponentModule_Description" PARAMETERS = "module var, item var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.pages" VALUE = "{ [ g.Module_Feature_TUI_DB ].Item_Load_PageList( l.item ) }">

	<MvFUNCTIONRETURN VALUE = "{ 'Exports Subscription Content template from pages: ' $ l.pages }">
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionsSkinsComponentModule_Description" PARAMETERS = "module var, item var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.pages" VALUE = "{ [ g.Module_Feature_TUI_DB ].Item_Load_PageList( l.item ) }">

	<MvFUNCTIONRETURN VALUE = "{ 'Exports Subscription List Content template from pages: ' $ l.pages }">
</MvFUNCTION>

<MvFUNCTION NAME = "SkinsComponentModule_Export_Item" PARAMETERS = "module var, item, output var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.item:code EQ 'toe_subscription_fields' OR
					l.item:code EQ 'toe_subscriptions' }">			<MvFUNCTIONRETURN VALUE = "{ SubscriptionSkinsComponentModule_Export_Item( l.module, l.item, l.output ) }">
	<MvELSEIF EXPR = "{ l.item:code EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderSkinsComponentModule_Export_Item( l.module, l.item, l.output ) }">
	<MvELSEIF EXPR = "{ l.item:code EQ 'toe_basket_contents' }">	<MvFUNCTIONRETURN VALUE = "{ BasketSkinsComponentModule_Export_Item( l.module, l.item, l.output ) }">
	</MvIF>

	<MvFUNCTIONRETURN>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionSkinsComponentModule_Export_Item" PARAMETERS = "module var, item, output var" STANDARDOUTPUTLEVEL = "">
	<MvCAPTURE VARIABLE = "l.output" STANDARDOUTPUTLEVEL = "text, html, compresswhitespace">
		<MvFOREACH ITERATOR = "l.page" ARRAY = "l.pages" COUNT = "{ [ g.Module_Feature_TUI_DB ].PageList_Load_Item_Runtime( l.item:id, l.pages ) }">
			<MvREFERENCEARRAY NAME = "l.settings" VARIABLE = "l.page:settings">
				<MvMEMBER NAME = "{ l.item:code }">
			</MvREFERENCEARRAY>

			<Page_Update code="{ l.page:code }">
				<Item code="{ l.item:code }">
					<AdditionalPriceDisplay><MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }">Retail<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }">Base<MvELSE>None</MvIF></AdditionalPriceDisplay>
					<DisplayLineItemDiscountDetails><MvIF EXPR = "{ l.settings:lineitemdiscounts }">Yes<MvELSE>No</MvIF></DisplayLineItemDiscountDetails>
					<DisplayShipping><MvIF EXPR = "{ l.settings:display:shipping }">Yes<MvELSE>No</MvIF></DisplayShipping>
					<DisplayHandling><MvIF EXPR = "{ l.settings:display:handling }">Yes<MvELSE>No</MvIF></DisplayHandling>
					<DisplaySalesTax><MvIF EXPR = "{ l.settings:display:salestax }">Yes<MvELSE>No</MvIF></DisplaySalesTax>
					<DisplayDiscounts><MvIF EXPR = "{ l.settings:display:discounts }">Yes<MvELSE>No</MvIF></DisplayDiscounts>

					<Fields>
						<MvFOREACH ITERATOR = "l.customfield" ARRAY = "l.settings:fields_custom">
							<Custom module="{ l.customfield:module }" code="{ l.customfield:code }" />
						</MvFOREACH>
					</Fields>

					<ImageTypes>
						<MvFOREACH ITERATOR = "l.imagetype" ARRAY = "l.settings:imagetypes">
							<ImageType><MvEVAL EXPR = "{ [ g.Module_Library_Utilities ].CDATA_Encode( l.imagetype ) }"></ImageType>
						</MvFOREACH>
					</ImageTypes>

					<MvIF EXPR = "{ l.settings:constrain NE 'B' }">
						<ImageDimensions constrain="No" />
					<MvELSE>
						<ImageDimensions constrain="Yes">
							<Width><MvEVAL EXPR = "{ int( l.settings:b_width ) }"></Width>
							<Height><MvEVAL EXPR = "{ int( l.settings:b_height ) }"></Height>
						</ImageDimensions>
					</MvIF>

					<MvIF EXPR = "{ l.settings:advanced }">
						<MvIF EXPR = "{ [ g.Module_Feature_TUI_DB ].ManagedTemplateVersion_Load_Filename_Current( l.settings:template_filename, l.templateversion ) }">
							<Template><MvEVAL EXPR = "{ miva_cdata_encode( l.templateversion:source ) }"></Template>
						</MvIF>
					</MvIF>

					<Notes>#Set_Current_Time#</Notes>
				</Item>
			</Page_Update>
		</MvFOREACH>
	</MvCAPTURE>
</MvFUNCTION>

<MvCOMMENT>
|
| Component Module Provision Feature (component_prov)
|
</MvCOMMENT>

<MvFUNCTION NAME = "ComponentModule_Provision" PARAMETERS = "module var, provide_xml var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ NOT [ g.Module_Feature_PRV_AD ].PRV_Attribute_Text( l.provide_xml, 'code', l.item ) }">
		<MvFUNCTIONRETURN>
	</MvIF>

	<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' OR
					l.item EQ 'toe_subscriptions' }">			<MvFUNCTIONRETURN VALUE = "{ SubscriptionComponentModule_Provision( l.module, l.provide_xml, l.settings, l.item ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_order_contents' }">		<MvFUNCTIONRETURN VALUE = "{ OrderComponentModule_Provision( l.module, l.provide_xml, l.settings ) }">
	<MvELSEIF EXPR = "{ l.item EQ 'toe_basket_contents' }">		<MvFUNCTIONRETURN VALUE = "{ BasketComponentModule_Provision( l.module, l.provide_xml, l.settings ) }">
	</MvIF>

	<MvFUNCTIONRETURN>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Provision" PARAMETERS = "module var, provide_xml var, settings var, item" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.working_settings"	VALUE = "{ l.settings }">

	<MvIF EXPR = "{ NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_List(		'O', l.provide_xml, 'AdditionalPriceDisplay',			l.working_settings:lineitemprice,			'Retail,Base,None',	'retail,base,' )	OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean(	'o', l.provide_xml, 'DisplayLineItemDiscountDetails',	l.working_settings:lineitemdiscounts )												OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean( 	'O', l.provide_xml, 'DisplayShipping',					l.working_settings:display:shipping )												OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean( 	'O', l.provide_xml, 'DisplayHandling',					l.working_settings:display:handling )												OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean( 	'O', l.provide_xml, 'DisplaySalesTax',					l.working_settings:display:salestax )												OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Boolean( 	'O', l.provide_xml, 'DisplayDiscounts',					l.working_settings:display:discounts )												OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'o', l.provide_xml,	'Template',							l.source )																			OR
					NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Text(		'O', l.provide_xml,	'Notes',							l.notes ) }">
		<MvFUNCTIONRETURN>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_PRV_AD ].PRV_Tag_Exists( l.provide_xml, 'Fields' ) }">
		<MvIF EXPR = "{ NOT SubscriptionComponentModule_Provision_Fields( l.module, l.provide_xml:tags:Fields[ 1 ], l.working_settings ) }">
			<MvFUNCTIONRETURN>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_PRV_AD ].PRV_Tag_Exists( l.provide_xml, 'ImageTypes' ) }">
		<MvIF EXPR = "{ NOT SubscriptionComponentModule_Provision_ImageTypes( l.module, l.provide_xml:tags:ImageTypes[ 1 ], l.working_settings ) }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogMessage( l.provide_xml, 'Unable to provision multiple image types' ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_PRV_AD ].PRV_Tag_Exists( l.provide_xml, 'ImageDimensions' ) }">
		<MvASSIGN NAME = "l.dimensions" VALUE = "{ l.provide_xml:tags:ImageDimensions[ 1 ] }">

		<MvIF EXPR = "{ NOT [ g.Module_Feature_PRV_AD ].PRV_Attribute_Boolean( l.dimensions, 'constrain', l.constrain ) }">
			<MvFUNCTIONRETURN>
		</MvIF>

		<MvIF EXPR = "{ NOT l.constrain }">
			<MvASSIGN NAME = "l.working_settings:constrain" VALUE = "N">
		<MvELSE>
			<MvASSIGN NAME = "l.working_settings:constrain" VALUE = "B">

			<MvIF EXPR = "{ NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Integer( 'R', l.dimensions, 'Width',	l.working_settings:b_width ) OR
							NOT [ g.Module_Feature_PRV_AD ].PRV_Tag_Integer( 'R', l.dimensions, 'Height',	l.working_settings:b_height ) }">
				<MvFUNCTIONRETURN>
			</MvIF>
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ [ g.Module_Feature_PRV_AD ].PRV_Tag_Exists( l.provide_xml, 'Template' ) }">
		<MvASSIGN NAME = "l.working_settings:advanced"	VALUE = 1>
	<MvELSE>
		<MvASSIGN NAME = "l.working_settings:advanced"	VALUE = 0>

		<MvIF EXPR = "{ l.item EQ 'toe_subscription_fields' }">	<MvEVAL EXPR = "{ SubscriptionComponentModule_Generate_Code( l.working_settings, l.source ) }">
		<MvELSEIF EXPR = "{ l.item EQ 'toe_subscriptions' }">	<MvEVAL EXPR = "{ SubscriptionsComponentModule_Generate_Code( l.working_settings, l.source ) }">
		</MvIF>
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_DB ].ManagedTemplate_Load_Filename( l.settings:template_filename, l.managedtemplate ) }">
		<MvIF EXPR = "{ NOT [ g.Module_Library_DB ].Error_Is_EOF() }">
			<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
		</MvIF>

		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogMessage( l.provide_xml, 'Unable to load template' ) }">
	</MvIF>

	<MvIF EXPR = "{ NOT [ g.Module_Feature_TUI_MGR ].TemplateManager_CreateIfModified_ManagedTemplateVersion( l.managedtemplate, l.notes, l.source, l.working_settings ) }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Feature_PRV_AD ].PRV_LogError( l.provide_xml ) }">
	</MvIF>

	<MvASSIGN NAME = "l.settings" VALUE = "{ l.working_settings }">

	<MvFUNCTIONRETURN>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Provision_Fields" PARAMETERS = "module var, provide_xml var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.settings:fields_custom"	VALUE = "">
	<MvASSIGN NAME = "l.customfield_count"		VALUE = 0>

	<MvASSIGN NAME = "l.child_pos"		VALUE = 1>
	<MvASSIGN NAME = "l.child_count"	VALUE = "{ miva_array_elements( l.provide_xml:children ) }">
	<MvWHILE EXPR = "{ l.child_pos LE l.child_count }">
		<MvASSIGN NAME = "l.name"		VALUE = "{ tolower( l.provide_xml:children[ l.child_pos ]:name ) }">

		<MvIF EXPR = "{ l.name EQ 'custom' }">
			<MvASSIGN NAME = "l.customfield_count"															VALUE = "{ l.customfield_count + 1 }">

			<MvIF EXPR = "{ NOT [ g.Module_Feature_PRV_AD ].PRV_Attribute_Text( l.provide_xml:children[ l.child_pos ], 'module',	l.settings:fields_custom[ l.customfield_count ]:module ) OR
							NOT [ g.Module_Feature_PRV_AD ].PRV_Attribute_Text( l.provide_xml:children[ l.child_pos ], 'code',		l.settings:fields_custom[ l.customfield_count ]:code ) }">
				<MvFUNCTIONRETURN VALUE = 0>
			</MvIF>
		</MvIF>

		<MvASSIGN NAME = "l.child_pos"	VALUE = "{ l.child_pos + 1 }">
	</MvWHILE>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Provision_ImageTypes" PARAMETERS = "module var, provide_xml var, settings var" STANDARDOUTPUTLEVEL = "">
	<MvASSIGN NAME = "l.settings:imagetypes" VALUE = "">

	<MvFOREACH ITERATOR = "l.child" ARRAY = "l.provide_xml:children" COUNT = "{ miva_array_elements( l.provide_xml:children ) }">
		<MvIF EXPR = "{ [ g.Module_Library_DB ].ImageType_Load_Code( l.child:value, l.imagetype ) }">
			<MvASSIGN NAME = "l.type_count" VALUE = "{ miva_array_insert( l.settings:imagetypes, l.imagetype:code, -1 ) }">
		</MvIF>
	</MvFOREACH>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionComponentModule_Generate_Code" PARAMETERS = "settings var, code var" STANDARDOUTPUTLEVEL = "">
	<MvCAPTURE VARIABLE = "l.code">
<MvIF EXPR = "{ NOT ISNULL l.settings:imagetypes[ 1 ] }">
	<MvASSIGN NAME = "l.imagetype"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.settings:imagetypes[ 1 ] ) }">

<MIVA STANDARDOUTPUTLEVEL = "text, html"><!-- Item Image -->
<mvt:if expr="{ 'NOT ISNULL l.settings:subscription:items[1]:imagetypes:' $ l.imagetype }">
	<div class="hide-for-mobile"><table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="50" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>
</div>
	<div class="img-center" style="font-size:0pt; line-height:0pt; text-align:center"><a href="&mvte:subscription:items[1]:link;" target="_blank"><img src="{ '&mvte:global:basehref;&mvte:subscription:items[1]:imagetypes:' $ l.imagetype $ ';' }" border="0" alt="&mvte:subscription:items[1]:name;" /></a></div>
	<div class="hide-for-mobile"><table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="50" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>
</div>
	<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="30" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>
</mvt:if>
<!-- END Item Image -->
<MIVA STANDARDOUTPUTLEVEL = "">
</MvIF>

<MIVA STANDARDOUTPUTLEVEL = "text, html">
<!-- Table -->
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td valign="top" nowrap style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3;" width="100%">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Subscription Term</strong></div>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

		</td>
		<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
		<td valign="top" nowrap style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3;">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong><mvt:if expr="l.settings:subscription:status NE 'C'">Next Re-Order Date<mvt:else>Cancelled</mvt:if></strong></div>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

		</td>
	</tr>
	<tr>
		<td valign="top">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><em><mvt:if expr="l.settings:subscription:status NE 'C'">&mvte:subscription:productsubscriptionterm:descrip;<mvt:else>Cancelled</mvt:if></em></div>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

		</td>
		<td valign="top" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
		<td valign="top">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><em><mvt:if expr="l.settings:subscription:status NE 'C'">&mvte:subscription:formatted_nextdate_date;<mvt:else>&mvte:subscription:formatted_cncldate_date;</mvt:if></em></div>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

		</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>
<!-- END Table -->

<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td>
			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="60%">
						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Item</strong></div>
					</td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="3%"></td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="10%">
						<div class="text-1-center" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:center"><strong>Qty</strong></div>
					</td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="3%"></td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="10%">
						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><strong>Price</strong></div>
					</td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="4%"></td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="10%">
						<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><strong>Total</strong></div>
					</td>
				</tr>

				<mvt:foreach iterator="item" array="subscription:items">
					<mvt:if expr="l.settings:item:option_count">
						<mvt:assign name="l.settings:item_padding" value="'padding-top: 15px; padding-bottom: 5px;'" />
					<mvt:else>
						<mvt:assign name="l.settings:item_padding" value="'padding-top: 15px; padding-bottom: 15px;'" />
					</mvt:if>

					<tr>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left">&mvt:item:name;</div>
							<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">&mvt:item:code;</div>
							<MIVA STANDARDOUTPUTLEVEL = "">
							<MvFOREACH ITERATOR = "l.customfield" ARRAY = "l.settings:fields_custom">
								<MvASSIGN NAME = "l.safe_module_code"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.customfield:module ) }">
								<MvASSIGN NAME = "l.safe_field_code"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.customfield:code ) }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
							<mvt:if expr="{ 'NOT ISNULL l.settings:item:customfield_values:' $ l.safe_module_code $ ':' $ l.safe_field_code }">
								<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">&mvt:customfield_names:<MvEVAL EXPR = "{ l.safe_module_code }">:<MvEVAL EXPR = "{ l.safe_field_code }">;: &mvt:item:customfield_values:<MvEVAL EXPR = "{ l.safe_module_code }">:<MvEVAL EXPR = "{ l.safe_field_code }">;</div>
							</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
							</MvFOREACH>
							<MvIF EXPR = "{ l.settings:lineitemdiscounts }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
							<mvt:foreach iterator="discount" array="item:discounts">
								<mvt:if expr="l.settings:discount:display">
									<div class="text-4" style="color:#fa4100; font-family:Arial, sans-serif; min-width:auto !important; font-size:12px; line-height:16px; text-align:left"><em>&mvt:discount:descrip;: &mvt:discount:formatted_discount;</em></div>
								</mvt:if>
							</mvt:foreach><MIVA STANDARDOUTPUTLEVEL = "">
							</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
						</td>
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1-center" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:center">&mvte:item:quantity;</div>
						</td>
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
								<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:retail AND l.settings:item:retail NE l.settings:item:price">
									<strike>&mvt:item:formatted_retail;</strike>
								<mvt:elseif expr="l.settings:item:base_price NE l.settings:item:price">
									<strike>&mvt:item:formatted_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:base_price NE l.settings:item:price">
									<strike>&mvt:item:formatted_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
								&mvt:item:formatted_price;
							</div>
						</td>
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">
								<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:subtotal_retail AND l.settings:item:subtotal_retail NE l.settings:item:subtotal">
									<strike>&mvt:item:formatted_subtotal_retail;</strike>
								<mvt:elseif expr="l.settings:item:subtotal_base_price NE l.settings:item:subtotal">
									<strike>&mvt:item:formatted_subtotal_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:subtotal_base_price NE l.settings:item:subtotal">
									<strike>&mvt:item:formatted_subtotal_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
								&mvt:item:formatted_subtotal;
							</div>
						</td>
					</tr>

					<mvt:foreach iterator="option" array="item:options">
						<mvt:if expr="l.pos2 LT l.settings:item:option_count">
							<mvt:assign name="l.settings:option_padding" value="'padding-bottom: 5px;'" />
						<mvt:else>
							<mvt:assign name="l.settings:option_padding" value="'padding-bottom: 15px;'" />
						</mvt:if>

						<tr>
							<td valign="top" style="&mvte:option_padding;">
								<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">
									<mvt:if expr="l.settings:option:option_id">
										&mvt:option:attr_code;: &mvt:option:opt_code;
									<mvt:elseif expr="NOT ISNULL l.settings:option:data">
										<mvt:if expr="( l.settings:option:attr_code EQ 'digitaldownload' ) AND ( NOT ISNULL l.settings:option:digital_download_url )">
											<a href="&mvte:option:digital_download_url;" target="_blank">Digital Download</a>
										<mvt:else>
											&mvt:option:attr_code;: &mvt:option:data;
										</mvt:if>
									<mvt:elseif expr="NOT ISNULL l.settings:option:data_long">
										&mvt:option:attr_code;: &mvt:option:data_long;
									<mvt:else>
										&mvt:option:attr_code;
									</mvt:if>
								</div><MIVA STANDARDOUTPUTLEVEL = "">
								<MvIF EXPR = "{ l.settings:lineitemdiscounts }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:foreach iterator="discount" array="option:discounts">
									<mvt:if expr="l.settings:discount:display">
										<div class="text-4" style="color:#fa4100; font-family:Arial, sans-serif; min-width:auto !important; font-size:12px; line-height:16px; text-align:left"><em>&mvt:discount:descrip;: &mvt:discount:formatted_discount;</em></div>
									</mvt:if>
								</mvt:foreach><MIVA STANDARDOUTPUTLEVEL = "">
								</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
							</td>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left"></td>
							<td valign="top" style="&mvte:option_padding;">
								&nbsp;
							</td>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left"></td>
							<td valign="top" style="&mvte:option_padding;">
								<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
									<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:retail OR l.settings:option:base_price OR l.settings:option:price">
										<mvt:if expr="l.settings:option:retail AND l.settings:option:retail NE l.settings:option:price">
											<strike>&mvt:option:formatted_retail;</strike>
										<mvt:elseif expr="l.settings:option:base_price NE l.settings:option:price">
											<strike>&mvt:option:formatted_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:base_price OR l.settings:option:price">
										<mvt:if expr="l.settings:option:base_price NE l.settings:option:price">
											<strike>&mvt:option:formatted_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSE><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:price"><MIVA STANDARDOUTPUTLEVEL = "">
									</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
										&mvt:option:formatted_price;
									<mvt:else>
										&nbsp;
									</mvt:if>
								</div>
							</td>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
							<td valign="top" style="&mvte:option_padding;">
								<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
									<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:subtotal_retail OR l.settings:option:subtotal_base_price OR l.settings:option:subtotal">
										<mvt:if expr="l.settings:option:subtotal_retail AND l.settings:option:subtotal_retail NE l.settings:option:subtotal">
											<strike>&mvt:option:formatted_subtotal_retail;</strike>
										<mvt:elseif expr="l.settings:option:subtotal_base_price NE l.settings:option:subtotal">
											<strike>&mvt:option:formatted_subtotal_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:subtotal_base_price OR l.settings:option:subtotal">
										<mvt:if expr="l.settings:option:subtotal_base_price NE l.settings:option:subtotal">
											<strike>&mvt:option:formatted_subtotal_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSE><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:subtotal"><MIVA STANDARDOUTPUTLEVEL = "">
									</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
										&mvt:option:formatted_subtotal;
									<mvt:else>
										&nbsp;
									</mvt:if>
								</div>
							</td>
						</tr>
					</mvt:foreach>
				</mvt:foreach>
			</table>
		</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="5" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" height="1" bgcolor="#e3e3e3">&nbsp;</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="20" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td align="right">
			<table border="0" cellspacing="0" cellpadding="0">
				<mvt:foreach iterator="charge" array="subscription:charges">
					<tr>
						<td>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">&mvt:charge:descrip;:</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
						<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td width="115">
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">&mvt:charge:formatted_disp_amt;</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
					</tr>
				</mvt:foreach>

				<tr>
					<td>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="h3-right" style="color:#303748; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:right"><strong>Estimated Total:</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

					</td>
					<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
					<td width="115">
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="h3-right" style="color:#303748; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:right"><strong>&mvt:subscription:formatted_display_total;</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

					</td>
				</tr>
			</table>
		</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="30" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

<!-- Table 2 -->
<mvt:if expr="l.settings:subscription:status NE 'C'">
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="20" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<div class="h3" style="color:#303748; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:left">
				<strong>Order Details</strong>
			</div>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" height="1" bgcolor="#e3e3e3">&nbsp;</td>
				</tr>
			</table>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr>
					<th class="column" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; Margin:0" valign="top" width="285">
						<div class="text" style="color:#1a2026; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Ship To</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left">
							&mvte:subscription:address:fname; &mvte:subscription:address:lname;<br />
							&mvte:subscription:address:addr1; &mvte:subscription:address:addr2;<br />
							&mvte:subscription:address:city;, &mvte:subscription:address:state; &mvte:subscription:address:zip;<br />
							&mvte:subscription:address:cntry;
						</div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="25" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<mvt:if expr="l.settings:subscription:ship_id">
						<div class="text" style="color:#1a2026; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Shipping Method</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left">&mvt:subscription:method;</div>
						</mvt:if>
					</th>
					<th class="column" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; Margin:0" valign="top" width="10">
						<table width="100%" border="0" cellspacing="0" cellpadding="0">
							<tr>
								<td><div style="font-size:0pt; line-height:0pt;" class="mobile-br-30"></div></td>
							</tr>
						</table>
					</th>
					<th class="column" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; Margin:0" valign="top">
						<div class="text" style="color:#1a2026; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Bill To</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left">
							<mvt:if expr="l.settings:subscription:paymentcard:id">
							&mvte:subscription:paymentcard:fname; &mvte:subscription:paymentcard:lname;<br />
							&mvte:subscription:paymentcard:addr1; &mvte:subscription:paymentcard:addr2;<br />
							&mvte:subscription:paymentcard:city;, &mvte:subscription:paymentcard:state; &mvte:subscription:paymentcard:zip;<br />
							&mvte:subscription:paymentcard:cntry;
							<mvt:else>
							&mvte:subscription:customer:bill_fname; &mvte:subscription:customer:bill_lname;<br />
							&mvte:subscription:customer:bill_addr1; &mvte:subscription:customer:bill_addr2;<br />
							&mvte:subscription:customer:bill_city;, &mvte:subscription:customer:bill_state; &mvte:subscription:customer:bill_zip;<br />
							&mvte:subscription:customer:bill_cntry;
							</mvt:if>
						</div>

						<mvt:if expr="l.settings:subscription:paymentcard:id">
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="25" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text" style="color:#1a2026; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Payment Method</strong></div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left">&mvte:subscription:paymentcard:type; Ending in &mvte:subscription:paymentcard:lastfour;</div>
						</mvt:if>
					</th>
				</tr>
			</table>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="50" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

		</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" height="1" bgcolor="#e3e3e3">&nbsp;</td>
	</tr>
</table>
</mvt:if>
<!-- END Table 2 -->

<mvt:if expr="l.settings:subscription:status NE 'C'">
<!-- Button -->
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td align="center">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="30" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<table border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td align="center" bgcolor="#2a68ce">
						<table border="0" cellspacing="0" cellpadding="0">
							<tr>
								<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="40"><table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="50" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table></td>
								<td bgcolor="#2a68ce">
									<div class="text-btn" style="color:#ffffff; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:center">
										<a href="&mvte:urls:CSBE:auto_sep;Subscription_ID=&mvta:subscription:id;" target="_blank" class="link-white" style="color:#ffffff; text-decoration:none"><span class="link-white" style="color:#ffffff; text-decoration:none">Manage Your Subscription</span></a>
									</div>
								</td>
								<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="40"></td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="30" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

		</td>
	</tr>
</table>
<!-- END Button -->
</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
	</MvCAPTURE>
</MvFUNCTION>

<MvFUNCTION NAME = "SubscriptionsComponentModule_Generate_Code" PARAMETERS = "settings var, code var" STANDARDOUTPUTLEVEL = "">
	<MvCAPTURE VARIABLE = "l.code">
<MIVA STANDARDOUTPUTLEVEL = "text, html"><mvt:foreach iterator="subscription" array="subscriptions"><MIVA STANDARDOUTPUTLEVEL = "">
<MvIF EXPR = "{ NOT ISNULL l.settings:imagetypes[ 1 ] }">
	<MvASSIGN NAME = "l.imagetype"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.settings:imagetypes[ 1 ] ) }">

<MIVA STANDARDOUTPUTLEVEL = "text, html">
<!-- Item Image -->
<mvt:if expr="{ 'NOT ISNULL l.settings:subscription:items[1]:imagetypes:' $ l.imagetype }">
	<div class="hide-for-mobile"><table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="50" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>
</div>
	<div class="img-center" style="font-size:0pt; line-height:0pt; text-align:center"><a href="&mvte:subscription:items[1]:link;" target="_blank"><img src="{ '&mvte:global:basehref;&mvte:subscription:items[1]:imagetypes:' $ l.imagetype $ ';' }" border="0" alt="&mvte:subscription:items[1]:name;" /></a></div>
	<div class="hide-for-mobile"><table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="50" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>
</div>
	<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="30" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>
</mvt:if>
<!-- END Item Image -->
<MIVA STANDARDOUTPUTLEVEL = "">
</MvIF>

<MIVA STANDARDOUTPUTLEVEL = "text, html">
<!-- Table -->
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td valign="top" nowrap style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3;" width="100%">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Subscription Term</strong></div>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

		</td>
		<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
		<td valign="top" nowrap style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3;">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong><mvt:if expr="l.settings:subscription:status NE 'C'">Next Re-Order Date<mvt:else>Cancelled</mvt:if></strong></div>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

		</td>
	</tr>
	<tr>
		<td valign="top">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><em><mvt:if expr="l.settings:subscription:status NE 'C'">&mvte:subscription:productsubscriptionterm:descrip;<mvt:else>Cancelled</mvt:if></em></div>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

		</td>
		<td valign="top" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
		<td valign="top">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><em><mvt:if expr="l.settings:subscription:status NE 'C'">&mvte:subscription:formatted_nextdate_date;<mvt:else>&mvte:subscription:formatted_cncldate_date;</mvt:if></em></div>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

		</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="10" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>
<!-- END Table -->

<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td>
			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="60%">
						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Item</strong></div>
					</td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="3%"></td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="10%">
						<div class="text-1-center" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:center"><strong>Qty</strong></div>
					</td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="3%"></td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="10%">
						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><strong>Price</strong></div>
					</td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="4%"></td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="10%">
						<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><strong>Total</strong></div>
					</td>
				</tr>

				<mvt:foreach iterator="item" array="subscription:items">
					<mvt:if expr="l.settings:item:option_count">
						<mvt:assign name="l.settings:item_padding" value="'padding-top: 15px; padding-bottom: 5px;'" />
					<mvt:else>
						<mvt:assign name="l.settings:item_padding" value="'padding-top: 15px; padding-bottom: 15px;'" />
					</mvt:if>

					<tr>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left">&mvt:item:name;</div>
							<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">&mvt:item:code;</div>
							<MIVA STANDARDOUTPUTLEVEL = "">
							<MvFOREACH ITERATOR = "l.customfield" ARRAY = "l.settings:fields_custom">
								<MvASSIGN NAME = "l.safe_module_code"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.customfield:module ) }">
								<MvASSIGN NAME = "l.safe_field_code"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.customfield:code ) }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
							<mvt:if expr="{ 'NOT ISNULL l.settings:item:customfield_values:' $ l.safe_module_code $ ':' $ l.safe_field_code }">
								<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">&mvt:customfield_names:<MvEVAL EXPR = "{ l.safe_module_code }">:<MvEVAL EXPR = "{ l.safe_field_code }">;: &mvt:item:customfield_values:<MvEVAL EXPR = "{ l.safe_module_code }">:<MvEVAL EXPR = "{ l.safe_field_code }">;</div>
							</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
							</MvFOREACH>
							<MvIF EXPR = "{ l.settings:lineitemdiscounts }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
							<mvt:foreach iterator="discount" array="item:discounts">
								<mvt:if expr="l.settings:discount:display">
									<div class="text-4" style="color:#fa4100; font-family:Arial, sans-serif; min-width:auto !important; font-size:12px; line-height:16px; text-align:left"><em>&mvt:discount:descrip;: &mvt:discount:formatted_discount;</em></div>
								</mvt:if>
							</mvt:foreach><MIVA STANDARDOUTPUTLEVEL = "">
							</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
						</td>
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1-center" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:center">&mvte:item:quantity;</div>
						</td>
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
								<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:retail AND l.settings:item:retail NE l.settings:item:price">
									<strike>&mvt:item:formatted_retail;</strike>
								<mvt:elseif expr="l.settings:item:base_price NE l.settings:item:price">
									<strike>&mvt:item:formatted_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:base_price NE l.settings:item:price">
									<strike>&mvt:item:formatted_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
								&mvt:item:formatted_price;
							</div>
						</td>
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">
								<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:subtotal_retail AND l.settings:item:subtotal_retail NE l.settings:item:subtotal">
									<strike>&mvt:item:formatted_subtotal_retail;</strike>
								<mvt:elseif expr="l.settings:item:subtotal_base_price NE l.settings:item:subtotal">
									<strike>&mvt:item:formatted_subtotal_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:subtotal_base_price NE l.settings:item:subtotal">
									<strike>&mvt:item:formatted_subtotal_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
								&mvt:item:formatted_subtotal;
							</div>
						</td>
					</tr>

					<mvt:foreach iterator="option" array="item:options">
						<mvt:if expr="l.pos2 LT l.settings:item:option_count">
							<mvt:assign name="l.settings:option_padding" value="'padding-bottom: 5px;'" />
						<mvt:else>
							<mvt:assign name="l.settings:option_padding" value="'padding-bottom: 15px;'" />
						</mvt:if>

						<tr>
							<td valign="top" style="&mvte:option_padding;">
								<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">
									<mvt:if expr="l.settings:option:option_id">
										&mvt:option:attr_code;: &mvt:option:opt_code;
									<mvt:elseif expr="NOT ISNULL l.settings:option:data">
										<mvt:if expr="( l.settings:option:attr_code EQ 'digitaldownload' ) AND ( NOT ISNULL l.settings:option:digital_download_url )">
											<a href="&mvte:option:digital_download_url;" target="_blank">Digital Download</a>
										<mvt:else>
											&mvt:option:attr_code;: &mvt:option:data;
										</mvt:if>
									<mvt:elseif expr="NOT ISNULL l.settings:option:data_long">
										&mvt:option:attr_code;: &mvt:option:data_long;
									<mvt:else>
										&mvt:option:attr_code;
									</mvt:if>
								</div><MIVA STANDARDOUTPUTLEVEL = "">
								<MvIF EXPR = "{ l.settings:lineitemdiscounts }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:foreach iterator="discount" array="option:discounts">
									<mvt:if expr="l.settings:discount:display">
										<div class="text-4" style="color:#fa4100; font-family:Arial, sans-serif; min-width:auto !important; font-size:12px; line-height:16px; text-align:left"><em>&mvt:discount:descrip;: &mvt:discount:formatted_discount;</em></div>
									</mvt:if>
								</mvt:foreach><MIVA STANDARDOUTPUTLEVEL = "">
								</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
							</td>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left"></td>
							<td valign="top" style="&mvte:option_padding;">
								&nbsp;
							</td>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left"></td>
							<td valign="top" style="&mvte:option_padding;">
								<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
									<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:retail OR l.settings:option:base_price OR l.settings:option:price">
										<mvt:if expr="l.settings:option:retail AND l.settings:option:retail NE l.settings:option:price">
											<strike>&mvt:option:formatted_retail;</strike>
										<mvt:elseif expr="l.settings:option:base_price NE l.settings:option:price">
											<strike>&mvt:option:formatted_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:base_price OR l.settings:option:price">
										<mvt:if expr="l.settings:option:base_price NE l.settings:option:price">
											<strike>&mvt:option:formatted_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSE><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:price"><MIVA STANDARDOUTPUTLEVEL = "">
									</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
										&mvt:option:formatted_price;
									<mvt:else>
										&nbsp;
									</mvt:if>
								</div>
							</td>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
							<td valign="top" style="&mvte:option_padding;">
								<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
									<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:subtotal_retail OR l.settings:option:subtotal_base_price OR l.settings:option:subtotal">
										<mvt:if expr="l.settings:option:subtotal_retail AND l.settings:option:subtotal_retail NE l.settings:option:subtotal">
											<strike>&mvt:option:formatted_subtotal_retail;</strike>
										<mvt:elseif expr="l.settings:option:subtotal_base_price NE l.settings:option:subtotal">
											<strike>&mvt:option:formatted_subtotal_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:subtotal_base_price OR l.settings:option:subtotal">
										<mvt:if expr="l.settings:option:subtotal_base_price NE l.settings:option:subtotal">
											<strike>&mvt:option:formatted_subtotal_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSE><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:subtotal"><MIVA STANDARDOUTPUTLEVEL = "">
									</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
										&mvt:option:formatted_subtotal;
									<mvt:else>
										&nbsp;
									</mvt:if>
								</div>
							</td>
						</tr>
					</mvt:foreach>
				</mvt:foreach>
			</table>
		</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="5" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" height="1" bgcolor="#e3e3e3">&nbsp;</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="20" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td align="right">
			<table border="0" cellspacing="0" cellpadding="0">
				<mvt:foreach iterator="charge" array="subscription:charges">
					<tr>
						<td>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">&mvt:charge:descrip;:</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
						<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td width="115">
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">&mvt:charge:formatted_disp_amt;</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
					</tr>
				</mvt:foreach>

				<tr>
					<td>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="h3-right" style="color:#303748; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:right"><strong>Estimated Total:</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

					</td>
					<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
					<td width="115">
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="h3-right" style="color:#303748; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:right"><strong>&mvt:subscription:formatted_display_total;</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

					</td>
				</tr>
			</table>
		</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="30" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

<!-- Button -->
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td align="center">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="30" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<table border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td align="center" bgcolor="#2a68ce">
						<table border="0" cellspacing="0" cellpadding="0">
							<tr>
								<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="40"><table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="50" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>
</td>
								<td bgcolor="#2a68ce">
									<div class="text-btn" style="color:#ffffff; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:center">
										<a href="&mvte:urls:CSBE:auto_sep;Subscription_ID=&mvta:subscription:id;" target="_blank" class="link-white" style="color:#ffffff; text-decoration:none"><span class="link-white" style="color:#ffffff; text-decoration:none">Manage Your Subscription</span></a>
									</div>
								</td>
								<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="40"></td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="30" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

		</td>
	</tr>
</table>
<!-- END Button -->
</mvt:foreach>

<!-- Order Details -->
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="20" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<div class="h3" style="color:#303748; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:left">
				<strong>Order Details</strong>
			</div>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" height="1" bgcolor="#e3e3e3">&nbsp;</td>
				</tr>
			</table>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr>
					<th class="column" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; Margin:0" valign="top" width="285">
						<div class="text" style="color:#1a2026; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Ship To</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left">
							&mvte:subscriptionorder:address:fname; &mvte:subscriptionorder:address:lname;<br />
							&mvte:subscriptionorder:address:addr1; &mvte:subscriptionorder:address:addr2;<br />
							&mvte:subscriptionorder:address:city;, &mvte:subscriptionorder:address:state; &mvte:subscriptionorder:address:zip;<br />
							&mvte:subscriptionorder:address:cntry;
						</div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="25" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<mvt:if expr="l.settings:subscriptionorder:ship_id">
						<div class="text" style="color:#1a2026; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Shipping Method</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left">&mvt:subscriptionorder:method;</div>
						</mvt:if>
					</th>
					<th class="column" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; Margin:0" valign="top" width="10">
						<table width="100%" border="0" cellspacing="0" cellpadding="0">
							<tr>
								<td><div style="font-size:0pt; line-height:0pt;" class="mobile-br-30"></div></td>
							</tr>
						</table>
					</th>
					<th class="column" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; Margin:0" valign="top">
						<div class="text" style="color:#1a2026; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Bill To</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left">
							<mvt:if expr="l.settings:subscriptionorder:paymentcard:id">
							&mvte:subscriptionorder:paymentcard:fname; &mvte:subscriptionorder:paymentcard:lname;<br />
							&mvte:subscriptionorder:paymentcard:addr1; &mvte:subscriptionorder:paymentcard:addr2;<br />
							&mvte:subscriptionorder:paymentcard:city;, &mvte:subscriptionorder:paymentcard:state; &mvte:subscriptionorder:paymentcard:zip;<br />
							&mvte:subscriptionorder:paymentcard:cntry;
							<mvt:else>
							&mvte:subscriptionorder:customer:bill_fname; &mvte:subscriptionorder:customer:bill_lname;<br />
							&mvte:subscriptionorder:customer:bill_addr1; &mvte:subscriptionorder:customer:bill_addr2;<br />
							&mvte:subscriptionorder:customer:bill_city;, &mvte:subscriptionorder:customer:bill_state; &mvte:subscriptionorder:customer:bill_zip;<br />
							&mvte:subscriptionorder:customer:bill_cntry;
							</mvt:if>
						</div>

						<mvt:if expr="l.settings:subscriptionorder:paymentcard:id">
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="25" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text" style="color:#1a2026; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Payment Method</strong></div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left">&mvte:subscriptionorder:paymentcard:type; Ending in &mvte:subscriptionorder:paymentcard:lastfour;</div>
						</mvt:if>
					</th>
				</tr>
			</table>
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="50" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>
		</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" height="1" bgcolor="#e3e3e3">&nbsp;</td>
	</tr>
</table>
<!-- END Order Details --><MIVA STANDARDOUTPUTLEVEL = "">
	</MvCAPTURE>
</MvFUNCTION>

<MvFUNCTION NAME = "OrderComponentModule_Generate_Code" PARAMETERS = "settings var, code var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.settings:groups }">					<MvASSIGN NAME = "l.array"			VALUE = "order:groups">
	<MvELSE>												<MvASSIGN NAME = "l.array"			VALUE = "order:items">
	</MvIF>

	<MvCAPTURE VARIABLE = "l.code"><MIVA STANDARDOUTPUTLEVEL = "text, html"><table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td>
			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr><MIVA STANDARDOUTPUTLEVEL = "">
				<MvIF EXPR = "{ NOT ISNULL l.settings:imagetypes[ 1 ] }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="75" >
						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Item</strong></div>
					</td><MIVA STANDARDOUTPUTLEVEL = "">
				</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td><MIVA STANDARDOUTPUTLEVEL = "">
				<MvIF EXPR = "{ NOT ISNULL l.settings:imagetypes[ 1 ] }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="200">&nbsp;</td><MIVA STANDARDOUTPUTLEVEL = "">
				<MvELSE><MIVA STANDARDOUTPUTLEVEL = "text, html">
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="200">
						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Item</strong></div>
					</td><MIVA STANDARDOUTPUTLEVEL = "">
				</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="100">
						<div class="text-1-center" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:center"><strong>Qty</strong></div>
					</td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="100">
						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><strong>Price</strong></div>
					</td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;">
						<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><strong>Total</strong></div>
					</td>
				</tr>

				<mvt:foreach iterator="item" array="{ l.array }">
					<mvt:if expr="l.settings:item:option_count">
						<mvt:assign name="l.settings:item_padding" value="'padding-top: 15px; padding-bottom: 5px;'" />
					<mvt:else>
						<mvt:assign name="l.settings:item_padding" value="'padding-top: 15px; padding-bottom: 15px;'" />
					</mvt:if>

					<tr><MIVA STANDARDOUTPUTLEVEL = "">
						<MvIF EXPR = "{ NOT ISNULL l.settings:imagetypes[ 1 ] }">
						<MvASSIGN NAME = "l.imagetype"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.settings:imagetypes[ 1 ] ) }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
						<mvt:if expr="l.settings:item:option_count">
							<mvt:assign name="l.settings:rowspan" value="l.settings:item:option_count + 1" />
						<mvt:else>
							<mvt:assign name="l.settings:rowspan" value="1" />
						</mvt:if>

						<td valign="top" style="&mvte:item_padding;" rowspan="&mvte:rowspan;">
							<div class="img" style="font-size:0pt; line-height:0pt; text-align:left">
								<mvt:if expr="{ 'ISNULL l.settings:item:imagetypes:' $ l.imagetype }">
									&nbsp;
								<mvt:else>
									<img src="{ '&mvt:global:baseurl;&mvte:item:imagetypes:' $ l.imagetype $ ';' }" border="0" alt="&mvte:item:name;" />
								</mvt:if>
							</div>
						</td><MIVA STANDARDOUTPUTLEVEL = "">
						</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left">&mvt:item:name;</div>
							<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">&mvt:item:code;</div>
							<MIVA STANDARDOUTPUTLEVEL = "">
							<MvFOREACH ITERATOR = "l.customfield" ARRAY = "l.settings:fields_custom">
								<MvASSIGN NAME = "l.safe_module_code"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.customfield:module ) }">
								<MvASSIGN NAME = "l.safe_field_code"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.customfield:code ) }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
							<mvt:if expr="{ 'NOT ISNULL l.settings:item:customfield_values:' $ l.safe_module_code $ ':' $ l.safe_field_code }">
								<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">&mvt:customfield_names:<MvEVAL EXPR = "{ l.safe_module_code }">:<MvEVAL EXPR = "{ l.safe_field_code }">;: &mvt:item:customfield_values:<MvEVAL EXPR = "{ l.safe_module_code }">:<MvEVAL EXPR = "{ l.safe_field_code }">;</div>
							</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
							</MvFOREACH>
							<MvIF EXPR = "{ l.settings:lineitemdiscounts }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
							<mvt:foreach iterator="discount" array="item:discounts">
								<mvt:if expr="l.settings:discount:display">
									<div class="text-4" style="color:#fa4100; font-family:Arial, sans-serif; min-width:auto !important; font-size:12px; line-height:16px; text-align:left"><em>&mvt:discount:descrip;: &mvt:discount:formatted_discount;</em></div>
								</mvt:if>
							</mvt:foreach><MIVA STANDARDOUTPUTLEVEL = "">
							</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
						</td>
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1-center" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:center">&mvte:item:quantity;</div>
						</td>
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
								<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:retail AND l.settings:item:retail NE l.settings:item:price">
									<strike>&mvt:item:formatted_retail;</strike>
								<mvt:elseif expr="l.settings:item:base_price NE l.settings:item:price">
									<strike>&mvt:item:formatted_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:base_price NE l.settings:item:price">
									<strike>&mvt:item:formatted_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
								&mvt:item:formatted_price;
							</div>
						</td>
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
								<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:subtotal_retail AND l.settings:item:subtotal_retail NE l.settings:item:subtotal">
									<strike>&mvt:item:formatted_subtotal_retail;</strike>
								<mvt:elseif expr="l.settings:item:subtotal_base_price NE l.settings:item:subtotal">
									<strike>&mvt:item:formatted_subtotal_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:subtotal_base_price NE l.settings:item:subtotal">
									<strike>&mvt:item:formatted_subtotal_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
								&mvt:item:formatted_subtotal;
							</div>
						</td>
					</tr>

					<mvt:foreach iterator="option" array="item:options">
						<mvt:if expr="l.pos2 LT l.settings:item:option_count">
							<mvt:assign name="l.settings:option_padding" value="'padding-bottom: 5px;'" />
						<mvt:else>
							<mvt:assign name="l.settings:option_padding" value="'padding-bottom: 15px;'" />
						</mvt:if>

						<tr>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
							<td valign="top" style="&mvte:option_padding;">
								<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">
									<mvt:if expr="l.settings:option:option_id">
										&mvt:option:attr_code;: &mvt:option:opt_code;
									<mvt:elseif expr="NOT ISNULL l.settings:option:data">
										<mvt:if expr="( l.settings:option:attr_code EQ 'digitaldownload' ) AND ( NOT ISNULL l.settings:option:digital_download_url )">
											<a href="&mvte:option:digital_download_url;" target="_blank">Digital Download</a>
										<mvt:else>
											&mvt:option:attr_code;: &mvt:option:data;
										</mvt:if>
									<mvt:elseif expr="NOT ISNULL l.settings:option:data_long">
										&mvt:option:attr_code;: &mvt:option:data_long;
									<mvt:else>
										&mvt:option:attr_code;
									</mvt:if>
								</div><MIVA STANDARDOUTPUTLEVEL = "">
								<MvIF EXPR = "{ l.settings:lineitemdiscounts }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:foreach iterator="discount" array="option:discounts">
									<mvt:if expr="l.settings:discount:display">
										<div class="text-4" style="color:#fa4100; font-family:Arial, sans-serif; min-width:auto !important; font-size:12px; line-height:16px; text-align:left"><em>&mvt:discount:descrip;: &mvt:discount:formatted_discount;</em></div>
									</mvt:if>
								</mvt:foreach><MIVA STANDARDOUTPUTLEVEL = "">
								</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
							</td>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
							<td valign="top" style="&mvte:option_padding;">
								&nbsp;
							</td>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
							<td valign="top" style="&mvte:option_padding;">
								<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
									<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:retail OR l.settings:option:base_price OR l.settings:option:price">
										<mvt:if expr="l.settings:option:retail AND l.settings:option:retail NE l.settings:option:price">
											<strike>&mvt:option:formatted_retail;</strike>
										<mvt:elseif expr="l.settings:option:base_price NE l.settings:option:price">
											<strike>&mvt:option:formatted_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:base_price OR l.settings:option:price">
										<mvt:if expr="l.settings:option:base_price NE l.settings:option:price">
											<strike>&mvt:option:formatted_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSE><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:price"><MIVA STANDARDOUTPUTLEVEL = "">
									</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
										&mvt:option:formatted_price;
									<mvt:else>
										&nbsp;
									</mvt:if>
								</div>
							</td>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
							<td valign="top" style="&mvte:option_padding;">
								<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
									<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:subtotal_retail OR l.settings:option:subtotal_base_price OR l.settings:option:subtotal">
										<mvt:if expr="l.settings:option:subtotal_retail AND l.settings:option:subtotal_retail NE l.settings:option:subtotal">
											<strike>&mvt:option:formatted_subtotal_retail;</strike>
										<mvt:elseif expr="l.settings:option:subtotal_base_price NE l.settings:option:subtotal">
											<strike>&mvt:option:formatted_subtotal_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:subtotal_base_price OR l.settings:option:subtotal">
										<mvt:if expr="l.settings:option:subtotal_base_price NE l.settings:option:subtotal">
											<strike>&mvt:option:formatted_subtotal_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSE><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:subtotal"><MIVA STANDARDOUTPUTLEVEL = "">
									</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
										&mvt:option:formatted_subtotal;
									<mvt:else>
										&nbsp;
									</mvt:if>
								</div>
							</td>
						</tr>
					</mvt:foreach>
				</mvt:foreach>
			</table>
		</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="5" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" height="1" bgcolor="#e3e3e3">&nbsp;</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="20" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td align="right">
			<table border="0" cellspacing="0" cellpadding="0"><MIVA STANDARDOUTPUTLEVEL = "">

			<MvIF EXPR = "{ l.settings:lineitemcoupons }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
				<mvt:foreach iterator="coupon" array="order:coupons">
					<tr>
						<td>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">
								Coupon (&mvt:coupon:code;)
								<mvt:if expr="NOT ISNULL l.settings:coupon:descrip">
									<div style="font-size: x-small; font-style: italic;">&mvt:coupon:descrip;</div>
								</mvt:if>
							</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
						<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td width="135">
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">&nbsp;</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
					</tr>
				</mvt:foreach><MIVA STANDARDOUTPUTLEVEL = "">
			</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">

				<mvt:foreach iterator="charge" array="order:charges">
					<tr>
						<td>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">&mvt:charge:descrip;:</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
						<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td width="135">
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">&mvt:charge:formatted_disp_amt;</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
					</tr>
				</mvt:foreach>

				<tr>
					<td>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="h3-right" style="color:#303748; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:right"><strong>Total:</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

					</td>
					<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
					<td width="135">
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="h3-right" style="color:#303748; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:right"><strong>&mvt:order:formatted_total;</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

					</td>
				</tr><MIVA STANDARDOUTPUTLEVEL = "">

			<MvIF EXPR = "{ l.settings:payments }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
				<mvt:foreach iterator="payment" array="order:payments">
					<tr>
						<td>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">
								<mvt:if expr="l.settings:payment:type EQ 6">
									Refund:
								<mvt:else>
									Payment:
								</mvt:if>

								&mvt:payment:desc;:
							</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
						<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td width="135">
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">
								<mvt:if expr="l.settings:payment:type EQ 6">
									&mvt:payment:formatted_amount;
								<mvt:else>
									&mvt:payment:formatted_amount_negative;
								</mvt:if>
							</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
					</tr>
				</mvt:foreach><MIVA STANDARDOUTPUTLEVEL = "">
			</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
			</table>
		</td>
	</tr>
</table>

<mvt:if expr="l.settings:order:have_custom_order_field_values">
	<table width="100%" border="0" cellspacing="0" cellpadding="0">
		<tr>
			<td colspan="2">
				<div class="h3" style="color:#303748; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:left">
					<strong>Additional Information</strong>
				</div>
			</td>
		</tr>
	</table>

	<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

	<table width="100%" border="0" cellspacing="0" cellpadding="0">
		<tr>
			<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" height="1" bgcolor="#e3e3e3">&nbsp;</td>
		</tr>
	</table>

	<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="15" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

	<table width="100%" border="0" cellspacing="0" cellpadding="0"><MIVA STANDARDOUTPUTLEVEL = "">
		<MvFOREACH ITERATOR = "l.customfield" ARRAY = "l.settings:fields_custom_order">
			<MvASSIGN NAME = "l.safe_module_code"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.customfield:module ) }">
			<MvASSIGN NAME = "l.safe_field_code"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.customfield:code ) }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
		<mvt:if expr="{ 'NOT ISNULL l.settings:order:customfield_order_values:' $ l.safe_module_code $ ':' $ l.safe_field_code }">
			<tr>
				<td nowrap>
					<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; font-weight:bold; padding-right:5px; line-height:22px; text-align:left">&mvt:customfield_order_names:<MvEVAL EXPR = "{ l.safe_module_code }">:<MvEVAL EXPR = "{ l.safe_field_code }">;:</div>
				</td>
				<td width="100%">
					<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">&mvt:order:customfield_order_values:<MvEVAL EXPR = "{ l.safe_module_code }">:<MvEVAL EXPR = "{ l.safe_field_code }">;</div>
				</td>
			</tr>
		</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
		</MvFOREACH><MIVA STANDARDOUTPUTLEVEL = "text, html">
	</table>
</mvt:if>

<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="30" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table><MIVA STANDARDOUTPUTLEVEL = "">
	</MvCAPTURE>
</MvFUNCTION>

<MvCOMMENT> TODO </MvCOMMENT>
<MvFUNCTION NAME = "BasketComponentModule_Generate_Code" PARAMETERS = "settings var, code var" STANDARDOUTPUTLEVEL = "">
	<MvIF EXPR = "{ l.settings:groups }">	<MvASSIGN NAME = "l.array" VALUE = "basket:groups">
	<MvELSE>								<MvASSIGN NAME = "l.array" VALUE = "basket:items">
	</MvIF>

	<MvCAPTURE VARIABLE = "l.code"><MIVA STANDARDOUTPUTLEVEL = "text, html"><table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td>
			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr><MIVA STANDARDOUTPUTLEVEL = "">
				<MvIF EXPR = "{ NOT ISNULL l.settings:imagetypes[ 1 ] }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="75" >
						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Item</strong></div>
					</td><MIVA STANDARDOUTPUTLEVEL = "">
				</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td><MIVA STANDARDOUTPUTLEVEL = "">
				<MvIF EXPR = "{ NOT ISNULL l.settings:imagetypes[ 1 ] }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="200">&nbsp;</td><MIVA STANDARDOUTPUTLEVEL = "">
				<MvELSE><MIVA STANDARDOUTPUTLEVEL = "text, html">
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="200">
						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left"><strong>Item</strong></div>
					</td><MIVA STANDARDOUTPUTLEVEL = "">
				</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="100">
						<div class="text-1-center" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:center"><strong>Qty</strong></div>
					</td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" width="100">
						<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><strong>Price</strong></div>
					</td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
					<td valign="top" style="border-bottom: 1px solid #e3e3e3; border-top: 1px solid #e3e3e3; padding-top: 10px; padding-bottom: 10px;">
						<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><strong>Total</strong></div>
					</td>
				</tr>

				<mvt:foreach iterator="item" array="{ l.array }">
					<mvt:if expr="l.settings:item:option_count">
						<mvt:assign name="l.settings:item_padding" value="'padding-top: 15px; padding-bottom: 5px;'" />
					<mvt:else>
						<mvt:assign name="l.settings:item_padding" value="'padding-top: 15px; padding-bottom: 15px;'" />
					</mvt:if>

					<tr><MIVA STANDARDOUTPUTLEVEL = "">
						<MvIF EXPR = "{ NOT ISNULL l.settings:imagetypes[ 1 ] }">
						<MvASSIGN NAME = "l.imagetype"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.settings:imagetypes[ 1 ] ) }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
						<mvt:if expr="l.settings:item:option_count">
							<mvt:assign name="l.settings:rowspan" value="l.settings:item:option_count + 1" />
						<mvt:else>
							<mvt:assign name="l.settings:rowspan" value="1" />
						</mvt:if>

						<td valign="top" style="&mvte:item_padding;" rowspan="&mvte:rowspan;">
							<div class="img" style="font-size:0pt; line-height:0pt; text-align:left">
								<mvt:if expr="{ 'ISNULL l.settings:item:imagetypes:' $ l.imagetype }">
									&nbsp;
								<mvt:else>
									<img src="{ '&mvt:global:baseurl;&mvte:item:imagetypes:' $ l.imagetype $ ';' }" border="0" alt="&mvte:item:name;" />
								</mvt:if>
							</div>
						</td><MIVA STANDARDOUTPUTLEVEL = "">
						</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:left">&mvt:item:name;</div>
							<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">&mvt:item:code;</div>
							<MIVA STANDARDOUTPUTLEVEL = "">
							<MvFOREACH ITERATOR = "l.customfield" ARRAY = "l.settings:fields_custom">
								<MvASSIGN NAME = "l.safe_module_code"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.customfield:module ) }">
								<MvASSIGN NAME = "l.safe_field_code"	VALUE = "{ [ g.Module_Feature_TUI_UT ].StripSpecialCharacters_TemplateCode( l.customfield:code ) }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
							<mvt:if expr="{ 'NOT ISNULL l.settings:item:customfield_values:' $ l.safe_module_code $ ':' $ l.safe_field_code }">
								<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">&mvt:customfield_names:<MvEVAL EXPR = "{ l.safe_module_code }">:<MvEVAL EXPR = "{ l.safe_field_code }">;: &mvt:item:customfield_values:<MvEVAL EXPR = "{ l.safe_module_code }">:<MvEVAL EXPR = "{ l.safe_field_code }">;</div>
							</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
							</MvFOREACH>
							<MvIF EXPR = "{ l.settings:lineitemdiscounts }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
							<mvt:foreach iterator="discount" array="item:discounts">
								<mvt:if expr="l.settings:discount:display">
									<div class="text-4" style="color:#fa4100; font-family:Arial, sans-serif; min-width:auto !important; font-size:12px; line-height:16px; text-align:left"><em>&mvt:discount:descrip;: &mvt:discount:formatted_discount;</em></div>
								</mvt:if>
							</mvt:foreach><MIVA STANDARDOUTPUTLEVEL = "">
							</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
						</td>
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1-center" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:center">&mvte:item:quantity;</div>
						</td>
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
								<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:retail AND l.settings:item:retail NE l.settings:item:price">
									<strike>&mvt:item:formatted_retail;</strike>
								<mvt:elseif expr="l.settings:item:base_price NE l.settings:item:price">
									<strike>&mvt:item:formatted_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:base_price NE l.settings:item:price">
									<strike>&mvt:item:formatted_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
								&mvt:item:formatted_price;
							</div>
						</td>
						<td valign="top" style="&mvte:item_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td valign="top" style="&mvte:item_padding;">
							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
								<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:subtotal_retail AND l.settings:item:subtotal_retail NE l.settings:item:subtotal">
									<strike>&mvt:item:formatted_subtotal_retail;</strike>
								<mvt:elseif expr="l.settings:item:subtotal_base_price NE l.settings:item:subtotal">
									<strike>&mvt:item:formatted_subtotal_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:if expr="l.settings:item:subtotal_base_price NE l.settings:item:subtotal">
									<strike>&mvt:item:formatted_subtotal_base_price;</strike>
								</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
								</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
								&mvt:item:formatted_subtotal;
							</div>
						</td>
					</tr>

					<mvt:foreach iterator="option" array="item:options">
						<mvt:if expr="l.pos2 LT l.settings:item:option_count">
							<mvt:assign name="l.settings:option_padding" value="'padding-bottom: 5px;'" />
						<mvt:else>
							<mvt:assign name="l.settings:option_padding" value="'padding-bottom: 15px;'" />
						</mvt:if>

						<tr>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
							<td valign="top" style="&mvte:option_padding;">
								<div class="text-3" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:14px; line-height:22px; text-align:left">
									<mvt:if expr="l.settings:option:option_id">
										&mvt:option:attr_code;: &mvt:option:opt_code;
									<mvt:elseif expr="NOT ISNULL l.settings:option:data">
										<mvt:if expr="( l.settings:option:attr_code EQ 'digitaldownload' ) AND ( NOT ISNULL l.settings:option:digital_download_url )">
											<a href="&mvte:option:digital_download_url;" target="_blank">Digital Download</a>
										<mvt:else>
											&mvt:option:attr_code;: &mvt:option:data;
										</mvt:if>
									<mvt:elseif expr="NOT ISNULL l.settings:option:data_long">
										&mvt:option:attr_code;: &mvt:option:data_long;
									<mvt:else>
										&mvt:option:attr_code;
									</mvt:if>
								</div><MIVA STANDARDOUTPUTLEVEL = "">
								<MvIF EXPR = "{ l.settings:lineitemdiscounts }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
								<mvt:foreach iterator="discount" array="option:discounts">
									<mvt:if expr="l.settings:discount:display">
										<div class="text-4" style="color:#fa4100; font-family:Arial, sans-serif; min-width:auto !important; font-size:12px; line-height:16px; text-align:left"><em>&mvt:discount:descrip;: &mvt:discount:formatted_discount;</em></div>
									</mvt:if>
								</mvt:foreach><MIVA STANDARDOUTPUTLEVEL = "">
								</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
							</td>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
							<td valign="top" style="&mvte:option_padding;">
								&nbsp;
							</td>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
							<td valign="top" style="&mvte:option_padding;">
								<div class="text-1" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
									<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:retail OR l.settings:option:base_price OR l.settings:option:price">
										<mvt:if expr="l.settings:option:retail AND l.settings:option:retail NE l.settings:option:price">
											<strike>&mvt:option:formatted_retail;</strike>
										<mvt:elseif expr="l.settings:option:base_price NE l.settings:option:price">
											<strike>&mvt:option:formatted_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:base_price OR l.settings:option:price">
										<mvt:if expr="l.settings:option:base_price NE l.settings:option:price">
											<strike>&mvt:option:formatted_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSE><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:price"><MIVA STANDARDOUTPUTLEVEL = "">
									</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
										&mvt:option:formatted_price;
									<mvt:else>
										&nbsp;
									</mvt:if>
								</div>
							</td>
							<td valign="top" style="&mvte:option_padding;" class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
							<td valign="top" style="&mvte:option_padding;">
								<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right"><MIVA STANDARDOUTPUTLEVEL = "">
									<MvIF EXPR = "{ l.settings:lineitemprice EQ 'retail' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:subtotal_retail OR l.settings:option:subtotal_base_price OR l.settings:option:subtotal">
										<mvt:if expr="l.settings:option:subtotal_retail AND l.settings:option:subtotal_retail NE l.settings:option:subtotal">
											<strike>&mvt:option:formatted_subtotal_retail;</strike>
										<mvt:elseif expr="l.settings:option:subtotal_base_price NE l.settings:option:subtotal">
											<strike>&mvt:option:formatted_subtotal_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSEIF EXPR = "{ l.settings:lineitemprice EQ 'base' }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:subtotal_base_price OR l.settings:option:subtotal">
										<mvt:if expr="l.settings:option:subtotal_base_price NE l.settings:option:subtotal">
											<strike>&mvt:option:formatted_subtotal_base_price;</strike>
										</mvt:if><MIVA STANDARDOUTPUTLEVEL = "">
									<MvELSE><MIVA STANDARDOUTPUTLEVEL = "text, html">
									<mvt:if expr="l.settings:option:subtotal"><MIVA STANDARDOUTPUTLEVEL = "">
									</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">
										&mvt:option:formatted_subtotal;
									<mvt:else>
										&nbsp;
									</mvt:if>
								</div>
							</td>
						</tr>
					</mvt:foreach>
				</mvt:foreach>
			</table>
		</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="5" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" height="1" bgcolor="#e3e3e3">&nbsp;</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="20" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td align="right">
			<table border="0" cellspacing="0" cellpadding="0"><MIVA STANDARDOUTPUTLEVEL = "">

			<MvIF EXPR = "{ l.settings:lineitemcoupons }"><MIVA STANDARDOUTPUTLEVEL = "text, html">
				<mvt:foreach iterator="coupon" array="basket:coupons">
					<tr>
						<td>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">
								Coupon (&mvt:coupon:code;)
								<mvt:if expr="NOT ISNULL l.settings:coupon:descrip">
									<div style="font-size: x-small; font-style: italic;">&mvt:coupon:descrip;</div>
								</mvt:if>
							</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
						<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td width="135">
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">&nbsp;</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
					</tr>
				</mvt:foreach><MIVA STANDARDOUTPUTLEVEL = "">
			</MvIF><MIVA STANDARDOUTPUTLEVEL = "text, html">

				<mvt:foreach iterator="charge" array="basket:charges">
					<tr>
						<td>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">&mvt:charge:descrip;:</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
						<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
						<td width="135">
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

							<div class="text-1-right" style="color:#7a838d; font-family:Arial, sans-serif; min-width:auto !important; font-size:16px; line-height:24px; text-align:right">&mvt:charge:formatted_disp_amt;</div>
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						</td>
					</tr>
				</mvt:foreach>

				<tr>
					<td>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="h3-right" style="color:#303748; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:right"><strong>Total:</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

					</td>
					<td class="img" style="font-size:0pt; line-height:0pt; text-align:left" width="10"></td>
					<td width="135">
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

						<div class="h3-right" style="color:#303748; font-family:Arial, sans-serif; min-width:auto !important; font-size:18px; line-height:22px; text-align:right"><strong>&mvt:basket:formatted_total;</strong></div>
						<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="3" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table>

					</td>
				</tr>
			</table>
		</td>
	</tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%"><tr><td height="30" class="spacer" style="font-size:0pt; line-height:0pt; text-align:center; width:100%; min-width:100%">&nbsp;</td></tr></table><MIVA STANDARDOUTPUTLEVEL = "">
	</MvCAPTURE>
</MvFUNCTION>

<MvCOMMENT>
|
| Notify CustomerPaymentCard Feature (not_paymentcard)
|
</MvCOMMENT>

<MvFUNCTION NAME = "Module_Notify_CustomerPaymentCard_Insert" PARAMETERS = "module var, paymentcard var" STANDARDOUTPUTLEVEL = "">
	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_CustomerPaymentCard_Update" PARAMETERS = "module var, paymentcard var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXPaymentCard WHERE custpc_id = ?' }"
			 FIELDS	= "l.paymentcard:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00121', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvFUNCTION NAME = "Module_Notify_CustomerPaymentCard_Delete" PARAMETERS = "module var, paymentcard var" STANDARDOUTPUTLEVEL = "" ERROROUTPUTLEVEL = "">
	<MvQUERY NAME	= "Merchant"
			 QUERY	= "{ 'DELETE FROM ' $ g.Store_Table_Prefix $ 'TemplateOrderEmailXPaymentCard WHERE custpc_id = ?' }"
			 FIELDS	= "l.paymentcard:id">
	<MvIF EXPR = "{ g.MvQUERY_Error }">
		<MvFUNCTIONRETURN VALUE = "{ [ g.Module_Library_Utilities ].Error( 'MER-FUF-TOE-00078', g.MvQUERY_Error ) }">
	</MvIF>

	<MvFUNCTIONRETURN VALUE = 1>
</MvFUNCTION>

<MvINCLUDE FILE = "modules/component/cmp-include-order.mv">
<MvINCLUDE FILE = "modules/component/cmp-include-basket.mv">
<MvINCLUDE FILE = "modules/fulfill/templateorderemails/functions.mv">
<MvINCLUDE FILE = "modules/fulfill/templateorderemails/list.mv">
<MvINCLUDE FILE = "modules/fulfill/templateorderemails/addeditdialog.mv">

<MvINCLUDE FILE = "json/mivascript.mv">
